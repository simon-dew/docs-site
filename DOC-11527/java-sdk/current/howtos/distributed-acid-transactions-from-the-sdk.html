<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>Distributed ACID Transactions from the Java SDK | Couchbase Docs (Preview)</title>
<link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-11527/java-sdk/current/howtos/distributed-acid-transactions-from-the-sdk.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="A practical guide on using Couchbase Distributed ACID transactions, via the Java SDK.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
        <link rel="prev" href="view-queries-with-sdk.html">
        <link rel="next" href="transactions-single-query.html">




                    <link rel="next" href="transactions-single-query.html">

        
<meta name="dcterms.subject" content="java-sdk">
<meta name="dcterms.identifier" content="3.3">
<meta name="page-url" content="/java-sdk/current/howtos/distributed-acid-transactions-from-the-sdk.html">
<meta name="page-nav-header-levels" content="0">
<meta name="generator" content="Antora 3.1.4">
<link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://simon-dew.github.io/docs-site/DOC-11527/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://simon-dew.github.io/docs-site/DOC-11527/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/3.3/modules/howtos/pages/distributed-acid-transactions-from-the-sdk.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../hello-world/overview.html">Java SDK</a></li>
<li class="crumb">Transactions</li>
<li class="crumb"><a href="distributed-acid-transactions-from-the-sdk.html">How-to Guide</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Distributed ACID Transactions from the Java SDK</h1>
<div class="labels">
<ul><li class="guide"><span><i class="far fa-check-square"></i> how-to</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
A practical guide on using Couchbase Distributed ACID transactions, via the Java SDK.
</blockquote>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Couchbase transactions feature was previously distributed as a separate library, before being integrated into the SDK from version <code>3.3.0</code>.
Users of the transactions library are recommended to follow the <a href="../project-docs/distributed-acid-transactions-migration-guide.html" class="xref page">Transactions Migration Guide</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This guide will show you examples of how to perform multi-document ACID (atomic, consistent, isolated, and durable) database transactions within your application, using the Couchbase Java SDK.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="../concept-docs/transactions.html" class="xref page">Distributed ACID Transactions</a> concept material for a high-level overview.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div id="tabs-1" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-1-couchbase-capella" class="tab">
<p>Couchbase Capella</p>
</li>
<li id="tabs-1-couchbase-server" class="tab">
<p>Couchbase Server</p>
</li>
</ul>
</div>
<div id="tabs-1-couchbase-capella--panel" class="tabpanel" aria-labelledby="tabs-1-couchbase-capella">
<div class="ulist">
<ul>
<li>
<p>Couchbase Capella account.</p>
</li>
<li>
<p>You should know how to perform <a href="kv-operations.html" class="xref page">key-value</a> or <a href="n1ql-queries-with-sdk.html" class="xref page">query</a> operations with the SDK.</p>
</li>
<li>
<p>Your application should have the relevant roles and permissions on the required buckets, scopes, and collections, to perform transactional operations.
Refer to the <a href="../../../cloud/organizations/organization-projects-overview.html" class="xref page">Organizations &amp; Access</a> page for more details.</p>
</li>
<li>
<p>If your application is using <a href="../concept-docs/xattr.html" class="xref page">extended attributes (XATTRs)</a>, you should avoid using the XATTR field <code>txn</code>&#8201;&#8212;&#8201;this is reserved for Couchbase use.</p>
</li>
</ul>
</div>
</div>
<div id="tabs-1-couchbase-server--panel" class="tabpanel" aria-labelledby="tabs-1-couchbase-server">
<div class="ulist">
<ul>
<li>
<p>Couchbase Server (6.6.1 or above).</p>
</li>
<li>
<p>You should know how to perform <a href="kv-operations.html" class="xref page">key-value</a> or <a href="n1ql-queries-with-sdk.html" class="xref page">query</a> operations with the SDK.</p>
</li>
<li>
<p>Your application should have the relevant roles and permissions on the required buckets, scopes, and collections, to perform transactional operations.
Refer to the <a href="#7.1@server:learn:security/roles.adoc" class="xref unresolved">Roles</a> page for more details.</p>
</li>
<li>
<p>If your application is using <a href="../concept-docs/xattr.html" class="xref page">extended attributes (XATTRs)</a>, you should avoid using the XATTR field <code>txn</code>&#8201;&#8212;&#8201;this is reserved for Couchbase use.</p>
</li>
<li>
<p>NTP should be configured so nodes of the Couchbase cluster are in sync with time.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Single Node Cluster</div>
<div class="paragraph">
<p>When using a single node cluster (for example, during development), the default number of replicas for a newly created bucket is <strong>1</strong>.
If left at this default, all key-value writes performed with durability will fail with a <code>DurabilityImpossibleException</code>.
In turn, this will cause all transactions (which perform all key-value writes durably) to fail.
This setting can be changed via:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../../../cloud/clusters/data-service/manage-buckets.html#add-bucket" class="xref page">Capella UI</a></p>
</li>
<li>
<p><a href="#7.1@server:manage:manage-buckets/create-bucket.adoc#couchbase-bucket-settings" class="xref unresolved">Couchbase Server UI</a></p>
</li>
<li>
<p><a href="#7.1@server:cli:cbcli/couchbase-cli-bucket-create.adoc#options" class="xref unresolved">Command Line</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the bucket already exists, then the server needs to be rebalanced for the setting to take effect.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-transaction"><a class="anchor" href="#creating-a-transaction"></a>Creating a Transaction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create a transaction, an application must supply its logic inside a <code>lambda</code>, including any conditional logic required.
Once the lambda has successfully run to conclusion, the transaction will be automatically committed.
If at any point an error occurs, the transaction will rollback and the lambda may run again.</p>
</div>
<div class="paragraph">
<p>You can create transactions either <em>synchronously</em> or <em>asynchronously</em> (using the <a href="https://projectreactor.io/">Project Reactor</a> reactive library).</p>
</div>
<div id="tabs-2" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-2-synchronous-api" class="tab">
<p>Synchronous API</p>
</li>
<li id="tabs-2-asynchronous-api" class="tab">
<p>Asynchronous API</p>
</li>
</ul>
</div>
<div id="tabs-2-synchronous-api--panel" class="tabpanel" aria-labelledby="tabs-2-synchronous-api">
<div class="paragraph">
<p>The synchronous mode is the easiest to write and understand.</p>
</div>
<div class="paragraph">
<p>Transactions are accessed via the <code>Cluster</code> object.
By invoking <code>Cluster.transactions()</code>, we can access the <code>Transactions</code> object and <code>run</code> the lambda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L194-L229">Scope inventory = cluster.bucket("travel-sample").scope("inventory");

try {
    TransactionResult result = cluster.transactions().run((ctx) -&gt; {
        // Inserting a doc:
        ctx.insert(collection, "doc-a", JsonObject.create());

        // Getting documents:
        TransactionGetResult docA = ctx.get(collection, "doc-a");

        // Replacing a doc:
        TransactionGetResult docB = ctx.get(collection, "doc-b");
        JsonObject content = docB.contentAs(JsonObject.class);
        content.put("transactions", "are awesome");
        ctx.replace(docB, content);

        // Removing a doc:
        TransactionGetResult docC = ctx.get(collection, "doc-c");
        ctx.remove(docC);

        // Performing a SELECT N1QL query against a scope:
        TransactionQueryResult qr = ctx.query(inventory, "SELECT * FROM hotel WHERE country = $1",
                TransactionQueryOptions.queryOptions()
                        .parameters(JsonArray.from("United Kingdom")));
        var rows = qr.rowsAs(JsonObject.class);

        // Performing an UPDATE N1QL query on multiple documents, in the `inventory` scope:
        ctx.query(inventory, "UPDATE route SET airlineid = $1 WHERE airline = $2",
                TransactionQueryOptions.queryOptions()
                        .parameters(JsonArray.from("airline_137", "AF")));
    });
} catch (TransactionCommitAmbiguousException e) {
    throw logCommitAmbiguousError(e);
} catch (TransactionFailedException e) {
    throw logFailure(e);
}</code></pre>
</div>
</div>
</div>
<div id="tabs-2-asynchronous-api--panel" class="tabpanel" aria-labelledby="tabs-2-asynchronous-api">
<div class="paragraph">
<p>The asynchronous mode allows you to build your application in a reactive style, which can help you scale with excellent efficiency.</p>
</div>
<div class="paragraph">
<p>Transactions are accessed via the <code>ReactiveCluster</code> object.
By invoking <code>Cluster.reactive().transactions()</code>, we can access the <code>ReactiveTransactions</code> object and <code>run</code> the lambda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L235-L277">ReactiveScope inventory = cluster.bucket("travel-sample").scope("inventory").reactive();

Mono&lt;TransactionResult&gt; result = cluster.reactive().transactions().run((ctx) -&gt; {
    // Inserting a doc:
    return ctx.insert(collection.reactive(), "doc-a", JsonObject.create())

            // Getting and replacing a doc:
            .then(ctx.get(collection.reactive(), "doc-b")).flatMap(docB -&gt; {
                var content = docB.contentAs(JsonObject.class);
                content.put("transactions", "are awesome");
                return ctx.replace(docB, content);
            })

            // Getting and removing a doc:
            .then(ctx.get(collection.reactive(), "doc-c"))
                .flatMap(doc -&gt; ctx.remove(doc))

            // Performing a SELECT N1QL query, in the `inventory` scope:
            .then(ctx.query(inventory, "SELECT * FROM hotel WHERE country = $1",
                    TransactionQueryOptions.queryOptions()
                            .parameters(JsonArray.from("United Kingdom"))))

            .flatMap(queryResult -&gt; {
                var rows = queryResult.rowsAs(JsonObject.class);
                // The application would do something with the rows here.
                return Mono.empty();
            })

            // Performing an UPDATE N1QL query on multiple documents, in the `inventory` scope:
            .then(ctx.query(inventory, "UPDATE route SET airlineid = $1 WHERE airline = $2",
                    TransactionQueryOptions.queryOptions()
                            .parameters(JsonArray.from("airline_137", "AF"))));
}).doOnError(err -&gt; {
    if (err instanceof TransactionCommitAmbiguousException) {
        throw logCommitAmbiguousError((TransactionCommitAmbiguousException) err);
    } else if (err instanceof TransactionFailedException) {
        throw logFailure((TransactionFailedException) err);
    }
});

// Normally you will chain this result further and ultimately subscribe.
// For simplicity, here we just block on the result.
result.block();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="lambda-ops" class="paragraph">
<p>The transaction lambda gets passed a <code>TransactionAttemptContext</code> object&#8201;&#8212;&#8201;generally referred to as <code>ctx</code> in these examples.
Since the lambda could be rerun multiple times, it is important that it does not contain any side effects.
In particular, you should never perform regular operations on a <code>Collection</code>, such as <code>collection.insert()</code>, inside the lambda.
Such operations may be performed multiple times, and will not be performed transactionally.
Instead, you should perform these operations through the <code>ctx</code> object, e.g. <code>ctx.insert()</code>.</p>
</div>
<div class="paragraph">
<p>The result of a transaction is represented by a <code>TransactionResult</code> object, which can be used to expose debugging and logging information to help track what happened during a transaction.</p>
</div>
<div class="paragraph">
<p>In the event that a transaction fails, your application could run into the following errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TransactionCommitAmbiguousException</code></p>
</li>
<li>
<p><code>TransactionFailedException</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to <a href="../concept-docs/transactions-error-handling.html#transaction_errors" class="xref page">Error Handling</a> for more details on these.</p>
</div>
<div class="sect2">
<h3 id="logging"><a class="anchor" href="#logging"></a>Logging</h3>
<div class="paragraph">
<p>To aid troubleshooting, each transaction maintains a list of log entries, which can be logged on failure like this:</p>
</div>
<div id="tabs-3" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-3-synchronous-api" class="tab">
<p>Synchronous API</p>
</li>
<li id="tabs-3-asynchronous-api" class="tab">
<p>Asynchronous API</p>
</li>
</ul>
</div>
<div id="tabs-3-synchronous-api--panel" class="tabpanel" aria-labelledby="tabs-3-synchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L147-L151">} catch (TransactionCommitAmbiguousException e) {
    throw logCommitAmbiguousError(e);
} catch (TransactionFailedException e) {
    throw logFailure(e);
}</code></pre>
</div>
</div>
</div>
<div id="tabs-3-asynchronous-api--panel" class="tabpanel" aria-labelledby="tabs-3-asynchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L177-L183">}).doOnError(err -&gt; {
    if (err instanceof TransactionCommitAmbiguousException) {
        throw logCommitAmbiguousError((TransactionCommitAmbiguousException) err);
    } else if (err instanceof TransactionFailedException) {
        throw logFailure((TransactionFailedException) err);
    }
});</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It is a good practice for the application to log any failed transactions into its own logging system, here represented with a logger object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L642-L662">public static RuntimeException logCommitAmbiguousError(TransactionCommitAmbiguousException err) {
    // This example will intentionally not compile: the application needs to use
    // its own logging system to replace `logger`.
    logger.warning("Transaction possibly reached the commit point");

    for (TransactionLogEvent msg : err.logs()) {
        logger.warning(msg.toString());
    }

    return err;
}

public static RuntimeException logFailure(TransactionFailedException err) {
    logger.warning("Transaction did not reach commit point");

    for (TransactionLogEvent msg : err.logs()) {
        logger.warning(msg.toString());
    }

    return err;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you should replace <code>logger.warning</code> with the logging system of choice for your application.</p>
</div>
<div class="paragraph">
<p>A failed transaction can involve dozens, even hundreds, of lines of logging, so it may be preferable to write failed transactions into a separate file.</p>
</div>
<div class="paragraph">
<p>You could also log a successful transaction like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L158-L162">TransactionResult result = cluster.transactions().run((ctx) -&gt; {
    // Your transaction logic
});

result.logs().forEach(message -&gt; logger.info(message.toString()));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="key-value-operations"><a class="anchor" href="#key-value-operations"></a>Key-Value Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can perform transactional database operations using familiar key-value CRUD methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>C</strong>reate - <code>insert()</code></p>
</li>
<li>
<p><strong>R</strong>ead - <code>get()</code></p>
</li>
<li>
<p><strong>U</strong>pdate - <code>replace()</code></p>
</li>
<li>
<p><strong>D</strong>elete - <code>remove()</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As mentioned <a href="#lambda-ops">previously</a>, make sure your application uses the transactional key-value operations inside the lambda&#8201;&#8212;&#8201;such as <code>ctx.insert()</code>, rather than <code>collection.insert()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="insert"><a class="anchor" href="#insert"></a>Insert</h3>
<div class="paragraph">
<p>To insert a document within a transaction lambda, simply call <code>ctx.insert()</code>.</p>
</div>
<div id="tabs-4" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-4-synchronous-api" class="tab">
<p>Synchronous API</p>
</li>
<li id="tabs-4-asynchronous-api" class="tab">
<p>Asynchronous API</p>
</li>
</ul>
</div>
<div id="tabs-4-synchronous-api--panel" class="tabpanel" aria-labelledby="tabs-4-synchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L284-L288">cluster.transactions().run((ctx) -&gt; {
    String docId = "docId";

    ctx.insert(collection, docId, JsonObject.create());
});</code></pre>
</div>
</div>
</div>
<div id="tabs-4-asynchronous-api--panel" class="tabpanel" aria-labelledby="tabs-4-asynchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L294-L296">cluster.reactive().transactions().run((ctx) -&gt; {
    return ctx.insert(collection.reactive(), "docId", JsonObject.create());
}).block();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="get"><a class="anchor" href="#get"></a>Get</h3>
<div class="paragraph">
<p>To retrieve a document from the database you can call <code>ctx.get()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L315-L317">cluster.transactions().run((ctx) -&gt; {
    TransactionGetResult doc = ctx.get(collection, "a-doc");
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, <code>ctx.get()</code> will return a <code>TransactionGetResult</code> object, which is very similar to the <code>GetResult</code> you are used to.</p>
</div>
<div class="paragraph">
<p>If the application needs to ignore or take action on a document not existing, it can catch the exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L302-L309">cluster.transactions().run((ctx) -&gt; {
    try {
        TransactionGetResult doc = ctx.get(collection, "a-doc");
    }
    catch (DocumentNotFoundException err) {
        // The application can continue the transaction here if needed, or take alternative action
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gets will "Read Your Own Writes", e.g. this will succeed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L323-L329">cluster.transactions().run((ctx) -&gt; {
    String docId = "docId";

    ctx.insert(collection, docId, JsonObject.create());

    TransactionGetResult doc = ctx.get(collection, docId);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, no other transaction will be able to read that inserted document, until this transaction reaches the commit point.</p>
</div>
</div>
<div class="sect2">
<h3 id="replace"><a class="anchor" href="#replace"></a>Replace</h3>
<div class="paragraph">
<p>Replacing a document requires a <code>ctx.get()</code> call first.
This is necessary so the SDK can check that the document is not involved in another transaction, and take appropriate action if so.</p>
</div>
<div id="tabs-5" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-5-synchronous-api" class="tab">
<p>Synchronous API</p>
</li>
<li id="tabs-5-asynchronous-api" class="tab">
<p>Asynchronous API</p>
</li>
</ul>
</div>
<div id="tabs-5-synchronous-api--panel" class="tabpanel" aria-labelledby="tabs-5-synchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L335-L340">cluster.transactions().run((ctx) -&gt; {
    TransactionGetResult doc = ctx.get(collection, "doc-id");
    JsonObject content = doc.contentAs(JsonObject.class);
    content.put("transactions", "are awesome");
    ctx.replace(doc, content);
});</code></pre>
</div>
</div>
</div>
<div id="tabs-5-asynchronous-api--panel" class="tabpanel" aria-labelledby="tabs-5-asynchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L346-L352">cluster.reactive().transactions().run((ctx) -&gt; {
    return ctx.get(collection.reactive(), "doc-id").flatMap(doc -&gt; {
        JsonObject content = doc.contentAs(JsonObject.class);
        content.put("transactions", "are awesome");
        return ctx.replace(doc, content);
    });
});</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="remove"><a class="anchor" href="#remove"></a>Remove</h3>
<div class="paragraph">
<p>As with replaces, removing a document requires a <code>ctx.get()</code> call first.</p>
</div>
<div id="tabs-6" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="tabs-6-synchronous-api" class="tab">
<p>Synchronous API</p>
</li>
<li id="tabs-6-asynchronous-api" class="tab">
<p>Asynchronous API</p>
</li>
</ul>
</div>
<div id="tabs-6-synchronous-api--panel" class="tabpanel" aria-labelledby="tabs-6-synchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L358-L361">cluster.transactions().run((ctx) -&gt; {
    TransactionGetResult doc = ctx.get(collection, "doc-id");
    ctx.remove(doc);
});</code></pre>
</div>
</div>
</div>
<div id="tabs-6-asynchronous-api--panel" class="tabpanel" aria-labelledby="tabs-6-asynchronous-api">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L367-L370">cluster.reactive().transactions().run((ctx) -&gt; {
    return ctx.get(collection.reactive(), "anotherDoc")
            .flatMap(doc -&gt; ctx.remove(doc));
});</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Reactor Mono&lt;Void&gt;</div>
Some <code>ctx</code> methods, notably <code>ctx.remove()</code>, return <code>Mono&lt;Void&gt;</code>.
There is a common "gotcha" with <code>Mono&lt;Void&gt;</code> in that it does not trigger a "next" reactive event - only a "completion" event.
This means that some reactive operators chained afterwards, including the common <code>flatMap</code>, will not trigger.
Generally, you will need to do <code>ctx.remove(&#8230;&#8203;).then(&#8230;&#8203;)</code> rather than <code>ctx.remove(&#8230;&#8203;).flatMap(&#8230;&#8203;)</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sql-queries"><a class="anchor" href="#sql-queries"></a>SQL++ Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you already use <a href="https://www.couchbase.com/products/n1ql">SQL++ (formerly N1QL)</a>, then its use in transactions is very similar.
A query returns a <code>TransactionQueryResult</code> that is very similar to the <code>QueryResult</code> you are used to, and takes most of the same options.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As mentioned <a href="#lambda-ops">previously</a>, make sure your application uses the transactional query operations inside the lambda&#8201;&#8212;&#8201;such as <code>ctx.query()</code>, rather than <code>cluster.query()</code> or <code>scope.query()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of selecting some rows from the <code>travel-sample</code> bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L563-L571">Bucket travelSample = cluster.bucket("travel-sample");
Scope inventory = travelSample.scope("inventory");

cluster.transactions().run((ctx) -&gt; {
    var qr = ctx.query(inventory, "SELECT * FROM hotel WHERE country = $1",
            TransactionQueryOptions.queryOptions()
                    .parameters(JsonArray.from("United States")));
    var rows = qr.rowsAs(JsonObject.class);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example using a <code>Scope</code> for an <code>UPDATE</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L575-L583">String hotelChain = "http://marriot%";
String country = "United States";

cluster.transactions().run((ctx) -&gt; {
    var qr = ctx.query(inventory, "UPDATE hotel SET price = $1 WHERE url LIKE $2 AND country = $3",
            TransactionQueryOptions.queryOptions()
                    .parameters(JsonArray.from(99.99, hotelChain, country)));
    assert(qr.metaData().metrics().get().mutationCount() == 1);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>And an example combining <code>SELECT</code> and <code>UPDATE</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L587-L601">cluster.transactions().run((ctx) -&gt; {
    // Find all hotels of the chain
    var qr = ctx.query(inventory, "SELECT reviews FROM hotel WHERE url LIKE $1 AND country = $2",
            TransactionQueryOptions.queryOptions()
                    .parameters(JsonArray.from(hotelChain, country)));

    // This function (not provided here) will use a trained machine learning model to provide a
    // suitable price based on recent customer reviews.
    double updatedPrice = priceFromRecentReviews(qr);

    // Set the price of all hotels in the chain
    ctx.query(inventory, "UPDATE hotel SET price = $1 WHERE url LIKE $2 AND country = $3",
            TransactionQueryOptions.queryOptions()
                    .parameters(JsonArray.from(updatedPrice, hotelChain, country)));
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the snippet above, it is possible to call regular Java methods from the lambda, permitting complex logic to be performed.
Just remember that since the lambda may be called multiple times, so may the method.</p>
</div>
<div class="paragraph">
<p>Like key-value operations, queries support "Read Your Own Writes".
This example shows inserting a document and then selecting it again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L611-L618">cluster.transactions().run((ctx) -&gt; {
    ctx.query("INSERT INTO `default` VALUES ('doc', {'hello':'world'})");  <i class="conum" data-value="1"></i><b>(1)</b>

    // Performing a 'Read Your Own Write'
    var st = "SELECT `default`.* FROM `default` WHERE META().id = 'doc'"; <i class="conum" data-value="2"></i><b>(2)</b>
    var qr = ctx.query(st);
    assert(qr.metaData().metrics().get().resultCount() == 1);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The inserted document is only staged at this point, as the transaction has not yet committed.<br>
Other transactions, and other non-transactional actors, will not be able to see this staged insert yet.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But the <code>SELECT</code> can, as we are reading a mutation staged inside the same transaction.</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="query-options"><a class="anchor" href="#query-options"></a>Query Options</h3>
<div class="paragraph">
<p>Query options can be provided via the <code>TransactionQueryOptions</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L703-L706">cluster.transactions().run((ctx) -&gt; {
    ctx.query("INSERT INTO `default` VALUES ('doc', {'hello':'world'})",
            TransactionQueryOptions.queryOptions().profile(QueryProfile.TIMINGS));
});</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported Transaction Query Options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parameters(JsonArray)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to set positional arguments for a parameterized query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parameters(JsonObject)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows you to set named arguments for a parameterized query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanConsistency(QueryScanConsistency)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a different scan consistency for this query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flexIndex(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tells the query engine to use a flex index (utilizing the search service).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>serializer(JsonSerializer)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to use a different serializer for the decoding of the rows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientContextId(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a context ID returned by the service for debugging purposes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanWait(Duration)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to specify a maximum scan wait time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanCap(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a maximum cap on the query scan size.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pipelineBatch(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the batch size for the query pipeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pipelineCap(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the cap for the query pipeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>profile(QueryProfile)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows you to enable additional query profiling as part of the response.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>readonly(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tells the client and server that this query is readonly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adhoc(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false will prepare the query and later execute the prepared statement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>raw(String, Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Escape hatch to add arguments that are not covered by these options.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mixing-key-value-and-sql"><a class="anchor" href="#mixing-key-value-and-sql"></a>Mixing Key-Value and SQL++</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Key-Value and SQL++ query operations can be freely intermixed, and will interact with each other as you would expect.
In this example we insert a document with a key-value operation, and read it with a <code>SELECT</code> query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L690-L697">cluster.transactions().run((ctx) -&gt; {
    ctx.insert(collection, "doc", JsonObject.create().put("hello", "world")); <i class="conum" data-value="1"></i><b>(1)</b>

    // Performing a 'Read Your Own Write'
    var st = "SELECT `default`.* FROM `default` WHERE META().id = 'doc'"; <i class="conum" data-value="2"></i><b>(2)</b>
    var qr = ctx.query(st);
    assert(qr.metaData().metrics().get().resultCount() == 1);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The key-value insert operation is only staged, and so it is not visible to other transactions or non-transactional actors.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But the <code>SELECT</code> can view it, as the insert was in the same transaction.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Query Mode</div>
<div class="paragraph">
<p>When a transaction executes a query statement, the transaction enters <strong>query mode</strong>, which means that the query is executed with the user&#8217;s query permissions.
Any <strong>key-value</strong> operations which are executed by the transaction <em>after</em> the query statement are <em>also</em> executed with the user&#8217;s query permissions.
These may or may not be different to the user&#8217;s data permissions; if they are different, you may get unexpected results.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concurrent-operations"><a class="anchor" href="#concurrent-operations"></a>Concurrent Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The reactive API allows operations to be performed concurrently inside a transaction, which can assist performance.</p>
</div>
<div class="paragraph">
<p>An example of performing parallel operations using the reactive API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L509-L524">List&lt;String&gt; docIds = Arrays.asList("doc1", "doc2", "doc3", "doc4", "doc5");
int concurrency = 100; // This many operations will be in-flight at once

var result = cluster.reactive().transactions().run((ctx) -&gt; {
    return Flux.fromIterable(docIds)
            .parallel(concurrency)
            .runOn(Schedulers.boundedElastic())
            .concatMap(docId -&gt; ctx.get(collection.reactive(), docId)
                    .flatMap(doc -&gt; {
                        var content = doc.contentAsObject();
                        content.put("value", "updated");
                        return ctx.replace(doc, content);
                    }))
            .sequential()
            .then();
}).block();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Query Concurrency</div>
Only one query statement will be performed by the Query service at a time.
Non-blocking mechanisms can be used to perform multiple concurrent query statements, but this may result internally in some added network traffic due to retries, and is unlikely to provide any increased performance.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="non-transactional-writes"><a class="anchor" href="#non-transactional-writes"></a>Non-Transactional Writes</h3>
<div class="paragraph">
<p>To ensure key-value performance is not compromised, and to avoid conflicting writes, applications should <strong>never</strong> perform non-transactional <em>writes</em> concurrently with transactional ones, on the same document.</p>
</div>
<div class="paragraph">
<p>You can verify this when debugging your application by subscribing to the client&#8217;s event logger and checking for any <code>IllegalDocumentStateEvent</code> events.
These events are raised when a non-transactional write has been detected and overridden.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L424-L429">cluster.environment().eventBus().subscribe(event -&gt; {
    if (event instanceof IllegalDocumentStateEvent) {
        // log this event for review
        log(((TransactionEvent) event).logs());
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The event contains the key of the document involved, to aid the application with debugging.</p>
</div>
<div class="paragraph">
<p>See <a href="../concept-docs/transactions.html#concurrency-with-non-transactional-writes" class="xref page">Concurrency with Non-Transactional Writes</a> to learn more.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default configuration should be appropriate for most use-cases.
If needed, transactions can be globally configured at the point of creating the <code>Cluster</code>.
As usual with <code>Cluster</code> configuration, you can either explicitly create and manage the <code>ClusterEnvironment</code> yourself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L85-L99">ClusterEnvironment env = ClusterEnvironment.builder()
        .transactionsConfig(TransactionsConfig.durabilityLevel(DurabilityLevel.PERSIST_TO_MAJORITY)
                .cleanupConfig(TransactionsCleanupConfig.cleanupWindow(Duration.ofSeconds(30)))
                .queryConfig(TransactionsQueryConfig.scanConsistency(QueryScanConsistency.NOT_BOUNDED)))
        .build();

Cluster cluster = Cluster.connect("localhost", ClusterOptions.clusterOptions("username", "password")
        .environment(env));

// Use the cluster
// ...

// Shutdown
cluster.disconnect();
env.shutdown();</code></pre>
</div>
</div>
<div class="paragraph">
<p>or alternatively use this lambda syntax, which leads to the <code>ClusterEnvironment</code> being owned and managed by the <code>Cluster</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/TransactionsExample.java#L105-L116">Cluster cluster = Cluster.connect("localhost", ClusterOptions.clusterOptions("username", "password")
        .environment(env -&gt; env.transactionsConfig(TransactionsConfig
                .durabilityLevel(DurabilityLevel.PERSIST_TO_MAJORITY)
                .cleanupConfig(TransactionsCleanupConfig
                        .cleanupWindow(Duration.ofSeconds(30)))
                .queryConfig(TransactionsQueryConfig
                        .scanConsistency(QueryScanConsistency.NOT_BOUNDED)))));
// Use the cluster
// ...

// Shutdown
cluster.disconnect();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default configuration will perform all writes with the durability setting <code>Majority</code>, ensuring that each write is available in-memory on the majority of replicas before the transaction continues.
There are two higher durability settings available that will additionally wait for all mutations to be written to physical storage on either the active or the majority of replicas, before continuing.
This further increases safety, at a cost of additional latency.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
A level of <code>None</code> is present but its use is discouraged and unsupported.
If durability is set to <code>None</code>, then ACID semantics are not guaranteed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-resources"><a class="anchor" href="#additional-resources"></a>Additional Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Learn more about <a href="../concept-docs/transactions.html" class="xref page">Distributed ACID Transactions</a>.</p>
</li>
<li>
<p>Check out the SDK <a href="https://docs.couchbase.com/sdk-api/couchbase-java-client/com/couchbase/client/java/transactions/package-summary.html">API Reference</a>.</p>
</li>
</ul>
</div>
</div>
</div>

        <nav class="pagination">

                <span>&nbsp;</span>
        
                    <span class="next"><a href="transactions-single-query.html">Single Query Transactions</a></span>

</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span> 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"SDKs","components":["dotnet-sdk","java-sdk","nodejs-sdk","python-sdk","tableau-connector","sdk-extensions"],"url":"/home/sdk.html","latestVersions":{"dotnet-sdk":"3.3","java-sdk":"3.3","nodejs-sdk":"4.1","python-sdk":"4.0","tableau-connector":"1.x","sdk-extensions":"master"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
