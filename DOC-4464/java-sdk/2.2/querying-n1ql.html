<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Working with N1QL | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4464/java-sdk/2.7/start-using-sdk.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="java-sdk">
    <meta name="dcterms.identifier" content="2.2">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4464">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="java-intro.html"><span class="title">Java SDK</span> <span class="version">2.2</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.7/start-using-sdk.html">Java SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/start-using-sdk.html">Java SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/start-using-sdk.html">Java SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/start-using-sdk.html">Java SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">Java SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.1/querying-n1ql.html">Java SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/querying-n1ql.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/querying-n1ql.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/querying-n1ql.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/querying-n1ql.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/querying-n1ql.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/querying-n1ql.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="java-intro.html">Java SDK 2.2</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API reference</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="migrate.html">Migrating from Java SDK 1.4.x to 2.x</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting started with the Java SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase Example</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="tutorial4.html">Java SDK tutorial</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-cluster.html">Managing clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="env-config.html">Configuring the environment</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="documents.html">Working with documents</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-basics.html">Document basics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-creating.html">Creating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-updating.html">Updating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-retrieving.html">Retrieving documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-deleting.html">Deleting documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-atomic.html">Atomic operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-bulk.html">Bulk operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability requirements</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="querying.html">Querying buckets</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="managing-views.html">Managing views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-views.html">Working with views</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-n1ql.html">Working with N1QL</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="rxjava.html">RxJava and reactive programming</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="observables.html">Mastering Observables</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="reactive-apps.html">Writing resilient reactive applications</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="event-bus-metrics.html">Production considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.7/start-using-sdk.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="java-intro.html">Java SDK</a></li>
    <li class="crumb"><a href="java-intro.html">Java SDK 2.2</a></li>
    <li class="crumb"><a href="querying.html">Querying buckets</a></li>
    <li class="crumb"><a href="querying-n1ql.html">Working with N1QL</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/2.2/modules/ROOT/pages/querying-n1ql.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Working with N1QL</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Java SDK offers advanced support for querying JSON documents using N1QL (aka "SQL for Documents").
N1QL is a superset of SQL.
</blockquote>
</div>
<div class="paragraph">
<p>To learn more about N1QL itself and Query support in Couchbase Server, see <a href="http://query.couchbase.com/" target="_blank" rel="noopener">the Query Documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="statements-the-dsl-vs-ad-hoc-querying"><a class="anchor" href="#statements-the-dsl-vs-ad-hoc-querying"></a>Statements: the DSL vs. ad-hoc querying</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The N1QL domain-specific language (DSL) is a powerful way to guide you in building your statements: you get type safety and autocompletion of relevant methods / N1QL clauses.</p>
</div>
<div class="paragraph">
<p>As of the <code>2.2</code> version of the SDK, the DSL supports the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data selection with <code>Select.select(...)</code> as an entry point (including index hinting)</p>
</li>
<li>
<p>All N1QL functions, organized by topic in the helper classes in the <code>com.couchbase.client.java.query.dsl.functions</code> package (eg.
<code>AggregateFunctions</code>)</p>
</li>
<li>
<p>A <a href="#case">mini DSL for building CASE constructs</a> via factory methods on the <code>Case</code> class</p>
</li>
<li>
<p>A <a href="#collections">mini DSL for building collection constructs</a> (ANY, EVERY, ARRAY...) via factory methods on the  <code>Collections</code> class</p>
</li>
<li>
<p><a href="#index">Index management</a> (index and primary index creation/deletion/deferred building) with <code>Index</code> factory methods as an entry point</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To construct statements, you can use the <code class="api">Expression</code> class that comes in with a variety of factory methods to construct both tokens and literals programmatically.
Expressions can be combined and chained with operators (like <code>gte</code> for "greater than or equal to" comparison...).</p>
</div>
<div class="paragraph">
<p>Use <code class="api">x</code> to construct a token, <code class="api">s</code> to construct a string literal, <code class="api">i</code> to construct a token escaped with backticks (for instance the bucket name <code>beer-sample</code> must be escaped because it contains a dash).</p>
</div>
<div class="paragraph">
<p>Additionally, if you find the DSL doesn&#8217;t support a particular statement, clause or keyword, <strong>you can always revert to providing your statement in plain String form</strong>.
This ensures that even if the DSL somehow lags behind the evolutions of the language, users will always have a mean of using new language features.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying"><a class="anchor" href="#querying"></a>Querying</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All queries are composed at a minimum of a statement and optionally of N1QL additional parameters.
The simplest form of query is just a raw string statement, or a DSL statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// raw string query
N1qlQueryResult queryResult =
   bucket.query(N1qlQuery.simple("SELECT * FROM beer-sample LIMIT 10"));

// using the DSL
N1qlQueryResult query = bucket.query(select("*").from("beer-sample").limit(10));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DSL provides a type-safe and intuitive way to perform queries.
The <code class="api">select()</code> method is a static import that kicks off a  BNF-aware DSL for N1QL.
(BNF stands for Backus-Naur Form.)</p>
</div>
<div class="paragraph">
<p>The query always returns a <code class="api">N1qlQueryResult</code>, which aside from the actual <code class="api">N1qlQueryRow</code>s also contains debug or error information if supplied.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parseSuccess</code>: Returns true if the query could correctly be parsed.
This information is available immediately even if the actual list of results takes more time to be computed and streamed to the client.</p>
</li>
<li>
<p><code>finalSuccess</code>: Returns true if the whole query could be executed successfully, including retrieving all the results and streaming them to the client.</p>
</li>
<li>
<p><code>allRows</code>: Contains all rows returned by the query, can be an empty list.</p>
</li>
<li>
<p><code>rows</code>: Same as <code>allRows</code> but in an iterator form (the <code class="api">N1qlQueryResult</code> itself is iterable).</p>
</li>
<li>
<p><code>requestId</code>: The server-generated unique ID for this query (useful to find associated logs on the N1QL server).</p>
</li>
<li>
<p><code>clientContextId</code>: User-provided identifier reflected in the server&#8217;s response.
This can be useful to group several queries (for example, in a kind of in-house transaction) and find all associated queries.</p>
</li>
<li>
<p><code>info</code>: Returns a <code class="api">N1qlMetrics</code> object containing metrics for the query (like number of results or processing time).</p>
</li>
<li>
<p><code>errors</code>: Returns a list of <code class="api">JsonObject</code> describing errors or warnings (if any occurred during execution).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying-asynchronously"><a class="anchor" href="#querying-asynchronously"></a>Querying Asynchronously</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Querying asynchronously is done through the <code class="api">AsyncBucket</code> interface, obtained by calling <code class="api">bucket.async()</code>.
The API is pretty similar except everything is returned as an <code class="api">Observable</code>.
Some of the components of the query result (an <code class="api">AsyncQueryResult</code>) can also be delayed and so returned as Observables.
Only <code class="api">requestId</code>, <code class="api">clientContextId</code> and <code class="api">parseSuccess</code> return immediately.</p>
</div>
<div class="paragraph">
<p>The following Java 8 code prints the found documents or errors as they come:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.async()
.query(select("*").from("beer-sample").limit(10))
.subscribe(result -&gt; {
	result.errors()
		.subscribe(
			e -&gt; System.err.println("N1QL Error/Warning: " + e),
			runtimeError -&gt; runtimeError.printStackTrace()
		);
	result.rows()
		.map(row -&gt; row.value())
		.subscribe(
			rowContent -&gt; System.out.println(rowContent),
			runtimeError -&gt; runtimeError.printStackTrace()
		)
	}
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, you can see that asynchronous mode is used.
Second line issues a <code class="api">Statement</code> using the DSL.
Then a first subscription is made to trigger the query and obtain the result.</p>
</div>
<div class="paragraph">
<p>On receiving the result (there will be only one), you have to subscribe to its components to be notified respectively of n1ql errors and n1ql results.
Results (as rows) are first mapped into their JSON values.</p>
</div>
<div class="paragraph">
<p>Notice this example also define an <code class="api">onError</code> behavior for both n1ql errors stream and results stream, that just prints the stack trace.</p>
</div>
<div class="paragraph">
<p><em>Note: All this is done asynchronously so it&#8217;s not suitable for a simple test (where the main thread would exit potentially before any result could have been displayed)</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="different-kinds-of-queries"><a class="anchor" href="#different-kinds-of-queries"></a>Different Kinds of Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Queries are represented by the <code class="api">N1qlQuery</code> interface, which also provides factory methods to create all variants of queries.
Each variant can be constructed from a <code class="api">Statement</code>, even in <code>String</code> form, but also additionally can define a <code class="api">N1qlParams</code>.
This represents additional N1QL parameters, like setting a <code>clientContextId</code>.</p>
</div>
<div class="paragraph">
<p>Variants of queries are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>simple</strong>: The basic query used so far in this tutorial.</p>
</li>
<li>
<p><strong>parameterized</strong>: A variant to use with statements containing placeholders (like <code class="api">$1</code> or <code class="api">$placeholder</code>).
The user must provide the values for the placeholders as well, either as a <code class="api">JsonArray</code> (for positional parameters) or <code class="api">JsonObject</code> (for named parameters).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="read-your-own-writes-ryow"><a class="anchor" href="#read-your-own-writes-ryow"></a>Read Your Own Writes (RYOW)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Often you will want to insert or update some data into Couchbase and immediately read this data back using a N1QL query.
This is referred to as read your own write (RYOW).</p>
</div>
<div class="paragraph">
<p>This can be achieved by using the <code>N1qlParams</code>, and more precisely the <code>consistency</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">JsonDocument doc = JsonDocument.create("test", JsonObject.create().put("test", true));
bucket.insert(doc);

Statement select = select("*").from("beer-sample")
	.where(x("test").eq(true));
N1qlParams ryow = N1qlParams.build().consistency(ScanConsistency.REQUEST_PLUS);

bucket.async()
	.query(N1qlQuery.simple(select, ryow))
	.subscribe(result -&gt; {
	result.errors()
		.subscribe(
			e -&gt; System.err.println("N1QL Error/Warning: " + e),
			runtimeError -&gt; runtimeError.printStackTrace()
		);
	result.rows()
		.map(row -&gt; row.value())
		.subscribe(
			rowContent -&gt; System.out.println(rowContent),
			runtimeError -&gt; runtimeError.printStackTrace()
		);
	}
);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adhoc-queries-vs-frequent-queries"><a class="anchor" href="#adhoc-queries-vs-frequent-queries"></a>Adhoc Queries vs Frequent Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you often execute a <code>N1qlQuery</code> it can be interesting to let the SDK and the query engine attempt additional optimizations.</p>
</div>
<div class="paragraph">
<p>By default, a <code>N1qlQuery</code> will be considered "ad hoc" (no additional optimization is done).
By calling <code>.adhoc(false)</code> on your query you can mark it for further optimization by the SDK and the query engine.
It will be prepared on the server and all subsequent invocations of this query will benefit from the prepared execution plan.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Other <code>N1qlQuery</code> instances with the <strong>same statement</strong> (but different placeholder values for example) will also benefit from the optimization, as long as they are marked as <code>adhoc(false)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The SDK will retry to prepare a plan once if the server is unable to execute the cached plan.
It will cache plans for up to 5000 statements locally.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="case"><a class="anchor" href="#case"></a>Conditionals, Case Expressions Mini DSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>com.couchbase.client.java.query.dsl.functions.Case</code> class contains a mini-DSL to deal with Conditional operators in N1QL of the <code>CASE</code> family.</p>
</div>
<div class="paragraph">
<p>The <code>Simple CASE</code> expression is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CASE expression  ( WHEN expression THEN expression)
[ ( WHEN expression THEN expression) ]*
[  ELSE expression ]  END</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Searched CASE</code> expression is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CASE  ( WHEN  condition THEN expression)
[( WHEN  condition THEN expression ) ]*
[ ELSE  expression ] END</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding mini-DSL are <code>Case.caseSimple</code> and <code>Case.caseSearch</code>.
Simple Case will compare the initial expression with each WHEN clause for equality, returning the corresponding THEN expression if a match is found.
Search Case allows to have a different condition for each WHEN clause.
Let&#8217;s see two examples.
First one could be used to map match results to a score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CASE hist.result WHEN "won" THEN 1 ELSE 0 END</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//import static com.couchbase.client.java.query.dsl.Expression.*;
//import static com.couchbase.client.java.query.dsl.functions.Case.*;

caseSimple(x("hist.result"))
	.when(s("won")).then(x(1))
	.elseReturn(x(0))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second example implements more complex scoring rule using a Search Case (first match of the day counts as 5 points if won):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CASE WHEN hist.result = "won" AND hist.matchNumber = 1 THEN 5
WHEN hist.result = "won" THEN 1
WHEN hist.result = "lost" THEN 0
END</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//import static com.couchbase.client.java.query.dsl.Expression.*;
//import static com.couchbase.client.java.query.dsl.functions.Case.*;

caseSearch()
	.when(x("hist.result").eq(s("won")).and(x("hist.matchNumber").eq(1))).then(x(5))
	.when(x("hist.result").eq(s("won"))).then(x(1))
	.when(x("hist.result").eq(s("lost"))).then(x(0))
	.end(); //no ELSE clause means other values will return NULL, have to explicitly close the CASE</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="collections"><a class="anchor" href="#collections"></a>Collection Operators Mini DSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>com.couchbase.client.java.query.dsl.functions.Collections</code> class contains a mini-DSL to deal with Collections operators in N1QL, such as <code>ANY</code>, <code>EVERY</code>, <code>ARRAY</code> and <code>FIRST</code>.</p>
</div>
<div class="paragraph">
<p>For example, the <code>ARRAY</code> construct is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ARRAY expression FOR variable ( IN |  WITHIN ) expression
[ ,  variable ( IN | WITHIN ) expression ]* [ ( WHEN  condition) ] END</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding mini-DSL is <code>Collections.arrayIn</code> (or <code>Collections.arrayWithin</code> if you want to start with a WITHIN clause).
Let&#8217;s see two examples from the following statement, which extracts children and also lists the ones that are teenagers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT tutorial.fname || ' ' || tutorial.lname AS adult,
	ARRAY child FOR child IN tutorial.children END AS children,
	ARRAY child.fname FOR child IN tutorial.children WHEN child.age &gt;= 12 END AS teenagers
FROM tutorial WHERE tutorial.children IS NOT NULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is how to write the second and third lines using the DSL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//import static com.couchbase.client.java.query.dsl.Expression.*;
//import static com.couchbase.client.java.query.dsl.functions.Collections.*;

//ARRAY child FOR child IN tutorial.children END AS children
arrayIn(x("child"), "child", path("tutorial", "children")).end().as("children");

//ARRAY child.fname FOR child IN tutorial.children WHEN child.age &gt;= 12 END AS teenagers
arrayIn(path("child", "fname"), "child", path("tutorial", "children")).when(path("child", "age").gte(12)).as("teenagers"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, <code>ANY</code> allows to test for a condition that applies to at least one member of a nested array (you can also match on <code>EVERY</code> member of the array).
Any is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ANY variable ( IN  | WITHIN ) expression
[  ,  variable ( IN | WITHIN ) expression  ]*
SATISFIES condition  END</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, you would see an entry for a parent that doesn&#8217;t have teenagers (its "teenagers" field would be empty), because the statement didn&#8217;t specify that the children should contain a teenager.
You can fix that with ANY, by rewriting the WHERE clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">#...FROM tutorial
#replace "WHERE tutorial.children IS NOT NULL" with:
WHERE ANY child IN tutorial.children SATISFIES child.age &gt;= 12;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//import static com.couchbase.client.java.query.dsl.Expression.*;
//import static com.couchbase.client.java.query.dsl.functions.Collections.*;

anyIn("child", x("tutorial.children")).satisfies(x("child.age").gte(12))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index"><a class="anchor" href="#index"></a>Managing Indexes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For N1QL to work, you must first ensure that at least a <code>Primary Index</code> has been created.
For that you can use the DSL from the <code>Index</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Index.createPrimaryIndex().on(bucket.name())</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Remember"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All these DSL produce a N1QL <code>Statement</code> that you must then execute using the <code>bucket.query(statement)</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.query(N1qlQuery.simple(
	Index.createPrimaryIndex().on(bucket.name())
));</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The fluent API will guide you with the available options, you just have to declare that you want to <code>createPrimaryIndex()</code> and specify <code>on(...)</code> which Bucket.</p>
</div>
<div class="paragraph">
<p>You can also create secondary indexes on specific fields of the JSON, for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Index.createIndex(name).on(bucket.name(), x("field1"), x("field2")))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, give a name to your index, specify the target bucket AND the field(s) in the JSON to index.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The SDK will escape bucket name and index name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the DSL you can also indicate that you want to declare multiple indexes before building them.
Use the <code>withDefer()</code> option for that.
Once all your indexes have been declared, trigger the build by using the <code>Index.buildIndex</code> DSL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Index.buildIndex().on("default").indexes("secondaryA", "secondaryB");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, if you want to remove indexes you can use the <code>Index.dropIndex(...)</code> or <code>Index.dropPrimaryIndex(...)</code> DSLs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can do a static import of the methods on <code>Index</code> to use them in an even more fluent manner.
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
