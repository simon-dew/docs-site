<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Go SDK tutorial | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4464/go-sdk/1.5/start-using-sdk.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="go-sdk">
    <meta name="dcterms.identifier" content="1.0">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4464">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="introduction.html"><span class="title">Go SDK</span> <span class="version">1.0</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../1.5/start-using-sdk.html">Go SDK 1.5</a></li>
                  <li><a class="navbar-item" href="../1.4/start-using-sdk.html">Go SDK 1.4</a></li>
                  <li><a class="navbar-item" href="../1.3/start-using-sdk.html">Go SDK 1.3</a></li>
                  <li><a class="navbar-item" href="../1.2/start-using-sdk.html">Go SDK 1.2</a></li>
                  <li><a class="navbar-item" href="../1.1/start-using-sdk.html">Go SDK 1.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/tutorial.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/tutorial.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/tutorial.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/tutorial.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/tutorial.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/tutorial.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="introduction.html">Go SDK 1.0</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API Reference</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase example</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="tutorial.html">Go SDK tutorial</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="documents.html">Working with documents</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="storing.html">Creating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="retrieving.html">Retrieving documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="updating.html">Updating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="deleting.html">Deleting documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="bulk-operations.html">Bulk operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="atomic-operations.html">Atomic operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability requirements</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="querying.html">Querying buckets</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-timeouts.html">Handling timeouts</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-errors.html">Handling errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="performance-tuning.html">Performance tuning</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../1.5/start-using-sdk.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="introduction.html">Go SDK</a></li>
    <li class="crumb"><a href="introduction.html">Go SDK 1.0</a></li>
    <li class="crumb"><a href="getting-started.html">Getting Started</a></li>
    <li class="crumb"><a href="tutorial.html">Go SDK tutorial</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-go/edit/release/1.0/modules/ROOT/pages/tutorial.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Go SDK tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Go SDK tutorial introduces some advanced concepts by walking through a complete web application.
</blockquote>
</div>
<div class="paragraph">
<p>The full source code for the tutorial is available <a href="https://github.com/couchbaselabs/try-cb-golang/" target="_blank" rel="noopener">on GitHub</a>.
The primary focus of the tutorial is to explain the function and theory behind the Couchbase Go client and how it connects to Couchbase server.
The tutorial highlights new features in Couchbase version 4.0 such as the N1QL query language.
It makes use of the <code>travel-sample</code> bucket that is provided with Couchbase Server.
The code that generates the web application is provided with the source code but is not discussed in this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites-and-setup"><a class="anchor" href="#prerequisites-and-setup"></a>Prerequisites and setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To go through the tutorial, you&#8217;ll need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your favorite IDE or editor.
The <a href="https://atom.io" target="_blank" rel="noopener">Atom</a> text editor, with the <a href="https://github.com/joefitzgerald/go-plus" target="_blank" rel="noopener">go-plus plugin</a> installed, provides a great Go IDE experience.
This tutorial is IDE agnostic.</p>
</li>
<li>
<p>Go 1.4 or higher.
This tutorial was written and tested using Go 1.5.</p>
</li>
<li>
<p>The sample app source code from GitHub (this tutorial cover only the Go part of the app).
The data model and AngularJS front end are explained in detail in the <a href="http://developer.couchbase.com/documentation/server/4.0/travel-app/travel-app-data-model.html" target="_blank" rel="noopener">travel-sample walkthrough</a>.</p>
</li>
<li>
<p>A local <code>Couchbase Server 4.0</code> installation.
Make sure that the sample bucket named <code>travel-sample</code> is loaded and that there is at least one node with data, query, and index services in the cluster.</p>
<div class="paragraph">
<p>If you already have Couchbase Server installed but did not install the <code>travel-sample</code> bucket, open the Couchbase Web Console and select <span class="menuseq"><b class="menu">Settings</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Sample Buckets</b></span>.
Select the <code>travel-sample</code> check box, and then click <strong class="ui">Create</strong>.
A notification box in the upper-right corner disappears when the bucket is ready to use.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To run the tutorial app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As long as your <code>GOPATH</code> environment variable is set up correctly, you should be able to install from the terminal by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go get github.com/couchbaselabs/try-cb-golang</code></pre>
</div>
</div>
</li>
<li>
<p>If you don&#8217;t want to connect to <code>localhost</code>, you need to change the configuration set up in the connection statement in the <em class="path">try.go</em> file (<code>cluster, _ := gocb.Connect("couchbase://127.0.0.1")</code>.
You can use either an IP address or a host name in the string.</p>
</li>
<li>
<p>Open <em class="path">try.go</em> (located under <em class="path">$GOPATH/src/github.com/couchbaselabs/try-cb-golang</em>)</p>
</li>
<li>
<p>Alternatively, go straight to running the project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run try.go</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-and-bootstrapping-the-sdk"><a class="anchor" href="#configuring-and-bootstrapping-the-sdk"></a>Configuring and bootstrapping the SDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configuring and bootstrapping the SDK involves connecting to the <code>Cluster</code> and getting a reference to a <code>Bucket</code>.
You can find the code discussed in this section in the <em class="path">try.go</em> file on lines 4 and 18 and lines 340–341 in the <code class="api">func main()</code> method.</p>
</div>
<div class="paragraph">
<p>The first step is to let the application connect to your cluster and obtain a reference to a <code>Bucket</code> object.
The bucket is your entry point for the whole storage API.
Both <code>Cluster</code> and <code>Bucket</code> should be reused across your application.
They are instantiated within the <code class="api">main()</code> function so they can be used across the application.</p>
</div>
<div class="paragraph">
<p>Import the Couchbase Go client in the import code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">"github.com/couchbase/gocb"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Declare a pointer to be used for the Couchbase bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">var bucket *gocb.Bucket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Various functions within the application use the <code>bucket</code> variable.
The cluster and bucket references are instantiated in <code>func main()</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For best results always use a bucket by reference.
Declaring the bucket variable as a pointer to the Couchbase bucket allows the bucket connection to be used by reference.
This is extremely important for performance.
Applications that spin up, execute, and tear down connections for each operation within an application are inefficient, resource-intensive, cause garbage collection headaches, and are not performant.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following code snippet connects to the cluster and opens the <code>travel-sample</code> bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">cluster, _ := gocb.Connect("couchbase://127.0.0.1")
bucket, _ = cluster.OpenBucket("travel-sample","")</code></pre>
</div>
</div>
<div class="paragraph">
<p>From within <code>func main()</code> we connect to the cluster, and then open the database (bucket).
This allows us to use sample data from <code>travel-sample</code>.
For using secure credentials reference <code>OpenBucket</code> from within the API <a href="http://godoc.org/github.com/couchbase/gocb" target="_blank" rel="noopener">docs</a>.</p>
</div>
<div class="paragraph">
<p>The application is now ready to use the Couchbase API.
To learn more about configuring the client and connecting to a bucket, see <a href="managing-connections.html" class="page">Managing connections</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-users-by-using-the-key-value-api"><a class="anchor" href="#managing-users-by-using-the-key-value-api"></a>Managing users by using the key-value API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Go SDK provides key-value operations on buckets that the app uses to manage users.
You can find the code discussed in this section in the <em class="path">try.go</em> file in <code class="api">func loginHandler()</code> method on lines 262–295.</p>
</div>
<div class="paragraph">
<p>Couchbase Server is both a document-oriented store and a key-value store.
It can be used purely as a key-value store, such as for caching, but it also offers advanced document oriented capabilities based on JSON documents such as indexing, views, and N1QL querying.
This is noticeable in the API, where the methods reflect key-value operations (such as <code>get</code> and <code>insert</code>) and work with a <code>value</code> interface pointer.
Go&#8217;s built-in JSON support for marshaling and unmarshaling is a natural fit for working with JSON documents stored in Couchbase Server.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Couchbase Go client always returns a pointer to an interface variable for retrieval operations, which greatly simplifies loading results into structs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Creating new users</strong></p>
</div>
<div class="paragraph">
<p>These are the steps for creating new users:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Route the HTTP request and check if it&#8217;s a <code>POST</code> (new user) or <code>GET</code> (existing user) request.</p>
</li>
<li>
<p>Check if a user exists.</p>
</li>
<li>
<p>Create a new user with a JSON web token.</p>
</li>
<li>
<p>Save the new user.</p>
</li>
<li>
<p>Return the JSON web token in a response</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Route the HTTP request</strong></p>
</div>
<div class="paragraph">
<p>Go&#8217;s built in <code>net/http</code> package is extremely simple for routing requests.
In <code>func main()</code> we route the request to the predefined request handler <code>loginHandler</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">http.HandleFunc("/api/user/login",loginHandler)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the <code>func loginHandler()</code>, we can check the request type by looking at the request method.
The request method is interrogated from a pointer to the request itself <code>r.Method</code>.
A <code>"POST"</code> is a new user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">	switch r.Method {
		case "GET":
			// login request for existing user
			q.User = r.URL.Query().Get("user")
			q.Password = r.URL.Query().Get("password")
			if authenticated:=q.LoginUser(); authenticated==true{
				s.Success=q.Token
				bytes,_:=json.Marshal(s)
				w.Write(bytes)
			}else{
				bytes:=[]byte(`{"failure":"Bad Username or Password"}`)
				w.Write(bytes)
			}
		case "POST":
			// login request for a new user
			_ = json.NewDecoder(r.Body).Decode(&amp;q)
			if exists := q.CheckUserExists(); exists == true {
				bytes:=[]byte(`{"failure":"User exists, please choose a different username"}`)
				w.Write(bytes)
			}
			if created := q.CreateUser(); created == true {
				s.Success=q.Token
				bytes,_:=json.Marshal(s)
				w.Write(bytes)
			}
		}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Check if the user exists</strong></p>
</div>
<div class="paragraph">
<p>Now we use the key-value API to determine if the new user we are going to create already exists.
First we define a variable <code>curUser</code> from our <code>User struct</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">type User struct {
	Type string `json:"_type"`
	ID string `json:"_id"`
	Name string `json:"name"`
	Password string `json:"password"`
	Token string `json:"token"`
	Flights []UserFlight `json:"flights"`
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then from our <code>bucket.Get()</code> call we pass in a reference to that variable.
If the user we&#8217;re trying to create exists, the <code>curUser</code> variable is populated.
The function returns <code>true</code> or <code>false</code> depending on if the user was found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">func (u *UserIntermediary) CheckUserExists() bool{
	var curUser User
	if _,err := bucket.Get(u.User,&amp;curUser); err != nil{
		return false
	}
	return true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Create a new user and return a JSON web token</strong></p>
</div>
<div class="paragraph">
<p>In this step we create a new instance of a <code>User</code> and assign the fields based on the information provided.
We also create a new JSON web token based on the credentials.
Because our <code>User</code> struct, shown above, is a native JSON document, storing this struct into Couchbase is simple.
We insert the document into Couchbase using the <code>Username</code> field as the key, and the <code>User</code> struct instance as the value.
After the User is stored, the application responds with the JSON token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">func (u *UserIntermediary) CreateUser() bool{
	token := jwt.New(jwt.SigningMethodHS256)
	token.Claims["user"] = u.User
	if encryptedToken, err := token.SignedString([]byte(hashToken)); err != nil{
		return false
	} else {
		u.Token=encryptedToken
	}

	var newUser User
	newUser.Type = "User"
	newUser.ID = "NOT_CURRENTLY_USED"
	newUser.Name = u.User
	newUser.Password = u.Password
	newUser.Token = u.Token
	if _, err := bucket.Insert(newUser.Name, newUser, 0); err != nil{
			return false
	}
	return true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To learn more about working with documents, see <a href="#">op-basics.adoc</a>, <a href="storing.html" class="page">Creating documents</a>, <a href="retrieving.html" class="page">Retrieving documents</a>, and <a href="updating.html" class="page">Updating documents</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="finding-airports-by-using-n1ql-queries"><a class="anchor" href="#finding-airports-by-using-n1ql-queries"></a>Finding airports by using N1QL queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Go SDK provides several methods for querying documents in Couchbase.
These methods operate on views, geospatial views, and N1QL queries.
You can find the code discussed in this section in the <em class="path">try.go</em> file in the <code class="api">airportHandler()</code> method on lines 151–181.</p>
</div>
<div class="paragraph">
<p>The query types within Go are <code>SpatialQuery</code>, <code>ViewQuery</code>, and <code>N1qlQuery</code>.
For N1QL, the <code>N1qlQuery</code> type is expected.
This allows us to wrap a N1QL statement in <code>N1qlQuery</code>, provide query tuning through a <code>params</code> interface.
The N1qlQuery is then run by the <code>bucket.ExecuteN1qlQuery()</code> method.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
N1QL is a superset of SQL, so if you&#8217;re familiar with SQL, you will feel at ease.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s issue our first <code>SELECT</code> query to find a list of airports that match a specified search string.</p>
</div>
<div class="paragraph">
<p>The <code>func airportHandler()</code> first builds the query string based on the search string provided.
We want to search by different fields like FAA, ICAO and to convert to all capitals if we&#8217;re searching by those particular fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">	var queryPrep string

	switch search := r.URL.Query().Get("search"); len(search) {
	case 3:
		queryPrep = "SELECT airportname FROM `travel-sample` WHERE faa ='" + strings.ToUpper(search) + "'"
	case 4:
		if s:=strings.ToUpper(search); s==search {
			queryPrep = "SELECT airportname FROM `travel-sample` WHERE icao ='" + strings.ToUpper(search) + "'"
		}else{
			queryPrep = "SELECT airportname FROM `travel-sample` WHERE airportname like '" + search + "%'"
		}
	default:
		queryPrep = "SELECT airportname FROM `travel-sample` WHERE airportname like '" + search + "%'"
	}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
N1QL uses the backtick (<code>) character for escape sequences.
Go also uses the backtick for escape sequences in `struct</code> definitions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll want to select just the airport name from relevant documents in our <code>bucket</code>.
After the query string is built, we define it as a query statement and then run using <code>bucket.ExecuteN1qlQuery</code>.
Each N1QL query returns these values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <code>interface{}</code> type</p>
</li>
<li>
<p>an error, if one is returned</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">     myQuery := gocb.NewN1qlQuery(queryPrep)
     rows,err := bucket.ExecuteN1qlQuery(myQuery,nil)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then loop through the results, and return the results in JSON format back in a response.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">    var airports []Airport
	var row Airport
	for rows.Next(&amp;row){
		airports=append(airports,row)
	}
	bytes,_:=json.Marshal(airports)
	w.Write(bytes)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To learn more about writing N1QL queries, see <a href="#">n1ql-queries.adoc</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="finding-routes-by-using-complex-queries"><a class="anchor" href="#finding-routes-by-using-complex-queries"></a>Finding routes by using complex queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This application also demonstrates complex queries that use UNION, JOIN, and UNNEST clauses.
You can find the code discussed in this section in the <em class="path">try.go</em> file in the <code class="api">flightPathHandler()</code> method on lines 184–248.</p>
</div>
<div class="paragraph">
<p>The following query uses a UNION clause to go from human-readable airport names for the departure and arrival airports to FAA codes that allow us to search on available flights by route.
Routes have departure and arrival airport fields defined by FAA codes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT faa AS fromAirport FROM `travel-sample` WHERE airportname = "Los Angeles Intl"
UNION SELECT faa AS toAirport FROM `travel-sample` WHERE airportname = "San Francisco Intl"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query constructs the result set of available flight paths that connect the two airports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment
FROM `travel-sample` AS r
UNNEST r.schedule AS s
JOIN `travel-sample` AS a ON KEYS r.airlineid
WHERE r.sourceairport = "LAX" AND r.destinationairport = "SFO" AND s.day = 6
ORDER BY a.name ASC</code></pre>
</div>
</div>
<div class="paragraph">
<p>N1QL can do joins on a single bucket or several buckets.
It works as long as the foreign key described by an <code>ON KEYS</code> clause can be mapped to a document&#8217;s key in the joined bucket.</p>
</div>
<div class="paragraph">
<p>A powerful feature of N1QL shown in the second statement is the UNNEST clause.
It extracts fields within an embedded JSON document within a result set and puts it at the same root level as the bucket.
Doing so, it makes it possible to do joins on each element in this embedded JSON as if they were entries in a left-hand side bucket.</p>
</div>
<div class="paragraph">
<p>The <code>funcFlightPathHandler()</code> method implements the above functionality including date verification, calculating flight duration, calculating pricing, and returns the response.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">func flightPathHandler(w http.ResponseWriter, r *http.Request) {

      	var queryPrep, queryTo, queryFrom string
      	var fromLon, fromLat, toLon, toLat, dist float64
      	var price, flightTime, weekday int
      	var leave time.Time
      	var row AirportIntermediary
      	var airports []AirportIntermediary
      	var flight Flight
      	var flights []Flight

      	from := r.URL.Query().Get("from")
      	to := r.URL.Query().Get("to")

      	leave,_ = time.Parse(layout,r.URL.Query().Get("leave"))
      	weekday = int(leave.Weekday())+1

      	queryPrep = "SELECT faa as fromAirport,geo FROM `travel-sample` WHERE airportname = '" + from +
      	        "' UNION SELECT faa as toAirport,geo FROM `travel-sample` WHERE airportname = '" + to + "'"

      	myQuery := gocb.NewN1qlQuery(queryPrep)
      	rows,err := bucket.ExecuteN1qlQuery(myQuery,nil)
      	if err!=nil{
      		fmt.Println("ERROR EXECUTING N1QL QUERY:",err)
      	}

      	for rows.Next(&amp;row) {
      		airports = append(airports,row)
      		if row.ToAirport!="" {
      			toLat=row.Geo.Lat
      			toLon=row.Geo.Lon
      			queryTo=row.ToAirport
      		}
      		if row.FromAirport!="" {
      			fromLat=row.Geo.Lat
      			fromLon=row.Geo.Lon
      			queryFrom=row.FromAirport
      		}
      		row = AirportIntermediary{}
      	}
      	dist = Haversine(fromLon,fromLat,toLon,toLat)
      	flightTime = int(dist/averageKilometersHour)
      	price = int(dist * distanceCostMultiplier)

      	_ = rows.Close()

      	queryPrep="SELECT r.id, a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment " +
                  "FROM `travel-sample` r UNNEST r.schedule s JOIN `travel-sample` a ON KEYS r.airlineid WHERE r.sourceairport='" +
      						queryFrom + "' AND r.destinationairport='" + queryTo + "' AND s.day=" + strconv.Itoa(weekday) + " ORDER BY a.name"

      	myQuery = gocb.NewN1qlQuery(queryPrep)
      	rows,err = bucket.ExecuteN1qlQuery(myQuery,nil)
      	if err!=nil{
      		fmt.Println("ERROR EXECUTING N1QL QUERY:",err)
      	}

      	for i:=0; rows.Next(&amp;flight);i++ {
      		flight.Flighttime=flightTime
      		flight.Price=price
      		flights=append(flights,flight)
      	}
      	_ = rows.Close()
      	bytes,_:=json.Marshal(flights)
      	w.Write(bytes)
      }</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
