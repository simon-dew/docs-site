<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Managing beers | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4464/nodejs-sdk/2.6/start-using-sdk.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="nodejs-sdk">
    <meta name="dcterms.identifier" content="2.1">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4464">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="introduction.html"><span class="title">Node.js SDK</span> <span class="version">2.1</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.6/start-using-sdk.html">Node.js SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/start-using-sdk.html">Node.js SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/start-using-sdk.html">Node.js SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">Node.js SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.2/start-using-sdk.html">Node.js SDK 2.2</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/manage-beers.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/manage-beers.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/manage-beers.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/manage-beers.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/manage-beers.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/manage-beers.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="introduction.html">Node.js SDK 2.0/2.1</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API Reference</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase Example</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="2">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="tutorial-intro.html">Tutorial</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="quick-start.html">Quick start</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="prep.html">Setting up the project</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="wecome.html">Creating a welcome page</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="manage-beers.html">Managing beers</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="tutorial-wrap.html">Where to go from here</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing server connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="documents.html">Working with documents</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="op-basics.html">Operation basics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="storing.html">Creating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="retrieving.html">Retrieving documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="updating.html">Updating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="deleting.html">Deleting documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="bulk-operations.html">Bulk operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="atomic-operations.html">Atomic operations</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="querying.html">Querying buckets</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="view-queries.html">Working with view queries</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-queries.html">Working with N1QL queries</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-clusters.html">Managing clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-timeouts.html">Handling timeouts</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-errors.html">Handling errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="performance-tuning.html">Performance tuning</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.6/start-using-sdk.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="introduction.html">Node.js SDK</a></li>
    <li class="crumb"><a href="introduction.html">Node.js SDK 2.0/2.1</a></li>
    <li class="crumb"><a href="getting-started.html">Getting Started</a></li>
    <li class="crumb"><a href="tutorial-intro.html">Tutorial</a></li>
    <li class="crumb"><a href="manage-beers.html">Managing beers</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-nodejs/edit/release/2.1/modules/ROOT/pages/manage-beers.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Managing beers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
This topic describes the code that interacts with Couchbase Server to display lists of beers and breweries and edit beer documents.
</blockquote>
</div>
<div class="paragraph">
<p>All of the basic CRUD operations are demonstrated in this code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="showing-beers"><a class="anchor" href="#showing-beers"></a>Showing beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The beer listing page displays each beer along with a link to the brewery that produces it.
However, the <code>beer/by_name</code> view returns only the name of the beer.
To obtain the brewery, you need to fetch each beer document and examine it.
The document contains the brewery that you need later.</p>
</div>
<div class="paragraph">
<p>After the list of all beers is retrieved, it creates a list of document IDs to fetch by using the <a href="http://underscorejs.org" target="_blank" rel="noopener">Underscore</a> library’s <code>pluck()</code> function and then passes the list to the <code>getMulti()</code> method.
Although it is simpler to perform an individual get on each beer’s ID, that method is less efficient in terms of network usage.</p>
</div>
<div class="paragraph">
<p>Now that you have the beer documents, you can iterate through the list of retrieved values and assign the key (which is the object key) to a property of the beer object itself to allow usage of it in the template.</p>
</div>
<div class="paragraph">
<p>Now let’s put this all together:</p>
</div>
<div class="listingblock">
<div class="title">beer_app.js (showing beer listings)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function list_beers(req, res) {
  var q = ViewQuery.from('beer', 'by_name')
      .limit(ENTRIES_PER_PAGE)
      .stale(ViewQuery.Update.BEFORE);

  db.query(q, function(err, values) {
    // 'by_name' view's map function emits beer-name as key and value as
    // null. So values will be a list of
    //      [ {id: &lt;beer-id&gt;, key: &lt;beer-name&gt;, value: &lt;null&gt;}, ... ]

    // we will fetch all the beer documents based on its id.
    var keys = _.pluck(values, 'id');

    db.getMulti( keys, function(err, results) {

      // Add the id to the document before sending to template
      var beers = _.map(results, function(v, k) {
        v.value.id = k;
        return v.value;
      });

      res.render('beer/index', {'beers':beers});
    })
  });
}
app.get('/beers', list_beers);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code also tells Express to route requests for <code>/beers</code> to this function, and then directs Express to render the <em class="path">beer/index.jade</em> template.
Here is the <em class="path">beer/index.jade</em> template:</p>
</div>
<div class="listingblock">
<div class="title">views/beer/index.jade</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jade hljs" data-lang="jade">extends ../layout
  block content

    h3 Browse Beers
    form(class="navbar-search pull-left")
      input#beer-search(class="search-query" type="text" placeholder="Search for Beers")

    table#beer-table(class="table table-striped")
      thead
        tr
          th Name
          th Brewery
          th
      tbody
        for beer in beers
          tr
            td: a(href="/beers/show/#{beer.id}") #{beer.name}
            td: a(href="/breweries/show/#{beer.brewery_id}") To Brewery
            td
              a(class="btn btn-small btn-warning" href="/beers/edit/#{beer.id}") Edit
              a(class="btn btn-small btn-danger" href="/beers/delete/#{beer.id}") Delete

    div
      a(class="btn btn-small btn-success" href="/beers/create") Add Beer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to <em class="path">http://localhost:1337/beers</em> to see a listing of beers.
Each beer has <strong class="ui">To Brewery</strong>, <strong class="ui">Edit</strong>, and <strong class="ui">Delete</strong> buttons.</p>
</div>
<div class="paragraph">
<p>On the bottom of the page, you can also see an <b class="button">Add Beer</b> button, which allows you to define new beers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deleting-beers"><a class="anchor" href="#deleting-beers"></a>Deleting Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Due to the simplicity of Couchbase and Express, you can implement a single method to delete both beers and breweries:</p>
</div>
<div class="listingblock">
<div class="title">beer_app.js (showing beer listings):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function delete_object( req, res ) {
  db.remove( req.params.object_id, function(err, meta) {
    if( err ) {
      console.log( 'Unable to delete document `' + req.params.object_id + '`' );
    }

    res.redirect('/welcome');
  });
}
app.get('/beers/delete/:object_id', delete_object);
app.get('/breweries/delete/:object_id', delete_object);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code tells Express to route the two deletion URLs to the same method.
It attempts to delete the object in the Couchbase cluster that is passed through the URL and then redirects the user to the welcome page.
If this delete fails, it also logs an error to the console.</p>
</div>
<div class="paragraph">
<p>If you find that a beer is still displayed after you click the delete button, you can wait a moment and refresh the browser page to verify that the beer has been deleted.
Deleted objects might not immediately get removed from the view because they might need to wait for a view index update.</p>
</div>
<div class="paragraph">
<p>Another way to verify that a beer has been deleted is by clicking the delete button again and getting a 404 error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="displaying-beers"><a class="anchor" href="#displaying-beers"></a>Displaying beers</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">beer_app.js (showing a single beer):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function show_beer(req, res) {
  db.get( req.params.beer_id, function(err, result) {
    var doc = result.value;
    if( doc === undefined ) {
      res.send(404);
    } else {
      doc.id = req.params.beer_id;

      var view = {
        'beer': doc,
        'beerfields': _.map(doc, function(v,k){return {'key':k,'value':v};})
      };
      res.render('beer/show', view);
    }
  });
}
app.get('/beers/show/:beer_id', show_beer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the delete example, the code first checks whether the document actually exists within the cluster.
The beer ID is passed through the URL, this is passed to use as beer_id, as seen in the Express route.</p>
</div>
<div class="paragraph">
<p>To retrieve the information for this particular beer, just call the connection&#8217;s <code>get()</code> method with the <code>beer_id</code> received through the route.
First check to ensure a document was received, and if not return an HTTP 404 error.</p>
</div>
<div class="paragraph">
<p>If the beer exists, build a view object to pass to the template that contains the beer object and a mapped list of all fields and values that are inside of the beer object.
Pass this data to the <em class="path">views/beer/show.jade</em> template:</p>
</div>
<div class="listingblock">
<div class="title">views/beer/show.jade:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jade hljs" data-lang="jade">extends ../layout
block content

  h3 Show Details for Beer #{beer.name}
  table(class="table table-striped")
    tbody
      tr
        td: strong #{beer.brewery_id}
        td: a(href="/breweries/show/#{beer.brewery_id}") #{beer.brewery_id}
      for beerfield in beerfields
        tr
          td: strong #{beerfield.key}
          td #{beerfield.value}

  a(class="btn btn-medium btn-warning" href="/beers/edit/#{beer.id}") Edit
  a(class="btn btn-medium btn-danger" href="/beers/delete/#{beer.id}") Delete</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code extracts the <code>brewery_id</code> and creates a special entry with a link pointing to the page to display the actual brewery.
Next it iterates over the rest of the fields, printing out the key and value of each one.
Finally, it provides links at the bottom to edit and delete the beer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="editing-beers"><a class="anchor" href="#editing-beers"></a>Editing beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following code shows how to edit beer documents:</p>
</div>
<div class="listingblock">
<div class="title">beer_app.js (beer editing):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function normalize_beer_fields(data) {
  var doc = {};
  _.each(data, function(value, key) {
    if(key.substr(0,4) == 'beer') {
      doc[key.substr(5)] = value;
    }
  });

  if (!doc['name']) {
    throw new Error('Must have name');
  }
  if (!doc['brewery_id']) {
    throw new Error('Must have brewery ID');
  }

  return doc;
}

function begin_edit_beer(req, res) {
  db.get(req.params.beer_id, function(err, result) {
    var doc = result.value;
    if( doc === undefined ) { // Trying to edit non-existing doc ?
      res.send(404);
    } else { // render form.
      doc.id = req.params.beer_id;
      var view = { is_create: false, beer: doc };
      res.render('beer/edit', view);
    }
  });
}
function done_edit_beer(req, res) {
  var doc = normalize_beer_fields(req.body);

  db.get( rc.doc.brewery_id, function(err, result) {
    if (result.value === undefined) { // Trying to edit non-existing doc ?
      res.send(404);
    } else {    // Set and redirect.
      db.set( req.params.beer_id, doc, function(err, doc, meta) {
        res.redirect('/beers/show/'+req.params.beer_id);
      })
    }
  });
}
app.get('/beers/edit/:beer_id', begin_edit_beer);
app.post('/beers/edit/:beer_id', done_edit_beer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code defines two handlers for editing.
The first handler is the <code>GET</code> method for /beers/edit/:beer_id, which displays a nice HTML form that you can use to edit the beer.
It passes the following parameters to the template: the beer object and a Boolean that indicates this is not a new beer (because the same template is also used for the create beer form).</p>
</div>
<div class="paragraph">
<p>The second handler is the <code>POST</code> method, which validates the input.
The <code>POST</code> handler calls the <code>normalize_beer_fields()</code> function, which converts the form fields into properly formed names for the beer document, checks to see that the beer has a valid name, and checks to see that a <code>brewery_id</code> is specified and that it indeed exists.
If all the checks pass, the function returns the formatted document.
If an exception is thrown, Express catches the error and renders it to the user.
Otherwise, the document is sent to Couchbase by using the <code>set()</code> method and the user is redirected to the newly created beer’s show page.</p>
</div>
<div class="paragraph">
<p>The following template for the editing page is rather wordy because it enumerates all the possible fields with a nice description.</p>
</div>
<div class="listingblock">
<div class="title">views/beer/edit.jade:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jade hljs" data-lang="jade">extends ../layout
block content

  if is_create
    h3 Create Beer
  else
    h3 Editing #{beer.name}

  form(method="post" action="")
    fieldset
      legend General Info
      .span12
        .span6
          label Type
          input(type="text" name="beer_type" placeholder="Type of the document" value="#{beer.type}")
          label Name
          input(type="text" name="beer_name" placeholder="The name of the beer" value="#{beer.name}")
          label Description
          input(type="text" name="beer_description" placeholder="A short description" value="#{beer.description}")
        .span6
          label Style
          input(type="text" name="beer_style" placeholder="Bitter? Sweet? Hoppy?" value="#{beer.style}")
          label Category
          input(type="text" name="beer_category" placeholder="Ale? Stout? Lager?" value="#{beer.category}")
    fieldset
      legend Details
      .span12
        .span6
          label Alcohol (ABV)
          input(type="text" name="beer_abv" placeholder="The beer's ABV" value="#{beer.abv}")
          label Biterness (IBU)
          input(type="text" name="beer_ibu" placeholder="The beer's IBU" value="#{beer.ibu}")
        .span6
          label Beer Color (SRM)
          input(type="text" name="beer_srm" placeholder="The beer's SRM" value="#{beer.srm}")
          label Universal Product Code (UPC)
          input(type="text" name="beer_upc" placeholder="The beer's UPC" value="#{beer.upc}")
    fieldset
      legend Brewery
      .span12
        .span6
          label Brewery
            input(type="text" name="beer_brewery_id" placeholder="The brewery" value="#{beer.brewery_id}")

    .form-actions
      button(type="submit" class="btn btn-primary") Save changes</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template first checks the i<code>s_create</code> variable.
If it’s false, that means the user is editing an existing beer, and the caption is filled with that name.
Otherwise, it’s titled as Create Beer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-beers"><a class="anchor" href="#creating-beers"></a>Creating beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code for creating beers is very similar to the code for editing beers:</p>
</div>
<div class="listingblock">
<div class="title">beer_app.js (create beer):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function begin_create_beer(req, res) {
  var view = { is_create : true, beer:{
    type: '',
    name: '',
    description: '',
    style: '',
    category: '',
    abv: '',
    ibu: '',
    srm: '',
    upc: '',
    brewery_id: ''
  } };
  res.render('beer/edit', view);
}
function done_create_beer(req, res) {
  var doc = normalize_beer_fields(req.body);
  var beer_id = doc.brewery_id + '-' +
                doc.name.replace(' ', '-').toLowerCase();
  db.add( beer_id, doc, function(err, result) {
    if (err) throw err;
    res.redirect('/beers/show/'+beer_id);
  });
}
app.get('/beers/create', begin_create_beer);
app.post('/beers/create', done_create_beer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>begin_create_beer()</code> function displays the same form as the one used for editing beers, except in this case the <code>is_create</code> parameter is set to true and an empty beer object is passed in.
The empty beer object is necessary because the template still tries to populate the form fields with existing values.</p>
</div>
<div class="paragraph">
<p>The <code>POST</code> handler calls the <code>normalize_beer_fields()</code> function.
Next it uses the <code>add()</code> method to create a new beer in Couchbase Server.
This raise causes the callback to be invoked with an error if the beer already exists.
If there is an error, it is caught and displayed to the user.
If everything went well, the user is redirected to the beer display page for the newly created beer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="searching-beers"><a class="anchor" href="#searching-beers"></a>Searching beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the beer listing page, you might have noticed a search box at the top.
You can use it to dynamically filter the table based on user input.
The code uses JavaScript at the client layer to perform the querying and filtering and views with range queries at the server (Node.js/Express) layer to return the results.</p>
</div>
<div class="paragraph">
<p>Before you implement the server-side search method, put the following in the <em class="path">static/js/beersample.js</em> file (if it’s not there already) to listen on search box changes and update the table with the resulting JSON (which is returned from the search method):</p>
</div>
<div class="listingblock">
<div class="title">static/js/beersample.js (snippet):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">$(document).ready(function() {

    /**
     * AJAX Beer Search Filter
     */
    $("#beer-search").keyup(function() {
       var content = $("#beer-search").val();
       if(content.length &gt;= 0) {
           $.getJSON("/beers/search", {"value": content}, function(data) {
               $("#beer-table tbody tr").remove();
               for(var i=0;i&lt;data.length;i++) {
                   var html = "&lt;tr&gt;";
                   html += "&lt;td&gt;&lt;a href=\"/beers/show/"+data[i].id+"\"&gt;"+data[i].name+"&lt;/a&gt;&lt;/td&gt;";
                   html += "&lt;td&gt;&lt;a href=\"/breweries/show/"+data[i].brewery+"\"&gt;To Brewery&lt;/a&gt;&lt;/td&gt;";
                   html += "&lt;td&gt;";
                   html += "&lt;a class=\"btn btn-small btn-warning\" href=\"/beers/edit/"+data[i].id+"\"&gt;Edit&lt;/a&gt;\n";
                   html += "&lt;a class=\"btn btn-small btn-danger\" href=\"/beers/delete/"+data[i].id+"\"&gt;Delete&lt;/a&gt;";
                   html += "&lt;/td&gt;";
                   html += "&lt;/tr&gt;";
                   $("#beer-table tbody").append(html);
               }
           });
       }
    });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code waits for key-up events on the search field, and if they happen, it issues an AJAX query on the search function within the app.
The search handler computes the result (using views) and returns it as JSON.
The JavaScript then clears the table, iterates over the results, and creates new rows.</p>
</div>
<div class="paragraph">
<p>The search handler looks like this:</p>
</div>
<div class="listingblock">
<div class="title">beer_app.js (ajax search response):</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function search_beer(req, res) {
  var value = req.query.value;
  var q = ViewQuery.from('beer', 'by_name')
      .range(value, value + JSON.parse('"\u0FFF"'))
      .stale(ViewQuery.Update.BEFORE)
      .limit(ENTRIES_PER_PAGE);
  db.query(q, function(err, values) {
    var keys = _.pluck(values, 'id');
    db.getMulti( keys, function(err, results) {
      var beers = [];
      for(var k in results) {
        beers.push({
          'id': k,
          'name': results[k].value.name,
          'brewery_id': results[k].value.brewery_id
        });
      }

      res.send(beers);
    });
  });
};
app.get('/beers/search', search_beer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>search_beer()</code> function first extracts the user input by examining the query string from the request.
It then builds an options object that is passed to the view query API.
The code passes the user&#8217;s input for the <code>startkey</code> and for the <code>endkey</code> passes the user&#8217;s input appended with a Unicode \u0FFF value, which for the view engine means "end here." You need to get used to it a bit, but it’s actually very neat and efficient.</p>
</div>
<div class="paragraph">
<p>It uses the <code>getMulti()</code> method to retrieve the complete data for each beer.
However, unlike previous uses of the method, rather than rendering a template using the retrieved data, the object is sent directly to Express, which serializes it to JSON.</p>
</div>
<div class="paragraph">
<p>Now your search box should work nicely.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
