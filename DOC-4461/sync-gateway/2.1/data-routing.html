<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Data Routing | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4461/sync-gateway/2.5/data-routing.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="sync-gateway">
    <meta name="dcterms.identifier" content="2.1">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4461">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="index.html"><span class="title">Sync Gateway</span> <span class="version">2.1</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.5/data-routing.html">Sync Gateway 2.5</a></li>
                  <li><a class="navbar-item" href="../2.0/data-routing.html">Sync Gateway 2.0</a></li>
                  <li><a class="navbar-item" href="../1.5/data-routing.html">Sync Gateway 1.5</a></li>
                  <li><a class="navbar-item" href="../1.4/data-routing.html">Sync Gateway 1.4</a></li>
                  <li><a class="navbar-item" href="../1.3/data-routing.html">Sync Gateway 1.3</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Introduction</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="index.html">What&#8217;s New</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Access Control</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="authentication.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="authorizing-users.html">Authorizing Users</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="data-routing.html">Data Routing</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sync-function-api.html">Sync Function API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Operations</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="config-properties.html">Configuration File</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="command-line-options.html">CLI</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="shared-bucket-access.html">Mobile-Web Data Sync</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-tombstones.html">Managing Tombstones</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="server-integration.html">Webhooks and Changes Feed</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="resolving-conflicts.html">Resolving Conflicts</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="integrating-external-stores.html">Integrating External Stores</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="running-replications.html">Running Replications</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api-client.html">REST API Client</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sgcollect-info.html">SGCollect Info</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="upgrade.html">Upgrade</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="security.html">Security</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="load-balancer.html">NGINX</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="database-offline.html">Taking Databases Offline and Online</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="os-level-tuning.html">OS Level Tuning</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">API References</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api.html">Public REST API</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="admin-rest-api.html">Admin REST API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Release Notes &amp; Compatibility</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-matrix.html">Compatibility Matrix</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.5/data-routing.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Sync Gateway</a></li>
    <li class="crumb">Access Control</li>
    <li class="crumb"><a href="data-routing.html">Data Routing</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbaselabs/docs-sync-gateway/edit/release/2.1/modules/ROOT/pages/data-routing.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Data Routing</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Sync Gateway uses channels to make it easy to share a database between a large number of users and control access to the database.
Channels are the intermediaries between documents and users.
Every document in the database belongs to a set of channels, and every user is allowed to access a set of channels.
You use channels to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partition the data set.</p>
</li>
<li>
<p>Authorize users to access documents.</p>
</li>
<li>
<p>Minimize the amount of data synced down to devices.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction-to-channels"><a class="anchor" href="#introduction-to-channels"></a>Introduction to Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Sync Gateway, a <strong>channel</strong> is like a combination of a tag and a message-queue.
Channels have relationships to both documents and users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every document is associated with a set of channels.
From the document&#8217;s perspectives, the channels are like tags that can be used to identify its type, purpose, accessibility, etc.
The app-defined sync function is responsible for assigning every incoming document revision a set of channels as it&#8217;s saved to the database.</p>
</li>
<li>
<p>Every user and role has a set of channels that they&#8217;re allowed to read.
A user can only read documents that are in at least one of the user&#8217;s channels (or the channels of roles that user has.)
User/role channel access can be assigned directly through the admin API, or via the sync function when a document is updated.</p>
</li>
<li>
<p>A Couchbase Lite "pull" replication can optionally specify what channels it wants to receive documents from.
(If it doesn&#8217;t, it gets all channels the user has access to.)
Client apps can use this ability to intelligently sync with a subset of the available documents from the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s not much to a channel besides its name.
Channels come into existence as documents are assigned to them.
Channels with no documents assigned to them are empty.</p>
</div>
<div class="paragraph">
<p>Valid channel names consist of text letters <code>[A–Z, a–z]</code>, digits <code>[0–9]</code>, and a few special characters <code>[= + / . , _ @]</code>.
Channel names are case-sensitive.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-channels"><a class="anchor" href="#creating-channels"></a>Creating Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you&#8217;ve learned what a channel is as a concept, let&#8217;s put it to practice and see how a channel definition is applied and how it affects the system.</p>
</div>
<div class="paragraph">
<p>You assign documents to <code>channels</code> either by adding a channels property to the document or by using a sync function.
No matter which option you choose, the channel assignment is implicit&#8212;&#8203;the content of the document determines what channels it belongs to.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Using the channels property</strong>.
Adding a <code>channels</code> property to each document is the easiest way to map documents to channels.
The <code>channels</code> property is an array of strings that contains the names of the channels to which the document belongs.
If you do not include a <code>channels</code> property in a document, the document does not appear in any channels.</p>
</li>
<li>
<p><strong>Using a sync function</strong>.
Creating a <a href="sync-function-api.html" class="page">sync function</a> is a more flexible way to map documents to channels.
A sync function is a JavaScript function that takes a document body as input and, based on the document content, decides what channels to assign the document to.
The sync function cannot reference any external state and must return the same results every time it&#8217;s called on the same input.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="channel-count"><a class="anchor" href="#channel-count"></a>Channel Count</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every time a document is assigned to a new channel, the channel name is appended to that document&#8217;s sync metadata.</p>
</div>
<div class="paragraph">
<p>Therefore, a document&#8217;s set of channels is bound by the allowed sync metadata size described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enable_shared_bucket_access: false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enable_shared_bucket_access: true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="2"><div><div class="paragraph">
<p><strong>Sync metadata size limit</strong></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20 MB per document</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 MB per document</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sync Gateway will assign a document to a new channel as long as the sync metadata remains under the allowed limit.</p>
</div>
<div class="paragraph">
<p><strong>What to do when your channel count exceeds the usable space for sync metadata?</strong></p>
</div>
<div class="paragraph">
<p>In order to lower the sync metadata size per document, you can do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lower the number of channels per document.</p>
</li>
<li>
<p>Shorten the channel names.
A shorter channel name will occupy less space ("customer==0030169303" vs "cs==0030169303").</p>
</li>
<li>
<p>Lower the <a href="config-properties.html#databases-foo_db-revs_limit" class="page">revs_limit</a> value.
Indeed, a copy of channel metadata is retained for each revision of a document.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="replicating-channels-to-couchbase-lite"><a class="anchor" href="#replicating-channels-to-couchbase-lite"></a>Replicating channels to Couchbase Lite</h3>
<div class="paragraph">
<p>If Couchbase Lite doesn&#8217;t specify any channels to replicate, it gets all the channels to which its user account has access.
Due to this behavior, most apps do not have to specify a channels filter&#8212;&#8203;instead they can just do the default sync configuration on the specify the Sync Gateway database URL with no filter in order to replicate the channels of interest.</p>
</div>
<div class="paragraph">
<p>To replicate channels to Couchbase Lite, you configure the replication to use a filter named <code>sync_gateway/bychannel</code> with a filter parameter named <code>channels</code>.
The value of the <code>channels</code> parameter is a comma-separated list of channels to fetch.
The replication from Sync Gateway now pulls only documents tagged with those channels.</p>
</div>
</div>
<div class="sect2">
<h3 id="removing-a-replicated-document"><a class="anchor" href="#removing-a-replicated-document"></a>Removing a replicated document</h3>
<div class="paragraph">
<p>A document can be removed from a channel without being deleted.
For example, this can happen when a new revision is not added to one or more channels that the previous revision was in.</p>
</div>
<div class="paragraph">
<p>Subscribers (downstream databases pulling from this database) automatically handle the change.
Sync Gateway&#8217;s <code>_changes</code> feed includes one more revision of a document after it stops matching a channel.
Couchbase Lite creates a special tombstone revision, adding <code>_removed:true</code> property to the entry when this happens.</p>
</div>
<div class="paragraph">
<p>This algorithm ensures that any views running in Couchbase Lite do not include an obsolete revision.
The app code should use views to filter the results rather than just assuming that all documents in its local database are relevant.</p>
</div>
<div class="paragraph">
<p>If a user&#8217;s access to a channel is revoked or Couchbase Lite stops syncing with a channel, documents that have already been synced are not removed from the user&#8217;s device.</p>
</div>
</div>
<div class="sect2">
<h3 id="authorizing-user-access"><a class="anchor" href="#authorizing-user-access"></a>Authorizing user access</h3>
<div class="paragraph">
<p>The <code>all_channels</code> property of a user account determines which channels the user can access.
Its value is derived from the union of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user&#8217;s <code>admin_channels</code> property, which is settable via the admin REST API.</p>
</li>
<li>
<p>The channels that user has been given access to by <code>access()</code> calls from sync functions invoked for current revisions of documents (see <a href="#programmatic-authorization">Programmatic Authorization</a>.</p>
</li>
<li>
<p>The <code>all_channels</code> properties of all roles the user belongs to, which are themselves computed according to the above two rules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only documents a user can access are those whose current revisions are assigned to one or more channels the user has access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A GET request to a document not assigned to one or more of the user&#8217;s available channels fails with a 403 error.</p>
</li>
<li>
<p>The <code>_all_docs</code> property is filtered to return only documents that are visible to the user.</p>
</li>
<li>
<p>The <code>_changes</code> property ignores requests (via the <code>channels</code> parameter) for channels not visible to the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Write protection&#8212;&#8203;access control of document PUT or DELETE requests&#8212;&#8203;is done by document validation.
This is handled in the sync function rather than a separate validation function.</p>
</div>
<div class="paragraph">
<p>After a user is granted access to a new channel, the changes feed incorporates all existing documents in that channel, even those from earlier sequences than the current request&#8217;s <code>since</code> parameter.
That way the next pull request retrieves all documents to which the user now has access.</p>
</div>
<div class="sect3">
<h4 id="programmatic-authorization"><a class="anchor" href="#programmatic-authorization"></a>Programmatic Authorization</h4>
<div class="paragraph">
<p>Documents can grant users access to channels.
This is done by writing a sync function that recognizes such documents and calls a special <code>access()</code> function to grant access.</p>
</div>
<div class="paragraph">
<p>The <code>access()</code> function takes the following parameters: a user name or array of user names and a channel name or array of channel names.
For convenience, null values are ignored (treated as empty arrays).</p>
</div>
<div class="paragraph">
<p>A typical example is a document that represents a shared resource (like a chat room or photo gallery).
The document has a <code>members</code> property that lists the users who can access the resource.
If the documents belonging to the resource are all tagged with a specific channel, then the following sync function can be used to detect the membership property and assign access to the users listed in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function(doc) {
    if (doc.type == "chatroom") {
        access (doc.members, doc.channel_id)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, a chat room is represented by a document with a <code>type</code> property set to <code>chatroom</code>.
The <code>channel_id</code> property names the associated channel (with which the actual chat messages are tagged) and the <code>members</code> property lists the users who have access.</p>
</div>
<div class="paragraph">
<p>The <code>access()</code> function can also operate on roles.
If a user name string begins with <code>role:</code> then the remainder of the string is interpreted as a role name.
There&#8217;s no ambiguity here, because ":" is an illegal character in a user or role name.</p>
</div>
<div class="paragraph">
<p>Because anonymous requests are authenticated as the user "GUEST", you can make a channel and its documents public by calling <code>access</code> with a username of <code>GUEST</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="authorizing-document-updates"><a class="anchor" href="#authorizing-document-updates"></a>Authorizing Document Updates</h4>
<div class="paragraph">
<p>Sync functions can also authorize document updates.
A sync function can reject the document by throwing an exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">throw ({forbidden: "error message"})</code></pre>
</div>
</div>
<div class="paragraph">
<p>A 403 Forbidden status and the given error string is returned to the client.</p>
</div>
<div class="paragraph">
<p>To validate a document you often need to know which user is changing it, and sometimes you need to compare the old and new revisions.
To get access to the old revision, declare the sync function like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function(doc, oldDoc) { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>oldDoc</code> is the old revision of the document (or empty if this is a new document).</p>
</div>
<div class="paragraph">
<p>You can validate user privileges by using the helper functions: <code>requireUser</code>, <code>requireRole</code>, or <code>requireAccess</code>.
Here&#8217;s some examples of how you can use the helper functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// throw an error if username is not "snej"
requireUser("snej")
// throw if username is not in the list
requireUser(["snej", "jchris", "tleyden"])
// throw an error unless the user has the "admin" role
requireRole("admin")
// throw an error unless the user has one of those roles
requireRole(["admin", "old-timer"])
// throw an error unless the user has access to read the "events" channel
requireAccess("events")
// throw an error unless the can read one of these channels
requireAccess(["events", "messages"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a simple sync function that validates whether the user is modifying a document in the old document&#8217;s <code>owner</code> list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
    if (oldDoc) {
        requireUser(oldDoc.owner); // may throw({forbidden: "wrong user"})
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="special-channels"><a class="anchor" href="#special-channels"></a>Special channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a two special channels that are automatically created when Sync Gateway starts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>public channel</strong>, written as <code>!</code> in the sync function.
Documents added to this channel are visible to any user (i.e all users are automatically granted access to the <code>!</code> channel).
This channel can be used as a public distribution channel.</p>
</li>
<li>
<p>The <strong>star</strong> channel, written as <code>*</code> in the sync function.
All documents are added to this channel.
So any user that is granted access to the <code>*</code> channel can access all the documents in the database.
A user can be given access to the <strong>star</strong> channel through the sync function or in the <a href="config-properties.html#databases-foo_db-users-foo_user" class="page">configuration file</a>.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Note 1:</strong> Sync Gateway automatically assigns documents to the all docs channel.
Explicitly assigning a document to it in the Sync Function (i.e <code>channel('*')</code>) will result in unexpected behavior such as receiving the document twice on the client side.</p>
</li>
<li>
<p><strong>Note 2:</strong> The <strong>star</strong> channel doesn&#8217;t mean that the user is granted access to all channels.
It is only being granted access to 1 channel which contains <strong>all documents</strong>.
This distinction is important when using the <a href="sync-function-api.html#requireaccess-channels" class="page"><code>requireAccess()</code></a> Sync Function method.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following Sync Function maps the document to the public channel if it contains an <code>isPublic</code> property set to true and grants users with the 'admin' role access to the all docs channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
    if (doc.isPublic) {
        channel('!');
    }
    if (doc.type == 'user') {
        requireRole('admin');
        access(doc.username, '*');
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting-channels"><a class="anchor" href="#troubleshooting-channels"></a>Troubleshooting channels</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="inspecting-document-channels"><a class="anchor" href="#inspecting-document-channels"></a>Inspecting document channels</h3>
<div class="paragraph">
<p>You can use the admin REST API to see the channels that documents are assigned to.
Issue an <code>_all_docs</code> request, and add the query parameter <code>?channels=true</code> to the URL.
Here&#8217;s a command-line example that uses the <a href="https://github.com/jakubroztocil/httpie">HTTPie</a> tool (like a souped-up curl) to look at the channels of the document <code>foo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ http POST 'http://localhost:4985/db/_all_docs?channels=true' keys:='["foo"]'

HTTP/1.1 200 OK
Content-Encoding: gzip
Content-Length: 150
Content-Type: application/json
Date: Wed, 07 May 2014 21:52:17 GMT
Server: Couchbase Sync Gateway/1.00
{
    "rows": [
        {
            "id": "foo",
            "key": "foo",
            "value": {
                "channels": [
                    "short",
                    "word"
                ],
                "rev": "1-86effb929acbf953905dd0e3974f6051"
            }
        }
    ],
    "total_rows": 16,
    "update_seq": 26
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that the document is in the channels <code>short</code> and <code>word</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="inspecting-user-role-channels"><a class="anchor" href="#inspecting-user-role-channels"></a>Inspecting user/role channels</h3>
<div class="paragraph">
<p>You can use the admin REST API to see what channels a user or role has access to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">$ curl http://localhost:4985/db/_user/pupshaw

{
    "admin_channels": [
        "all"
    ],
    "admin_roles": [
        "froods"
    ],
    "all_channels": [
        "all",
        "hoopy"
    ],
    "name": "pupshaw",
    "roles": [
        "froods"
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that the user <code>pupshaw</code> has access to channels <code>all</code> and <code>hoopy</code>.</p>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
