<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>C Sample App Backend Tutorial | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4465/c-sdk/2.10/sample-app-backend.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="c-sdk">
    <meta name="dcterms.identifier" content="2.9">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4465">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="start-using-sdk.html"><span class="title">C SDK</span> <span class="version">2.9</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.10/sample-app-backend.html">C SDK 2.10</a></li>
                  <li><a class="navbar-item" href="../2.8/sample-app-backend.html">C SDK 2.8</a></li>
                  <li><a class="navbar-item" href="../2.7/sample-app-backend.html">C SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/start-using-sdk.html">C SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/c-intro.html">C SDK 2.5</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/sample-app-backend.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/sample-app-backend.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/sample-app-backend.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/sample-app-backend.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/sample-app-backend.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/sample-app-backend.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Hello World!</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="start-using-sdk.html">Start Using the SDK</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sample-application.html">Sample Application</a>
    </span>
<ul class="nav-list">
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sample-app-backend.html">Sample App Backend</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="webui-cli-access.html">Browser and CLI Access</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Users and Security</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-authentication-overview.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-user-management-overview.html">User Management</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-user-management-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="encryption.html">Field Level Encryption</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="encrypting-using-sdk.html">Field Level Encryption from the C SDK</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with Data</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="core-operations.html">Core Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="document-operations.html">Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="subdocument-operations.html">Sub-Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="datastructures.html">Data Structures</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-query.html">Querying with N1QL</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="n1ql-queries-with-sdk.html">N1QL from the SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="scan-consistency-examples.html">Using Scan Consistency</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-search-overview.html">Full Text Search</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-searching-with-sdk.html">Searching from the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="view-queries-with-sdk.html">MapReduce Views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="async-programming.html">Asynchronous Programming</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="batching-operations.html">Batching Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="concurrent-mutations-cluster.html">Concurrent Document Mutations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-xattr-overview.html">Extended Attributes</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-xattr-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="nonjson.html">Non-JSON Documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compression-intro.html">Compression</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment Environments</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing Connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-clusters.html">Managing Clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Settings, Error Handling &amp; Diagnostics</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="client-settings.html">Client Settings</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-error-conditions.html">Handling Errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="failure-considerations.html">Failure Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="collecting-information-and-logging.html">Collecting Information</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="threshold-logging.html">Threshold Logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="tracing-from-the-sdk.html">Tracing from the SDK</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Project Docs</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="relnotes-c-sdk.html#2-9-5-september-21-2018">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-licenses.html">Licenses</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="get-involved.html">Get involved</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/home/contribute/index.html">Improve the Docs</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.10/sample-app-backend.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="start-using-sdk.html">C SDK</a></li>
    <li class="crumb">Hello World!</li>
    <li class="crumb"><a href="sample-application.html">Sample Application</a></li>
    <li class="crumb"><a href="sample-app-backend.html">Sample App Backend</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-c/edit/release/2.9/modules/ROOT/pages/sample-app-backend.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">C Sample App Backend Tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This page will walk you through how some of the queries may be constructed using the C SDK.
The sample app uses the C API with a C++ JSON library (<a href="https://github.com/open-source-parsers/jsoncpp" target="_blank" rel="noopener">json-cpp</a>), though you are free to use your own.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This tutorial focuses on querying through N1QL and FTS rather than views.
If you want information about using views, see <a href="#">6.0@server:understanding-couchbase:views/views-intro.adoc</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="walking-through-the-api"><a class="anchor" href="#walking-through-the-api"></a>Walking Through the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections lead you through the primary functions of the sample application.</p>
</div>
<div class="paragraph">
<p>This shows you how to use the various features and services of Couchbase including: <strong>connecting</strong> to a cluster and bucket, <strong>key/value</strong> iteraction, document <strong>query through N1QL</strong> and <strong>full text searches</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-and-bootstrap-the-sdk"><a class="anchor" href="#configure-and-bootstrap-the-sdk"></a>Configure and Bootstrap the SDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="managing-connections.html" class="page">Managing Connections Using the C (libcouchbase) SDK with Couchbase Server</a></p>
</div>
<div class="paragraph">
<p>The first step is to let the application connect to your cluster and obtain a reference to a <code>lcb_t</code> (the Bucket is the entry point for the whole storage API).</p>
</div>
<div class="paragraph">
<p><strong>Connecting to a Bucket</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lcb_t instance;
lcb_create_st options;
memset(&amp;options, 0, sizeof options);
options.version = 3;
options.v.v3.connstr = "couchbase://localhost/travel-sample";
/* Username and password for Couchbase 5.0+ */
options.v.v3.username = "mark";
options.v.v3.passwd = "secret";
lcb_create(&amp;instance, &amp;options);
lcb_connect(instance);
lcb_wait(instance);
if (lcb_get_bootstrap_status(instance) != LCB_SUCCESS) {
    printf("Error while bootstrapping: %s\n", lcb_strerror(NULL, lcb_get_bootstrap_status(instance)));
    // .. handle error further..
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You could make the bootstrap process safer by providing a list of hostnames/IPs to bootstrap from (in case the one node you provided for bootstrap is unavailable when creating the Cluster reference).
In production the best practice is to provide at least 3 nodes in the boostrap list.
You can separate the list of hostnames in the connection string using a comma, e.g.
<code>couchbase://host1,host2,host3</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code class="api">lcb_create</code> function creates the raw library handle.
The <code class="api">lcb_connect</code> function starts the connection attempt.
The <code class="api">lcb_wait</code> function must be called to actually wait for the connection to complete.
Finally, the status of the initial bootstrapping connection can be obtained using <code class="api">lcb_get_bootstrap_status</code>.
If successful, it will return <code>LCB_SUCCESS</code>; otherwise a textual description of the error can be obtained using the <code class="api">lcb_strerror</code> function.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="manage-users-using-key-value-api"><a class="anchor" href="#manage-users-using-key-value-api"></a>Manage Users using Key/Value API</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="document-operations.html" class="page">CRUD Document Operations using the C (libcouchbase) SDK with Couchbase Server</a>, <a href="async-programming.html" class="page">Asynchronous Progamming Using the C (libcouchbase) SDK with Couchbase Server</a></p>
</div>
<div class="paragraph">
<p>Couchbase Server is a document-oriented database which provides access to your data both through its document ID (for high performance access), as well as through views, N1QL (as powerful query languages) and FTS.</p>
</div>
<div class="paragraph">
<p><strong>Creating New Users</strong></p>
</div>
<div class="paragraph">
<p>Next, prepare the content for the new user (as a JSON object) and the associated document (in order to give it an ID):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Json::Value doc(Json::objectValue);
std::string username = get_user();
doc["type"] = "user";
doc["name"] = username;
// make_pass_hash() is just a stub.
doc["password"] = make_pass_hash(password);

std::string docbuf(Json::FastWriter().write(doc));
std::string docid(std::string("user::") + username);

lcb_CMDSTORE scmd = { 0 };
LCB_CMD_SET_KEY(&amp;scmd, docid.c_str(), docid.size());
LCB_CMD_SET_VALUE(&amp;scmd, docbuf.c_str(), docbuf.size());
// Ensure you've set a callback using lcb_install_callback3(instance, LCB_CALLBACK_STORE, your_callback);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>"user::"</code> prefix is arbitrary to this application, this is just a convention that the app uses to obtain unique keys and have additional information in it, but the key could have been anything (even sequence numbers or UUIDs).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now it is time to use the Couchbase Server key/value API to store the document.
Note that you need to install a callback to check the result of the storage operation (using <code class="api">lcb_install_callback3</code>), in case it failed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lcb_store3(instance, NULL, &amp;scmd);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When it comes to storing a document, you have three choices of operation, which you can set using the <code class="api">lcb_CMDSTORE::operation</code> field</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LCB_ADD</code> will only work if no document currently exists for the given ID, otherwise a <code>LCB_KEY_EEXISTS</code> will be received in the callback.</p>
</li>
<li>
<p><code>LCB_REPLACE</code> on the contrary will only work if the document does already exist (otherwise a <code>LCB_KEY_ENOENT</code> will be received in the callback).</p>
</li>
<li>
<p><code>LCB_SET</code> will always work, replacing or creating the document as needed.
This is the default operation.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Checking Login by Getting the User&#8217;s Document</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">std::string docid(std::string("user::") + username);
lcb_CMDGET cmd = { 0 };
LCB_CMD_SET_KEY(&amp;cmd, docid.c_str(), docid.size());
lcb_get3(instance, NULL, &amp;cmd);
lcb_wait(instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the action takes place in the callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">static void get_callback(lcb_t, int, const lcb_RESPGET* resp) {
    if (resp-&gt;rc == LCB_KEY_ENOENT) {
        // User doesn't exist. Handle this!
    } else if (resp-&gt;rc != LCB_SUCCESS) {
        // Other error!?
    }

    Json::Value value;
    const char *encoded = reinterpret_cast&lt;const char *&gt;(resp-&gt;value);
    // Decode JSON
    if (!Json::Reader().parse(encoded, encoded + resp-&gt;nvalue, value)) {
        // Parse error!
    }

    std::string input_pass = get_input_pass(resp-&gt;cookie);
    if (make_pass_hash(input_pass) != value["password"]) {
        // Password doesn't match!
    }
    // More handling here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a-first-n1ql-query-finding-airports"><a class="anchor" href="#a-first-n1ql-query-finding-airports"></a>A First N1QL Query: Finding Airports</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the SDK, there is a <code class="api">lcb_n1ql_query</code> function that can issue N1QL queries against Couchbase.
The function accepts an <code class="api">lcb_CMDN1QL</code> structure which contains the encoded query.
You can use the <code class="api">lcb_N1QLPARAMS</code> structure and its associated functions to help you construct the encoded query.
If you&#8217;re using C++ (as the sample application is), it might be simpler to simply encode the query per the specification.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
N1QL is a super-set of SQL, so if you&#8217;re familiar with SQL you&#8217;ll feel at ease.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Only the airport names are required for this part of the application, therefore just the airport name from relevant documents in the bucket should be selected.
As the application needs to filter relevant document on a criteria that depends on the input length, the SELECT and FROM clauses are performed first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">std::string stmt("SELECT airportname FROM ");
stmt.append("`").append("travel-sample").append("`"); // Backticks, because '-' in the bucket name must be escaped
stmt.append(" WHERE ");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the correct fields can be chosen to look into, depending on the length of the input.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">std::string query_arg;
if (params.size() == 3) {
    stmt.append("faa = $1");
    query_arg = params;
} else if (params.size() == 4) {
    stmt.append("icao = $1");
    query_arg = params;
} else {
    stmt.append("airportname LIKE $1");
    query_arg = "%" + params + "%";
}

// Now encode everything
Json::Value query(Json::objectValue);
query["statement"] = stmt;
query["args"].append(query_arg);

std::string encoded(Json::FastWriter().write(query));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the statement is actually executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lcb_CMDN1QL cmd = { 0 };
cmd.query = query.c_str();
cmd.nquery = query.size();
cmd.callback = query_callback; // We'll show this function soon
if (lcb_n1ql_query(instance, NULL, &amp;cmd) != LCB_SUCCESS) {
    // Handle error
}
lcb_wait(instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>query_callback</code> then handles the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">static void query_callback(lcb_t, int, const lcb_RESPN1QL *resp) {
    if (resp-&gt;rc != LCB_SUCCESS) {
        // Problem! Handle this
    }
    if (resp-&gt;rflags &amp; LCB_RESP_F_FINAL) {
        // Last response in sequence. All rows have already been received
    }

    // Normal response:
    Json::Value json;
    // Decode the row as JSON
    Json::Reader().parse(resp-&gt;row, resp-&gt;row + resp-&gt;nrow, json);

    std::cout &lt;&lt; json["airportname"] &lt;&lt; std::endl;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query callback is invoked once for each result row received.
It is invoked one last time with the <code class="api">LCB_RESP_F_FINAL</code> flag set (in the response&#8217;s <code>rflags</code> field) as a terminator to indicate that no more rows remain.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="more-complex-queries-finding-routes"><a class="anchor" href="#more-complex-queries-finding-routes"></a>More Complex Queries: Finding Routes</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="n1ql-queries-with-sdk.html" class="page">N1QL Queries using the C (libcouchbase) SDK with Couchbase Server</a>.</p>
</div>
<div class="paragraph">
<p>In this service, there are two more complex queries.
The first aims at transforming the human-readable airport name for the departure and arrival airports to FAA codes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT faa AS fromAirport FROM `travel-sample` WHERE airportname = "Los Angeles Intl"
UNION SELECT faa AS toAirport FROM `travel-sample` WHERE airportname = "San Francisco Intl"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second aims at constructing the result set of available flight paths that connect the two airports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment
FROM `travel-sample` AS r
UNNEST r.schedule AS s
JOIN `travel-sample` AS a ON KEYS r.airlineid
WHERE r.sourceairport = "LAX" AND r.destinationairport = "SFO" AND s.day = 6
ORDER BY a.name ASC</code></pre>
</div>
</div>
<div class="paragraph">
<p>A specificity of N1QL that can be seen in the second statement is <code>UNNEST</code>.
It extracts a sub-JSON object and puts it at the same root level as the bucket, so its possible to do joins on each element in this sub-JSON as if they were entries in a left-hand side bucket.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing-the-data-n1ql-gsi"><a class="anchor" href="#indexing-the-data-n1ql-gsi"></a>Indexing the Data: N1QL &amp; GSI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Index management is a bit more advanced (and is already done when loading the sample), so now that you&#8217;ve learned the bsaics of N1QL, you can have a look at it.
For N1QL to work, you must first ensure that at least a <code>Primary Index</code> has been created.
For that you can issue the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE PRIMARY INDEX ON `travel-sample`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the above example on how to execute this query from the SDK.
You&#8217;ll still need a callback, though there will be no result rows (but the final callback will be invoked always).</p>
</div>
<div class="paragraph">
<p>You can also create secondary indexes on specific fields of the document, for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE INDEX `def_username` ON `travel-sample`(username)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, give a name to your index (<code>def_username</code>), specify the target bucket (<code>travel-sample</code>) AND the field(s) in the JSON to index (<code>username</code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="full-text-search-finding-hotels"><a class="anchor" href="#full-text-search-finding-hotels"></a>Full Text Search: Finding Hotels</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="full-text-searching-with-sdk.html" class="page">Full Text Search (FTS) using the C (libcouchbase) SDK with Couchbase Server</a>, <a href="subdocument-operations.html" class="page">Sub-Document Operations</a>.</p>
</div>
<div class="paragraph">
<p>In this service, hotels are searched for using more fuzzy criterias, like the content of the address or the description of a hotel.
This is done using Full Text Search (FTS).
When some results match the specified criteria, only the relevant data for each result to be displayed in the UI is fetched using the subdocument API.</p>
</div>
<div class="paragraph">
<p>To find a hotel based on its location and its description, first a JSON query body is created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Json::Value query(Json::objectValue);
query["query"]["conjuncts"] = Json::Value(Json::arrayValue);
Json::Value typeQuery(Json::objectValue);
typeQuery["term"] = "hotel";
typeQuery["field"] = "type";
query["query"]["conjuncts"].append(typeQuery)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A conjunction query allows you to combine multiple FTS queries into one, in an AND fashion.
This query always includes an exact match criteria that restricts it to the <code>hotel</code> data type (as reflected in the <code>type</code> field of the JSON document).</p>
</div>
<div class="paragraph">
<p>If the user provided a location keyword, a second component is added to the FTS query that will look for that keyword in several address-related fields of the document.
This is done in an OR fashion, using <code>disjuncts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">if (!location.empty() &amp;&amp; location != "*") {
    Json::Value locationQuery(Json::objectValue);
    Json::Value disjuncts(Json::objectValue);
    disjuncts["disjuncts"] = Json::Value(Json::arrayValue);
    Json::Value matchPhrase(Json::objectValue);

    matchPhrase["match_phrase"] = location
    std::array&lt;const char*, 4&gt; fields({"country", "city", "state", "address"});
    for (const auto ptr : fields) {
        matchPhrase["field"] = ptr;
        disjuncts.append(matchPhrase);
    }
    query["query"]["conjuncts"].append(disjuncts);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">if (!description.empty() &amp;&amp; description != "*") {
    Json::Value disjuncts(Json::objectValue);
    std::array&lt;const char *, 2&gt; fields({"description", "name"});
    for (const auto field : fields) {
        Json::Value matchPhrase(Json::objectValue);
        matchPhrase["field"] = field;
        matchPhrase["match_phrase"] = description;
    }
    query["query"]["conjuncts"].append(disjuncts);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before the query is executed, you can limit the number of results to be returned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">query["size"] = 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compound FTS query is now ready to be executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lcb_CMDFTS cmd = { 0 };
std::string buf(Json::FastWriter().write(query));
cmd.query = buf.c_str();
cmd.nquery = buf.size();
cmd.callback = search_callback; // Defined later
lcb_fts_query(instance, NULL, &amp;cmd);
lcb_wait(instance);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step of working with hotels is done inside the callback.
The callback is very similar to the N1QL callback.</p>
</div>
<div class="paragraph">
<p>The FTS are iterated over in the callback, and the document corresponding to each result is fetched.
In actuality, only the parts of the document that will be displayed in the UI are required.
This is where the sub-document API comes in.</p>
</div>
<div class="paragraph">
<p>The sub-document API allows you to fetch or mutate only a set of paths inside a JSON document, without having to send the whole document back and forth.
This can save network bandwidth if the document is large and the parts that we&#8217;re interested in are small.
The callback iterates over each result of the FTS search then triggers a subdoc call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">static void search_callback(lcb_t instance, int, const lcb_RESPFTS* resp) {
    if (resp-&gt;rc != LCB_SUCCESS) {
        // ...
    }
    if (resp-&gt;rflags &amp; LCB_RESP_F_FINAL) {
        // ...
    }

    Json::Value row;
    Json::Reader().parse(resp-&gt;row, resp-&gt;row + resp-&gt;nrow, row);
    std::string docid(row["id"]);
    // Fetch the various subdoc fields:
    std::vector&lt;lcb_SDSPEC&gt; specs;
    std::array&lt;const char *, 6&gt; fields({"country", "city", "state", "address", "name", "description"});
    for (auto field : fields) {
        lcb_SDSPEC spec = { 0 };
        spec.sdcmd = LCB_SDCMD_GET;
        LCB_SDSPEC_SET_PATH(&amp;spec, field, strlen(field));
        specs.push_back(spec);
    }
    lcb_CMDSUBDOC cmd = { 0 };
    LCB_CMD_SET_KEY(&amp;cmd, docid.c_str(), docid.size());
    cmd.specs = &amp;specs[0];
    cmd.nspecs = specs.size();
    lcb_subdoc3(instance, NULL, &amp;cmd);
    // Note, the above requires that the subdoc callback has been installed.
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">static void subdoc_callback(lcb_t, int, const lcb_RESPSUBDOC *resp) {
    if (resp-&gt;rc != LCB_SUCCESS) {
        // Couldn't get hotel description!
    }
    // Fields are retrieved in order; so the first field is 'country',
    // the second is 'city', and so on:
    lcb_SDENTRY ent;
    size_t iter = 0;
    lcb_sdresult_next(resp, &amp;ent, &amp;iter);
    printf("Country is: %.*s\n", ent.value, ent.nvalue);
    // and so on..
}</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
