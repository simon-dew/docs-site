<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Java Sample App Backend Tutorial | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4465/java-sdk/2.7/sample-app-backend.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="java-sdk">
    <meta name="dcterms.identifier" content="2.5">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4465">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="start-using-sdk.html"><span class="title">Java SDK</span> <span class="version">2.5</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.7/sample-app-backend.html">Java SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/sample-app-backend.html">Java SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.4/sample-app-backend.html">Java SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">Java SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.2/java-intro.html">Java SDK 2.2</a></li>
                  <li><a class="navbar-item" href="../2.1/java-intro.html">Java SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/sample-app-backend.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/sample-app-backend.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/sample-app-backend.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/sample-app-backend.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/sample-app-backend.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/sample-app-backend.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Hello World!</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="start-using-sdk.html">Start Using the SDK</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sample-application.html">Sample Application</a>
    </span>
<ul class="nav-list">
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sample-app-backend.html">Sample App Backend</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="webui-cli-access.html">Browser and CLI Access</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Users and Security</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-authentication-overview.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-user-management-overview.html">User Management</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-user-management-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with Data</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="core-operations.html">Core Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="document-operations.html">Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="subdocument-operations.html">Sub-Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="datastructures.html">Data Structures</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-query.html">Querying with N1QL</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="n1ql-queries-with-sdk.html">N1QL from the SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="scan-consistency-examples.html">Using Scan Consistency</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-search-overview.html">Full Text Search</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-searching-with-sdk.html">Searching from the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="view-queries-with-sdk.html">MapReduce Views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="async-programming.html">Asynchronous Programming</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="batching-operations.html">Batching Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="concurrent-mutations-cluster.html">Concurrent Document Mutations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-xattr-overview.html">Extended Attributes</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-xattr-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="nonjson.html">Non-JSON Documents</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment Environments</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing Connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-clusters.html">Managing Clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Settings, Error Handling &amp; Diagnostics</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="client-settings.html">Client Settings</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-error-conditions.html">Handling Errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="failure-considerations.html">Failure Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="collecting-information-and-logging.html">Collecting Information</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Project Docs</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="relnotes-java-sdk.html#version-2-5-9-7-june-2018">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-licenses.html">Licenses</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="get-involved.html">Get involved</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/home/contribute/index.html">Improve the Docs</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.7/sample-app-backend.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="start-using-sdk.html">Java SDK</a></li>
    <li class="crumb">Hello World!</li>
    <li class="crumb"><a href="sample-application.html">Sample Application</a></li>
    <li class="crumb"><a href="sample-app-backend.html">Sample App Backend</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/2.5/modules/ROOT/pages/sample-app-backend.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Java Sample App Backend Tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Java SDK tutorial bridges the gap between simple and advanced concepts by walking through a complete web application.
</blockquote>
</div>
<div class="paragraph">
<p>The full source code for the tutorial is available <a href="https://github.com/couchbaselabs/try-cb-java/tree/5.0-updates" target="_blank" rel="noopener">on GitHub couchbaselabs/try-cb-Java</a>.
The primary focus of the tutorial is to explain the function and theory behind the Couchbase Java client and how it works together with Couchbase Server, and especially new features in versions 4.0/4.5 like <code>N1QL</code>, <code>FTS</code> and <code>sub-document</code>.
It makes use of the <code>travel-sample</code> data set.
The code that generates the web application is provided with the source code, but is not discussed in this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="specific-java-prerequisites-and-set-up"><a class="anchor" href="#specific-java-prerequisites-and-set-up"></a>Specific Java prerequisites and set up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the prerequisites mentioned in the <a href="sample-application.html" class="page">Sample Application</a>, you&#8217;ll also need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your favourite IDE with a JDK 1.6+ installed (this tutorial assumes IntelliJ with JDK 1.8)</p>
</li>
<li>
<p>Maven 3</p>
</li>
<li>
<p>That&#8217;s it!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To get set up for the tutorial, follow these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>git clone https://github.com/couchbaselabs/try-cb-java.git</code> or <a href="https://github.com/couchbaselabs/try-cb-java/releases/tag/v2.0.0" target="_blank" rel="noopener">download the source</a></p>
</li>
<li>
<p>if your Couchbase Server is not running on <code>localhost</code> you can update the configuration&#8217;s hostname in <code>src/main/resources/application.properties</code></p>
</li>
<li>
<p>open the project in your IDE, import as needed and let it build</p>
</li>
<li>
<p>alternatively, go straight to running the project by executing the following command in a terminal from inside the project&#8217;s root directory: <code>mvn spring-boot:run</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to code it yourself, the real work is done in the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/config/Database.java" target="_blank" rel="noopener"><code>src/main/java/trycb/config/Database.java</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/Airport.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/Airport.java</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/FlightPath.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/FlightPath.java</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/User.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/User.java</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/Hotel.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/Hotel.java</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s currently no "fill-in-the-blanks" branch so you&#8217;ll have to delete method bodies and try to take it from there.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This tutorial focuses on querying through N1QL and FTS rather than mapreduce views.
If you want information about using views, see the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>General Information about views: <a href="../../server/5.1/architecture/incremental-map-reduce-views.html" class="page">Incremental MapReduce Views</a></p>
</li>
<li>
<p>Querying views: <a href="#">5.1@server:indexes:querying-using-map-reduce-views.adoc</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="walking-through-the-api"><a class="anchor" href="#walking-through-the-api"></a>Walking Through the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections lead you through the primary functions of the sample application.
This shows you how to use the various features and services of Couchbase including: <strong>connecting</strong> to a cluster and bucket, <strong>key/value</strong> interactions, document <strong>query through N1QL</strong> and <strong>full text searches</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-and-bootstrap-the-sdk"><a class="anchor" href="#configure-and-bootstrap-the-sdk"></a>Configure and Bootstrap the SDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/config/Database.java" target="_blank" rel="noopener"><code>src/main/java/trycb/config/Database.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Connecting to a <code>Cluster</code>, getting a reference to a <code>Bucket</code> and learning to reuse it.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="managing-connections.html" class="page">Managing Connections using the Java SDK with Couchbase Server</a></p>
</div>
<div class="paragraph">
<p>The first step is to let the application connect to your cluster and obtain a reference to a <code>Bucket</code> (this is your entry point for the whole storage API).
Spring Boot automatically configures a <code>Cluster</code> using the <code>@autowired</code> keyword by looking for the following properties in <code>src/main/resources/application.properties</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring.couchbase.bootstrap-hosts</p>
</li>
<li>
<p>spring.couchbase.bootstrap.bucket.name</p>
</li>
<li>
<p>spring.couchbase.bootstrap.bucket.password</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that both <code>Cluster</code> and <code>Bucket</code> are thread safe and <strong>must</strong> be reused across your application (if you don&#8217;t, you&#8217;ll see a warning in the logs).
Spring already knows the <code>Cluster</code> is a singleton because it&#8217;s <code>@autowired</code> and the <code>Bucket</code> can be set up with the <code>@Bean</code> keyword so that it will also be managed as a singleton in the application.</p>
</div>
<div class="paragraph">
<p><strong>Connecting to the Cluster</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public @Bean Cluster cluster() {
    return CouchbaseCluster.create(hostname);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>cluster()</code> method creates the bean for the cluster reference.
Here the application uses one of the simpler factory methods, with just a hostname.
Without a <code>hostname</code>, the default is to connect to <code>localhost</code>.
Note that you can tune the SDK through a <code>CouchbaseEnvironment</code> instance; you can pass this in as an additional first argument.
This is particularly recommended if you need to connect to multiple clusters in the same application.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You could make the bootstrap process safer by providing a list of hostnames/IPs to bootstrap from (in case the one node you provided for bootstrap is unfortunately down when creating the <code>Cluster</code> reference).
It is recommended for production deployments that at least 3 hostnames/IPs are used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Getting a Bucket</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public @Bean Bucket bucket() {
    return cluster().openBucket(bucket, password);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step is to connect to the Couchbase bucket you&#8217;ll be using.
Here the application uses sample data from <code>travel-sample</code> (and the <code>application.properties</code> configuration reflects that).
To obtain the corresponding <code>Bucket</code> from the <code>Cluster</code> and register it as a <code>@Bean</code> in <code>bucket()</code> method, simply open it using the configured <code>bucket</code> name and <code>password</code>.</p>
</div>
<div class="paragraph">
<p>Both the bucket and cluster can be managed through the SDK as well (e.g.
add views or create new buckets), see <a href="managing-clusters.html" class="page">Managing clusters using the Java SDK with Couchbase Server</a> for more information.</p>
</div>
<div class="paragraph">
<p>With these steps, the application is ready to use the API.
In the next step, the Key/Value (KV) storage part of the API will be covered.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="manage-users-using-key-value-api"><a class="anchor" href="#manage-users-using-key-value-api"></a>Manage Users using Key/Value API</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/User.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/User.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use <code class="code">Bucket</code>'s Key/Value operations and discover the <code>Document</code> API.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="document-operations.html" class="page">CRUD Document Operations Using the Java SDK with Couchbase Server</a>, <a href="async-programming.html" class="page">Asynchronous Progamming Using the Java SDK with Couchbase Server</a></p>
</div>
<div class="paragraph">
<p>Couchbase Server is a document oriented database which provides access to your data both through a document ID (for high performance access), as well as through views and N1QL (as powerful query languages).</p>
</div>
<div class="paragraph">
<p>This is noticeable in the API, where the methods reflect Key/Value operations (<code>get</code>, <code>create</code>, etc) and work with a <code>Document</code> interface that has an <code>id()</code> and a content.
The default Document implementation, <code>JsonDocument</code>, accepts a simple representation of JSON as a content using <code>JsonObject</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you already have mechanisms in place to deal with marshalling/unmarshalling of your domain objects to/from JSON, you can skip the extra step of converting them to <code>JsonObject</code> and use a <code>RawJsonDocument</code> instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Creating New Users</strong></p>
</div>
<div class="paragraph">
<p>Since this is a <code>@Service</code>, the <code>createLogin</code> method will be used by the REST API and return a <code>Result</code> object.
This is a standardized wrapper for results returned by this application, that the frontend can interpret.
This particular result will contain a <code>Map&lt;String, Object&gt;</code> with some more information about the user just created.
Spring injects the Bucket reference for us, along with the request parameters <code>username</code> and <code>password</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * Create a user.
 */
public Result&lt;Map&lt;String, Object&gt;&gt; createLogin(final Bucket bucket, final String username, final String password,   int expiry) {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next the application will prepare the content for the new user (as a JsonObject) and the associated document (in order to give it an ID) and it will also set the document expiry, if one was provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String passHash = BCrypt.hashpw(password, BCrypt.gensalt());
JsonObject data = JsonObject.create()
    .put("type", "user")
    .put("name", username)
    .put("password", passHash);
JsonDocument doc;
if (expiry &gt; 0) {
    doc = JsonDocument.create("user::" + username, expiry, data);
} else {
    doc = JsonDocument.create("user::" + username, data);
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>"user::"</code> prefix is arbitrary to this application, this is just a convention that the app uses to obtain unique keys and have additional information in it, but the key could have been anything else (even sequence numbers or UUIDs).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here comes the part where the application use the Couchbase Server API to store the document, it&#8217;s rather simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.insert(doc);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually, the application should send a response with the content and a success flag to the HTTP client.
It should also indicate failure if the SDK throws an exception, so it wraps that in a try-catch block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try {
    bucket.insert(doc);
    return Result.of(
            JsonObject.create().put("token", jwtService.buildToken(username)).toMap(),
            narration);
} catch (Exception e) {
    throw new AuthenticationServiceException("There was an error creating account");
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When it comes to storing a document, you have broadly three choices of method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>insert()</code> will only work if no document currently exists for the given ID, otherwise a <code>DocumentAlreadyExistsException</code> will be thrown.</p>
</li>
<li>
<p><code>replace()</code> will only work if the document does already exist, otherwise a <code>DocumentDoesNotExistException</code> is thrown.</p>
</li>
<li>
<p><code>upsert()</code> will always work, replacing or creating the document as needed.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So the result in fact just contains a JWT (Json WebToken) to identify the new user.
If there is a problem, an <code>AuthenticationServiceException</code> will be thrown and correctly translated by the controller layer.
But what is this <code>narration</code> object in the Result?</p>
</div>
<div class="paragraph">
<p>The frontend understands this second part of the Result, the narration, as something that it can display in a console, so that users of the application can get an idea of what is going on, on the server side while browsing the app.
It is similar to a log, but sent to the frontend.</p>
</div>
<div class="paragraph">
<p><strong>Checking Login by Getting the User&#8217;s Document</strong></p>
</div>
<div class="paragraph">
<p>In the <code>login</code> method, the application checks a User&#8217;s credential and for that it needs to retrieve the corresponding document.
Since user documents are identified by prefixing their username with <code>user::</code>, this is pretty simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">JsonDocument doc = bucket.get("user::" + username);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If that particular key doesn&#8217;t exist, the <code>get</code> method returns <code>null</code>.
That&#8217;s useful to check if the user exists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (doc == null) {
    throw new AuthenticationCredentialsNotFoundException("Bad Username or Password");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise it&#8217;s just a matter of checking the hashed password with the one provided by the user, and responding accordingly.
Notice how the application gets the hash by calling <code>content().getString("password")</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//...continued
} else if(BCrypt.checkpw(password, doc.content().getString("password"))) {
    return JsonObject.create()
        .put("token", jwtService.buildToken(username))
        .toMap();
} else {
    throw new AuthenticationCredentialsNotFoundException("Bad Username or Password");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>A Quick Glance at the Async API with RxJava</strong></p>
</div>
<div class="paragraph">
<p>The 2.x Java SDK relies on <a href="http://reactivex.io/" target="_blank" rel="noopener">RxJava</a> for its asynchronous API.
It offers a powerful way of composing asynchronous streams for your processing.
The <code>getFlightsForUser()</code> method can serve as a quick example of such an asynchronous call, it will return the result of a chain started with the async SDK call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.async().get("user::" + username)</code></pre>
</div>
</div>
<div class="paragraph">
<p>RxJava&#8217;s <code>Observable</code> is a push model where you describe your stream (by composing and chaining rx operators) then subscribe to it (to consume the end data).
You can also manage what to do with error notifications in the subscription.</p>
</div>
<div class="paragraph">
<p>The <code>async()</code> method on Bucket will switch to the async API.
There, <code>get</code> will return an <code>Observable</code> in which the requested Document is emitted.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the requested key doesn&#8217;t exist, the async API will instead result in an empty Observable and nothing will be emitted.
See below for an example of how to deal with that particular case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step in the chain is simply to extract the flight information that is needed and return it as a <code>List</code>.
This is done by the transforming operator <code>map</code>.
The application passes a function that will transform each emitted <code>JsonDocument</code> into a <code>List&lt;Object&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.map(new Func1&lt;JsonDocument, List&lt;Object&gt;&gt;() {
     @Override
     public List&lt;Object&gt; call(JsonDocument doc) {
         JsonObject data = doc.content();
         JsonArray flights = data.getArray("flights");
         if (flights != null) {
             return flights.toList();
         } else {
             return Collections.emptyList();
         }
     }
 })</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to detect that the document doesn&#8217;t exist, the application has to do things a bit differently since the <em>map</em> function won&#8217;t receive a <code>null</code> (it&#8217;s the enclosing Observable stream that is empty).
Fortunately, RxJava provides a method to emit a single default value if an upstream Observable is empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.defaultIfEmpty(Collections.emptyList())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, since in this example the application still must exit the method by returning a value in a synchronous manner, it can revert to a blocking behaviour and say "we only expect a <code>single()</code> value to be emitted and wait for it to return it":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.toBlocking()
.single();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To learn more about Observables, see the <a href="async-programming.html" class="page">Asynchronous Progamming Using the Java SDK with Couchbase Server</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a-first-n1ql-query-finding-airports"><a class="anchor" href="#a-first-n1ql-query-finding-airports"></a>A First N1QL Query: Finding Airports</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/Airport.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/Airport.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use N1QL and the DSL to perform your first <code>SELECT</code> on Couchbase Server.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="n1ql-queries-with-sdk.html" class="page">N1QL Queries Using the Java SDK with Couchbase Server</a>.</p>
</div>
<div class="paragraph">
<p>In the SDK, there is a <code>query</code> method that accepts all variants of querying with Couchbase Server (views, spatial/geo views, N1QL and FTS).
For N1QL, the <code>N1qlQuery</code> is expected.
This allows you to wrap a N1QL <code>Statement</code>, provide query tuning through a <code>N1qlParams</code> and if necessary provide values for placeholders in the statement as a <code>JsonObject</code> or <code>JsonArray</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
N1QL is a super-set of SQL, so if you&#8217;re familiar with SQL you&#8217;ll feel at ease.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Statements can be provided either in String form or using the DSL.</p>
</div>
<div class="paragraph">
<p>The <code>findAll</code> method is expected to return a <code>List</code> (several matching rows) of <code>Map</code>s representing the JSON value.
Once again, it is to be wrapped in a <code>Result</code> to standardize the JSON representation for the frontend.
Spring will inject the <code>bucket</code> into it and the <code>params</code> attribute from the HTTP request.
From that the application will start building a <code>Statement</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * Find all airports.
 */
public static Result&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; findAll(final Bucket bucket, final String params) {
    Statement query;
//continued...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application needs to select just the airport name from relevant documents in the bucket.
Since it wants to filter relevant document on a criteria that depends on the input length, the query starts with "SELECT airportname FROM `travel-sample`".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">AsPath prefix = select("airportname").from(i(bucket.name()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then it can choose the correct fields to look into depending on the length of the input.
Notice the <code>x()</code> method that produces a token/expression from a string.
From there you can apply operators like <code>eq()</code> (equals).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (params.length() == 3) {
    query = prefix.where(x("faa").eq(s(params.toUpperCase())));
} else if (params.length() == 4 &amp;&amp; (params.equals(params.toUpperCase()) || params.equals(params.toLowerCase()))) {
    query = prefix.where(x("icao").eq(s(params.toUpperCase())));
} else {
    query = prefix.where(i("airportname").like(s(params + "%")));
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use <strong>static</strong> imports on these methods of the <code>Expression</code> class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>x</code> to create an <code>Expression</code> representing a plain token, like a field.</p>
</li>
<li>
<p><code>s</code> to create a string literal (with appropriate quotes).</p>
</li>
<li>
<p><code>i</code> to escape a token with back ticks (for instance when refering to the travel-sample bucket, you need to escape it because otherwise N1QL will interpret the dash as a subtraction operator).</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The statement is ready!
You can view (and log it) via its <code>toString()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">logQuery(query.toString());
//query.toString() example: SELECT airportname FROM `travel-sample` WHERE faa = "LAX"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the application needs to actually execute this statement by wrapping it in a <code>N1qlQuery</code> and invoking <code>bucket.query()</code>.
Here is a very simple query with no placeholders and no particular tuning of the query is necessary, so we&#8217;ll use the <code>N1qlQuery.simple()</code> factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">N1qlQueryResult result = bucket.query(N1qlQuery.simple(query));
List&lt;Map&lt;String, Object&gt;&gt; data = extractResultOrThrow(result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>By looking at <code>extractResultOrThrow</code>, you can understand the structure of the N1QL response (as represented by <code>N1qlQueryResult</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * Extract a N1Ql result or throw if there is an issue.
 */
private static List&lt;Map&lt;String, Object&gt;&gt; extractResultOrThrow(N1qlQueryResult result) {
    if (!result.finalSuccess()) {
        LOGGER.warn("Query returned with errors: " + result.errors());
        throw new DataRetrievalFailureException("Query error: " + result.errors());
    }

    List&lt;Map&lt;String, Object&gt;&gt; content = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
    for (N1qlQueryRow row : result) {
        content.add(row.value().toMap());
    }
    return content;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>N1qlQueryResult</code> has two status flags: one intermediary <code>parseSuccess()</code> that indicates immediately if there is a syntax error (<code>parseSuccess() == false</code>) or not, and one that indicates the definite result of the query (<code>finalSuccess()</code>).</p>
</div>
<div class="paragraph">
<p>If the query is successful, it will offer a list of <code>N1qlQueryRow</code> through <code>allRows()</code>.
Otherwise it will have <code>JsonObject</code> errors in <code>errors()</code>.
That&#8217;s what the application inspects to respectively build a list of results or throw a <code>DataRetrievalFailureException</code> containing all the errors.</p>
</div>
<div class="paragraph">
<p>After is has extracted the rows, it once again packages them into a <code>Result</code>, augmented with the exact statement the application executed as a narration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">return Result.of(data, query.toString());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="more-complex-queries-finding-routes"><a class="anchor" href="#more-complex-queries-finding-routes"></a>More Complex Queries: Finding Routes</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/FlightPath.java" target="_blank" rel="noopener"><code>src/main/java/trycb/service/FlightPath.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Let the DSL guide you into making more complex N1QL queries.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="n1ql-queries-with-sdk.html" class="page">N1QL Queries Using the Java SDK with Couchbase Server</a>.</p>
</div>
<div class="paragraph">
<p>In this class, there are two more complex queries.
The first aims at transforming the human-readable airport name for the departure and arrival airports to FAA codes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT faa AS fromAirport FROM `travel-sample` WHERE airportname = "Los Angeles Intl"
  UNION SELECT faa AS toAirport FROM `travel-sample` WHERE airportname = "San Francisco Intl"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second aims at constructing the result set of available flight paths that connect the two airports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment
  FROM `travel-sample` AS r
  UNNEST r.schedule AS s
  JOIN `travel-sample` AS a ON KEYS r.airlineid
  WHERE r.sourceairport = "LAX" AND r.destinationairport = "SFO" AND s.day = 6
  ORDER BY a.name ASC</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Yes, you read that right, N1QL can do joins (on a single bucket or on several).
It works as long as the "foreign key" described by <code>ON KEYS</code> clause can be mapped to a document&#8217;s key in the joined bucket.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A specificity of N1QL that can be seen in the second statement is <code>UNNEST</code>.
It extracts a sub-JSON and puts it at the same root level as the bucket (so its possible to do joins on each element in this sub-JSON as if they were entries in a left-hand side bucket).</p>
</div>
<div class="paragraph">
<p>For this final step, try to obtain the equivalent of these statements via the DSL and see how it guides you through the possibilities of the query language.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing-the-data-n1ql-gsi"><a class="anchor" href="#indexing-the-data-n1ql-gsi"></a>Indexing the Data: N1QL &amp; GSI</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/util/StartupPreparations.java" target="_blank" rel="noopener"><code>src/main/java/trycb/utils/StartupPreparations.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use the Index DSL to make sure data is indexed for N1QL to query it.</p>
</div>
<div class="paragraph">
<p>Index management is a bit more advanced (and is already done when loading the sample), so now that you&#8217;ve learned about N1QL, you can have a look at it.
For N1QL to work, you must first ensure that at least a <code>Primary Index</code> has been created.
For that you can use the DSL from the <code>Index</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Index.createPrimaryIndex().on(bucket.name())</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fluent API will guide you with the available options, you just have to declare that you want to <code>createPrimaryIndex()</code> and specify <code>on(...)</code> which Bucket.</p>
</div>
<div class="paragraph">
<p>You can also create secondary indexes on specific fields of the JSON, for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Index.createIndex("index_name").on(bucket.name(), "field_to_index")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, give a name to your index, specify the target bucket AND the field(s) in the JSON to index.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="full-text-search-finding-hotels"><a class="anchor" href="#full-text-search-finding-hotels"></a>Full Text Search: Finding Hotels</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-java/blob/master/src/main/java/trycb/service/Hotel.java" target="_blank" rel="noopener"><code>src/mainjava/trycb/service/Hotel.java</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use FTS to search for matching Hotels and use subdoc API to fetch the relevant data for each result.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="full-text-searching-with-sdk.html" class="page">Searching from the SDK</a>, <a href="subdocument-operations.html" class="page">Sub-Document Operations</a>.</p>
</div>
<div class="paragraph">
<p>In this service, hotels are searched for using more fuzzy criterias, like the content of the address or the description of an hotel.
This is done using Full Text Search (FTS).
When some results match the specified criteria, only the relevant data for each result to be displayed in the UI is fetched using the subdocument API.</p>
</div>
<div class="paragraph">
<p>The <code>findHotels</code> method accepts two parameters, <code>location</code> and <code>description</code>, which are the two possible refining criteria for an hotel search.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public Result findHotels(final String location, final String description) {
    ConjunctionQuery fts = SearchQuery.conjuncts(SearchQuery.term("hotel").field("type"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ConjunctionQuery</code> allows to combine multiple FTS queries into one, in an AND fashion.
That search always includes an exact match criteria that restricts it to the <code>hotel</code> data type (as reflected in the <code>type</code> field of the JSON document).</p>
</div>
<div class="paragraph">
<p>If the user provided a location keyword, a second component is added to the FTS query that will look for that keyword in several address-related fields of the document.
That is done in an OR fashion, using a <code>Disjunction</code> this time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (location != null &amp;&amp; !location.isEmpty() &amp;&amp; !"*".equals(location)) {
    fts.and(SearchQuery.disjuncts(
                SearchQuery.matchPhrase(location).field("country"),
                SearchQuery.matchPhrase(location).field("city"),
                SearchQuery.matchPhrase(location).field("state"),
                SearchQuery.matchPhrase(location).field("address")
        ));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, if a description keyword was provided by the user, the application look at the freeform text <code>description</code> field and <code>name</code> fields of the document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (description != null &amp;&amp; !description.isEmpty() &amp;&amp; !"*".equals(description)) {
    fts.and(
        SearchQuery.disjuncts(
                SearchQuery.matchPhrase(description).field("description"),
                SearchQuery.matchPhrase(description).field("name")
        ));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>matchPhrase</code> FTS query can contain several words and will search for variations of the words (e.g.
including plural forms or words with the same root).</p>
</div>
<div class="paragraph">
<p>The compound FTS query is now ready to be executed.
The application builds a <code>SearchQuery</code> object out of it, which also determines which FTS index to use ("hotels") and allows you to set various parameters (like a limit of maximum 100 hits to return).
The query is logged (and kept for narration) then executed, returning a <code>SearchQueryResult</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SearchQuery query = new SearchQuery("hotels", fts)
    .limit(100);
logQuery(query.export().toString());
SearchQueryResult result = bucket.query(query);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The FTS results are then iterated over, and the document corresponding to each result is fetched.
In actuality, only the parts of the document that will be displayed in the UI are required.
This is where the sub-document API comes in.</p>
</div>
<div class="paragraph">
<p>The sub-document API allows you to fetch or mutate only a set of paths inside a JSON document, without having to send the whole document back and forth.
This can save network bandwidth if the document is large and the parts that the application is interested in are small.
So here the results of the FTS search are iterated over and appropriate subdoc calls are triggered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">for (SearchQueryRow row : result) {
    DocumentFragment&lt;Lookup&gt; fragment = bucket
            .lookupIn(row.id())
            .get("country")
            .get("city")
            .get("state")
            .get("address")
            .get("name")
            .get("description")
            .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each FTS result is represented as a <code>SearchQueryRow</code> which exposes the document&#8217;s <code>id()</code>.
The application can use the sub-document API dedicated to fetching data (<code>bucket.lookupIn(documentId)</code>) and specify what parts it wants: country, city, state, address, name and description.
It can then <code>execute()</code> the sub-document specification.
In the rest of the code, the address-related fields are aggregated together and the data obtained is returned as a <code>List&lt;Map&lt;String, Object&gt;&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Back in the <code>findHotels</code> method, the application artificially prepares a narration that reflects the subdocument specification and returns the list of data wrapped in a <code>Result</code> with two narration elements: the FTS query that was executed and the subdocument specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String ftsContext = ftsContext = query.export().toString();
String subdocContext = "DocumentFragment&lt;Lookup&gt; fragment = bucket\n" +
"                    .lookupIn(row.id())\n" +
"                    .get(\"country\")\n" +
"                    .get(\"city\")\n" +
"                    .get(\"state\")\n" +
"                    .get(\"address\")\n" +
"                    .get(\"name\")\n" +
"                    .get(\"description\")\n" +
"                    .execute();";

return Result.of(extractResultOrThrow(result), ftsContext, subdocContext);</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
