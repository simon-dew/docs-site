<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>Configure SAML | Couchbase Docs (Preview)</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.6">
<meta name="page-url" content="/server/7.6/manage/manage-security/configure-saml.html">
<meta name="page-nav-header-levels" content="0">
<meta name="generator" content="Antora 3.1.4">
<link rel="icon" href="../../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://simon-dew.github.io/docs-site/DOC-11568/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://simon-dew.github.io/docs-site/DOC-11568/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
    <template id="page-versions" style="display: none">
      <select class="version_list" data-component="server">
        <option value="7.6" data-url="configure-saml.html" selected>7.6 Prerelease</option>
        <option value="7.2" data-url="../../../current/index.html">7.2</option>
      </select>
    </template>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/simondew/GitHub/simon-dew/docs-server/modules/manage/pages/manage-security/configure-saml.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-banner">
<i class="fas fa-file-alt"></i> <p>You are viewing the documentation for a prerelease version.</p>
</div>
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">server</a></li>
<li class="crumb">Manage</li>
<li class="crumb"><a href="security-management-overview.html">Manage Security</a></li>
<li class="crumb"><a href="manage-authentication.html">Manage Authentication</a></li>
<li class="crumb"><a href="configure-saml.html">Configure SAML</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure SAML</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>You can enable <em>Structured Authentication Markup Language</em> (SAML)  authentication that allows users to log into the Couchbase Server Web Console. This authentication methods offers features such as single sign on, two-factor authentication, and centralized authentication administration.</p>
</div>
<div class="paragraph">
<p>To learn more about SAML, see <a href="../../learn/security/authentication-domains.html#saml-authentication" class="xref page">SAML Authentication</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before configuring SAML authentication consider the following:</p>
</div>
<div class="sect2">
<h3 id="identity-provider"><a class="anchor" href="#identity-provider"></a>Identity Provider</h3>
<div class="paragraph">
<p>SAML authentication relies on an <em>Identity Provider</em> (IdP) to authenticate a user with the Couchbase Server Web Console. Couchbase Server supports the following IdPs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Okta</p>
</li>
<li>
<p>Microsoft Azure AD</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Other IdPs may work. Couchbase Server was tested with the IdPs in the previous list.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your IdP may have its own requirements for interacting with services like Couchbase Server. See your IdP&#8217;s documentation to understand its requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="idp-metadata"><a class="anchor" href="#idp-metadata"></a>IdP Metadata</h3>
<div class="paragraph">
<p>Couchbase Server needs metadata about the IdP to be able to accept authentication messages from it. Your IdP provides you with a URL to retrieve this metadata. If your Couchbase Cluster can connect to the IdP, you can have it directly retrieve the metadata. You can configure Couchbase Server to periodically refresh this metadata to learn of changes to the IdP&#8217;s configuration.</p>
</div>
<div class="paragraph">
<p>If Couchbase Server cannot connect to the IdP, you can upload a file containing the metadata when initially configuring SAML authentication. In this case, you may need to  manually update the configuration periodically.</p>
</div>
</div>
<div class="sect2">
<h3 id="certificates"><a class="anchor" href="#certificates"></a>Certificates</h3>
<div class="paragraph">
<p>You need a key and certificate for your Couchbase cluster to use when signing messages to the IdP. The IdP uses the certificate to verify the signature in SAML messages. This verification lets the IdP know that the message came from Couchbase Server. You can use a certificate specifically for SAML authentication or reuse the same certificate you use for client authentication.</p>
</div>
<div class="paragraph">
<p>You can configure Couchbase Server to authenticate SAML message signatures to verify that they came from the IdP. It can authenticate the signature using a full certificate or a trusted fingerprint which is a hash of the certificate. Fingerprints are smaller, so there is a bit less overhead on Couchbase Server when using them instead of a full certificate. In either case, you must get the certificate or fingerprint from the IdP so Couchbase Server can use it.</p>
</div>
<div class="paragraph">
<p>To use fingerprints, you just copy them from your IdP and paste them into the Couchbase SAML configuration page.</p>
</div>
<div class="paragraph">
<p>When using certificates to authenticate messages, Couchbase Server gets the certificate from the IdP&#8217;s metadata. Getting the certificate from the metadata can automate updating new certificates due to key rotation. Couchbase Server automatically updates to a new certificate if you configure it to refresh the metadata periodically.</p>
</div>
<div class="paragraph">
<p>If you choose to use certificates, you must make sure Couchbase Server gets the metadata from the IdP securely. You have three options to securely get the metadata:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Give Couchbase Server a secure HTTPS URL to retrieve the metadata from the IdP directly. Then enable <strong>Verify remote peer</strong> on the SAML configuration page and supply the CA certificate that issued the certificate for the IdP&#8217;s metadata site. This certificate is often different from the certificate it uses to sign its SAML metadata. With this configuration, Couchbase Server verifies the identity of the IdP when downloading the metadata.</p>
</li>
<li>
<p>If the IdP signs its metadata, enable <strong>Validate metadata using trusted fingerprints</strong> on the SAML configuration page. Then add a trusted fingerprint for the IdP&#8217;s certificate to the <strong>Trusted Fingerprints</strong> box. Couchbase Server verifies the IdP&#8217;s signature in the metadata using the fingerprint and therefore trusts the certificate in the metadata.</p>
</li>
<li>
<p>Directly download the metadata from the IdP and upload it to Couchbase Server via the SAML configuration page. In this case, be sure you&#8217;re using a secure HTTPS connection to the IdP when downloading its metadata.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="network-configuration"><a class="anchor" href="#network-configuration"></a>Network Configuration</h3>
<div class="paragraph">
<p>Some IdPs do not require a direct network connection to your Couchbase Server. Instead, the user&#8217;s browser transmits the authentication request and response between Couchbase Server and the IdP. As long as the user&#8217;s browser can reach both Couchbase Server and the IdP, they can use SAML to authenticate.</p>
</div>
<div class="paragraph">
<p>However, some IdPs may want to connect to services such as Couchbase Server to verify SAML metadata such as the certificate. This connection enables frequent key rotation, which helps increase security. Verify any inbound network connection requirements with your IdP.</p>
</div>
<div class="paragraph">
<p>If you restrict your Couchbase cluster&#8217;s connections to the Internet, consider granting it access to the IdP. Allowing this connection makes SAML configuration easier by letting Couchbase Server retrieve most of the configuration information it needs directly from the IdP. This connection also automates updating the IdP&#8217;s certificates when they change due to key rotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="group-and-roles-management"><a class="anchor" href="#group-and-roles-management"></a>Group and Roles Management</h3>
<div class="paragraph">
<p>Decide whether you&#8217;ll manage group and role membership in Couchbase Server or in the IdP. If you decide to manage groups and roles in Couchbase Server, create Couchbase Server users in the external authentication realm. Assign these users the groups and roles they need. If you choose to manage groups and roles in the IdP, create SAML attributes that you&#8217;ll map to Couchbase Server groups and roles. Edit the users in the IdP so their attributes reflect the groups and roles they need.</p>
</div>
</div>
<div class="sect2">
<h3 id="nameid"><a class="anchor" href="#nameid"></a>NameID and User Identity</h3>
<div class="paragraph">
<p>The SAML authentication message sent from the IdP to Couchbase Server identifies the user using a format called nameID. The nameID format is a colon-delimited string. It can be one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</code> uses a unique identifier that remains constant across different IdPs and services. This is the default value for Couchbase Server.</p>
</li>
<li>
<p><code>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</code> does not set a format for the user identity. It can be any text string.</p>
</li>
<li>
<p><code>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</code> sets the format to an email address.</p>
</li>
<li>
<p><code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code> uses a unique but temporary identifier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of relying on the nameID, you can have Couchbase Server get the username from an attribute in the SAML message. Use an attribute instead of the nameID if the IdP uses a format that doesn&#8217;t match Couchbase Server usernames. For example, suppose the IdP only supports identifying users using an email address instead of a username. In this case, you can have the IdP send the user&#8217;s username in an attribute. Then configure Couchbase Server to extract the username from the attribute instead of using the nameID.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-saml-with-the-ui"><a class="anchor" href="#configure-saml-with-the-ui"></a>Configure SAML with the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure SAML authentication using Web Console:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the navigation bar, click <strong>Security</strong>.</p>
</li>
<li>
<p>In the navigation menu, click <strong>SAML</strong>.</p>
</li>
<li>
<p>Turn on the <strong>Enabled</strong> toggle.</p>
</li>
<li>
<p>Complete the following procedures to finish configuring SAML:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#configure-couchbase-metadata">Configure Couchbase Metadata</a></p>
</li>
<li>
<p><a href="#configure-the-idp">Configure the IdP</a></p>
</li>
<li>
<p><a href="#configure-single-sign-on">Configure Single Sign-On</a></p>
</li>
<li>
<p>Optionally, <a href="#configure-advanced-settings">Configure Advanced Settings</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <b class="button">Save</b> to save the SAML settings.</p>
</li>
<li>
<p>Verify that Couchbase Server saved the settings by looking for a green popup stating that the settings were saved. If you do not see this popup, look for error messages at the top of the SAML Configuration page.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After you enable SAML authentication, the top of the configuration page lists several URLs you need when you configure your IdP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Current SP metadata URL</strong>: the URL to retrieve your Couchbase Server&#8217;s SAML metadata. A link also appears that you can use to download the metadata. Use this link if your IdP is not able to connect to Couchbase Server directly.</p>
</li>
<li>
<p><strong>Current SP consume URL</strong>: the SAML <em>Assertion Consumer Service</em> (ACS) endpoint for your Couchbase server. The IdP sends SAML assertion messages to this endpoint.</p>
</li>
<li>
<p><strong>Current SP logout URL</strong>: the URL to which the IdP sends SAML logout requests and responses.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="configure-couchbase-metadata"><a class="anchor" href="#configure-couchbase-metadata"></a>Configure Couchbase Metadata</h3>
<div class="paragraph">
<p>Under <strong>Metadata</strong>, enter information about your Couchbase Server and organization. Most of these fields supply contact information to your IdP and do not affect the authentication process. The exceptions are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SP Entity ID</dt>
<dd>
<p>A URL that identifies your Couchbase Server to the IdP. You add this URL to your IdP&#8217;s configuration so it can identify the service with which the user is authenticating. This field is optional. If you do not enter a value, Couchbase Server uses a URL based on the node&#8217;s fully qualified domain name, port number, and the path to the SAML metadata page (<code>/saml/metadata</code>).</p>
</dd>
</dl>
</div>
<div id="sp-base-url" class="dlist">
<dl>
<dt class="hdlist1">SP Base URL Type</dt>
<dd>
<p>This option controls hostname in the URL to which the IdP redirects the user&#8217;s browser after authentication. Choose this option based on the address users enter to connect to your Couchbase Server:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Node address</strong> sends the user back to the self-reported address of the node the user is logging into.</p>
</li>
<li>
<p><strong>Alternate node address</strong> sends the user to the node&#8217;s alternate address. See <a href="../../learn/clusters-and-availability/connectivity.html#alternate-addresses" class="xref page">Alternate Addresses</a>.</p>
</li>
<li>
<p><strong>Custom URL</strong> sends the user to the URL you enter in <strong>Custom URL</strong> box which appears when you select this option. Select this option when users use some other URL when connecting to nodes in the cluster. For example, if you use a load balancer to redirect users to nodes, enter its URL here.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Key and Certificates</dt>
<dd>
<p>Add the Couchbase Server&#8217;s private key and certificate. Either copy and paste their content or upload them by clicking <b class="button">Select File</b>. If the certificate was not directly signed by a CA, added the intermediate certificates in <strong>Certificate chain</strong>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configure-the-idp"><a class="anchor" href="#configure-the-idp"></a>Configure the IdP</h3>
<div class="paragraph">
<p>Under <strong>Identity Provider Configuration</strong>, enter the information about your IdP:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Load IDP metadata from</dt>
<dd>
<p>Either enter the IdP&#8217;s metadata URL or upload a snapshot of its metadata in a file. If you provide a URL, you can have Couchbase Server refresh the metadata periodically.</p>
</dd>
<dt class="hdlist1">Verify remote peer</dt>
<dd>
<p>Select to enable verification of the IdP&#8217;s certificate. Only has an effect if you entered a secure URL (<code>https://</code>) in <strong>Load IDP metadata from</strong>. If you enable this option, supply a copy of the IdP&#8217;s certificate in <strong>CA Certificates</strong>.</p>
</dd>
<dt class="hdlist1">Validate metadata using trusted fingerprints</dt>
<dd>
<p>Select to enable using fingerprints to validate the signature of the IdP&#8217;s metadata. Select <strong>Use trusted fingerprints for metadata bootstrap only</strong> to limit using fingerprint verification to just the initial retrieval of the metadata. Select <strong>Always use trusted fingerprints to validate signatures in SAML&#8230;&#8203;</strong> to use fingerprints to validate all SAML messages instead of just metadata.</p>
</dd>
<dt class="hdlist1">Trusted Fingerprints</dt>
<dd>
<p>Add the IdP&#8217;s trusted fingerprints if you&#8217;re using them to validate the IdP&#8217;s messages.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configure-single-sign-on"><a class="anchor" href="#configure-single-sign-on"></a>Configure Single Sign-On</h3>
<div class="paragraph">
<p>Under the <strong>Single Sign-On</strong> section, configure how Couchbase Server and the IdP communicate about user authentication.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Authentication IDP Binding</dt>
<dt class="hdlist1">Logout IDP Binding</dt>
<dd>
<p>Select <strong>Post</strong> if Couchbase Server should use POST messages to send authentication and logout requests to the IdP. Select <strong>Redirect</strong> if Couchbase Server should use URL parameters instead.</p>
</dd>
<dt class="hdlist1">Validate assertion signature</dt>
<dt class="hdlist1">Validate assertion envelope signature</dt>
<dd>
<p>Select to have Couchbase verify the signature of either the SAML assertions or the entire SAML envelope the IdP sends. You should enable at least one form of signature validation based on how your IdP signs its messages.</p>
</dd>
<dt class="hdlist1">NameID format</dt>
<dd>
<p>Enter the format that the IdP uses to identify the user. You must enter a value here, even if you configure Couchbase Server to use an attribute for the username.</p>
</dd>
<dt class="hdlist1">Username attribute</dt>
<dd>
<p>Select if you want to use a SAML attribute for the username and enter the attribute&#8217;s name in <strong>Username attribute</strong> box.</p>
</dd>
<dt class="hdlist1">Groups attribute</dt>
<dd>
<p>Select if you want Couchbase Server to get group membership from the IdP. Enter the name of the SAML attribute containing the groups in the <strong>Groups attribute</strong> box. Enter the separator character in <strong>Groups separator</strong> if your IdP sends lists of groups in a string. If you want Couchbase Server to only use a subset of the group names that the IdP sends it, enter a regular expression in <strong>Groups filter</strong>. Couchbase Server only applies a group to the user if the group&#8217;s name matches the regular expression.</p>
</dd>
<dt class="hdlist1">Roles attribute</dt>
<dd>
<p>Select if you want the IdP to manage user roles. Works the same way the Groups attribute works.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="configure-advanced-settings"><a class="anchor" href="#configure-advanced-settings"></a>Configure Advanced Settings</h3>
<div class="paragraph">
<p>In most cases you do not need to change the settings under <strong>Advanced</strong>. If you&#8217;re having an issue with the SAML integration, these settings may help resolve it. Most of these settings are self-explanatory. The following need some explanation:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Value of SP metadata cacheDuration attribute</dt>
<dd>
<p>Sets how long the IdP caches Couchbase Server&#8217;s metadata. This value is in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener">ISO8601 duration format</a>. The default value <code>P1M</code> sets this duration to one month.</p>
</dd>
</dl>
</div>
<div id="dupe-check" class="dlist">
<dl>
<dt class="hdlist1">SP Assertion Dupe Check</dt>
<dd>
<p>When you select <strong>Enable Dupe Check</strong>, Couchbase Server prevents a user from reusing an IdP&#8217;s SAML assertion to log in a second time. If you enable this option, you can choose whether this restriction applies to all nodes or just a single node. Select the <strong>Global</strong> option to prevent users from reusing a SAML assertion on any node in the cluster. Select <strong>Local</strong> to prevent SAML assertion reuse on the same node. The <strong>Local</strong> option allows a user reuse a SAML assertion to log into a different node.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-okta-as-a-saml-idp"><a class="anchor" href="#configuring-okta-as-a-saml-idp"></a>Configuring Okta as a SAML IdP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Okta is an SSO service that supports SAML and enables 2FA. Follow these steps to configure Okta as a SAML IdP for Couchbase Server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into your Okta administrator account.</p>
</li>
<li>
<p>Under <strong>Applictions</strong> click <strong>Applications</strong>.</p>
</li>
<li>
<p>Click <b class="button">Create App Integration</b>.</p>
</li>
<li>
<p>Select <strong>SAML 2.0</strong> and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In <strong>App Name</strong>, enter a name for your Couchbase Server and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In the <strong>General</strong> section, configure Okta&#8217;s integration with Couchbase Server. The following table lists the Couchbase Server fields and their corresponding Okta fields.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Okta Field</th>
<th class="tableblock halign-left valign-top">Couchbase field</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Single sign-on URL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Current SP consume URL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Current SP consume URL</strong> appears in Couchbase Server&#8217;s SAML Configuration page after you enable SAML authentication. The default value is the URL of the Couchbase node plus the path <code>saml/consume</code>. You can add a placeholder value in Okta initially. After enabling SAML in Couchbase Server, update the value in Okta.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Audience URI</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Current SP metadata URL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the URL shown in <strong>Current SP metadata URL</strong> after enabling SAML in Couchbase Server. You can use a placeholder in Okta until after you finish enabling SAML in Couchbase Server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Name ID format</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>NameID format</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Okta lists just the description of the format instead of the entire format string. For example, select <strong>Unspecified</strong> in Okta&#8217;s <strong>Name ID format</strong> list if you entered <code>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</code> in Couchbase&#8217;s <strong>NameID format</strong> field.</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>In <strong>Application username</strong> field, choose the Okta attribute that corresponds to the Couchbase Server username. For example, choose <strong>Okta username</strong> if the username in Okta is the same as the username in Couchbase Server. Choose any value if you&#8217;re using a SAML attribute instead of the SAML subject to set the username for Couchbase Server.</p>
</li>
<li>
<p>Under <strong>Attribute Statements</strong> add entries for any Okta attributes you to want to pass to Couchbase Server as SAML attributes. For example, suppose you want to use a SAML attribute to pass the user&#8217;s roles from Okta to Couchbase. Then choose a name for the SAML attribute and enter it under the <strong>Name</strong> column. Under the <strong>Value</strong> column, select the Okta attribute for the roles. Later, enter the attribute name in the <strong>Roles attribute</strong> field on the Couchbase Server&#8217;s SAML page.</p>
</li>
<li>
<p>Configure the SAML attribute name under <strong>Group Attribute Statements</strong> if you&#8217;re using the user&#8217;s Okta&#8217;s group membership to set the user&#8217;s Couchbase Server groups. In the <strong>Name</strong> column, enter the attribute name you set in <strong>Groups attribute</strong> field of the Couchbase Server SAML configuration page.</p>
</li>
<li>
<p>Click <b class="button">Next</b> and then <b class="button">Finish</b>.</p>
</li>
<li>
<p>The <strong>Sign On</strong> tab contains the information you need to enter into the Couchbase Server SAML configuration page. Click <strong>More details</strong> to show all of the information you need.</p>
</li>
<li>
<p>Copy the Okta values in the following table to their corresponding fields on the SAML page.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Okta Value</th>
<th class="tableblock halign-left valign-top">SAML Page Field</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Metadata URL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>URL</strong> under <strong>Metadata</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Signing Certificate</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CA Certificates</strong> under <strong>Metadata</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CA Certificates</strong> is hidden until you select <strong>Verify remote peer</strong>. You can download the certificate from Okta by clicking <b class="button">Download</b> and then upload it to Couchbase Server by clicking <b class="button">Select File</b>.</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Fill in the rest of the Couchbase Server SAML page as explained in <a href="#configure-saml-with-the-ui">Configure SAML with the UI</a>.</p>
</li>
<li>
<p>In Okta, click the <strong>Assignments</strong> tab.</p>
</li>
<li>
<p>Assign users who need to log into the Couchbase Server Web Console to the Okta application you just created. See the Okta documentation for the steps you need to take.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-saml-with-the-rest-api"><a class="anchor" href="#configure-saml-with-the-rest-api"></a>Configure SAML with the REST API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code>/settings/saml</code> endpoint to configure a SAML IdP using the REST API. The following example demonstrates calling this endpoint using curl.  In the following example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The curl command adds the Couchbase Server&#8217;s key and certificate by using the <code>--data-urlencode</code> argument to read them from the files <code>my_key.pem</code> and <code>my_certificate.crt</code>.</p>
</li>
<li>
<p>The <em>Fully Qualified Domain Name</em> (FQDN) where users connect to the Web Console is <code>nodename.example.com</code>. Couchbase Server determines this value based on its own configuration.</p>
</li>
<li>
<p>The IdP&#8217;s metadata URL is <code>https://myidp.com/sso/saml/metadata</code>. In this example, the metadata provides all of the configuration information Couchbase Server needs to interact with the IdP. Therefore, the curl command has no further IdP parameters.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre data-source-url="file:///Users/simondew/GitHub/simon-dew/docs-server/modules/rest-api/examples/post-saml.sh">curl -X POST -u Administrator:password \
http://localhost:8091/settings/saml \
-d enabled=true \
-d idpMetadataTLSVerifyPeer=false \
-d idpMetadataURL=https://myidp.com/sso/saml/metadata \
-d spBaseURLScheme=http  \
-d spBaseURLType=node \
--data-urlencode spCertificate@my_certificate.crt 
--data-urlencode spKey@my_key.pem 
-d idpSignsMetadata=false

{
    "authnNameIDFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
    "enabled": true,
    "groupsAttribute": "",
    "groupsAttributeSep": " ,",
    "groupsFilterRE": ".*",
    "idpAuthnBinding": "post",
    "idpLogoutBinding": "post",
    "idpMetadataConnectAddressFamily": "undefined",
    "idpMetadataHttpTimeoutMs": 5000,
    "idpMetadataOrigin": "http",
    "idpMetadataRefreshIntervalS": 3600,
    "idpMetadataTLSCAs": "",
    "idpMetadataTLSExtraOpts": "[]",
    "idpMetadataTLSSNI": "",
    "idpMetadataTLSVerifyPeer": false,
    "idpMetadataURL": "https://myidp.com/sso/saml/metadata",
    "idpSignsMetadata": false,
    "rolesAttribute": "",
    "rolesAttributeSep": " ,",
    "rolesFilterRE": ".*",
    "singleLogoutEnabled": true,
    "spAssertionDupeCheck": "global",
    "spBaseURLScheme": "http",
    "spBaseURLType": "node",
    "spCertificate": "-----BEGIN CERTIFICATE-----\n
    ...
    \n-----END CERTIFICATE-----\n",
    "spChain": "",
    "spConsumeURL": "http://nodename.example.com:8091/saml/consume",
    "spContactEmail": "",
    "spContactName": "",
    "spEntityId": "",
    "spKey": "**********",
    "spLogoutURL": "http://nodename.example.com:8091/saml/logout",
    "spMetadataCacheDuration": "P1M",
    "spMetadataURL": "http://nodename.example.com:8091/saml/metadata",
    "spOrgDisplayName": "",
    "spOrgName": "",
    "spOrgURL": "",
    "spSessionExpire": "SessionNotOnOrAfter",
    "spSignMetadata": true,
    "spSignRequests": true,
    "spTrustedFingerprints": [],
    "spTrustedFingerprintsUsage": "metadataInitialOnly",
    "spVerifyAssertionEnvelopSig": true,
    "spVerifyAssertionSig": true,
    "spVerifyLogoutReqSig": true,
    "spVerifyRecipient": "consumeURL",
    "usernameAttribute": ""
}</pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
