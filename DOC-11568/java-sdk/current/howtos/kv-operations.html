<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>Key Value Operations | Couchbase Docs (Preview)</title>
<link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-11568/java-sdk/current/howtos/kv-operations.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Key Value (KV) or data service offers the simplest way to retrieve or mutate data where the key is known.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="java-sdk">
<meta name="dcterms.identifier" content="3.3">
<meta name="page-url" content="/java-sdk/current/howtos/kv-operations.html">
<meta name="page-nav-header-levels" content="0">
<meta name="generator" content="Antora 3.1.4">
<link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://simon-dew.github.io/docs-site/DOC-11568/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://simon-dew.github.io/docs-site/DOC-11568/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/3.3/modules/howtos/pages/kv-operations.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../hello-world/overview.html">Java SDK</a></li>
<li class="crumb">Working with Data</li>
<li class="crumb"><a href="kv-operations.html">Key Value Operations</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Key Value Operations</h1>
<div class="labels">
<ul><li class="guide"><span><i class="far fa-check-square"></i> how-to</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Key Value (KV) or data service offers the simplest way to retrieve or mutate data where the key is known.
Here we cover CRUD operations, document expiration, and optimistic locking with CAS.
</blockquote>
</div>
<div class="paragraph">
<p>The complete code sample used on this page can be downloaded from <a href="https://github.com/couchbase/docs-sdk-java/blob/release/3.2/modules/howtos/examples/KvOperations.java">here</a>.</p>
</div>
<div class="paragraph">
<p>At its heart Couchbase Server is a high-performance key-value store, and the key-value interface outlined below is the fastest and best method to perform operations involving single documents.</p>
</div>
<div class="paragraph">
<p>A <em>document</em> refers to an entry in the database (other databases may refer to the same concept as a <em>row</em>).
A document has an ID (<em>primary key</em> in other databases), which is unique to the document and by which it can be located.
The document also has a value which contains the actual application data.
See <a href="../concept-docs/documents.html" class="xref page">the concept guide to <em>Documents</em></a> for a deeper dive into documents in the Couchbase Data Platform.</p>
</div>
<div class="paragraph">
<p>Before proceeding, make sure you&#8217;re familiar with the basics of authorization and connecting to a Cluster from the <a href="../hello-world/start-using-sdk.html" class="xref page">Start Using the SDK</a> section.</p>
</div>
<div class="paragraph">
<p>The code samples below will use these imports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L18-L45">import static com.couchbase.client.java.kv.GetOptions.getOptions;
import static com.couchbase.client.java.kv.InsertOptions.insertOptions;
import static com.couchbase.client.java.kv.ReplaceOptions.replaceOptions;
import static com.couchbase.client.java.kv.UpsertOptions.upsertOptions;

import java.time.Duration;
import java.time.Instant;
import java.time.Period;
import java.util.Optional;

import com.couchbase.client.core.error.CasMismatchException;
import com.couchbase.client.core.error.CouchbaseException;
import com.couchbase.client.core.error.DocumentExistsException;
import com.couchbase.client.core.error.DocumentNotFoundException;
import com.couchbase.client.core.error.DurabilityImpossibleException;
import com.couchbase.client.core.error.ReplicaNotConfiguredException;
import com.couchbase.client.core.msg.kv.DurabilityLevel;
import com.couchbase.client.java.AsyncCollection;
import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.Collection;
import com.couchbase.client.java.ReactiveCollection;
import com.couchbase.client.java.Scope;
import com.couchbase.client.java.json.JsonObject;
import com.couchbase.client.java.kv.GetResult;
import com.couchbase.client.java.kv.MutationResult;
import com.couchbase.client.java.kv.PersistTo;
import com.couchbase.client.java.kv.ReplicateTo;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">N1QL vs. Key-Value</div>
<div class="paragraph">
<p>N1QL can also be used to perform many single-document operations but we very strongly recommend using the key-value API for this instead, as it can be much more efficient. The request can go directly to the correct node, there&#8217;s no query parsing overhead, and it&#8217;s over the highly optimized memcached binary protocol.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="json"><a class="anchor" href="#json"></a>JSON</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Couchbase Server is a key-value store that&#8217;s agnostic to what&#8217;s stored, but it&#8217;s very common to store JSON so most of the examples below will focus on that use-case.</p>
</div>
<div class="paragraph">
<p>The Java SDK provides you with several options for working with JSON.</p>
</div>
<div class="paragraph">
<p>If you pass any object (like the provided <code>JsonObject</code> and <code>JsonArray</code>), including <code>Map&lt;String, Object&gt;</code> or <code>List&lt;Object&gt;</code> into the APIs provided,
the SDK will use its internal JSON codec (utilizing <a href="https://github.com/FasterXML/jackson">Jackson</a>) to encode/decode those objects transparently.
The SDK also supports custom transcoders and serializers which are covered separately.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upsert"><a class="anchor" href="#upsert"></a>Upsert</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Sub-Document Operations</div>
<div class="paragraph">
<p>All of these operations involve fetching the complete document from the Cluster.
Where the number of operations or other circumstances make bandwidth a significant issue,
the SDK can work on just a specific <em>path</em> of the document with <a href="subdocument-operations.html" class="xref page">Sub-Document Operations</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a simple upsert operation, which will insert the document if it does not exist, or replace it if it does.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll use the built-in JSON types for simplicity, but you can use different types if you want.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L72-L76">JsonObject content = JsonObject.create()
    .put("author", "mike")
    .put("title", "My Blog Post 1");

MutationResult result = collection.upsert("document-key", content);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All the examples here use the Java SDK&#8217;s simplest API, which blocks until the operation is performed.
There&#8217;s also an asynchronous API that is based around Java&#8217;s <code>CompletableFuture</code>,
and a reactive API built around <a href="https://projectreactor.io/">Project Reactor</a>.
They can be accessed like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L65-L66">AsyncCollection asynccollection = collection.async();
ReactiveCollection reactivecollection = collection.reactive();</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="insert"><a class="anchor" href="#insert"></a>Insert</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Insert works very similarly to upsert, but will fail if the document already exists with a <code>DocumentExistsException</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L83-L91">try {
  JsonObject content = JsonObject.create()
      .put("title", "My Blog Post 2");
  MutationResult insertResult = collection.insert("document-key2", content);
} catch (DocumentExistsException ex) {
  System.err.println("The document already exists!");
} catch (CouchbaseException ex) {
  System.err.println("Something else happened: " + ex);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retrieving-documents"><a class="anchor" href="#retrieving-documents"></a>Retrieving documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve tried upserting and inserting documents into Couchbase Server, let&#8217;s get them back:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L98-L104">try {
  GetResult getResult = collection.get("document-key");
  String title = getResult.contentAsObject().getString("title");
  System.out.println(title); // title == "My Blog Post"
} catch (DocumentNotFoundException ex) {
  System.out.println("Document not found!");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course if we&#8217;re getting a document we probably want to do something with the content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L111-L117">GetResult found = collection.get("document-key");
JsonObject content = found.contentAsObject();
if (content.getString("author").equals("mike")) {
  // do something
} else {
  // do something else
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have a <code>GetResult</code>, we can use <code>contentAsObject()</code> to turn the content back into a <code>JsonObject</code> like we inserted it in the examples before,
or use the more generic <code>contentAs(T.class)</code> equivalent to turn it back into other entity structures.
In fact, the <code>contentAsObject()</code> method is just a convenience method for <code>contentAs(JsonObject.class)</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replace"><a class="anchor" href="#replace"></a>Replace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A very common sequence of operations is to <code>get</code> a document, modify its contents, and <code>replace</code> it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L124-L129">collection.upsert("my-document", JsonObject.create().put("initial", true));

GetResult result = collection.get("my-document");
JsonObject content = result.contentAsObject();
content.put("modified", true).put("initial", false);
collection.replace("my-document", content, replaceOptions().cas(result.cas()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We <code>upsert</code> an initial version of the document.
We don&#8217;t care about the exact details of the result, just whether it succeeded or not, so do not assign a return value.
Then we <code>get</code> it back into <code>doc</code> and pull out the document&#8217;s content as a <code>JsonObject</code> using <code>contentAs</code>.
Afterwards, we update a field in the <code>JsonObject</code> with <code>put</code>.  <code>JsonObject</code> is mutable, we don&#8217;t need to store the result of the <code>put</code>.
Finally, we <code>replace</code> the document with the updated content, and a CAS value, storing the final result as <code>result</code>.</p>
</div>
<div class="paragraph">
<p>So, what is CAS?</p>
</div>
<div class="paragraph">
<p>CAS, or Compare And Swap, is a form of optimistic locking. Every document in Couchbase has a CAS value, and it&#8217;s changed on every mutation.
When you <code>get</code> a document you also get the document&#8217;s CAS, and then when it&#8217;s time to write the document, you send the same CAS back.
If another thread or program has modified that document in the meantime, the Couchbase Server can detect you&#8217;ve provided a now-outdated CAS, and return an error.
This provides cheap, safe concurrency.
See <a href="concurrent-document-mutations.html" class="xref page">this detailed description of CAS</a> for further details.</p>
</div>
<div class="paragraph">
<p>In general, you&#8217;ll want to provide a CAS value whenever you <code>replace</code> a document, to prevent overwriting another agent&#8217;s mutations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retrying-on-cas-failures"><a class="anchor" href="#retrying-on-cas-failures"></a>Retrying on CAS failures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But if we get a CAS mismatch, we usually just want to retry the operation.
Let&#8217;s see a more advanced <code>replace</code> example that shows one way to handle this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L136-L150">String id = "my-document";
collection.upsert(id, JsonObject.create().put("initial", true));

while (true) {
  GetResult found = collection.get(id);
  JsonObject content = found.contentAsObject();
  content.put("modified", true).put("initial", false);

  try {
    collection.replace(id, content, replaceOptions().cas(found.cas()));
    break; // if successful, break out of the retry loop
  } catch (CasMismatchException ex) {
    // don't do anything, we'll retry the loop
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this code is simplistic to show how CAS retry works in general.
If the <code>replace()</code> above never works, you would always get a CAS mismatch, and never break out of the loop - so
<code>for(int i = 0; i &lt; maxAttempts; i++)</code> would be a reasonable alternative.</p>
</div>
<div class="paragraph">
<p>In later chapters we cover more sophisticated approaches to this, including asynchronous retry, retry with backoff and bailing out after a maximum amount of tries.
All these should be in place for robust, production ready code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="removing"><a class="anchor" href="#removing"></a>Removing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Removing a document is straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L157-L161">try {
  collection.remove("my-document");
} catch (DocumentNotFoundException ex) {
  System.out.println("Document did not exist when trying to remove");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like <code>replace</code>, <code>remove</code> also optionally takes the CAS value if you want to make sure you are only removing the document if it hasn&#8217;t changed since you last fetched it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="durability"><a class="anchor" href="#durability"></a>Durability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Writes in Couchbase are written to a single node, and from there the Couchbase Server will take care of sending that mutation to any configured replicas.</p>
</div>
<div class="paragraph">
<p>The optional <code>durability</code> parameter, which all mutating operations accept, allows the application to wait until this replication (or persistence) is successful before proceeding.</p>
</div>
<div class="paragraph">
<p>It can be used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L169-L170">collection.upsert("my-document", JsonObject.create().put("doc", true),
    upsertOptions().durability(DurabilityLevel.MAJORITY));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no argument is provided the application will report success back as soon as the primary node has acknowledged the mutation in its memory.
However, we recognize that there are times when the application needs that extra certainty that especially vital mutations have been successfully replicated,
and the other durability options provide the means to achieve this.</p>
</div>
<div class="paragraph">
<p>The options differ depend on what Couchbase Server version is in use.
If 6.5 or above is being used, you can take advantage of the <a href="../concept-docs/durability-replication-failure-considerations.html#durable-writes" class="xref page">Durable Write</a> feature,
in which Couchbase Server will only return success to the SDK after the requested replication level has been achieved.
The three replication levels are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Majority</code> - The server will ensure that the change is available in memory on the majority of configured replicas.</p>
</li>
<li>
<p><code>MajorityAndPersistToActive</code> - Majority level, plus persisted to disk on the active node.</p>
</li>
<li>
<p><code>PersistToMajority</code> - Majority level, plus persisted to disk on the majority of configured replicas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The options are in increasing levels of safety.
Note that nothing comes for free - for a given node, waiting for writes to storage is considerably slower than waiting for it to be available in-memory.
These tradeoffs, as well as which settings may be tuned, are discussed in the <a href="../concept-docs/durability-replication-failure-considerations.html#durable-writes" class="xref page">durability page</a>.</p>
</div>
<div class="paragraph">
<p>If a version of Couchbase Server lower than 6.5 is being used then the application can fall-back to <a href="../concept-docs/durability-replication-failure-considerations.html#older-server-versions" class="xref page">'client verified' durability</a>.
Here the SDK will do a simple poll of the replicas and only return once the requested durability level is achieved.
This can be achieved like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L181-L182">collection.upsert("my-document", JsonObject.create().put("doc", true),
    upsertOptions().durability(PersistTo.NONE, ReplicateTo.TWO));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To stress, durability is a useful feature but should not be the default for most applications, as there is a performance consideration,
and the default level of safety provided by Couchbase will be reasonable for the majority of situations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="document-expiration"><a class="anchor" href="#document-expiration"></a>Document Expiration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Server includes an option to have particular documents automatically expire after a set time.
This can be useful for some use-cases, such as user sessions, caches, or other temporary documents.</p>
</div>
<div class="paragraph">
<p>You can set an expiry value from a <code>Duration</code> when creating a document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L192-L193">MutationResult insertResult = collection.insert("my-document2", json,
    insertOptions().expiry(Duration.ofHours(2)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expiry may be specified as a <code>Duration</code> only if the provided value is less than 50 years.</p>
</div>
<div class="paragraph">
<p>For expiration more than 50 years in the future, or if you have already calculated when a document should expire, you can specify the expiry as an <code>Instant</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L200-L201">MutationResult insertResult = collection.insert("my-document3", json,
    insertOptions().expiry(Instant.now().plus(Period.ofDays(62))));</code></pre>
</div>
</div>
<div class="paragraph">
<p>When getting a document from Couchbase Server, the expiry is not included by default, but it can be requested
by setting the <code>withExpiry</code> option to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L208-L210">GetResult result = collection.get("my-document3", getOptions().withExpiry(true));
Optional&lt;Instant&gt; expiry = result.expiryTime();
System.out.println("Expiry of found doc: " + expiry);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when updating the document, special care must be taken to avoid resetting the expiry to zero.
If you are using Couchbase Server 7.0 or later, set the <code>preserveExpiry</code> option when updating the document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L231-L232">collection.replace("my-document3", json,
    replaceOptions().preserveExpiry(true));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prior to Couchbase 7.0, it&#8217;s necessary to fetch the previous expiry and set it again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L219-L222">GetResult found = collection.get("my-document3", getOptions().withExpiry(true));

MutationResult result = collection.replace("my-document3", json,
    replaceOptions().expiry(found.expiryTime().get()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some applications may find <code>getAndTouch</code> useful, which fetches a document while updating its expiry field.
It can be used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L241">GetResult result = collection.getAndTouch("my-document3", Duration.ofDays(1));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="atomic-counters"><a class="anchor" href="#atomic-counters"></a>Atomic Counters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The value of a document can be increased or decreased atomically using <code>collecion.binary().increment()</code> and <code>collection.binary().decrement()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Increment &amp; Decrement are considered part of the ‘binary’ API and as such may still be subject to change
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Setting the document expiry time only works when a document is created, and it is not possible to update the expiry time of an existing counter document with the Increment method&#8201;&#8212;&#8201;to do this during an increment, use with the <code>Touch()</code> method.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="atomicity-across-data-centers"><a class="anchor" href="#atomicity-across-data-centers"></a>Atomicity Across Data Centers</h3>
<div class="paragraph">
<p>If you are using <a href="#7.1@server:manage:manage-xdcr/xdcr-management-overview.adoc" class="xref unresolved">Cross Data Center Replication</a> (XDCR), be sure to avoid modifying the same counter in more than one datacenter.
If the same counter is modified in multiple datacenters between replications, the counter will no longer be atomic, and its value can change in unspecified ways.</p>
</div>
<div class="paragraph">
<p>A counter must be incremented or decremented by only a single datacenter.
Each datacenter must have its own set of counters that it uses&#8201;&#8212;&#8201;a possible implementation would be including a datacenter name in the counter document ID.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scoped-kv-operations"><a class="anchor" href="#scoped-kv-operations"></a>Scoped KV Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to perform scoped key-value operations on named <a href="#7.1@server:learn:data/scopes-and-collections.adoc" class="xref unresolved"><code>Collections</code></a> <em>with Couchbase Server release 7.x</em>.
See the <a href="https://docs.couchbase.com/sdk-api/couchbase-java-client/com/couchbase/client/java/Collection.html">API docs</a> for more information.</p>
</div>
<div class="paragraph">
<p>Here is an example showing an upsert in the <code>users</code> collection, which lives in the <code>travel-sample.tenant_agent_00</code> keyspace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java" data-source-url="https://github.com/couchbase/docs-sdk-java/blob/841c6e7ca8bd2052fa246a284cb63285e8de7c18/modules/howtos/examples/KvOperations.java#L250-L255">Scope agentScope = bucket.scope("tenant_agent_00");
Collection usersCollection = agentScope.collection("users");

JsonObject content = JsonObject.create().put("name", "John Doe").put("preferred_email",
    "johndoe111@test123.test");
MutationResult result = usersCollection.upsert("user-key", content);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-resources"><a class="anchor" href="#additional-resources"></a>Additional resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Working on just a specific path within a JSON document will reduce network bandwidth requirements&#8201;&#8212;&#8201;see the <a href="subdocument-operations.html" class="xref page">Sub-Document</a> pages.</p>
</div>
<div class="paragraph">
<p>For a significant performance speed up with large volumes of data, reference our <a href="concurrent-async-apis.html" class="xref page">asynchronous programming options</a>.</p>
</div>
<div class="paragraph">
<p>Another way of increasing network performance is to <em>pipeline</em> operations with <a href="concurrent-async-apis.html#batching" class="xref page">Batching Operations</a>.</p>
</div>
<div class="paragraph">
<p>As well as various <a href="../concept-docs/data-model.html" class="xref page">Formats</a> of JSON, Couchbase can work directly with <a href="../concept-docs/nonjson.html" class="xref page">arbitrary bytes, or binary format</a>.</p>
</div>
<div class="paragraph">
<p>Our <a href="n1ql-queries-with-sdk.html" class="xref page">Query Engine</a> enables retrieval of information using the SQL-like syntax of N1QL.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"SDKs","components":["dotnet-sdk","java-sdk","nodejs-sdk","python-sdk","sdk-extensions"],"url":"/home/sdk.html","latestVersions":{"dotnet-sdk":"3.3","java-sdk":"3.3","nodejs-sdk":"4.1","python-sdk":"4.0","sdk-extensions":"master"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
