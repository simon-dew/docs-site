<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Using Indexes | Couchbase Docs (Staging)</title>
<link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-7458/server/6.6/analytics/7_using_index.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Using indexes to speedup queries.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="6.5">
<meta name="generator" content="Antora 2.3.0">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="https://www.couchbase.com">
                <img src="../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://simon-dew.github.io/docs-site/DOC-7458/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/cloud.html">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Downloads
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<nav class="nav">
</nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="https://github.com/couchbase/docs-analytics/edit/release/6.5/modules/analytics/pages/7_using_index.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-banner">
<i class="fas fa-file-alt"></i> <p>A newer version of this documentation is available.</p>
<a class="btn" href="../../6.6/analytics/7_using_index.html">View Latest</a>
</div>
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../index.html">server</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Using Indexes</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise Edition</a></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Indexes can speedup both selection queries and join queries if they
are applied properly. The following two sections describe
scenarios that indexes are explored inside the system for query processing purpose.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Secondary indexes do not store NULL values.
Queries that select objects based on the existence of a NULL field are not accelerated by an index.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Selection_queries"><a class="anchor" href="#Selection_queries"></a>Selection Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The query optimizer chooses to use a secondary index for query execution
if both of the following conditions are met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The query contains a conjunctive equality or range predicate over one or more fields, or a join predicate
(see the next section).
The conjunctive predicate has a form:</p>
<div class="literalblock">
<div class="content">
<pre>QualifiedName Operator Literal ( AND field Operator Literal )+</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>Operator</code> is <code>=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, or <code>BETWEEN</code>;</p>
</div>
</li>
<li>
<p>There is an index with a key, such that the corresponding fields in the predicate form a prefix of that key.
For example, suppose that there is an index on dataset <code>foo</code> with key fields <code>c_s</code> and <code>c_d</code>.</p>
<div class="literalblock">
<div class="content">
<pre>CREATE INDEX idx_s_d ON foo(c_s:STRING, c_d:DOUBLE);</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following query uses the index because it has an equality predicate (=) on a field (c_s) that is a prefix of the
indexed key (c_s, c_d):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT f.c_x as res
FROM foo f
WHERE f.c_s = 'world';</pre>
</div>
</div>
<div class="paragraph">
<p>If you would like an available index to not be used for a particular query predicate (e.g., because there will be many,
many matching objects), a skip-index hint can be used:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT f.c_x as res
FROM foo f
WHERE f.c_s /*+ skip-index */ = 'world';</pre>
</div>
</div>
<div class="paragraph">
<p>If multiple indexes are eligible access paths, there can be two cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two or more indexes are sharing the same prefix and the predicate is on that prefix.
For example: <code>indexA</code> is on (c1, c2), <code>indexB</code> is on (c1, c3) and the predicate is on c1 (c1 = 100).
In this case, the query optimizer picks the first index in the order of their names, e.g., <code>indexA</code>.</p>
</li>
<li>
<p>No indexes share the same prefix and the predicate refers to fields from each individual index.
For example: <code>indexA</code> in on (c1) and <code>indexB</code> is on (c2), the predicate is on c1 and c2 (c1 = 100 and c2 = 200).
In this case, both indexes will be used to retrieve matched primary keys and
then the key sets will be intersected to further filter retrieved primary keys.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Join_queries"><a class="anchor" href="#Join_queries"></a>Join Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>N1QL for Analytics supports joins from standard SQL in the following forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inner join:</p>
<div class="literalblock">
<div class="content">
<pre>SELECT * FROM ds_outer, ds_inner WHERE &lt;predicate&gt;;
SELECT * FROM ds_outer JOIN ds_inner ON &lt;predicate&gt;;</pre>
</div>
</div>
</li>
<li>
<p>Left outer join:</p>
<div class="literalblock">
<div class="content">
<pre>SELECT * FROM ds_outer LEFT OUTER JOIN ds_inner ON &lt;predicate&gt;;</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>ds_outer is the <code>outer</code> branch and ds_inner is the <code>inner</code> branch
(in the order in which they appear in the FROM clause).</p>
</div>
<div class="paragraph">
<p>The query optimizer picks an index for join evaluation if the following conditions are met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The join predicate is an equality or range predicate that refers to fields from both branches of the join,
in the form of:</p>
<div class="literalblock">
<div class="content">
<pre>fn(expr_outer) /*+ indexnl */ op field_inner</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>op</code> is <code>&lt;</code>, <code>&lt;=</code>, <code>=</code>, <code>&gt;=</code>, <code>&gt;</code>, or <code>BETWEEN</code>;</p>
</div>
</li>
<li>
<p><code>field_inner</code> is a field from the inner dataset on which the index is defined;</p>
</li>
<li>
<p>The index join hint, <code>/*+ indexnl */</code>, is provided for the join predicate;</p>
</li>
<li>
<p><code>fn()</code> is a function that returns the same data type as the type specified in the index for the <code>field_inner</code>.
Usually, <code>fn()</code> is one of the following: to_string(), to_double(), or to_bigint().</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that if the type of <code>expr_outer</code> is not known at compile time therefore the index join cannot be
selected if the join predicate is just <code>expr_outer /*+ indexnl */ op field_inner</code>.</p>
</div>
<div class="paragraph">
<p>For example, suppose there are two shadow datasets, foo1 and foo2, with an index on foo2:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CREATE index idx_f2 ON foo2(c_s2:string);</pre>
</div>
</div>
<div class="paragraph">
<p>Then the following query would use this index for join evaluation:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT f1.c_x1 as c1, f2.c_x2 as c2
FROM foo1 AS f1, foo2 AS f2
WHERE to_string(f1.c_s1)  /*+ indexnl */ = f2.c_s2</pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
