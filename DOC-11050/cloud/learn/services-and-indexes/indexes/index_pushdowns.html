<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>Index Pushdowns | Couchbase Docs (Preview)</title>
<link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-11050/cloud/learn/services-and-indexes/indexes/index_pushdowns.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Index Pushdowns are performance optimizations where the Query engine pushes more of the work down to the Indexer.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="cloud">
<meta name="dcterms.identifier" content="">
<meta name="page-url" content="/cloud/learn/services-and-indexes/indexes/index_pushdowns.html">
<meta name="page-nav-header-levels" content="1">
<meta name="generator" content="Antora 3.1.4">
<link rel="icon" href="../../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://simon-dew.github.io/docs-site/DOC-11050/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://simon-dew.github.io/docs-site/DOC-11050/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/pages/services-and-indexes/indexes/index_pushdowns.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../../index.html">Couchbase Capella</a></li>
<li class="crumb">Develop</li>
<li class="crumb"><a href="../../../n1ql/query.html">Query Data with SQL++</a></li>
<li class="crumb"><a href="global-secondary-indexes.html">Primary and Secondary Index Reference</a></li>
<li class="crumb"><a href="index_pushdowns.html">Index Pushdowns</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Index Pushdowns</h1>
<div class="labels">
<ul>
<li class="concept"><span><i class="far fa-lightbulb"></i> concept</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Index Pushdowns are performance optimizations where the Query engine pushes more of the work down to the Indexer.
</blockquote>
</div>
<div class="paragraph">
<p>The GSI Indexes are a vital part of query performance and are tightly coupled with the Query engine.
The Query engine implements many query processing optimizations to achieve the best possible performance for SQL++ queries.</p>
</div>
<div class="paragraph">
<p>Query Indexer not only indexes data, it also supports various operations such as point scans, range scans, array indexing, sort order, and pagination.
The Query engine tries to leverage the indexer functionality as much as possible by pushing down operations to the indexer as part of the index scan.
This helps performance, predominantly, in two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Minimize the amount of data transferred from Indexer nodes to Query nodes.</p>
</li>
<li>
<p>Minimize the amount of processing done at Query nodes.</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Examples on this Page</div>
<div class="paragraph">
<p>The examples in this topic use the travel-sample dataset which is supplied with Couchbase Capella.
For instructions on how to install the sample data, see <a href="../../../clusters/data-service/import-data-documents.html#import-overview" class="xref page">Import Sample Data</a>.</p>
</div>
<div class="paragraph">
<p>To use the examples on this page, you must set the query context to the <code>inventory</code> scope in the travel sample dataset.
For more information, see <a href="../../../n1ql/n1ql-intro/queriesandresults.html#query-context" class="xref page">Query Context</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index-projection"><a class="anchor" href="#index-projection"></a>Index Projection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When processing a SELECT or DML with a WHERE clause, the Query engine picks one or more qualified indexes to be used for the query.
Note that each index will have document field names explicitly specified as index-keys, and some metadata fields, such as <code>meta().id</code>, implicitly stored in the index.
The Query engine requests the exact list of fields needed for the query.
For a covered query, it is the fields referred in projection, predicate, GROUP BY clauses, ORDER BY clauses, HAVING clauses, ON key, and subqueries of the query.
For non-covered queries, it is just <code>META().id</code>.</p>
</div>
<div class="paragraph">
<p>For example, consider the following index and query:</p>
</div>
<div id="example-simple" class="exampleblock">
<div class="title">Example 1. Index Projection</div>
<div class="content">
<div class="paragraph">
<p>This example uses the <code>def_inventory_route_route_src_dst_day</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX def_inventory_route_route_src_dst_day
ON route(sourceairport, destinationairport,
   (DISTINCT (ARRAY (v.day) FOR v IN schedule END)));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT sourceairport FROM route
USE INDEX (def_inventory_route_route_src_dst_day)
WHERE sourceairport = "SFO"
LIMIT 1;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-simple.jsonc#L2-L29">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "DistinctScan",
            "limit": "1",
            "scan": {
              "#operator": "IndexScan3",
              "bucket": "travel-sample",
              "covers": [
                "cover ((`route`.`sourceairport`))",
                "cover ((`route`.`destinationairport`))",
                "cover ((distinct (array (`v`.`day`) for `v` in (`route`.`schedule`) end)))",
                "cover ((meta(`route`).`id`))"
              ],
              "filter": "(cover ((`route`.`sourceairport`)) = \"SFO\")",
              "index": "def_inventory_route_route_src_dst_day",
              "index_id": "e7eb4b4555f90179",
              "index_projection": {
                "entry_keys": [ <i class="conum" data-value="1"></i><b>(1)</b>
                  0
                ],
                "primary_key": true <i class="conum" data-value="2"></i><b>(2)</b>
              },</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query refers to fields <code>sourceairport</code> and <code>type</code>.
The index is wider in scope, that is, it has <code>sourceairport</code>, <code>destinationairport</code>, <code>schedule.day</code>, and <code>type</code> fields.</p>
</div>
<div class="paragraph">
<p>So, for each matching document, the query requires only a subset of the data stored in the index.
With index-projection support, the Query engine indicates the exact data requested as part of the index-scan.
In this example,</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>entry_keys</code> in the EXPLAIN output indicate the exact index-key fields that should be returned in the index-scan result.
This has only one entry (<code>0</code>) indicating the first index-key <code>sourceairport</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Also, the <code>primary_key</code> indicates whether the index should return the primary key <code>meta().id</code> of the matching document.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that in some cases (such as when <code>distinctScan</code> or <code>intersectScan</code> are used, as in this example), the primary key <code>meta().id</code> may be retrieved even though the query doesn’t explicitly specify it in the query.
Without this optimization, index-scan would return all the index-keys defined in the index.
If the <code>index_projection</code> field is missing in the EXPLAIN output, then Indexer would return all index-keys.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="predicate-pushdown"><a class="anchor" href="#predicate-pushdown"></a>Predicate Pushdown</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Query engine and GSI indexes support many optimizations for efficiently processing predicate push-downs.
In general, this performance optimization is leveraged when the Query engine decides to use an Index-scan for processing a query, and whole or partial predicates can be pushed to the indexer to filter documents of interest to the query.</p>
</div>
<div class="paragraph">
<p>For example, in the above query <a href="#example-simple">Example 1</a> with a simple WHERE clause, the predicate (<code>sourceairport = "SFO"</code>) is pushed to the index <code>def_inventory_route_route_src_dst_day</code> with the following single <code>span</code> and <code>range</code>.
These attributes exactly define different characteristics of the index scan:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Predicate Pushdown</div>
<div class="content">
<div class="paragraph">
<p>The <code>span</code> and <code>range</code> from the EXPLAIN output of <a href="#example-simple">Example 1</a>.</p>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-simple.jsonc#L35-L46">              "spans": [
                {
                  "exact": true,
                  "range": [
                    {
                      "high": "\"SFO\"",
                      "inclusion": 3,
                      "low": "\"SFO\""
                    }
                  ]
                }
              ],</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Each Span defines details about one index-key summarizing corresponding predicate conditions into a range-scan lookup for the index.
In this example, the predicate condition (<code>sourceairport = "SFO"</code>) translates to one span with one range that specifies both <code>low</code> and <code>high</code> values of "SFO" (to imply equals condition).</p>
</li>
<li>
<p>Refer to section <a href="index-scans.html" class="xref page">Scans</a> for more information.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="composite-predicate-pushdown"><a class="anchor" href="#composite-predicate-pushdown"></a>Composite Predicate Pushdown</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compound or composite predicates are those with multiple conditions on different fields of the document.
When the predicate is conjunctive with multiple AND conditions, then a single <code>span</code> with multiple <code>ranges</code> are specified in the index-scan request.
When the predicate is disjunctive, then multiple <code>spans</code> are specified.
See <a href="index-scans.html" class="xref page">Scans</a>
for more details and examples on how predicate pushdown works for various types of index-scans as well as the conjunctive predicate AND and the disjunctive predicate OR.</p>
</div>
<div class="sect2">
<h3 id="index-key-order-and-structure"><a class="anchor" href="#index-key-order-and-structure"></a>Index Key Order and Structure</h3>
<div class="paragraph">
<p>Composite indexes have more than one index key, and the order of the index keys is important for any lookup or scan of the index, because the indexes structure all the indexed entries in linearized default collation sorted order of all the index-keys.
For example, consider the following hypothetical index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX `idx_age_name` ON users(age, name);</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/services-and-indexes/indexes/IndexKeyOrder.png" alt="IndexKeyOrder" width="570">
</div>
</div>
<div class="paragraph">
<p>Various age and name values are stored in the index in a tree-like structure, represented in simplified form in the diagram above, with all the index key values linearly sorted as ordered pairs.
For instance,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The diagram above shows index-entries with all names in sorted order with an age of 20 followed by the entries for age 21 and related names.</p>
</li>
<li>
<p>The arrowed paths logically depict how an index lookup or scan would find entries in the index.</p>
</li>
<li>
<p>A point lookup query for <code>age=20 AND name="joe"</code> may follow arrows labelled <strong>p1</strong>.</p>
</li>
<li>
<p>Similarly, a range scan for <code>(age BETWEEN 20 and 21) AND (name="joe")</code> may find entries of interest between the paths labelled <strong>p1</strong> and <strong>p2</strong> (highlighted in green).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This range may include some unwanted entries (such as "mark", "abby", "anne") which will be filtered subsequently.</p>
</div>
<div class="paragraph">
<p>Queries with predicates such as <code>(age = 20) AND (name BETWEEN "joe" and "mark")</code> will need all the entries found using range scans.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In general, when the predicate has a range condition on prefixing index-keys (such as <code>age</code>) may produce unwanted results from the range-scan index-lookups.
In Couchbase Capella, the Query service and Indexer are enhanced with complete and accurate predicate pushdown to filter such unnecessary results in the Indexer itself.
This improves query performance as it saves the additional overhead in transferring the unwanted data/results to query nodes and subsequently filtering the results.
This is explained with an example in the following section: <a href="#range-scan-prefix">Composite Predicate with Range Scan on Prefix Index-Keys</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="range-scan-prefix"><a class="anchor" href="#range-scan-prefix"></a>Composite Predicate with Range Scan on Prefix Index-Keys</h3>
<div class="paragraph">
<p>The Query engine supports efficient predicate pushdown to indexes in the cases when the WHERE clause has a range predicate on any of the prefixing index-keys.</p>
</div>
<div class="paragraph">
<p>Consider the following query, which finds all destination airports within 2000 miles of LAX.</p>
</div>
<div id="example-comp-explain" class="exampleblock">
<div class="title">Example 3. Composite Predicate with Range Scan</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_route_src_dst_dist
ON route(distance, sourceairport, destinationairport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT destinationairport
FROM route
USE INDEX (idx_route_src_dst_dist)
WHERE distance &lt; 2000 AND sourceairport = "LAX"; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this query, the predicate has the range condition on the first index-key <code>distance</code> and an equality predicate on the 2nd index-key <code>sourceairport</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-comp-explain.jsonc#L2-L44">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3",
        "bucket": "travel-sample",
        "covers": [
          "cover ((`route`.`distance`))",
          "cover ((`route`.`sourceairport`))",
          "cover ((`route`.`destinationairport`))",
          "cover ((meta(`route`).`id`))"
        ],
        "filter": "((cover ((`route`.`distance`)) &lt; 2000) and (cover ((`route`.`sourceairport`)) = \"LAX\"))",
        "index": "idx_route_src_dst_dist",
        "index_id": "6a502445eefe20b5",
        "index_projection": {
          "entry_keys": [
            0,
            1,
            2
          ]
        },
        "keyspace": "route",
        "namespace": "default",
        "scope": "inventory",
        "spans": [ <i class="conum" data-value="1"></i><b>(1)</b>
          {
            "exact": true,
            "range": [ <i class="conum" data-value="2"></i><b>(2)</b>
              {
                "high": "2000", <i class="conum" data-value="3"></i><b>(3)</b>
                "inclusion": 0,
                "low": "null"
              },
              {
                "high": "\"LAX\"", <i class="conum" data-value="4"></i><b>(4)</b>
                "inclusion": 3,
                "low": "\"LAX\""
              }
            ]
          }
        ],</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>spans</code> attribute of the EXPLAIN query plan output shows that the predicate is accurately represented and pushed-down to the indexer.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>range[]</code> attribute is an array of the predicate bounds for individual index-keys involved in the compound predicate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first element of <code>range[]</code> corresponds to the index-key <code>distance</code> with (<code>low</code>, <code>high</code>) values (<code>null</code>, <code>2000</code>) respectively.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The second element of <code>range[]</code> corresponds to the index-key <code>sourceairport</code> with (<code>low</code>, <code>high</code>) values (<code>"LAX"</code>, <code>"LAX"</code>) representing equals condition.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Indexer processes the lookup request and exactly returns only the documents matching the predicate conditions.
For example, when you <a href="../../../../server/current/manage/monitor/monitoring-n1ql-query.html" class="xref page">enable monitoring</a> with the configuration parameter <code>profile = "timings"</code> for this query, you can see that the indexer returns 165 documents, which is the same as the final result set of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-comp-plan.jsonc">    "~children": [
      {
        "#operator": "IndexScan3",
        "#stats": {
          "#heartbeatYields": 54,
          "#itemsOut": 165,
          "#phaseSwitches": 663,
          "execTime": "462.968µs",
          "kernTime": "638.333µs",
          "servTime": "38.110289ms"
        },
// ...
      {
        "#operator": "Stream",
        "#stats": {
          "#itemsIn": 165,
          "#itemsOut": 165,
          "#phaseSwitches": 166,
          "execTime": "354.652µs"
        }
      }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="composite-predicate-with-skip-key-range-scan"><a class="anchor" href="#composite-predicate-with-skip-key-range-scan"></a>Composite Predicate with Skip-Key Range Scan</h3>
<div class="paragraph">
<p>In <a href="#example-comp-explain">Example 3</a> above, the query has a composite predicate on continuous leading index-keys, namely the index-keys <code>distance</code> and <code>sourceairport</code>, which occur together at the start of the index definition.
In Couchbase Capella, it is possible to push down a composite predicate on non-continuous leading index-keys.
There must be a predicate on the first key in the index definition, and then on any of the subsequent index-keys.</p>
</div>
<div class="paragraph">
<p>Consider the following query, which is a variant of the query in <a href="#example-comp-explain">Example 3</a> above, and uses the same index.</p>
</div>
<div id="example-skip" class="exampleblock">
<div class="title">Example 4. Composite Predicate with Skip-Key Range Scan</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT sourceairport
FROM route
USE INDEX (idx_route_src_dst_dist)
WHERE distance &lt; 2000 AND destinationairport = "LAX"; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This query has a range predicate on the first index-key <code>distance</code> and an equality predicate on the 3rd index-key <code>destinationairport</code>.
There is no predicate on the 2nd index-key <code>sourceairport</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-skip.jsonc#L2-L48">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IndexScan3",
          "bucket": "travel-sample",
          "covers": [
            "cover ((`route`.`distance`))",
            "cover ((`route`.`sourceairport`))",
            "cover ((`route`.`destinationairport`))",
            "cover ((meta(`route`).`id`))"
          ],
          "filter": "((cover ((`route`.`distance`)) &lt; 2000) and (cover ((`route`.`destinationairport`)) = \"LAX\"))",
          "index": "idx_route_src_dst_dist",
          "index_id": "6a502445eefe20b5",
          "index_projection": {
            "entry_keys": [
              0,
              1,
              2
            ]
          },
          "keyspace": "route",
          "namespace": "default",
          "scope": "inventory",
          "spans": [ <i class="conum" data-value="1"></i><b>(1)</b>
            {
              "exact": true,
              "range": [
                {
                  "high": "2000", <i class="conum" data-value="2"></i><b>(2)</b>
                  "inclusion": 0,
                  "low": "null"
                },
                {
                  "inclusion": 0 <i class="conum" data-value="3"></i><b>(3)</b>
                },
                {
                  "high": "\"LAX\"", <i class="conum" data-value="4"></i><b>(4)</b>
                  "inclusion": 3,
                  "low": "\"LAX\""
                }
              ]
            }
          ],</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The EXPLAIN query plan output shows that the predicate is pushed-down to the indexer.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The first element of <code>range[]</code> corresponds to the index-key <code>distance</code> with (<code>low</code>, <code>high</code>) values (<code>null</code>, <code>2000</code>) respectively.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The second element of <code>range[]</code> corresponds to the index-key <code>sourceairport</code> with no low or high bounds, i.e. a whole range scan.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The third element of <code>range[]</code> corresponds to the index-key <code>destinationairport</code> with (<code>low</code>, <code>high</code>) values (<code>"LAX"</code>, <code>"LAX"</code>) representing equals condition.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By skipping the index-key that does not have a predicate, and including all the non-continuous index-keys that do have predicates, the query uses the index more effectively and reduces the number of documents that need to be fetched.
This increases query preparation time a little, but vastly speeds up the execution of the query.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pagination-pushdown"><a class="anchor" href="#pagination-pushdown"></a>Pagination Pushdown</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pagination in SQL++ queries is achieved by using the LIMIT and OFFSET clauses, and both of the operators can be pushed to indexer whenever possible.
These operators may not always be pushed to Indexer, depending on the following factors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whether or not the whole predicate in the WHERE clause can be completely and accurately pushed to a single index.</p>
</li>
<li>
<p>When using IntersectScan, the Query engine uses multiple indexes to process the query.
As such, LIMIT/OFFSET will need to be processed in the Query engine at a later stage of query processing, and hence cannot be pushed to the Indexer.</p>
</li>
<li>
<p>Whether or not the SELECT query has other clauses that may impact pagination, such as ORDER BY or JOIN.
For example,</p>
<div class="ulist">
<ul>
<li>
<p>When ORDER BY key in the query is different from that of the index order, then the query layer will need to process the sort; and hence, in those cases, the pagination cannot be pushed to the indexer as shown in <a href="#example-page-3">Example 7</a> below.</p>
</li>
<li>
<p>For JOIN queries, index scans can be used only for the left side keyspace.
Subsequent JOIN phrases may filter some documents, after which only LIMIT/OFFSET can be applied.
Hence, the pagination operators cannot be pushed when a query has JOIN clauses.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="example-page-1" class="exampleblock">
<div class="title">Example 5. Pagination with Secondary Index</div>
<div class="content">
<div class="paragraph">
<p>When using a secondary index, both LIMIT and OFFSET operators are pushed to the index.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT * FROM landmark
WHERE city = "San Francisco"
OFFSET  4000  LIMIT 10000;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-page-1.jsonc#L2-L33">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "index": "def_inventory_landmark_city",
            "index_id": "39eb8e83720948f",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "landmark",
            "limit": "10000", <i class="conum" data-value="1"></i><b>(1)</b>
            "namespace": "default",
            "offset": "4000", <i class="conum" data-value="2"></i><b>(2)</b>
            "scope": "inventory",
            "spans": [
              {
                "exact": true,
                "range": [
                  {
                    "high": "\"San Francisco\"",
                    "inclusion": 3,
                    "low": "\"San Francisco\""
                  }
                ]
              }
            ],</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>IndexScan3</code> operator handles <code>limit</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>IndexScan3</code> operator handles <code>offset</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="example-page-2" class="exampleblock">
<div class="title">Example 6. Pagination with Primary Index</div>
<div class="content">
<div class="paragraph">
<p>When using a primary index, both LIMIT and OFFSET operators are pushed to the Indexer.
This example uses the <code>def_inventory_landmark_primary</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE PRIMARY INDEX `def_inventory_landmark_primary`
  ON landmark;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT * FROM landmark
OFFSET  4000  LIMIT 10000;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-page-2.jsonc#L2-L22">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "PrimaryScan3",
            "bucket": "travel-sample",
            "index": "def_inventory_landmark_primary",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "landmark",
            "limit": "10000", <i class="conum" data-value="1"></i><b>(1)</b>
            "namespace": "default",
            "offset": "4000", <i class="conum" data-value="2"></i><b>(2)</b>
            "scope": "inventory",
            "using": "gsi"
          },</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>PrimaryScan3</code> operator handles <code>limit</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>PrimaryScan3</code> operator handles <code>offset</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="example-page-3" class="exampleblock">
<div class="title">Example 7. Pagination with Different Index Order</div>
<div class="content">
<div class="paragraph">
<p>LIMIT and OFFSET operators are not pushed to the Indexer when the index order is different from that specified in the ORDER BY.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT * FROM landmark
USE INDEX(def_inventory_landmark_city)
WHERE city = "San Francisco"
ORDER BY name
OFFSET  4000  LIMIT 10000;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-page-3.jsonc">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3", <i class="conum" data-value="1"></i><b>(1)</b>
            "bucket": "travel-sample",
            "index": "def_inventory_landmark_city",
            "index_id": "39eb8e83720948f",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "landmark",
            "namespace": "default",
            "scope": "inventory",
// ...
      {
        "#operator": "Order",
        "limit": "10000",
        "offset": "4000",
        "sort_terms": [
          {
            "expr": "(`landmark`.`name`)"
          }
        ]
      },
      {
        "#operator": "Offset", <i class="conum" data-value="2"></i><b>(2)</b>
        "expr": "4000"
      },
      {
        "#operator": "Limit", <i class="conum" data-value="3"></i><b>(3)</b>
        "expr": "10000"
      }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>IndexScan3</code> operator does not handle <code>offset</code> or <code>limit</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Offset operator is handled by the Query engine.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The Limit operator is handled by the Query engine.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-index-order"><a class="anchor" href="#using-index-order"></a>Using Index Order</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Query engine may avoid ORDER BY processing in cases where the ordering of entries in the index can be leveraged for the query.
The Query engine carefully evaluates each query to decide whether ORDER BY keys are aligned with the index key order.
For example, ORDER BY may not be pushed down when the ORDER BY fields are not aligned with the index-key order defining the index.</p>
</div>
<div id="example-idx-1" class="exampleblock">
<div class="title">Example 8. Ascending Sort by String Field</div>
<div class="content">
<div class="paragraph">
<p>Find all cities that start with "San", and sort the results by the city name in ascending order.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT city FROM landmark
WHERE city LIKE "San%"
ORDER BY city;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`city`))",
              "cover ((meta(`landmark`).`id`))"
            ],
            "filter": "(cover ((`landmark`.`city`)) like \"San%\")",
            "index": "def_inventory_landmark_city",
// ...
                {
                  "#operator": "InitialProject",
                  "result_terms": [
                    {
                      "expr": "cover ((`landmark`.`city`))"
                    }
                  ]
                } <i class="conum" data-value="1"></i><b>(1)</b>
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, you can see that the query plan does not have an ORDER operator before the final projection.
That means order pushdown is being leveraged, and the query is relying on the index order.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="example-idx-2" class="exampleblock">
<div class="title">Example 9. Ascending Sort by Primary Key</div>
<div class="content">
<div class="paragraph">
<p>Find all cities that start with "San", and sort the results by the document primary key in ascending order.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT city FROM landmark
WHERE city LIKE "San%"
ORDER BY meta().id;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-idx-2.jsonc">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`city`))",
              "cover ((meta(`landmark`).`id`))"
            ],
            "filter": "(cover ((`landmark`.`city`)) like \"San%\")",
            "index": "def_inventory_landmark_city",
// ...
                {
                  "#operator": "InitialProject",
                  "result_terms": [
                    {
                      "expr": "cover ((`landmark`.`city`))"
                    }
                  ]
                }
              ]
            }
          }
        ]
      },
      {
        "#operator": "Order", <i class="conum" data-value="1"></i><b>(1)</b>
        "sort_terms": [
          {
            "expr": "cover ((meta(`landmark`).`id`))"
          }
        ]
      }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, you can see an additional ORDER operator before the final projection, because the ORDER BY field <code>meta().id</code> is different from the index order key <code>city</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<h3 id="limitation" class="discrete">Limitation</h3>
<div class="paragraph">
<p>Currently the Query engine supports order pushdown only when the ORDER BY keys are aligned with the Index order.
But reverse-scan of the index is not supported.</p>
</div>
<div class="paragraph">
<p>For example, in <a href="#example-idx-1">Example 8</a> above, you can see that the query plan does not have an ORDER operator before the final projection, because the index order is the same as the ascending order specified in the query.
Similarly, in the following example <a href="#example-idx-3">Example 10</a>, the ORDER BY clause has DESC, and that matches with the index order defined by the index <code>idx_landmark_city_desc</code>.</p>
</div>
<div class="paragraph">
<p>However, the ASC order in <a href="#example-idx-1">Example 8</a> will not be able to leverage the index order in the index <code>idx_landmark_city_desc</code>, nor will the DESC order in <a href="#example-idx-3">Example 10</a> be able to leverage the index order in the index <code>def_inventory_landmark_city</code>.</p>
</div>
<div id="example-idx-3" class="exampleblock">
<div class="title">Example 10. Descending Sort by String Field</div>
<div class="content">
<div class="paragraph">
<p>Descending variation of <a href="#example-idx-1">Example 8</a>.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_landmark_city_desc ON landmark(city DESC);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT city FROM landmark
WHERE city LIKE "San%"
ORDER BY city DESC;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-idx-3.jsonc">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`city`))",
              "cover ((meta(`landmark`).`id`))"
            ],
            "filter": "(cover ((`landmark`.`city`)) like \"San%\")",
            "index": "idx_landmark_city_desc",
            "index_id": "efc36547ec1c0f00",
            "index_order": [
              {
                "desc": true,
                "keypos": 0
              }
// ...
                {
                  "#operator": "InitialProject",
                  "result_terms": [
                    {
                      "expr": "cover ((`landmark`.`city`))"
                    }
                  ]
                }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="operator-pushdowns"><a class="anchor" href="#operator-pushdowns"></a>Operator Pushdowns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Query engine tries to avoid unnecessary processing operators such as MIN(), MAX(), and COUNT(), which can be processed by the Indexer much more efficiently.
In such cases, the Query engine pushes down necessary hints or options to the Indexer to process the following operators.</p>
</div>
<div class="sect2">
<h3 id="max-pushdown"><a class="anchor" href="#max-pushdown"></a>MAX() Pushdown</h3>
<div class="paragraph">
<p>This function returns the highest value of the input field based on the default collation rules. (For details, see <a href="../../../n1ql/n1ql-language-reference/datatypes.html" class="xref page">Data types</a> and <a href="../../../n1ql/n1ql-language-reference/comparisonops.html" class="xref page">Comparison Operators</a>.)</p>
</div>
<div class="paragraph">
<p>MAX() can be pushed to the Indexer even if the index was not created with matching index keys or sort order.</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. MAX of a String Field</div>
<div class="content">
<div class="paragraph">
<p>Find the alphabetically highest city name in the <code>landmark</code> collection.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT MAX(city)
FROM landmark
USE INDEX (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-max.jsonc#L2-L25">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3",
        "bucket": "travel-sample",
        "covers": [
          "cover ((`landmark`.`city`))",
          "cover ((meta(`landmark`).`id`))",
          "cover (max(cover ((`landmark`.`city`))))"
        ],
        "index": "def_inventory_landmark_city",
        "index_group_aggs": {
          "aggregates": [
            {
              "aggregate": "MAX",
              "depends": [
                0
              ],
              "expr": "cover ((`landmark`.`city`))",
              "id": 2,
              "keypos": 0
            }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="min-pushdown"><a class="anchor" href="#min-pushdown"></a>MIN() Pushdown</h3>
<div class="paragraph">
<p>This function returns the lowest value of the input field based on the default collation rules. (For details, see <a href="../../../n1ql/n1ql-language-reference/datatypes.html" class="xref page">Data types</a> and <a href="../../../n1ql/n1ql-language-reference/comparisonops.html" class="xref page">Comparison Operators</a>.)</p>
</div>
<div class="paragraph">
<p>MIN() can be pushed to the Indexer even if the index was not created with matching index keys or sort order.</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. MIN of a String Field</div>
<div class="content">
<div class="paragraph">
<p>Find the alphabetically lowest city name in the <code>landmark</code> collection.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT MIN(city)
FROM landmark
USE INDEX (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-min.jsonc#L2-L25">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3",
        "bucket": "travel-sample",
        "covers": [
          "cover ((`landmark`.`city`))",
          "cover ((meta(`landmark`).`id`))",
          "cover (min(cover ((`landmark`.`city`))))"
        ],
        "index": "def_inventory_landmark_city",
        "index_group_aggs": {
          "aggregates": [
            {
              "aggregate": "MIN",
              "depends": [
                0
              ],
              "expr": "cover ((`landmark`.`city`))",
              "id": 2,
              "keypos": 0
            }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="count-pushdown"><a class="anchor" href="#count-pushdown"></a>COUNT() Pushdown</h3>
<div class="paragraph">
<p>This function returns the total number of non-Null values of an input field from the matching documents of an index scan.</p>
</div>
<div id="example-count-out" class="exampleblock">
<div class="title">Example 13. Count of a String Field</div>
<div class="content">
<div class="paragraph">
<p>Find the number of cities entered in the <code>landmark</code> collection.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(city) AS NumberOfCities
FROM landmark
USE INDEX (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "NumberOfCities": 4479
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="example-count-plan" class="exampleblock">
<div class="title">Example 14. Count Details</div>
<div class="content">
<div class="paragraph">
<p>The details behind <a href="#example-count-out">Example 13</a>.</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT COUNT(city) AS NumberOfCities
FROM landmark
USE INDEX (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-count.jsonc#L2-L25">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3", <i class="conum" data-value="1"></i><b>(1)</b>
        "bucket": "travel-sample",
        "covers": [
          "cover ((`landmark`.`city`))",
          "cover ((meta(`landmark`).`id`))",
          "cover (count(cover ((`landmark`.`city`))))"
        ],
        "index": "def_inventory_landmark_city",
        "index_group_aggs": {
          "aggregates": [
            {
              "aggregate": "COUNT",
              "depends": [
                0
              ],
              "expr": "cover ((`landmark`.`city`))",
              "id": 2,
              "keypos": 0
            }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The index operator <code>IndexCountScan3</code> counts values so the Query Service does not need to do additional processing.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="countdistinct-pushdown"><a class="anchor" href="#countdistinct-pushdown"></a>COUNT(DISTINCT) Pushdown</h3>
<div class="paragraph">
<p>This function returns the total number of unique non-Null values of an input field from the matching documents of an index scan.</p>
</div>
<div id="example-distinct-out" class="exampleblock">
<div class="title">Example 15. Count Distinct of a String Field</div>
<div class="content">
<div class="paragraph">
<p>Find the number of unique city names in the <code>landmark</code> collection.
This example uses the <code>def_inventory_landmark_city</code> index that comes pre-installed and can be made by the statement:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-def-city.n1ql">CREATE INDEX def_inventory_landmark_city ON landmark(city);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT (DISTINCT city) AS NumberOfDistinctCities
FROM landmark
USE index (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "NumberOfDistinctCities": 625
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="example-distinct-plan" class="exampleblock">
<div class="title">Example 16. Count Distinct Details</div>
<div class="content">
<div class="paragraph">
<p>The details behind <a href="#example-distinct-out">Example 15</a>.</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT COUNT (DISTINCT city) AS NumberOfDistinctCities
FROM landmark
USE index (def_inventory_landmark_city)
WHERE city IS NOT NULL;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/simondew/GitHub/couchbaselabs/docs-devex/modules/learn/examples/services-and-indexes/indexes/pushdown-distinct.jsonc#L2-L26">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3", <i class="conum" data-value="1"></i><b>(1)</b>
        "bucket": "travel-sample",
        "covers": [
          "cover ((`landmark`.`city`))",
          "cover ((meta(`landmark`).`id`))",
          "cover (count(DISTINCT cover ((`landmark`.`city`))))"
        ],
        "index": "def_inventory_landmark_city",
        "index_group_aggs": {
          "aggregates": [
            {
              "aggregate": "COUNT",
              "depends": [
                0
              ],
              "distinct": true,
              "expr": "cover ((`landmark`.`city`))",
              "id": 2,
              "keypos": 0
            }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The index operator <code>IndexCountScan3</code> counts distinct values so the Query Service does not need to do additional processing.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-links"><a class="anchor" href="#related-links"></a>Related Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="index-scans.html#query-execution-details" class="xref page">Query Execution: Details</a></p>
</li>
<li>
<p><a href="../../../n1ql/n1ql-language-reference/covering-indexes.html" class="xref page">Covering Indexes</a></p>
</li>
<li>
<p><a href="../../../n1ql/n1ql-language-reference/groupby-aggregate-performance.html" class="xref page">Grouping and Aggregate Pushdown</a></p>
</li>
<li>
<p><a href="early-filters-and-pagination.html" class="xref page">Early Filters, Ordering and Pagination</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Capella","components":["cloud"],"url":"/cloud/index.html","latestVersions":{"cloud":""}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
