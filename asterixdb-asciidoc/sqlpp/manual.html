<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/asciidoc/sqlpp/manual.adoc at 2020-01-28
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200128" />
    <meta http-equiv="Content-Language" content="en" />
    <title>AsterixDB &#x2013; </title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script type="text/javascript" src="../js/apache-maven-fluido-1.7.min.js"></script>

  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href=".././" id="bannerLeft"><img src="../images/asterixlogo.png"  alt="AsterixDB"/></a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-01-28</li>
      <li id="projectVersion" class="pull-right">Version: 0.9.5-SNAPSHOT</li>
      <li class="pull-right"><a href="../index.html" title="Documentation Home">Documentation Home</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Get Started - Installation</li>
    <li><a href="../ncservice.html" title="Option 1: using NCService"><span class="none"></span>Option 1: using NCService</a></li>
    <li><a href="../ansible.html" title="Option 2: using Ansible"><span class="none"></span>Option 2: using Ansible</a></li>
    <li><a href="../aws.html" title="Option 3: using Amazon Web Services"><span class="none"></span>Option 3: using Amazon Web Services</a></li>
      <li class="nav-header">AsterixDB Primer</li>
    <li><a href="../sqlpp/primer-sqlpp.html" title="Using SQL++"><span class="none"></span>Using SQL++</a></li>
      <li class="nav-header">Data Model</li>
    <li><a href="../datamodel.html" title="The Asterix Data Model"><span class="none"></span>The Asterix Data Model</a></li>
      <li class="nav-header">Queries</li>
    <li class="active"><a href="#"><span class="none"></span>The SQL++ Query Language</a></li>
    <li><a href="../sqlpp/builtins.html" title="Builtin Functions"><span class="none"></span>Builtin Functions</a></li>
      <li class="nav-header">API/SDK</li>
    <li><a href="../api.html" title="HTTP API"><span class="none"></span>HTTP API</a></li>
    <li><a href="../csv.html" title="CSV Output"><span class="none"></span>CSV Output</a></li>
      <li class="nav-header">Advanced Features</li>
    <li><a href="../aql/externaldata.html" title="Accessing External Data"><span class="none"></span>Accessing External Data</a></li>
    <li><a href="../feeds.html" title="Data Ingestion with Feeds"><span class="none"></span>Data Ingestion with Feeds</a></li>
    <li><a href="../udf.html" title="User Defined Functions"><span class="none"></span>User Defined Functions</a></li>
    <li><a href="../sqlpp/filters.html" title="Filter-Based LSM Index Acceleration"><span class="none"></span>Filter-Based LSM Index Acceleration</a></li>
    <li><a href="../sqlpp/fulltext.html" title="Support of Full-text Queries"><span class="none"></span>Support of Full-text Queries</a></li>
    <li><a href="../sqlpp/similarity.html" title="Support of Similarity Queries"><span class="none"></span>Support of Similarity Queries</a></li>
      <li class="nav-header">Deprecated</li>
    <li><a href="../aql/primer.html" title="AsterixDB Primer: Using AQL"><span class="none"></span>AsterixDB Primer: Using AQL</a></li>
    <li><a href="../aql/manual.html" title="Queries: The Asterix Query Language (AQL)"><span class="none"></span>Queries: The Asterix Query Language (AQL)</a></li>
    <li><a href="../aql/builtins.html" title="Queries: Builtin Functions (AQL)"><span class="none"></span>Queries: Builtin Functions (AQL)</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href=".././" title="AsterixDB" class="builtBy"><img class="builtBy"  alt="AsterixDB" src="../images/asterixlogo.png"    /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>The Query Language</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#expressions">2. Expressions</a></li>
<li><a href="#queries">3. Queries</a></li>
<li><a href="#errors">4. Errors</a></li>
<li><a href="#ddl-and-dml-statements">5. DDL and DML statements</a></li>
<li><a href="#appendix-1.-reserved-keywords">Appendix 1. Reserved keywords</a></li>
<li><a href="#appendix-2.-performance-tuning">Appendix 2. Performance Tuning</a></li>
<li><a href="#appendix-3.-variable-bindings-and-name-resolution">Appendix 3. Variable Bindings and Name Resolution</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is intended as a reference guide to the full syntax and
semantics of AsterixDB&#8217;s query language, a SQL-based language for
working with semistructured data. The language is a derivative of SQL,
a declarative query language for JSON data which is largely backwards
compatible with SQL. SQL originated from research in the FORWARD
project at UC San Diego, and it has much in common with SQL; some
differences exist due to the different data models that the two
languages were designed to serve. SQL was designed for interacting with
the flat, schema-ified world of relational databases, while SQL++
generalizes SQL to also handle nested data formats (like JSON) and the
schema-optional (or even schema-less) data models of modern NoSQL and
BigData systems.</p>
</div>
<div class="paragraph">
<p>In the context of Apache AsterixDB, the query language is intended for
working with the Asterix Data Model (<a href="../datamodel.html">ADM</a>), a
data model based on a superset of JSON with an enriched and flexible
type system. New AsterixDB users are encouraged to read and work through
the (much friendlier) guide "<a href="primer-sqlpp.html">AsterixDB 101: An
ADM and SQL++ Primer</a>" before attempting to make use of this document.
In addition, readers are advised to read through the
<a href="../datamodel.html">Asterix Data Model (ADM) reference guide</a> first
as well, as an understanding of the data model is a prerequisite to
understanding the query language.</p>
</div>
<div class="paragraph">
<p>In what follows, we detail the features of the query language in a
grammar-guided manner. We list and briefly explain each of the
productions in the query grammar, offering examples (and results) for
clarity.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expressions">2. Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The query language is a highly composable expression language. Each
expression in the query language returns zero or more data model
instances. There are three major kinds of expressions. At the topmost
level, an expression can be an OperatorExpression (similar to a
mathematical expression) or a QuantifiedExpression (which yields a
boolean value). Each will be detailed as we explore the full grammar of
the language.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expression ::= OperatorExpression | QuantifiedExpression</pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the following text, words enclosed in angle brackets denote
keywords that are not case-sensitive.</p>
</div>
<div class="sect2">
<h3 id="operator-expressions">Operator Expressions</h3>
<div class="paragraph">
<p>Operators perform a specific operation on the input values or
expressions. The syntax of an operator expression is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OperatorExpression ::= PathExpression
                       | Operator OperatorExpression
                       | OperatorExpression Operator (OperatorExpression)?
                       | OperatorExpression &lt;BETWEEN&gt; OperatorExpression &lt;AND&gt; OperatorExpression</pre>
</div>
</div>
<div class="paragraph">
<p>The language provides a full set of operators that you can use within
its statements. Here are the categories of operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Arithmetic_operators">Arithmetic Operators</a>, to perform basic
mathematical operations;</p>
</li>
<li>
<p><a href="#Collection_operators">Collection Operators</a>, to evaluate
expressions on collections or objects;</p>
</li>
<li>
<p><a href="#Comparison_operators">Comparison Operators</a>, to compare two
expressions;</p>
</li>
<li>
<p><a href="#Logical_operators">Logical Operators</a>, to combine operators using
Boolean logic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following table summarizes the precedence order (from higher to
lower) of the major unary and binary operators:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXISTS, NOT EXISTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection emptiness testing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponentiation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*, /, DIV, MOD (%)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiplication, division, modulo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+, -</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addition, subtraction</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String concatenation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NULL, IS NOT
NULL, IS MISSING, IS NOT MISSING, IS UNKNOWN, IS NOT UNKNOWN, IS VALUED,
IS NOT VALUED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown value comparison</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BETWEEN, NOT BETWEEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Range comparison (inclusive on both sides)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">=, !=, &lt;&gt;, &lt;, &gt;, &#8656;, &gt;=,
LIKE, NOT LIKE, IN, NOT IN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical negation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AND</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conjunction</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disjunction</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In general, if any operand evaluates to a <code>MISSING</code> value, the enclosing
operator will return <code>MISSING</code>; if none of operands evaluates to a
<code>MISSING</code> value but there is an operand evaluates to a <code>NULL</code> value, the
enclosing operator will return <code>NULL</code>. However, there are a few
exceptions listed in <a href="#Comparison_operators">Comparison Operators</a>
and <a href="#Logical_operators">Logical Operators</a>.</p>
</div>
<div class="sect3">
<h4 id="Arithmetic_operators">Arithmetic Operators</h4>
<div class="paragraph">
<p>Arithmetic operators are used to exponentiate, add, subtract, multiply,
and divide numeric values, or concatenate string values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+, -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As unary operators, they denote a positive or negative expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE -1;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+, -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As binary operators, they add or subtract</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 1 + 2;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 4 * 2;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Divide (returns a value of type <code>double</code> if both operands are
integers)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 5 / 2;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DIV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Divide (returns an integer value if both operands are integers)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 5 DIV 2;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MOD (%)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 5 % 2;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponentiation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE 2^3;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String concatenation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE "ab"</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"c"</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"d";</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Collection_operators">Collection Operators</h4>
<div class="paragraph">
<p>Collection operators are used for membership tests (IN, NOT IN) or empty
collection tests (EXISTS, NOT EXISTS).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Membership test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.user.lang
IN ["en", "de"];</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-membership test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.user.lang NOT IN ["en"];</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXISTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a collection is not empty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM
ChirpMessages cm WHERE EXISTS cm.referredTopics;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT EXISTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a collection is empty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM
ChirpMessages cm WHERE NOT EXISTS cm.referredTopics;</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Comparison_operators">Comparison Operators</h4>
<div class="paragraph">
<p>Comparison operators are used to compare values. The comparison
operators fall into one of two sub-categories: missing value comparisons
and regular value comparisons. The query language (and JSON) has two
ways of representing missing information in a object - the presence of
the field with a NULL for its value (as in SQL), and the absence of the
field (which JSON permits). For example, the first of the following
objects represents Jack, whose friend is Jill. In the other examples,
Jake is friendless a la SQL, with a friend field that is NULL, while Joe
is friendless in a more natural (for JSON) way, i.e., by not having a
friend field.</p>
</div>
<div id="examples" class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>\{"name": "Jack", "friend": "Jill"}</p>
</div>
<div class="paragraph">
<p>\{"name": "Jake", "friend": NULL}</p>
</div>
<div class="paragraph">
<p>\{"name": "Joe"}</p>
</div>
<div class="paragraph">
<p>The following table enumerates all of the query language&#8217;s comparison
operators.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.user.name IS NULL;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is not NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages
cm WHERE cm.user.name IS NOT NULL;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm
WHERE cm.user.name IS MISSING;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is not MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM
ChirpMessages cm WHERE cm.user.name IS NOT MISSING;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is NULL or MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM
ChirpMessages cm WHERE cm.user.name IS UNKNOWN;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is neither NULL nor MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT *
FROM ChirpMessages cm WHERE cm.user.name IS NOT UNKNOWN;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS KNOWN (IS VALUED)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is neither NULL nor MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.user.name IS KNOWN;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT KNOWN (IS NOT VALUED)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is NULL or MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.user.name IS NOT KNOWN;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BETWEEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if a value is between a start value and a end value. The
comparison is inclusive to both start and end values.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM
ChirpMessages cm WHERE cm.chirpId BETWEEN 10 AND 20;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equality test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.chirpId=10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inequality test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.chirpId!=10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inequality test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.chirpId&lt;&gt;10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.chirpId&lt;10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.chirpId&gt;10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than or equal to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.chirpId&#8656;10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than or equal to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE
cm.chirpId&gt;=10;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIKE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if the left side matches a pattern defined on the right
side; in the pattern, "%" matches any string while "_" matches any
character.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.user.name LIKE
"%Giesen%";</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT LIKE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if the left side does not match a pattern defined on the
right side; in the pattern, "%" matches any string while "_" matches any
character.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT * FROM ChirpMessages cm WHERE cm.user.name NOT LIKE
"%Giesen%";</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following table summarizes how the missing value comparison
operators work.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Non-NULL/Non-MISSING value</th>
<th class="tableblock halign-left valign-top">NULL</th>
<th class="tableblock halign-left valign-top">MISSING</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS KNOWN (IS VALUED)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS NOT KNOWN (IS NOT VALUED)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Logical_operators">Logical Operators</h4>
<div class="paragraph">
<p>Logical operators perform logical <code>NOT</code>, <code>AND</code>, and <code>OR</code> operations over
Boolean values (<code>TRUE</code> and <code>FALSE</code>) plus <code>NULL</code> and <code>MISSING</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns true if the following condition is false, otherwise
returns false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE NOT TRUE;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns true if both branches are true, otherwise returns false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT VALUE TRUE AND FALSE;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns true if one branch is true, otherwise returns false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT
VALUE FALSE OR FALSE;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following table is the truth table for <code>AND</code> and <code>OR</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">A</th>
<th class="tableblock halign-left valign-top">B</th>
<th class="tableblock halign-left valign-top">A AND B</th>
<th class="tableblock halign-left valign-top">A OR B</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following table demonstrates the results of <code>NOT</code> on all possible
inputs.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">A</th>
<th class="tableblock halign-left valign-top">NOT A</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MISSING</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="quantified-expressions">Quantified Expressions</h3>
<div class="listingblock">
<div class="content">
<pre>QuantifiedExpression ::= ( (&lt;ANY&gt;|&lt;SOME&gt;) | &lt;EVERY&gt; ) Variable &lt;IN&gt; Expression ( "," Variable "in" Expression )*
                         &lt;SATISFIES&gt; Expression (&lt;END&gt;)?</pre>
</div>
</div>
<div class="paragraph">
<p>Quantified expressions are used for expressing existential or universal
predicates involving the elements of a collection.</p>
</div>
<div class="paragraph">
<p>The following pair of examples illustrate the use of a quantified
expression to test that every (or some) element in the set [1, 2, 3] of
integers is less than three. The first example yields <code>FALSE</code> and second
example yields <code>TRUE</code>.</p>
</div>
<div class="paragraph">
<p>It is useful to note that if the set were instead the empty set, the
first expression would yield <code>TRUE</code> ("every" value in an empty set
satisfies the condition) while the second expression would yield <code>FALSE</code>
(since there isn&#8217;t "some" value, as there are no values in the set, that
satisfies the condition).</p>
</div>
<div class="paragraph">
<p>A quantified expression will return a <code>NULL</code> (or <code>MISSING</code>) if the first
expression in it evaluates to <code>NULL</code> (or <code>MISSING</code>). A type error will
be raised if the first expression in a quantified expression does not
return a collection.</p>
</div>
<div id="examples-1" class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre>EVERY x IN [ 1, 2, 3 ] SATISFIES x &lt; 3
SOME x IN [ 1, 2, 3 ] SATISFIES x &lt; 3</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="path-expressions">Path Expressions</h3>
<div class="listingblock">
<div class="content">
<pre>PathExpression  ::= PrimaryExpression ( Field | Index )*
Field           ::= "." Identifier
Index           ::= "[" Expression (":" ( Expression )? )? "]"</pre>
</div>
</div>
<div class="paragraph">
<p>Components of complex types in the data model are accessed via path
expressions. Path access can be applied to the result of a query
expression that yields an instance of a complex type, for example, an
object or an array instance.</p>
</div>
<div class="paragraph">
<p>For objects, path access is based on field names, and it accesses the
field whose name was specified. For arrays, path access is based on
(zero-based) array-style indexing. Array indexes can be used to retrieve
either a single element from an array, or a whole subset of an array.
Accessing a single element is achieved by providing a single index
argument (zero-based element position), while obtaining a subset of an
array is achieved by providing the <code>start</code> and <code>end</code> (zero-based) index
positions; the returned subset is from position <code>start</code> to position
<code>end - 1</code>; the <code>end</code> position argument is optional. Multisets have
similar behavior to arrays, except for retrieving arbitrary items as the
order of items is not fixed in multisets.</p>
</div>
<div class="paragraph">
<p>Attempts to access non-existent fields or out-of-bound array elements
produce the special value <code>MISSING</code>. Type errors will be raised for
inappropriate use of a path expression, such as applying a field
accessor to a numeric value.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate field access for an object,
index-based element access or subset retrieval of an array, and also a
composition thereof.</p>
</div>
<div id="examples-2" class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre>({"name": "MyABCs", "array": [ "a", "b", "c"]}).array

(["a", "b", "c"])[2]

({"name": "MyABCs", "array": [ "a", "b", "c"]}).array[2]

(["a", "b", "c"])[0:2]

(["a", "b", "c"])[0:]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="primary-expressions">Primary Expressions</h3>
<div class="listingblock">
<div class="content">
<pre>PrimaryExpr ::= Literal
              | VariableReference
              | ParameterReference
              | ParenthesizedExpression
              | FunctionCallExpression
              | CaseExpression
              | Constructor</pre>
</div>
</div>
<div class="paragraph">
<p>The most basic building block for any expression in the query language
is PrimaryExpression. This can be a simple literal (constant) value, a
reference to a query variable that is in scope, a parenthesized
expression, a function call, or a newly constructed instance of the data
model (such as a newly constructed object, array, or multiset of data
model instances).</p>
</div>
</div>
<div class="sect2">
<h3 id="literals">Literals</h3>
<div class="listingblock">
<div class="content">
<pre>Literal        ::= StringLiteral
                   | IntegerLiteral
                   | FloatLiteral
                   | DoubleLiteral
                   | &lt;NULL&gt;
                   | &lt;MISSING&gt;
                   | &lt;TRUE&gt;
                   | &lt;FALSE&gt;
StringLiteral  ::= "\"" (
                             &lt;EscapeQuot&gt;
                           | &lt;EscapeBslash&gt;
                           | &lt;EscapeSlash&gt;
                           | &lt;EscapeBspace&gt;
                           | &lt;EscapeFormf&gt;
                           | &lt;EscapeNl&gt;
                           | &lt;EscapeCr&gt;
                           | &lt;EscapeTab&gt;
                           | ~["\"","\\"])*
                    "\""
                    | "\'"(
                             &lt;EscapeApos&gt;
                           | &lt;EscapeBslash&gt;
                           | &lt;EscapeSlash&gt;
                           | &lt;EscapeBspace&gt;
                           | &lt;EscapeFormf&gt;
                           | &lt;EscapeNl&gt;
                           | &lt;EscapeCr&gt;
                           | &lt;EscapeTab&gt;
                           | ~["\'","\\"])*
                      "\'"
&lt;ESCAPE_Apos&gt;  ::= "\\\'"
&lt;ESCAPE_Quot&gt;  ::= "\\\""
&lt;EscapeBslash&gt; ::= "\\\\"
&lt;EscapeSlash&gt;  ::= "\\/"
&lt;EscapeBspace&gt; ::= "\\b"
&lt;EscapeFormf&gt;  ::= "\\f"
&lt;EscapeNl&gt;     ::= "\\n"
&lt;EscapeCr&gt;     ::= "\\r"
&lt;EscapeTab&gt;    ::= "\\t"

IntegerLiteral ::= &lt;DIGITS&gt;
&lt;DIGITS&gt;       ::= ["0" - "9"]+
FloatLiteral   ::= &lt;DIGITS&gt; ( "f" | "F" )
                 | &lt;DIGITS&gt; ( "." &lt;DIGITS&gt; ( "f" | "F" ) )?
                 | "." &lt;DIGITS&gt; ( "f" | "F" )
DoubleLiteral  ::= &lt;DIGITS&gt; "." &lt;DIGITS&gt;
                   | "." &lt;DIGITS&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Literals (constants) in a query can be strings, integers, floating point
values, double values, boolean constants, or special constant values
like <code>NULL</code> and <code>MISSING</code>. The <code>NULL</code> value is like a <code>NULL</code> in SQL; it
is used to represent an unknown field value. The special value <code>MISSING</code>
is only meaningful in the context of field accesses; it occurs when the
accessed field simply does not exist at all in a object being accessed.</p>
</div>
<div class="paragraph">
<p>The following are some simple examples of literals.</p>
</div>
<div id="examples-3" class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre>'a string'
"test string"
42</pre>
</div>
</div>
<div class="paragraph">
<p>Different from standard SQL, double quotes play the same role as single
quotes and may be used for string literals in queries as well.</p>
</div>
<div class="sect3">
<h4 id="variable-references">Variable References</h4>
<div class="listingblock">
<div class="content">
<pre>VariableReference     ::= &lt;IDENTIFIER&gt; | &lt;DelimitedIdentifier&gt;
&lt;IDENTIFIER&gt;          ::= (&lt;LETTER&gt; | "_") (&lt;LETTER&gt; | &lt;DIGIT&gt; | "_" | "$")*
&lt;LETTER&gt;              ::= ["A" - "Z", "a" - "z"]
DelimitedIdentifier   ::= "`" (&lt;EscapeQuot&gt;
                                | &lt;EscapeBslash&gt;
                                | &lt;EscapeSlash&gt;
                                | &lt;EscapeBspace&gt;
                                | &lt;EscapeFormf&gt;
                                | &lt;EscapeNl&gt;
                                | &lt;EscapeCr&gt;
                                | &lt;EscapeTab&gt;
                                | ~["`","\\"])*
                          "`"</pre>
</div>
</div>
<div class="paragraph">
<p>A variable in a query can be bound to any legal data model value. A
variable reference refers to the value to which an in-scope variable is
bound. (E.g., a variable binding may originate from one of the <code>FROM</code>,
<code>WITH</code> or <code>LET</code> clauses of a <code>SELECT</code> statement or from an input
parameter in the context of a function body.) Backticks, for example,
<code>id</code>, are used for delimited identifiers. Delimiting is needed when a
variable&#8217;s desired name clashes with a keyword or includes characters
not allowed in regular identifiers. More information on exactly how
variable references are resolved can be found in the appendix section on
Variable Resolution.</p>
</div>
<div id="examples-4" class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tweet
id
`SELECT`
`my-function`</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="parameter-references">Parameter References</h4>
<div class="listingblock">
<div class="content">
<pre>ParameterReference              ::= NamedParameterReference | PositionalParameterReference
NamedParameterReference         ::= "$" (&lt;IDENTIFIER&gt; | &lt;DelimitedIdentifier&gt;)
PositionalParameterReference    ::= ("$" &lt;DIGITS&gt;) | "?"</pre>
</div>
</div>
<div class="paragraph">
<p>A statement parameter is an external variable which value is provided
through the <a href="../api.html#queryservice">statement execution API</a>. An
error will be raised if the parameter is not bound at the query
execution time. Positional parameter numbering starts at 1. "?"
parameters are interpreted as \($1, .. $\)N in the order in
which they appear in the statement.</p>
</div>
<div id="examples-5" class="paragraph">
<p>Examples</p>
</div>
<hr/>
<div class="paragraph">
<p>$id
$1
?
---</p>
</div>
</div>
<div class="sect3">
<h4 id="parenthesized-expressions">Parenthesized Expressions</h4>
<div class="listingblock">
<div class="content">
<pre>ParenthesizedExpression ::= "(" Expression ")" | Subquery</pre>
</div>
</div>
<div class="paragraph">
<p>An expression can be parenthesized to control the precedence order or
otherwise clarify a query. For composability, a subquery is also an
parenthesized expression.</p>
</div>
<div class="paragraph">
<p>The following expression evaluates to the value 2.</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>( 1 + 1 )</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="function-call-expressions">Function Call Expressions</h4>
<div class="listingblock">
<div class="content">
<pre>FunctionCallExpression ::= ( FunctionName "(" ( Expression ( "," Expression )* )? ")" ) | WindowFunctionCall</pre>
</div>
</div>
<div class="paragraph">
<p>Functions are included in the query language, like most languages, as a
way to package useful functionality or to componentize complicated or
reusable computations. A function call is a legal query expression that
represents the value resulting from the evaluation of its body
expression with the given parameter bindings; the parameter value
bindings can themselves be any expressions in the query language.</p>
</div>
<div class="paragraph">
<p>Note that Window functions, and aggregate functions used as window
functions, have a more complex syntax. Window function calls are
described in the section on <a href="manual.html#Over_clauses">OVER Clauses</a>.</p>
</div>
<div class="paragraph">
<p>The following example is a (built-in) function call expression whose
value is 8.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>length('a string')</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="case-expressions">Case Expressions</h3>
<div class="listingblock">
<div class="content">
<pre>CaseExpression ::= SimpleCaseExpression | SearchedCaseExpression
SimpleCaseExpression ::= &lt;CASE&gt; Expression ( &lt;WHEN&gt; Expression &lt;THEN&gt; Expression )+ ( &lt;ELSE&gt; Expression )? &lt;END&gt;
SearchedCaseExpression ::= &lt;CASE&gt; ( &lt;WHEN&gt; Expression &lt;THEN&gt; Expression )+ ( &lt;ELSE&gt; Expression )? &lt;END&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In a simple <code>CASE</code> expression, the query evaluator searches for the
first <code>WHEN</code> &#8230;&#8203; <code>THEN</code> pair in which the <code>WHEN</code> expression is equal to
the expression following <code>CASE</code> and returns the expression following
<code>THEN</code>. If none of the <code>WHEN</code> &#8230;&#8203; <code>THEN</code> pairs meet this condition, and
an <code>ELSE</code> branch exists, it returns the <code>ELSE</code> expression. Otherwise,
<code>NULL</code> is returned.</p>
</div>
<div class="paragraph">
<p>In a searched CASE expression, the query evaluator searches from left to
right until it finds a <code>WHEN</code> expression that is evaluated to <code>TRUE</code>,
and then returns its corresponding <code>THEN</code> expression. If no condition is
found to be <code>TRUE</code>, and an <code>ELSE</code> branch exists, it returns the <code>ELSE</code>
expression. Otherwise, it returns <code>NULL</code>.</p>
</div>
<div class="paragraph">
<p>The following example illustrates the form of a case expression.</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CASE (2 &lt; 3) WHEN true THEN "yes" ELSE "no" END</pre>
</div>
</div>
<div class="sect3">
<h4 id="constructors">Constructors</h4>
<div class="listingblock">
<div class="content">
<pre>Constructor              ::= ArrayConstructor | MultisetConstructor | ObjectConstructor
ArrayConstructor         ::= "[" ( Expression ( "," Expression )* )? "]"
MultisetConstructor      ::= "{{" ( Expression ( "," Expression )* )? "}}"
ObjectConstructor        ::= "{" ( FieldBinding ( "," FieldBinding )* )? "}"
FieldBinding             ::= Expression ( ":" Expression )?</pre>
</div>
</div>
<div class="paragraph">
<p>A major feature of the query language is its ability to construct new
data model instances. This is accomplished using its constructors for
each of the model&#8217;s complex object structures, namely arrays, multisets,
and objects. Arrays are like JSON arrays, while multisets have bag
semantics. Objects are built from fields that are field-name/field-value
pairs, again like JSON.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate how to construct a new array with 4
items and a new object with 2 fields respectively. Array elements can be
homogeneous (as in the first example), which is the common case, or they
may be heterogeneous (as in the second example). The data values and
field name values used to construct arrays, multisets, and objects in
constructors are all simply query expressions. Thus, the collection
elements, field names, and field values used in constructors can be
simple literals or they can come from query variable references or even
arbitrarily complex query expressions (subqueries). Type errors will be
raised if the field names in an object are not strings, and duplicate
field errors will be raised if they are not distinct.</p>
</div>
<div id="examples-6" class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ 'a', 'b', 'c', 'c' ]

[ 42, "forty-two!", { "rank" : "Captain", "name": "America" }, 3.14159 ]

{
  'project name': 'Hyracks',
  'project members': [ 'vinayakb', 'dtabass', 'chenli', 'tsotras', 'tillw' ]
}</pre>
</div>
</div>
<div class="paragraph">
<p>If only one expression is specified instead of the
field-name/field-value pair in an object constructor then this
expression is supposed to provide the field value. The field name is
then automatically generated based on the kind of the value expression:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If it is a variable reference expression then generated field name is
the name of that variable.</p>
</li>
<li>
<p>If it is a field access expression then generated field name is the
last identifier in that expression.</p>
</li>
<li>
<p>For all other cases, a compilation error will be raised.</p>
</li>
</ul>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT VALUE { user.alias, user.userSince }
FROM GleambookUsers user
WHERE user.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "alias": "Margarita",
    "userSince": "2012-08-20T10:10:00"
} ]</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="queries">3. Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A query can be any legal expression or <code>SELECT</code> statement. A query
always ends with a semicolon.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Query ::= (Expression | SelectStatement) ";"</pre>
</div>
</div>
<div class="sect2">
<h3 id="declarations">Declarations</h3>
<div class="listingblock">
<div class="content">
<pre>DatabaseDeclaration ::= "USE" Identifier</pre>
</div>
</div>
<div class="paragraph">
<p>At the uppermost level, the world of data is organized into data
namespaces called <strong>dataverses</strong>. To set the default dataverse for
statements, the USE statement is provided.</p>
</div>
<div class="paragraph">
<p>As an example, the following statement sets the default dataverse to be
"TinySocial".</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>USE TinySocial;</pre>
</div>
</div>
<div class="paragraph">
<p>When writing a complex query, it can sometimes be helpful to define one
or more auxilliary functions that each address a sub-piece of the
overall query. The declare function statement supports the creation of
such helper functions. In general, the function body (expression) can be
any legal query expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FunctionDeclaration  ::= "DECLARE" "FUNCTION" Identifier ParameterList "{" Expression "}"
ParameterList        ::= "(" ( &lt;VARIABLE&gt; ( "," &lt;VARIABLE&gt; )* )? ")"</pre>
</div>
</div>
<div class="paragraph">
<p>The following is a simple example of a temporary function definition and
its use.</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DECLARE FUNCTION friendInfo(userId) {
    (SELECT u.id, u.name, len(u.friendIds) AS friendCount
     FROM GleambookUsers u
     WHERE u.id = userId)[0]
 };

SELECT VALUE friendInfo(2);</pre>
</div>
</div>
<div class="paragraph">
<p>For our sample data set, this returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
  { "id": 2, "name": "IsbelDull", "friendCount": 2 }
]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="select-statements">SELECT Statements</h3>
<div class="paragraph">
<p>The following shows the (rich) grammar for the <code>SELECT</code> statement in the
query language.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SelectStatement    ::= ( WithClause )?
                       SelectSetOperation (OrderbyClause )? ( LimitClause )?
SelectSetOperation ::= SelectBlock (&lt;UNION&gt; &lt;ALL&gt; ( SelectBlock | Subquery ) )*
Subquery           ::= "(" SelectStatement ")"

SelectBlock        ::= SelectClause
                       ( FromClause ( LetClause )?)?
                       ( WhereClause )?
                       ( GroupbyClause ( LetClause )? ( HavingClause )? )?
                       |
                       FromClause ( LetClause )?
                       ( WhereClause )?
                       ( GroupbyClause ( LetClause )? ( HavingClause )? )?
                       SelectClause

SelectClause       ::= &lt;SELECT&gt; ( &lt;ALL&gt; | &lt;DISTINCT&gt; )? ( SelectRegular | SelectValue )
SelectRegular      ::= Projection ( "," Projection )*
SelectValue        ::= ( &lt;VALUE&gt; | &lt;ELEMENT&gt; | &lt;RAW&gt; ) Expression
Projection         ::= ( Expression ( &lt;AS&gt; )? Identifier | "*" | Identifier "." "*" )

FromClause         ::= &lt;FROM&gt; FromTerm ( "," FromTerm )*
FromTerm           ::= Expression (( &lt;AS&gt; )? Variable)?
                       ( ( JoinType )? ( JoinClause | UnnestClause ) )*

JoinClause         ::= &lt;JOIN&gt; Expression (( &lt;AS&gt; )? Variable)? &lt;ON&gt; Expression
UnnestClause       ::= ( &lt;UNNEST&gt; ) Expression
                       ( &lt;AS&gt; )? Variable ( &lt;AT&gt; Variable )?
JoinType           ::= ( &lt;INNER&gt; | &lt;LEFT&gt; ( &lt;OUTER&gt; )? )

WithClause         ::= &lt;WITH&gt; WithElement ( "," WithElement )*
LetClause          ::= (&lt;LET&gt; | &lt;LETTING&gt;) LetElement ( "," LetElement )*
LetElement         ::= Variable "=" Expression
WithElement        ::= Variable &lt;AS&gt; Expression

WhereClause        ::= &lt;WHERE&gt; Expression

GroupbyClause      ::= &lt;GROUP&gt; &lt;BY&gt; Expression ( ( (&lt;AS&gt;)? Variable )?
                       ( "," Expression ( (&lt;AS&gt;)? Variable )? )* )
                       ( &lt;GROUP&gt; &lt;AS&gt; Variable
                         ("(" VariableReference &lt;AS&gt; Identifier
                         ("," VariableReference &lt;AS&gt; Identifier )* ")")?
                       )?
HavingClause       ::= &lt;HAVING&gt; Expression

OrderbyClause      ::= &lt;ORDER&gt; &lt;BY&gt; Expression ( &lt;ASC&gt; | &lt;DESC&gt; )?
                       ( "," Expression ( &lt;ASC&gt; | &lt;DESC&gt; )? )*
LimitClause        ::= &lt;LIMIT&gt; Expression ( &lt;OFFSET&gt; Expression )?</pre>
</div>
</div>
<div class="paragraph">
<p>In this section, we will make use of two stored collections of objects
(datasets), <code>GleambookUsers</code> and <code>GleambookMessages</code>, in a series of
running examples to explain <code>SELECT</code> queries. The contents of the
example collections are as follows:</p>
</div>
<div class="paragraph">
<p><code>GleambookUsers</code> collection (or, dataset):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
  "id":1,
  "alias":"Margarita",
  "name":"MargaritaStoddard",
  "nickname":"Mags",
  "userSince":"2012-08-20T10:10:00",
  "friendIds":[2,3,6,10],
  "employment":[{
                  "organizationName":"Codetechno",
                  "start-date":"2006-08-06"
                },
                {
                  "organizationName":"geomedia",
                  "start-date":"2010-06-17",
                  "end-date":"2010-01-26"
                }],
  "gender":"F"
},
{
  "id":2,
  "alias":"Isbel",
  "name":"IsbelDull",
  "nickname":"Izzy",
  "userSince":"2011-01-22T10:10:00",
  "friendIds":[1,4],
  "employment":[{
                  "organizationName":"Hexviafind",
                  "startDate":"2010-04-27"
               }]
},
{
  "id":3,
  "alias":"Emory",
  "name":"EmoryUnk",
  "userSince":"2012-07-10T10:10:00",
  "friendIds":[1,5,8,9],
  "employment":[{
                  "organizationName":"geomedia",
                  "startDate":"2010-06-17",
                  "endDate":"2010-01-26"
               }]
} ]</pre>
</div>
</div>
<div class="paragraph">
<p><code>GleambookMessages</code> collection (or, dataset):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
  "messageId":2,
  "authorId":1,
  "inResponseTo":4,
  "senderLocation":[41.66,80.87],
  "message":" dislike x-phone its touch-screen is horrible"
},
{
  "messageId":3,
  "authorId":2,
  "inResponseTo":4,
  "senderLocation":[48.09,81.01],
  "message":" like product-y the plan is amazing"
},
{
  "messageId":4,
  "authorId":1,
  "inResponseTo":2,
  "senderLocation":[37.73,97.04],
  "message":" can't stand acast the network is horrible:("
},
{
  "messageId":6,
  "authorId":2,
  "inResponseTo":1,
  "senderLocation":[31.5,75.56],
  "message":" like product-z its platform is mind-blowing"
}
{
  "messageId":8,
  "authorId":1,
  "inResponseTo":11,
  "senderLocation":[40.33,80.87],
  "message":" like ccast the 3G is awesome:)"
},
{
  "messageId":10,
  "authorId":1,
  "inResponseTo":12,
  "senderLocation":[42.5,70.01],
  "message":" can't stand product-w the touch-screen is terrible"
},
{
  "messageId":11,
  "authorId":1,
  "inResponseTo":1,
  "senderLocation":[38.97,77.49],
  "message":" can't stand acast its plan is terrible"
} ]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="select-clause">SELECT Clause</h3>
<div class="paragraph">
<p>The <code>SELECT</code> clause always returns a collection value as its result
(even if the result is empty or a singleton).</p>
</div>
<div class="sect3">
<h4 id="select-elementvalueraw">Select Element/Value/Raw</h4>
<div class="paragraph">
<p>The <code>SELECT VALUE</code> clause returns an array or multiset that contains the
results of evaluating the <code>VALUE</code> expression, with one evaluation being
performed per "binding tuple" (i.e., per <code>FROM</code> clause item) satisfying
the statement&#8217;s selection criteria. For historical reasons the query
language also allows the keywords <code>ELEMENT</code> or <code>RAW</code> to be used in place
of <code>VALUE</code> (not recommended).</p>
</div>
<div class="paragraph">
<p>If there is no FROM clause, the expression after <code>VALUE</code> is evaluated
once with no binding tuples (except those inherited from an outer
environment).</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT VALUE 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<hr/>
<div class="paragraph">
<p>[
  1
]
---</p>
</div>
<div class="paragraph">
<p>The following example shows a query that selects one user from the
GleambookUsers collection.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT VALUE user
FROM GleambookUsers user
WHERE user.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[{
    "userSince": "2012-08-20T10:10:00.000Z",
    "friendIds": [
        2,
        3,
        6,
        10
    ],
    "gender": "F",
    "name": "MargaritaStoddard",
    "nickname": "Mags",
    "alias": "Margarita",
    "id": 1,
    "employment": [
        {
            "organizationName": "Codetechno",
            "start-date": "2006-08-06"
        },
        {
            "end-date": "2010-01-26",
            "organizationName": "geomedia",
            "start-date": "2010-06-17"
        }
    ]
} ]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sql-style-select">SQL-style SELECT</h4>
<div class="paragraph">
<p>The traditional SQL-style <code>SELECT</code> syntax is also supported in the query
language. This syntax can also be reformulated in a <code>SELECT VALUE</code> based
manner. (E.g., <code>SELECT expA AS fldA, expB AS fldB</code> is syntactic sugar
for <code>SELECT VALUE { 'fldA': expA, 'fldB': expB }</code>.) Unlike in SQL, the
result of a query does not preserve the order of expressions in the
<code>SELECT</code> clause.</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT user.alias user_alias, user.name user_name
FROM GleambookUsers user
WHERE user.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "user_name": "MargaritaStoddard",
    "user_alias": "Margarita"
} ]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Select_star">SELECT *</h4>
<div class="paragraph">
<p><code>SELECT *</code> returns an object with a nested field for each input
tuple. Each field has as its field name the name of a binding variable
generated by either the <code>FROM</code> clause or <code>GROUP BY</code> clause in the
current enclosing <code>SELECT</code> statement, and its field value is the value
of that binding variable.</p>
</div>
<div class="paragraph">
<p>Note that the result of <code>SELECT *</code> is different from the result of query
that selects all the fields of an object.</p>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookUsers user;</pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>user</code> is the only binding variable generated in the <code>FROM</code>
clause, this query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "user": {
        "userSince": "2012-08-20T10:10:00.000Z",
        "friendIds": [
            2,
            3,
            6,
            10
        ],
        "gender": "F",
        "name": "MargaritaStoddard",
        "nickname": "Mags",
        "alias": "Margarita",
        "id": 1,
        "employment": [
            {
                "organizationName": "Codetechno",
                "start-date": "2006-08-06"
            },
            {
                "end-date": "2010-01-26",
                "organizationName": "geomedia",
                "start-date": "2010-06-17"
            }
        ]
    }
}, {
    "user": {
        "userSince": "2011-01-22T10:10:00.000Z",
        "friendIds": [
            1,
            4
        ],
        "name": "IsbelDull",
        "nickname": "Izzy",
        "alias": "Isbel",
        "id": 2,
        "employment": [
            {
                "organizationName": "Hexviafind",
                "startDate": "2010-04-27"
            }
        ]
    }
}, {
    "user": {
        "userSince": "2012-07-10T10:10:00.000Z",
        "friendIds": [
            1,
            5,
            8,
            9
        ],
        "name": "EmoryUnk",
        "alias": "Emory",
        "id": 3,
        "employment": [
            {
                "organizationName": "geomedia",
                "endDate": "2010-01-26",
                "startDate": "2010-06-17"
            }
        ]
    }
} ]</pre>
</div>
</div>
<div id="example-4" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookUsers u, GleambookMessages m
WHERE m.authorId = u.id and u.id = 2;</pre>
</div>
</div>
<div class="paragraph">
<p>This query does an inner join that we will discuss in
<a href="#Multiple_from_terms">Multiple FROM Terms</a>. Since both <code>u</code> and <code>m</code>
are binding variables generated in the <code>FROM</code> clause, this query
returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "u": {
        "userSince": "2011-01-22T10:10:00",
        "friendIds": [
            1,
            4
        ],
        "name": "IsbelDull",
        "nickname": "Izzy",
        "alias": "Isbel",
        "id": 2,
        "employment": [
            {
                "organizationName": "Hexviafind",
                "startDate": "2010-04-27"
            }
        ]
    },
    "m": {
        "senderLocation": [
            31.5,
            75.56
        ],
        "inResponseTo": 1,
        "messageId": 6,
        "authorId": 2,
        "message": " like product-z its platform is mind-blowing"
    }
}, {
    "u": {
        "userSince": "2011-01-22T10:10:00",
        "friendIds": [
            1,
            4
        ],
        "name": "IsbelDull",
        "nickname": "Izzy",
        "alias": "Isbel",
        "id": 2,
        "employment": [
            {
                "organizationName": "Hexviafind",
                "startDate": "2010-04-27"
            }
        ]
    },
    "m": {
        "senderLocation": [
            48.09,
            81.01
        ],
        "inResponseTo": 4,
        "messageId": 3,
        "authorId": 2,
        "message": " like product-y the plan is amazing"
    }
} ]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="select-variable.">SELECT <em>variable</em>.*</h4>
<div class="paragraph">
<p>Whereas <code>SELECT <strong></code> returns all the fields bound to all the variables
which are currently defined, the notation <code>SELECT c.</strong></code> returns all the
fields of the object bound to variable <code>c</code>. The variable <code>c</code> must be
bound to an object for this to work.</p>
</div>
<div id="example-5" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT user.*
FROM GleambookUsers user;</pre>
</div>
</div>
<div class="paragraph">
<p>Compare this query with the first example given under
<a href="#Select_star">SELECT *</a>. This query returns all users from the
<code>GleambookUsers</code> dataset, but the <code>user</code> variable name is omitted from
the results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
  {
    "id": 1,
    "alias": "Margarita",
    "name": "MargaritaStoddard",
    "nickname": "Mags",
    "userSince": "2012-08-20T10:10:00",
    "friendIds": [
      2,
      3,
      6,
      10
    ],
    "employment": [
      {
        "organizationName": "Codetechno",
        "start-date": "2006-08-06"
      },
      {
        "organizationName": "geomedia",
        "start-date": "2010-06-17",
        "end-date": "2010-01-26"
      }
    ],
    "gender": "F"
  },
  {
    "id": 2,
    "alias": "Isbel",
    "name": "IsbelDull",
    "nickname": "Izzy",
    "userSince": "2011-01-22T10:10:00",
    "friendIds": [
      1,
      4
    ],
    "employment": [
      {
        "organizationName": "Hexviafind",
        "startDate": "2010-04-27"
      }
    ]
  },
  {
    "id": 3,
    "alias": "Emory",
    "name": "EmoryUnk",
    "userSince": "2012-07-10T10:10:00",
    "friendIds": [
      1,
      5,
      8,
      9
    ],
    "employment": [
      {
        "organizationName": "geomedia",
        "startDate": "2010-06-17",
        "endDate": "2010-01-26"
      }
    ]
  }
]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="select-distinct">SELECT DISTINCT</h4>
<div class="paragraph">
<p>The <code>DISTINCT</code> keyword is used to eliminate duplicate items in results.
The following example shows how it works.</p>
</div>
<div id="example-6" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT DISTINCT * FROM [1, 2, 2, 3] AS foo;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "foo": 1
}, {
    "foo": 2
}, {
    "foo": 3
} ]</pre>
</div>
</div>
<div id="example-7" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT DISTINCT VALUE foo FROM [1, 2, 2, 3] AS foo;</pre>
</div>
</div>
<div class="paragraph">
<p>This version of the query returns:</p>
</div>
<hr/>
<div class="paragraph">
<p>[ 1
, 2
, 3
 ]
---</p>
</div>
</div>
<div class="sect3">
<h4 id="unnamed-projections">Unnamed Projections</h4>
<div class="paragraph">
<p>Similar to standard SQL, the query language supports unnamed projections
(a.k.a, unnamed <code>SELECT</code> clause items), for which names are generated.
Name generation has three cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a projection expression is a variable reference expression, its
generated name is the name of the variable.</p>
</li>
<li>
<p>If a projection expression is a field access expression, its generated
name is the last identifier in the expression.</p>
</li>
<li>
<p>For all other cases, the query processor will generate a unique name.</p>
</li>
</ul>
</div>
<div id="example-8" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT substr(user.name, 10), user.alias
FROM GleambookUsers user
WHERE user.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "alias": "Margarita",
    "$1": "Stoddard"
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>In the result, <code>$1</code> is the generated name for <code>substr(user.name, 1)</code>,
while <code>alias</code> is the generated name for <code>user.alias</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="abbreviated-field-access-expressions">Abbreviated Field Access Expressions</h4>
<div class="paragraph">
<p>As in standard SQL, field access expressions can be abbreviated (not
recommended!) when there is no ambiguity. In the next example, the
variable <code>user</code> is the only possible variable reference for fields <code>id</code>,
<code>name</code> and <code>alias</code> and thus could be omitted in the query. More
information on abbbreviated field access can be found in the appendix
section on Variable Resolution.</p>
</div>
<div id="example-9" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT substr(name, 10) AS lname, alias
FROM GleambookUsers user
WHERE id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>Outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "lname": "Stoddard",
    "alias": "Margarita"
} ]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unnest-clause">UNNEST Clause</h3>
<div class="paragraph">
<p>For each of its input tuples, the <code>UNNEST</code> clause flattens a
collection-valued expression into individual items, producing multiple
tuples, each of which is one of the expression&#8217;s original input tuples
augmented with a flattened item from its collection.</p>
</div>
<div class="sect3">
<h4 id="inner-unnest">Inner UNNEST</h4>
<div class="paragraph">
<p>The following example is a query that retrieves the names of the
organizations that a selected user has worked for. It uses the <code>UNNEST</code>
clause to unnest the nested collection <code>employment</code> in the user&#8217;s
object.</p>
</div>
<div id="example-10" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.id AS userId, e.organizationName AS orgName
FROM GleambookUsers u
UNNEST u.employment e
WHERE u.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "orgName": "Codetechno",
    "userId": 1
}, {
    "orgName": "geomedia",
    "userId": 1
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>UNNEST</code> has SQL&#8217;s inner join semantics --- that is, if a user
has no employment history, no tuple corresponding to that user will be
emitted in the result.</p>
</div>
</div>
<div class="sect3">
<h4 id="left-outer-unnest">Left Outer UNNEST</h4>
<div class="paragraph">
<p>As an alternative, the <code>LEFT OUTER UNNEST</code> clause offers SQL&#8217;s left
outer join semantics. For example, no collection-valued field named
<code>hobbies</code> exists in the object for the user whose id is 1, but the
following query&#8217;s result still includes user 1.</p>
</div>
<div id="example-11" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.id AS userId, h.hobbyName AS hobby
FROM GleambookUsers u
LEFT OUTER UNNEST u.hobbies h
WHERE u.id = 1;</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "userId": 1
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that if <code>u.hobbies</code> is an empty collection or leads to a <code>MISSING</code>
(as above) or <code>NULL</code> value for a given input tuple, there is no
corresponding binding value for variable <code>h</code> for an input tuple. A
<code>MISSING</code> value will be generated for <code>h</code> so that the input tuple can
still be propagated.</p>
</div>
</div>
<div class="sect3">
<h4 id="expressing-joins-using-unnest">Expressing Joins Using UNNEST</h4>
<div class="paragraph">
<p>The <code>UNNEST</code> clause is similar to SQL&#8217;s <code>JOIN</code> clause except that it
allows its right argument to be correlated to its left argument, as in
the examples above --- i.e., think "correlated cross-product". The next
example shows this via a query that joins two data sets, GleambookUsers
and GleambookMessages, returning user/message pairs. The results contain
one object per pair, with result objects containing the user&#8217;s name and
an entire message. The query can be thought of as saying "for each
Gleambook user, unnest the <code>GleambookMessages</code> collection and filter the
output with the condition `message.authorId = user.id`".</p>
</div>
<div id="example-12" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u
UNNEST GleambookMessages m
WHERE m.authorId = u.id;</pre>
</div>
</div>
<div class="paragraph">
<p>This returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "uname": "MargaritaStoddard",
    "message": " can't stand acast its plan is terrible"
}, {
    "uname": "MargaritaStoddard",
    "message": " dislike x-phone its touch-screen is horrible"
}, {
    "uname": "MargaritaStoddard",
    "message": " can't stand acast the network is horrible:("
}, {
    "uname": "MargaritaStoddard",
    "message": " like ccast the 3G is awesome:)"
}, {
    "uname": "MargaritaStoddard",
    "message": " can't stand product-w the touch-screen is terrible"
}, {
    "uname": "IsbelDull",
    "message": " like product-z its platform is mind-blowing"
}, {
    "uname": "IsbelDull",
    "message": " like product-y the plan is amazing"
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, the above query can also be expressed as the `UNNEST`ing of a
correlated subquery:</p>
</div>
<div id="example-13" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u
UNNEST (
    SELECT VALUE msg
    FROM GleambookMessages msg
    WHERE msg.authorId = u.id
) AS m;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="from-clauses">FROM clauses</h3>
<div class="paragraph">
<p>A <code>FROM</code> clause is used for enumerating (i.e., conceptually iterating
over) the contents of collections, as in SQL.</p>
</div>
<div class="sect3">
<h4 id="binding-expressions">Binding expressions</h4>
<div class="paragraph">
<p>In addition to stored collections, a <code>FROM</code> clause can iterate over any
intermediate collection returned by a valid query expression. In the
tuple stream generated by a <code>FROM</code> clause, the ordering of the input
tuples are not guaranteed to be preserved.</p>
</div>
<div id="example-14" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT VALUE foo
FROM [1, 2, 2, 3] AS foo
WHERE foo &gt; 2;</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<hr/>
<div class="paragraph">
<p>[
  3
]
---</p>
</div>
</div>
<div class="sect3">
<h4 id="Multiple_from_terms">Multiple FROM Terms</h4>
<div class="paragraph">
<p>The query language permits correlations among <code>FROM</code> terms.
Specifically, a <code>FROM</code> binding expression can refer to variables defined
to its left in the given <code>FROM</code> clause. Thus, the first unnesting
example above could also be expressed as follows:</p>
</div>
<div id="example-15" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.id AS userId, e.organizationName AS orgName
FROM GleambookUsers u, u.employment e
WHERE u.id = 1;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="expressing-joins-using-from-terms">Expressing Joins Using FROM Terms</h4>
<div class="paragraph">
<p>Similarly, the join intentions of the other <code>UNNEST</code>-based join examples
above could be expressed as:</p>
</div>
<div id="example-16" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u, GleambookMessages m
WHERE m.authorId = u.id;</pre>
</div>
</div>
<div id="example-17" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u,
  (
    SELECT VALUE msg
    FROM GleambookMessages msg
    WHERE msg.authorId = u.id
  ) AS m;</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the first alternative is one of the SQL-92 approaches to
expressing a join.</p>
</div>
</div>
<div class="sect3">
<h4 id="implicit-binding-variables">Implicit Binding Variables</h4>
<div class="paragraph">
<p>Similar to standard SQL, the query language supports implicit <code>FROM</code>
binding variables (i.e., aliases), for which a binding variable is
generated. Variable generation falls into three cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the binding expression is a variable reference expression, the
generated variable&#8217;s name will be the name of the referenced variable
itself.</p>
</li>
<li>
<p>If the binding expression is a field access expression (or a fully
qualified name for a dataset), the generated variable&#8217;s name will be the
last identifier (or the dataset name) in the expression.</p>
</li>
<li>
<p>For all other cases, a compilation error will be raised.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next two examples show queries that do not provide binding variables
in their <code>FROM</code> clauses.</p>
</div>
<div id="example-18" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT GleambookUsers.name, GleambookMessages.message
FROM GleambookUsers, GleambookMessages
WHERE GleambookMessages.authorId = GleambookUsers.id;</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "name": "MargaritaStoddard",
    "message": " like ccast the 3G is awesome:)"
}, {
    "name": "MargaritaStoddard",
    "message": " can't stand product-w the touch-screen is terrible"
}, {
    "name": "MargaritaStoddard",
    "message": " can't stand acast its plan is terrible"
}, {
    "name": "MargaritaStoddard",
    "message": " dislike x-phone its touch-screen is horrible"
}, {
    "name": "MargaritaStoddard",
    "message": " can't stand acast the network is horrible:("
}, {
    "name": "IsbelDull",
    "message": " like product-y the plan is amazing"
}, {
    "name": "IsbelDull",
    "message": " like product-z its platform is mind-blowing"
} ]</pre>
</div>
</div>
<div id="example-19" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT GleambookUsers.name, GleambookMessages.message
FROM GleambookUsers,
  (
    SELECT VALUE GleambookMessages
    FROM GleambookMessages
    WHERE GleambookMessages.authorId = GleambookUsers.id
  );</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: "Syntax error: Need an alias for the enclosed expression:\n(select element GleambookMessages\n    from GleambookMessages as GleambookMessages\n    where (GleambookMessages.authorId = GleambookUsers.id)\n )",
    "query_from_user": "use TinySocial;\n\nSELECT GleambookUsers.name, GleambookMessages.message\n    FROM GleambookUsers,\n      (\n        SELECT VALUE GleambookMessages\n        FROM GleambookMessages\n        WHERE GleambookMessages.authorId = GleambookUsers.id\n      );"</pre>
</div>
</div>
<div class="paragraph">
<p>More information on implicit binding variables can be found in the
appendix section on Variable Resolution.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="join-clauses">JOIN Clauses</h3>
<div class="paragraph">
<p>The join clause in the query language supports both inner joins and left
outer joins from standard SQL.</p>
</div>
<div class="sect3">
<h4 id="inner-joins">Inner joins</h4>
<div class="paragraph">
<p>Using a <code>JOIN</code> clause, the inner join intent from the preceding examples
can also be expressed as follows:</p>
</div>
<div id="example-20" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u JOIN GleambookMessages m ON m.authorId = u.id;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="left-outer-joins">Left Outer Joins</h4>
<div class="paragraph">
<p>The query language supports SQL&#8217;s notion of left outer join. The
following query is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u LEFT OUTER JOIN GleambookMessages m ON m.authorId = u.id;</pre>
</div>
</div>
<div class="paragraph">
<p>Returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "uname": "MargaritaStoddard",
    "message": " like ccast the 3G is awesome:)"
}, {
    "uname": "MargaritaStoddard",
    "message": " can't stand product-w the touch-screen is terrible"
}, {
    "uname": "MargaritaStoddard",
    "message": " can't stand acast its plan is terrible"
}, {
    "uname": "MargaritaStoddard",
    "message": " dislike x-phone its touch-screen is horrible"
}, {
    "uname": "MargaritaStoddard",
    "message": " can't stand acast the network is horrible:("
}, {
    "uname": "IsbelDull",
    "message": " like product-y the plan is amazing"
}, {
    "uname": "IsbelDull",
    "message": " like product-z its platform is mind-blowing"
}, {
    "uname": "EmoryUnk"
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>For non-matching left-side tuples, the query language produces <code>MISSING</code>
values for the right-side binding variables; that is why the last object
in the above result doesn&#8217;t have a <code>message</code> field. Note that this is
slightly different from standard SQL, which instead would fill in <code>NULL</code>
values for the right-side fields. The reason for this difference is
that, for non-matches in its join results, the query language views
fields from the right-side as being "not there" (a.k.a. <code>MISSING</code>)
instead of as being "there but unknown" (i.e., <code>NULL</code>).</p>
</div>
<div class="paragraph">
<p>The left-outer join query can also be expressed using
<code>LEFT OUTER UNNEST</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u
LEFT OUTER UNNEST (
    SELECT VALUE message
    FROM GleambookMessages message
    WHERE message.authorId = u.id
  ) m;</pre>
</div>
</div>
<div class="paragraph">
<p>In general, SQL-style join queries can also be expressed by <code>UNNEST</code>
clauses and left outer join queries can be expressed by
<code>LEFT OUTER UNNESTs</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="variable-scope-in-join-clauses">Variable scope in JOIN clauses</h4>
<div class="paragraph">
<p>Variables defined by <code>JOIN</code> subclauses are not visible to other
subclauses in the same <code>FROM</code> clause. This also applies to the <code>FROM</code>
variable that starts the <code>JOIN</code> subclause.</p>
</div>
<div id="example-21" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM GleambookUsers u
JOIN (SELECT VALUE m
      FROM GleambookMessages m
      WHERE m.authorId = u.id) m
ON u.id = m.authorId;</pre>
</div>
</div>
<div class="paragraph">
<p>The variable <code>u</code> defined by the <code>FROM</code> clause is not visible inside the
<code>JOIN</code> subclause, so this query returns no results.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="group-by-clauses">GROUP BY Clauses</h3>
<div class="paragraph">
<p>The <code>GROUP BY</code> clause generalizes standard SQL&#8217;s grouping and
aggregation semantics, but it also retains backward compatibility with
the standard (relational) SQL <code>GROUP BY</code> and aggregation features.</p>
</div>
<div class="sect3">
<h4 id="group-variables">Group variables</h4>
<div class="paragraph">
<p>In a <code>GROUP BY</code> clause, in addition to the binding variable(s) defined
for the grouping key(s), the query language allows a user to define a
<em>group variable</em> by using the clause&#8217;s <code>GROUP AS</code> extension to denote
the resulting group. After grouping, then, the query&#8217;s in-scope
variables include the grouping key&#8217;s binding variables as well as this
group variable which will be bound to one collection value for each
group. This per-group collection (i.e., multiset) value will be a set of
nested objects in which each field of the object is the result of a
renamed variable defined in parentheses following the group variable&#8217;s
name. The <code>GROUP AS</code> syntax is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;GROUP&gt; &lt;AS&gt; Variable ("(" VariableReference &lt;AS&gt; Identifier ("," VariableReference &lt;AS&gt; Identifier )* ")")?</pre>
</div>
</div>
<div id="example-22" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookMessages message
GROUP BY message.authorId AS uid GROUP AS msgs(message AS msg);</pre>
</div>
</div>
<div class="paragraph">
<p>This first example query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "msgs": [
        {
            "msg": {
                "senderLocation": [
                    38.97,
                    77.49
                ],
                "inResponseTo": 1,
                "messageId": 11,
                "authorId": 1,
                "message": " can't stand acast its plan is terrible"
            }
        },
        {
            "msg": {
                "senderLocation": [
                    41.66,
                    80.87
                ],
                "inResponseTo": 4,
                "messageId": 2,
                "authorId": 1,
                "message": " dislike x-phone its touch-screen is horrible"
            }
        },
        {
            "msg": {
                "senderLocation": [
                    37.73,
                    97.04
                ],
                "inResponseTo": 2,
                "messageId": 4,
                "authorId": 1,
                "message": " can't stand acast the network is horrible:("
            }
        },
        {
            "msg": {
                "senderLocation": [
                    40.33,
                    80.87
                ],
                "inResponseTo": 11,
                "messageId": 8,
                "authorId": 1,
                "message": " like ccast the 3G is awesome:)"
            }
        },
        {
            "msg": {
                "senderLocation": [
                    42.5,
                    70.01
                ],
                "inResponseTo": 12,
                "messageId": 10,
                "authorId": 1,
                "message": " can't stand product-w the touch-screen is terrible"
            }
        }
    ],
    "uid": 1
}, {
    "msgs": [
        {
            "msg": {
                "senderLocation": [
                    31.5,
                    75.56
                ],
                "inResponseTo": 1,
                "messageId": 6,
                "authorId": 2,
                "message": " like product-z its platform is mind-blowing"
            }
        },
        {
            "msg": {
                "senderLocation": [
                    48.09,
                    81.01
                ],
                "inResponseTo": 4,
                "messageId": 3,
                "authorId": 2,
                "message": " like product-y the plan is amazing"
            }
        }
    ],
    "uid": 2
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>As we can see from the above query result, each group in the example
query&#8217;s output has an associated group variable value called <code>msgs</code> that
appears in the <code>SELECT *&#8217;s result. This variable contains a collection
of objects associated with the group; each of the group&#8217;s `message</code>
values appears in the <code>msg</code> field of the objects in the <code>msgs</code>
collection.</p>
</div>
<div class="paragraph">
<p>The group variable in the query language makes more complex, composable,
nested subqueries over a group possible, which is important given the
language&#8217;s more complex data model (relative to SQL). As a simple
example of this, as we really just want the messages associated with
each user, we might wish to avoid the "extra wrapping" of each message
as the <code>msg</code> field of an object. (That wrapping is useful in more
complex cases, but is essentially just in the way here.) We can use a
subquery in the <code>SELECT</code> clause to tunnel through the extra nesting and
produce the desired result.</p>
</div>
<div id="example-23" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid, (SELECT VALUE g.msg FROM g) AS msgs
FROM GleambookMessages gbm
GROUP BY gbm.authorId AS uid
GROUP AS g(gbm as msg);</pre>
</div>
</div>
<div class="paragraph">
<p>This variant of the example query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   [ {
       "msgs": [
           {
               "senderLocation": [
                   38.97,
                   77.49
               ],
               "inResponseTo": 1,
               "messageId": 11,
               "authorId": 1,
               "message": " can't stand acast its plan is terrible"
           },
           {
               "senderLocation": [
                   41.66,
                   80.87
               ],
               "inResponseTo": 4,
               "messageId": 2,
               "authorId": 1,
               "message": " dislike x-phone its touch-screen is horrible"
           },
           {
               "senderLocation": [
                   37.73,
                   97.04
               ],
               "inResponseTo": 2,
               "messageId": 4,
               "authorId": 1,
               "message": " can't stand acast the network is horrible:("
           },
           {
               "senderLocation": [
                   40.33,
                   80.87
               ],
               "inResponseTo": 11,
               "messageId": 8,
               "authorId": 1,
               "message": " like ccast the 3G is awesome:)"
           },
           {
               "senderLocation": [
                   42.5,
                   70.01
               ],
               "inResponseTo": 12,
               "messageId": 10,
               "authorId": 1,
               "message": " can't stand product-w the touch-screen is terrible"
           }
       ],
       "uid": 1
   }, {
       "msgs": [
           {
               "senderLocation": [
                   31.5,
                   75.56
               ],
               "inResponseTo": 1,
               "messageId": 6,
               "authorId": 2,
               "message": " like product-z its platform is mind-blowing"
           },
           {
               "senderLocation": [
                   48.09,
                   81.01
               ],
               "inResponseTo": 4,
               "messageId": 3,
               "authorId": 2,
               "message": " like product-y the plan is amazing"
           }
       ],
       "uid": 2
   } ]</pre>
</div>
</div>
<div class="paragraph">
<p>The next example shows a more interesting case involving the use of a
subquery in the <code>SELECT</code> list. Here the subquery further processes the
groups. There is no renaming in the declaration of the group variable
<code>g</code> such that <code>g</code> only has one field <code>gbm</code> which comes from the <code>FROM</code>
clause.</p>
</div>
<div id="example-24" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid,
       (SELECT VALUE g.gbm
        FROM g
        WHERE g.gbm.message LIKE '% like%'
        ORDER BY g.gbm.messageId
        LIMIT 2) AS msgs
FROM GleambookMessages gbm
GROUP BY gbm.authorId AS uid
GROUP AS g;</pre>
</div>
</div>
<div class="paragraph">
<p>This example query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "msgs": [
        {
            "senderLocation": [
                40.33,
                80.87
            ],
            "inResponseTo": 11,
            "messageId": 8,
            "authorId": 1,
            "message": " like ccast the 3G is awesome:)"
        }
    ],
    "uid": 1
}, {
    "msgs": [
        {
            "senderLocation": [
                48.09,
                81.01
            ],
            "inResponseTo": 4,
            "messageId": 3,
            "authorId": 2,
            "message": " like product-y the plan is amazing"
        },
        {
            "senderLocation": [
                31.5,
                75.56
            ],
            "inResponseTo": 1,
            "messageId": 6,
            "authorId": 2,
            "message": " like product-z its platform is mind-blowing"
        }
    ],
    "uid": 2
} ]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implicit-grouping-key-variables">Implicit Grouping Key Variables</h4>
<div class="paragraph">
<p>In the query language syntax, providing named binding variables for
<code>GROUP BY</code> key expressions is optional. If a grouping key is missing a
user-provided binding variable, the underlying compiler will generate
one. Automatic grouping key variable naming falls into three cases, much
like the treatment of unnamed projections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the grouping key expression is a variable reference expression, the
generated variable gets the same name as the referred variable;</p>
</li>
<li>
<p>If the grouping key expression is a field access expression, the
generated variable gets the same name as the last identifier in the
expression;</p>
</li>
<li>
<p>For all other cases, the compiler generates a unique variable (but the
user query is unable to refer to this generated variable).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next example illustrates a query that doesn&#8217;t provide binding
variables for its grouping key expressions.</p>
</div>
<div id="example-25" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT authorId,
       (SELECT VALUE g.gbm
        FROM g
        WHERE g.gbm.message LIKE '% like%'
        ORDER BY g.gbm.messageId
        LIMIT 2) AS msgs
FROM GleambookMessages gbm
GROUP BY gbm.authorId
GROUP AS g;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    [ {
    "msgs": [
        {
            "senderLocation": [
                40.33,
                80.87
            ],
            "inResponseTo": 11,
            "messageId": 8,
            "authorId": 1,
            "message": " like ccast the 3G is awesome:)"
        }
    ],
    "authorId": 1
}, {
    "msgs": [
        {
            "senderLocation": [
                48.09,
                81.01
            ],
            "inResponseTo": 4,
            "messageId": 3,
            "authorId": 2,
            "message": " like product-y the plan is amazing"
        },
        {
            "senderLocation": [
                31.5,
                75.56
            ],
            "inResponseTo": 1,
            "messageId": 6,
            "authorId": 2,
            "message": " like product-z its platform is mind-blowing"
        }
    ],
    "authorId": 2
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Based on the three variable generation rules, the generated variable for
the grouping key expression <code>message.authorId</code> is <code>authorId</code> (which is
how it is referred to in the example&#8217;s <code>SELECT</code> clause).</p>
</div>
</div>
<div class="sect3">
<h4 id="Implicit_group_variables">Implicit Group Variables</h4>
<div class="paragraph">
<p>The group variable itself is also optional in the <code>GROUP BY</code> syntax. If
a user&#8217;s query does not declare the name and structure of the group
variable using <code>GROUP AS</code>, the query compiler will generate a unique
group variable whose fields include all of the binding variables defined
in the <code>FROM</code> clause of the current enclosing <code>SELECT</code> statement. In
this case the user&#8217;s query will not be able to refer to the generated
group variable, but is able to call SQL-92 aggregation functions as in
SQL-92.</p>
</div>
</div>
<div class="sect3">
<h4 id="aggregation-functions">Aggregation Functions</h4>
<div class="paragraph">
<p>In the traditional SQL, which doesn&#8217;t support nested data, grouping
always also involves the use of aggregation to compute properties of the
groups (for example, the average number of messages per user rather than
the actual set of messages per user). Each aggregation function in the
query language takes a collection (for example, the group of messages)
as its input and produces a scalar value as its output. These
aggregation functions, being truly functional in nature (unlike in SQL),
can be used anywhere in a query where an expression is allowed. The
following table catalogs the built-in aggregation functions of the query
language and also indicates how each one handles <code>NULL</code>/<code>MISSING</code> values
in the input collection or a completely empty input collection:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">NULL</th>
<th class="tableblock halign-left valign-top">MISSING</th>
<th class="tableblock halign-left valign-top">Empty Collection</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">counted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">counted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_SUM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_MAX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_MIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_AVG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_STDDEV_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_STDDEV_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_VAR_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_VAR_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_SKEWNESS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRICT_KURTOSIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not counted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not counted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_SUM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_MAX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_MIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_AVG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_STDDEV_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_STDDEV_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_VAR_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_VAR_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_SKEWNESS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_KURTOSIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignores NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">returns NULL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Notice that the query language offers two versions for each of the
aggregate functions listed above. For each function, the STRICT version
handles <code>UNKNOWN</code> values in a semantically strict fashion, where unknown
values in the input result in unknown values in the output; and the
ARRAY version handles them in the ad hoc "just ignore the unknown
values" fashion that the SQL standard chose to adopt.</p>
</div>
<div id="example-26" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ARRAY_AVG(
    (
      SELECT VALUE ARRAY_COUNT(friendIds) FROM GleambookUsers
    )
);</pre>
</div>
</div>
<div class="paragraph">
<p>This example returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>3.3333333333333335</pre>
</div>
</div>
<div id="example-27" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid AS uid, ARRAY_COUNT(grp) AS msgCnt
FROM GleambookMessages message
GROUP BY message.authorId AS uid
GROUP AS grp(message AS msg);</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "uid": 1,
    "msgCnt": 5
}, {
    "uid": 2,
    "msgCnt": 2
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the query forms groups where each group involves a message
author and their messages. (SQL cannot do this because the grouped
intermediate result is non-1NF in nature.) The query then uses the
collection aggregate function ARRAY_COUNT to get the cardinality of each
group of messages.</p>
</div>
<div class="paragraph">
<p>Each aggregation function in the query language supports the DISTINCT
modifier that removes duplicate values from the input collection.</p>
</div>
<div id="example-28" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ARRAY_SUM(DISTINCT [1, 1, 2, 2, 3])</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="paragraph">
<p>-
6
-</p>
</div>
</div>
<div class="sect3">
<h4 id="sql-92-aggregation-functions">SQL-92 Aggregation Functions</h4>
<div class="paragraph">
<p>For compatibility with the traditional SQL aggregation functions, the
query language also offers SQL-92&#8217;s aggregation function symbols
(<code>COUNT</code>, <code>SUM</code>, <code>MAX</code>, <code>MIN</code>, <code>AVG</code>, <code>ARRAY_AGG</code>, <code>STDDEV_SAMP</code>,
<code>STDDEV_POP</code>, <code>VAR_SAMP</code>, <code>VAR_POP</code>) as supported syntactic sugar. The
query compiler rewrites queries that utilize these function symbols into
queries that only use the collection aggregate functions of the query
language. The following example uses the SQL-92 syntax approach to
compute a result that is identical to that of the more explicit example
above:</p>
</div>
<div id="example-29" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid, COUNT(*) AS msgCnt
FROM GleambookMessages msg
GROUP BY msg.authorId AS uid;</pre>
</div>
</div>
<div class="paragraph">
<p>It is important to realize that <code>COUNT</code> is actually <strong>not</strong> a built-in
aggregation function. Rather, the <code>COUNT</code> query above is using a special
"sugared" function symbol that the query compiler will rewrite as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid AS uid, ARRAY_COUNT( (SELECT VALUE 1 FROM `$1` as g) ) AS msgCnt
FROM GleambookMessages msg
GROUP BY msg.authorId AS uid
GROUP AS `$1`(msg AS msg);</pre>
</div>
</div>
<div class="paragraph">
<p>The same sort of rewritings apply to the function symbols <code>SUM</code>, <code>MAX</code>,
<code>MIN</code>, <code>AVG</code>, <code>ARRAY_AGG</code>,<code>STDDEV_SAMP</code>, <code>STDDEV_POP</code>, <code>VAR_SAMP</code>, and
<code>VAR_POP</code>. In contrast to the collection aggregate functions of the
query language, these special SQL-92 function symbols can only be used
in the same way they are in standard SQL (i.e., with the same
restrictions).</p>
</div>
<div class="paragraph">
<p>The DISTINCT modifier is also supported for these aggregate functions.</p>
</div>
<div class="paragraph">
<p>The following table shows the SQL-92 functions supported by the query
language, their aliases where available, and their corresponding
built-in functions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SQL-92 Function</th>
<th class="tableblock halign-left valign-top">Aliases</th>
<th class="tableblock halign-left valign-top">Corresponding Built-in Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COUNT</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_COUNT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUM</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_SUM</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAX</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_MAX</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MIN</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_MIN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AVG</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_AVG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_AGG</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STDDEV_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STDDEV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_STDDEV_SAMP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STDDEV_POP</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_STDDEV_POP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VAR_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARIANCE, VARIANCE_SAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_VAR_SAMP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VAR_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARIANCE_POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARRAY_VAR_POP</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that the <code>ARRAY_AGG</code> function symbol is rewritten simply to return
the result of the generated subquery, without applying any built-in
function.</p>
</div>
</div>
<div class="sect3">
<h4 id="sql-92-compliant-group-by-aggregations">SQL-92 Compliant GROUP BY Aggregations</h4>
<div class="paragraph">
<p>The query language provides full support for SQL-92 <code>GROUP BY</code>
aggregation queries. The following query is such an example:</p>
</div>
<div id="example-30" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT msg.authorId, COUNT(*)
FROM GleambookMessages msg
GROUP BY msg.authorId;</pre>
</div>
</div>
<div class="paragraph">
<p>This query outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "authorId": 1,
    "$1": 5
}, {
    "authorId": 2,
    "$1": 2
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>In principle, a <code>msg</code> reference in the query&#8217;s <code>SELECT</code> clause would be
"sugarized" as a collection (as described in
<a href="#Implicit_group_variables">Implicit Group Variables</a>). However,
since the SELECT expression <code>msg.authorId</code> is syntactically identical to
a GROUP BY key expression, it will be internally replaced by the
generated group key variable. The following is the equivalent rewritten
query that will be generated by the compiler for the query above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT authorId AS authorId, ARRAY_COUNT( (SELECT g.msg FROM `$1` AS g) )
FROM GleambookMessages msg
GROUP BY msg.authorId AS authorId
GROUP AS `$1`(msg AS msg);</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="column-aliases">Column Aliases</h4>
<div class="paragraph">
<p>The query language also allows column aliases to be used as <code>ORDER BY</code>
keys.</p>
</div>
<div id="example-31" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT msg.authorId AS aid, COUNT(*)
FROM GleambookMessages msg
GROUP BY msg.authorId;
ORDER BY aid;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "$1": 5,
    "aid": 1
}, {
    "$1": 2,
    "aid": 2
} ]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="where-clauses-and-having-clauses">WHERE Clauses and HAVING Clauses</h3>
<div class="paragraph">
<p>Both <code>WHERE</code> clauses and <code>HAVING</code> clauses are used to filter input data
based on a condition expression. Only tuples for which the condition
expression evaluates to <code>TRUE</code> are propagated. Note that if the
condition expression evaluates to <code>NULL</code> or <code>MISSING</code> the input tuple
will be discarded.</p>
</div>
</div>
<div class="sect2">
<h3 id="Order_By_clauses">ORDER BY Clauses</h3>
<div class="paragraph">
<p>The <code>ORDER BY</code> clause is used to globally sort data in either ascending
order (i.e., <code>ASC</code>) or descending order (i.e., <code>DESC</code>). During ordering,
<code>MISSING</code> and <code>NULL</code> are treated as being smaller than any other value
if they are encountered in the ordering key(s). <code>MISSING</code> is treated as
smaller than <code>NULL</code> if both occur in the data being sorted. The ordering
of values of a given type is consistent with its type&#8217;s &#8656; ordering; the
ordering of values across types is implementation-defined but stable.
The following example returns all <code>GleambookUsers</code> in descending order
by their number of friends.</p>
</div>
<div id="example-32" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  SELECT VALUE user
  FROM GleambookUsers AS user
  ORDER BY ARRAY_COUNT(user.friendIds) DESC;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  [ {
      "userSince": "2012-08-20T10:10:00.000Z",
      "friendIds": [
          2,
          3,
          6,
          10
      ],
      "gender": "F",
      "name": "MargaritaStoddard",
      "nickname": "Mags",
      "alias": "Margarita",
      "id": 1,
      "employment": [
          {
              "organizationName": "Codetechno",
              "start-date": "2006-08-06"
          },
          {
              "end-date": "2010-01-26",
              "organizationName": "geomedia",
              "start-date": "2010-06-17"
          }
      ]
  }, {
      "userSince": "2012-07-10T10:10:00.000Z",
      "friendIds": [
          1,
          5,
          8,
          9
      ],
      "name": "EmoryUnk",
      "alias": "Emory",
      "id": 3,
      "employment": [
          {
              "organizationName": "geomedia",
              "endDate": "2010-01-26",
              "startDate": "2010-06-17"
          }
      ]
  }, {
      "userSince": "2011-01-22T10:10:00.000Z",
      "friendIds": [
          1,
          4
      ],
      "name": "IsbelDull",
      "nickname": "Izzy",
      "alias": "Isbel",
      "id": 2,
      "employment": [
          {
              "organizationName": "Hexviafind",
              "startDate": "2010-04-27"
          }
      ]
  } ]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limit-clauses">LIMIT Clauses</h3>
<div class="paragraph">
<p>The <code>LIMIT</code> clause is used to limit the result set to a specified
constant size. The use of the <code>LIMIT</code> clause is illustrated in the next
example.</p>
</div>
<div id="example-33" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  SELECT VALUE user
  FROM GleambookUsers AS user
  ORDER BY len(user.friendIds) DESC
  LIMIT 1;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  [ {
      "userSince": "2012-08-20T10:10:00.000Z",
      "friendIds": [
          2,
          3,
          6,
          10
      ],
      "gender": "F",
      "name": "MargaritaStoddard",
      "nickname": "Mags",
      "alias": "Margarita",
      "id": 1,
      "employment": [
          {
              "organizationName": "Codetechno",
              "start-date": "2006-08-06"
          },
          {
              "end-date": "2010-01-26",
              "organizationName": "geomedia",
              "start-date": "2010-06-17"
          }
      ]
  } ]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="with-clauses">WITH Clauses</h3>
<div class="paragraph">
<p>As in standard SQL, <code>WITH</code> clauses are available to improve the
modularity of a query. The next query shows an example.</p>
</div>
<div id="example-34" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>WITH avgFriendCount AS (
  SELECT VALUE AVG(ARRAY_COUNT(user.friendIds))
  FROM GleambookUsers AS user
)[0]
SELECT VALUE user
FROM GleambookUsers user
WHERE ARRAY_COUNT(user.friendIds) &gt; avgFriendCount;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "userSince": "2012-08-20T10:10:00.000Z",
    "friendIds": [
        2,
        3,
        6,
        10
    ],
    "gender": "F",
    "name": "MargaritaStoddard",
    "nickname": "Mags",
    "alias": "Margarita",
    "id": 1,
    "employment": [
        {
            "organizationName": "Codetechno",
            "start-date": "2006-08-06"
        },
        {
            "end-date": "2010-01-26",
            "organizationName": "geomedia",
            "start-date": "2010-06-17"
        }
    ]
}, {
    "userSince": "2012-07-10T10:10:00.000Z",
    "friendIds": [
        1,
        5,
        8,
        9
    ],
    "name": "EmoryUnk",
    "alias": "Emory",
    "id": 3,
    "employment": [
        {
            "organizationName": "geomedia",
            "endDate": "2010-01-26",
            "startDate": "2010-06-17"
        }
    ]
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>The query is equivalent to the following, more complex, inlined form of
the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookUsers user
WHERE ARRAY_COUNT(user.friendIds) &gt;
    ( SELECT VALUE AVG(ARRAY_COUNT(user.friendIds))
      FROM GleambookUsers AS user
    ) [0];</pre>
</div>
</div>
<div class="paragraph">
<p>WITH can be particularly useful when a value needs to be used several
times in a query.</p>
</div>
<div class="paragraph">
<p>Before proceeding further, notice that both the WITH query and its
equivalent inlined variant include the syntax "[0]"&#8201;&#8212;&#8201;this is due to a
noteworthy difference between the query language and SQL-92. In SQL-92,
whenever a scalar value is expected and it is being produced by a query
expression, the SQL-92 query processor will evaluate the expression,
check that there is only one row and column in the result at runtime,
and then coerce the one-row/one-column tabular result into a scalar
value. A JSON query language, being designed to deal with nested data
and schema-less data, should not do this. Collection-valued data is
perfectly legal in most contexts, and its data is schema-less, so the
query processor rarely knows exactly what to expect where and such
automatic conversion would often not be desirable. Thus, in the queries
above, the use of "[0]" extracts the first (i.e., 0th) element of an
array-valued query expression&#8217;s result; this is needed above, even
though the result is an array of one element, to extract the only
element in the singleton array and obtain the desired scalar for the
comparison.</p>
</div>
</div>
<div class="sect2">
<h3 id="let-clauses">LET Clauses</h3>
<div class="paragraph">
<p>Similar to <code>WITH</code> clauses, <code>LET</code> clauses can be useful when a (complex)
expression is used several times within a query, allowing it to be
written once to make the query more concise. The next query shows an
example.</p>
</div>
<div id="example-35" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, messages AS messages
FROM GleambookUsers u
LET messages = (SELECT VALUE m
                FROM GleambookMessages m
                WHERE m.authorId = u.id)
WHERE EXISTS messages;</pre>
</div>
</div>
<div class="paragraph">
<p>This query lists <code>GleambookUsers</code> that have posted <code>GleambookMessages</code>
and shows all authored messages for each listed user. It returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "uname": "MargaritaStoddard",
    "messages": [
        {
            "senderLocation": [
                38.97,
                77.49
            ],
            "inResponseTo": 1,
            "messageId": 11,
            "authorId": 1,
            "message": " can't stand acast its plan is terrible"
        },
        {
            "senderLocation": [
                41.66,
                80.87
            ],
            "inResponseTo": 4,
            "messageId": 2,
            "authorId": 1,
            "message": " dislike x-phone its touch-screen is horrible"
        },
        {
            "senderLocation": [
                37.73,
                97.04
            ],
            "inResponseTo": 2,
            "messageId": 4,
            "authorId": 1,
            "message": " can't stand acast the network is horrible:("
        },
        {
            "senderLocation": [
                40.33,
                80.87
            ],
            "inResponseTo": 11,
            "messageId": 8,
            "authorId": 1,
            "message": " like ccast the 3G is awesome:)"
        },
        {
            "senderLocation": [
                42.5,
                70.01
            ],
            "inResponseTo": 12,
            "messageId": 10,
            "authorId": 1,
            "message": " can't stand product-w the touch-screen is terrible"
        }
    ]
}, {
    "uname": "IsbelDull",
    "messages": [
        {
            "senderLocation": [
                31.5,
                75.56
            ],
            "inResponseTo": 1,
            "messageId": 6,
            "authorId": 2,
            "message": " like product-z its platform is mind-blowing"
        },
        {
            "senderLocation": [
                48.09,
                81.01
            ],
            "inResponseTo": 4,
            "messageId": 3,
            "authorId": 2,
            "message": " like product-y the plan is amazing"
        }
    ]
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>This query is equivalent to the following query that does not use the
<code>LET</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname, ( SELECT VALUE m
                          FROM GleambookMessages m
                          WHERE m.authorId = u.id
                        ) AS messages
FROM GleambookUsers u
WHERE EXISTS ( SELECT VALUE m
               FROM GleambookMessages m
               WHERE m.authorId = u.id
             );</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="union-all">UNION ALL</h3>
<div class="paragraph">
<p>UNION ALL can be used to combine two input arrays or multisets into one.
As in SQL, there is no ordering guarantee on the contents of the output
stream. However, unlike SQL, the query language does not constrain what
the data looks like on the input streams; in particular, it allows
heterogeneity on the input and output streams. A type error will be
raised if one of the inputs is not a collection. The following odd but
legal query is an example:</p>
</div>
<div id="example-36" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT u.name AS uname
FROM GleambookUsers u
WHERE u.id = 2
  UNION ALL
SELECT VALUE m.message
FROM GleambookMessages m
WHERE authorId=2;</pre>
</div>
</div>
<div class="paragraph">
<p>This query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
  " like product-z its platform is mind-blowing"
  , {
    "uname": "IsbelDull"
}, " like product-y the plan is amazing"
 ]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="over-clauses">OVER Clauses</h3>
<div class="paragraph">
<p>All window functions must have an OVER clause to define the window
partitions, the order of tuples within those partitions, and the extent
of the window frame. Some window functions take additional window
options, which are specified by modifiers before the OVER clause.</p>
</div>
<div class="paragraph">
<p>The query language has a dedicated set of window functions. Aggregate
functions can also be used as window functions, when they are used with
an OVER clause.</p>
</div>
<div class="sect3">
<h4 id="window-function-call">Window Function Call</h4>
<div class="listingblock">
<div class="content">
<pre>WindowFunctionCall ::= WindowFunctionType "(" WindowFunctionArguments ")"
(WindowFunctionOptions)? &lt;OVER&gt; (Variable &lt;AS&gt;)? "(" WindowDefinition ")"</pre>
</div>
</div>
<div class="sect4">
<h5 id="window-function-type">Window Function Type</h5>
<div class="listingblock">
<div class="content">
<pre>WindowFunctionType ::= AggregateFunction | WindowFunction</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the <a href="builtins.html#AggregateFunctions">Aggregate Functions</a>
section for a list of aggregate functions.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="builtins.html#WindowFunctions">Window Functions</a>
section for a list of window functions.</p>
</div>
</div>
<div class="sect4">
<h5 id="window-function-arguments">Window Function Arguments</h5>
<div class="listingblock">
<div class="content">
<pre>WindowFunctionArguments ::= ( (&lt;DISTINCT&gt;)? Expression |
(Expression ("," Expression ("," Expression)? )? )? )</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the <a href="builtins.html#AggregateFunctions">Aggregate Functions</a>
section or the <a href="builtins.html#WindowFunctions">Window Functions</a>
section for details of the arguments for individual functions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="window-function-options">Window Function Options</h4>
<div class="listingblock">
<div class="content">
<pre>WindowFunctionOptions ::= (NthValFrom)? (NullsTreatment)?</pre>
</div>
</div>
<div class="paragraph">
<p>Window function options cannot be used with
<a href="builtins.html#AggregateFunctions">aggregate functions</a>.</p>
</div>
<div class="paragraph">
<p>Window function options can only be used with some
<a href="builtins.html#WindowFunctions">window functions</a>, as described
below.</p>
</div>
<div class="sect4">
<h5 id="nth-val-from">Nth Val From</h5>
<div class="listingblock">
<div class="content">
<pre>NthValFrom ::= &lt;FROM&gt; ( &lt;FIRST&gt; | &lt;LAST&gt; )</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>nth val from</strong> modifier determines whether the computation begins at
the first or last tuple in the window.</p>
</div>
<div class="paragraph">
<p>This modifier can only be used with the <code>nth_value()</code> function.</p>
</div>
<div class="paragraph">
<p>This modifier is optional. If omitted, the default setting is
<code>FROM FIRST</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="nulls-treatment">Nulls Treatment</h5>
<div class="listingblock">
<div class="content">
<pre>NullsTreatment ::= ( &lt;RESPECT&gt; | &lt;IGNORE&gt; ) &lt;NULLS&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>nulls treatment</strong> modifier determines whether NULL values are
included in the computation, or ignored. MISSING values are treated the
same way as NULL values.</p>
</div>
<div class="paragraph">
<p>This modifier can only be used with the <code>first_value()</code>, <code>last_value()</code>,
<code>nth_value()</code>, <code>lag()</code>, and <code>lead()</code> functions.</p>
</div>
<div class="paragraph">
<p>This modifier is optional. If omitted, the default setting is
<code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="window-frame-variable">Window Frame Variable</h4>
<div class="paragraph">
<p>The AS keyword enables you to specify an alias for the window frame
contents. It introduces a variable which will be bound to the contents
of the frame. When using a built-in
<a href="builtins.html#AggregateFunctions">aggregate function</a> as a window
function, the function’s argument must be a subquery which refers to
this alias, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT ARRAY_COUNT(DISTINCT (FROM alias SELECT VALUE alias.src.field))
OVER alias AS (PARTITION BY … ORDER BY …)
FROM source AS src</pre>
</div>
</div>
<div class="paragraph">
<p>The alias is not necessary when using a
<a href="builtins.html#WindowFunctions">window function</a>, or when using a
standard SQL aggregate function with the OVER clause.</p>
</div>
<div class="sect4">
<h5 id="standard-sql-aggregate-functions-with-the-over-clause">Standard SQL Aggregate Functions with the OVER Clause</h5>
<div class="paragraph">
<p>A standard SQL aggregate function with an OVER clause is rewritten by
the query compiler using a built-in aggregate function over a frame
variable. For example, the following query with the <code>sum()</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT SUM(field) OVER (PARTITION BY … ORDER BY …)
FROM source AS src</pre>
</div>
</div>
<div class="paragraph">
<p>Is rewritten as the following query using the <code>array_sum()</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT ARRAY_SUM( (SELECT VALUE alias.src.field FROM alias) )
  OVER alias AS (PARTITION BY … ORDER BY …)
FROM source AS src</pre>
</div>
</div>
<div class="paragraph">
<p>This is similar to the way that standard SQL aggregate functions are
rewritten as built-in aggregate functions in the presence of the GROUP
BY clause.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="window-definition">Window Definition</h4>
<div class="listingblock">
<div class="content">
<pre>WindowDefinition ::= (WindowPartitionClause)? (WindowOrderClause
(WindowFrameClause (WindowFrameExclusion)? )? )?</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window definition</strong> specifies the partitioning, ordering, and
framing for window functions.</p>
</div>
<div class="sect4">
<h5 id="window-partition-clause">Window Partition Clause</h5>
<div class="listingblock">
<div class="content">
<pre>WindowPartitionClause ::= &lt;PARTITION&gt; &lt;BY&gt; Expression ("," Expression)*</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window partition clause</strong> divides the tuples into logical partitions
using one or more expressions.</p>
</div>
<div class="paragraph">
<p>This clause may be used with any
<a href="builtins.html#WindowFunctions">window function</a>, or any
<a href="builtins.html#AggregateFunctions">aggregate function</a> used as a
window function.</p>
</div>
<div class="paragraph">
<p>This clause is optional. If omitted, all tuples are united in a single
partition.</p>
</div>
</div>
<div class="sect4">
<h5 id="Window_order_clause">Window Order Clause</h5>
<div class="listingblock">
<div class="content">
<pre>WindowOrderClause ::= &lt;ORDER&gt; &lt;BY&gt; OrderingTerm ("," OrderingTerm)*</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window order clause</strong> determines how tuples are ordered within each
partition. The window function works on tuples in the order specified by
this clause.</p>
</div>
<div class="paragraph">
<p>This clause may be used with any
<a href="builtins.html#WindowFunctions">window function</a>, or any
<a href="builtins.html#AggregateFunctions">aggregate function</a> used as a
window function.</p>
</div>
<div class="paragraph">
<p>This clause is optional. If omitted, all tuples are considered peers,
i.e. their order is tied. When tuples in the window partition are tied,
each window function behaves differently.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>row_number()</code> function returns a distinct number for each tuple.
If tuples are tied, the results may be unpredictable.</p>
</li>
<li>
<p>The <code>rank()</code>, <code>dense_rank()</code>, <code>percent_rank()</code>, and <code>cume_dist()</code>
functions return the same result for each tuple.</p>
</li>
<li>
<p>For other functions, if the <a href="#Window_frame_clause">window frame</a> is
defined by <code>ROWS</code>, the results may be unpredictable. If the window frame
is defined by <code>RANGE</code> or <code>GROUPS</code>, the results are same for each tuple.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This clause may have multiple <a href="#Ordering_term">ordering terms</a>. To
reduce the number of ties, add additional <a href="#Ordering_term">ordering terms</a>.</p>
</div>
<div id="note" class="paragraph">
<p>Note</p>
</div>
<div class="paragraph">
<p>This clause does not guarantee the overall order of the query results.
To guarantee the order of the final results, use the query ORDER BY
clause.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ordering_term">Ordering Term</h5>
<div class="listingblock">
<div class="content">
<pre>OrderingTerm ::= Expression ( &lt;ASC&gt; | &lt;DESC&gt; )?</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>ordering term</strong> specifies an ordering expression and collation.</p>
</div>
<div class="paragraph">
<p>This clause has the same syntax and semantics as the ordering term for
queries. Refer to the <a href="#Order_By_clauses">ORDER BY Clauses</a> section
for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="Window_frame_clause">Window Frame Clause</h5>
<div class="listingblock">
<div class="content">
<pre>WindowFrameClause ::= ( &lt;ROWS&gt; | &lt;RANGE&gt; | &lt;GROUPS&gt; ) WindowFrameExtent</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window frame clause</strong> defines the window frame.</p>
</div>
<div class="paragraph">
<p>This clause can be used with all
<a href="builtins.html#AggregateFunctions">aggregate functions</a> and some
<a href="builtins.html#WindowFunctions">window functions</a> — refer to the
descriptions of individual functions for more details.</p>
</div>
<div class="paragraph">
<p>This clause is allowed only when the <a href="#Window_order_clause">Window Order Clause</a> is present.</p>
</div>
<div class="paragraph">
<p>This clause is optional.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If this clause is omitted and there is no
<a href="#Window_order_clause">Window Order Clause</a>, the window frame is the
entire partition.</p>
</li>
<li>
<p>If this clause is omitted but there is a
<a href="#Window_order_clause">Window Order Clause</a>, the window frame becomes
all tuples in the partition preceding the current tuple and its peers —
the same as <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The window frame can be defined in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ROWS</code>: Counts the exact number of tuples within the frame. If window
ordering doesn’t result in unique ordering, the function may produce
unpredictable results. You can add a unique expression or more window
ordering expressions to produce unique ordering.</p>
</li>
<li>
<p><code>RANGE</code>: Looks for a value offset within the frame. The function
produces deterministic results.</p>
</li>
<li>
<p><code>GROUPS</code>: Counts all groups of tied rows within the frame. The
function produces deterministic results.</p>
</li>
</ul>
</div>
<div id="note-1" class="paragraph">
<p>Note</p>
</div>
<div class="paragraph">
<p>If this clause uses <code>RANGE</code> with either <code>Expression PRECEDING</code> or
<code>Expression FOLLOWING</code>, the <a href="#Window_order_clause">Window Order Clause</a> must have only a single ordering term.</p>
</div>
<div class="paragraph">
<p>The ordering term expression must evaluate to a number.</p>
</div>
<div class="paragraph">
<p>If these conditions are not met, the window frame will be empty, which
means the window function will return its default value: in most cases
this is NULL, except for <code>strict_count()</code> or <code>array_count()</code>, whose
default value is 0.</p>
</div>
<div class="paragraph">
<p>This restriction does not apply when the window frame uses <code>ROWS</code> or
<code>GROUPS</code>.</p>
</div>
<div id="tip" class="paragraph">
<p>Tip</p>
</div>
<div class="paragraph">
<p>The <code>RANGE</code> window frame is commonly used to define window frames based
on date or time.</p>
</div>
<div class="paragraph">
<p>If you want to use <code>RANGE</code> with either <code>Expression PRECEDING</code> or
<code>Expression FOLLOWING</code>, and you want to use an ordering expression based
on date or time, the expression in <code>Expression PRECEDING</code> or
<code>Expression FOLLOWING</code> must use a data type that can be added to the
ordering expression.</p>
</div>
</div>
<div class="sect4">
<h5 id="window-frame-extent">Window Frame Extent</h5>
<div class="listingblock">
<div class="content">
<pre>WindowFrameExtent ::= ( ( &lt;UNBOUNDED&gt; | Expression ) &lt;PRECEDING&gt; | &lt;CURRENT&gt; &lt;ROW&gt; ) |
&lt;BETWEEN&gt;
  ( &lt;UNBOUNDED&gt; &lt;PRECEDING&gt; | &lt;CURRENT&gt; &lt;ROW&gt; | Expression ( &lt;PRECEDING&gt; | &lt;FOLLOWING&gt; ) )
&lt;AND&gt;
  ( &lt;UNBOUNDED&gt; &lt;FOLLOWING&gt; | &lt;CURRENT&gt; &lt;ROW&gt; | Expression ( &lt;PRECEDING&gt; | &lt;FOLLOWING&gt; ) )</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window frame extent clause</strong> specifies the start point and end point
of the window frame. The expression before <code>AND</code> is the start point and
the expression after <code>AND</code> is the end point. If <code>BETWEEN</code> is omitted,
you can only specify the start point; the end point becomes
<code>CURRENT ROW</code>.</p>
</div>
<div class="paragraph">
<p>The window frame end point can’t be before the start point. If this
clause violates this restriction explicitly, an error will result. If it
violates this restriction implicitly, the window frame will be empty,
which means the window function will return its default value: in most
cases this is NULL, except for <code>strict_count()</code> or <code>array_count()</code>,
whose default value is 0.</p>
</div>
<div class="paragraph">
<p>Window frame extents that result in an explicit violation are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BETWEEN CURRENT ROW AND Expression PRECEDING</code></p>
</li>
<li>
<p><code>BETWEEN Expression FOLLOWING AND Expression PRECEDING</code></p>
</li>
<li>
<p><code>BETWEEN Expression FOLLOWING AND CURRENT ROW</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Window frame extents that result in an implicit violation are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BETWEEN UNBOUNDED PRECEDING AND Expression PRECEDING</code> — if
<code>Expression</code> is too high, some tuples may generate an empty window
frame.</p>
</li>
<li>
<p><code>BETWEEN Expression PRECEDING AND Expression PRECEDING</code> — if the
second <code>Expression</code> is greater than or equal to the first <code>Expression</code>,
all result sets will generate an empty window frame.</p>
</li>
<li>
<p><code>BETWEEN Expression FOLLOWING AND Expression FOLLOWING</code> — if the first
<code>Expression</code> is greater than or equal to the second <code>Expression</code>, all
result sets will generate an empty window frame.</p>
</li>
<li>
<p><code>BETWEEN Expression FOLLOWING AND UNBOUNDED FOLLOWING</code> — if
<code>Expression</code> is too high, some tuples may generate an empty window
frame.</p>
</li>
<li>
<p>If the <a href="#Window_frame_exclusion">Window Frame Exclusion clause</a> is
present, any window frame specification may result in empty window
frame.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Expression</code> must be a positive constant or an expression that
evaluates as a positive number. For <code>ROWS</code> or <code>GROUPS</code>, the <code>Expression</code>
must be an integer.</p>
</div>
</div>
<div class="sect4">
<h5 id="Window_frame_exclusion">Window Frame Exclusion</h5>
<div class="listingblock">
<div class="content">
<pre>WindowFrameExclusion ::= &lt;EXCLUDE&gt; ( &lt;CURRENT&gt; &lt;ROW&gt; | &lt;GROUP&gt; | &lt;TIES&gt; |
&lt;NO&gt; &lt;OTHERS&gt; )</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>window frame exclusion clause</strong> enables you to exclude specified
tuples from the window frame.</p>
</div>
<div class="paragraph">
<p>This clause can be used with all
<a href="builtins.html#AggregateFunctions">aggregate functions</a> and some
<a href="builtins.html#WindowFunctions">window functions</a> — refer to the
descriptions of individual functions for more details.</p>
</div>
<div class="paragraph">
<p>This clause is allowed only when the <a href="#Window_frame_clause">Window Frame Clause</a> is present.</p>
</div>
<div class="paragraph">
<p>This clause is optional. If this clause is omitted, the default is no
exclusion — the same as <code>EXCLUDE NO OTHERS</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EXCLUDE CURRENT ROW</code>: If the current tuple is still part of the
window frame, it is removed from the window frame.</p>
</li>
<li>
<p><code>EXCLUDE GROUP</code>: The current tuple and any peers of the current tuple
are removed from the window frame.</p>
</li>
<li>
<p><code>EXCLUDE TIES</code>: Any peers of the current tuple, but not the current
tuple itself, are removed from the window frame.</p>
</li>
<li>
<p><code>EXCLUDE NO OTHERS</code>: No additional tuples are removed from the window
frame.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the current tuple is already removed from the window frame, then it
remains removed from the window frame.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="subqueries">Subqueries</h3>
<div class="paragraph">
<p>In the query language, an arbitrary subquery can appear anywhere that an
expression can appear. Unlike SQL-92, as was just alluded to, the
subqueries in a SELECT list or a boolean predicate need not return
singleton, single-column relations. Instead, they may return arbitrary
collections. For example, the following query is a variant of the prior
group-by query examples; it retrieves an array of up to two "dislike"
messages per user.</p>
</div>
<div id="example-37" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT uid,
       (SELECT VALUE m.msg
        FROM msgs m
        WHERE m.msg.message LIKE '%dislike%'
        ORDER BY m.msg.messageId
        LIMIT 2) AS msgs
FROM GleambookMessages message
GROUP BY message.authorId AS uid GROUP AS msgs(message AS msg);</pre>
</div>
</div>
<div class="paragraph">
<p>For our sample data set, this query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ {
    "msgs": [
        {
            "senderLocation": [
                41.66,
                80.87
            ],
            "inResponseTo": 4,
            "messageId": 2,
            "authorId": 1,
            "message": " dislike x-phone its touch-screen is horrible"
        }
    ],
    "uid": 1
}, {
    "msgs": [

    ],
    "uid": 2
} ]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that a subquery, like a top-level <code>SELECT</code> statment, always returns
a collection&#8201;&#8212;&#8201;regardless of where within a query the subquery occurs&#8201;&#8212;&#8201;and again, its result is never automatically cast into a scalar.</p>
</div>
</div>
<div class="sect2">
<h3 id="differences-from-sql-92">Differences from SQL-92</h3>
<div class="paragraph">
<p>The query language offers the following additional features beyond
SQL-92:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fully composable and functional: A subquery can iterate over any
intermediate collection and can appear anywhere in a query.</p>
</li>
<li>
<p>Schema-free: The query language does not assume the existence of a
static schema for any data that it processes.</p>
</li>
<li>
<p>Correlated FROM terms: A right-side FROM term expression can refer to
variables defined by FROM terms on its left.</p>
</li>
<li>
<p>Powerful GROUP BY: In addition to a set of aggregate functions as in
standard SQL, the groups created by the <code>GROUP BY</code> clause are directly
usable in nested queries and/or to obtain nested results.</p>
</li>
<li>
<p>Generalized SELECT clause: A SELECT clause can return any type of
collection, while in SQL-92, a <code>SELECT</code> clause has to return a
(homogeneous) collection of objects.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following matrix is a quick "SQL-92 compatibility cheat sheet" for
the query language.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-left valign-top">The query language</th>
<th class="tableblock halign-left valign-top">SQL-92</th>
<th class="tableblock halign-left valign-top">Why different?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns nested objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns flattened concatenated
objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nested collections are 1st class citizens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order not preserved</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order preserved</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fields in a JSON
object are not ordered</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subquery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The returned collection is cast into a
scalar value if the subquery appears in a SELECT list or on one side of
a comparison or as input to a function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nested collections are 1st class
citizens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEFT OUTER JOIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fills in <code>MISSING</code>(s) for non-matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fills in
<code>NULL</code>(s) for non-matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Absence" is more appropriate than "unknown"
here</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNION ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows heterogeneous inputs and output</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input streams must
be UNION-compatible and output field names are drawn from the first
input stream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heterogenity and nested collections are common</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IN constant_expr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The constant expression has to be an array or
multiset, i.e., [..,..,&#8230;&#8203;]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The constant collection can be represented
as comma-separated items in a paren pair</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nested collections are 1st
class citizens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double quotes or single quotes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single quotes only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double quoted strings are pervasive</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delimited identifiers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backticks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double quotes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double quoted strings
are pervasive</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following SQL-92 features are not implemented yet. However, the
query language does not conflict with these features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CROSS JOIN, NATURAL JOIN, UNION JOIN</p>
</li>
<li>
<p>RIGHT and FULL OUTER JOIN</p>
</li>
<li>
<p>INTERSECT, EXCEPT, UNION with set semantics</p>
</li>
<li>
<p>CAST expression</p>
</li>
<li>
<p>COALESCE expression</p>
</li>
<li>
<p>ALL and SOME predicates for linking to subqueries</p>
</li>
<li>
<p>UNIQUE predicate (tests a collection for duplicates)</p>
</li>
<li>
<p>MATCH predicate (tests for referential integrity)</p>
</li>
<li>
<p>Row and Table constructors</p>
</li>
<li>
<p>Preserved order for expressions in a SELECT list</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="errors">4. Errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A query can potentially result in one of the following errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>syntax error,</p>
</li>
<li>
<p>identifier resolution error,</p>
</li>
<li>
<p>type error,</p>
</li>
<li>
<p>resource error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the query processor runs into any error, it will terminate the
ongoing processing of the query and immediately return an error message
to the client.</p>
</div>
<div class="sect2">
<h3 id="syntax-errors">Syntax Errors</h3>
<div class="paragraph">
<p>A valid query must satisfy the grammar rules of the query language.
Otherwise, a syntax error will be raised.</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
GleambookUsers user</pre>
</div>
</div>
<div class="paragraph">
<p>Since the query misses a <code>FROM</code> keyword before the dataset
<code>GleambookUsers</code>, we will get a syntax error as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Syntax error: In line 2 &gt;&gt;GleambookUsers user;&lt;&lt; Encountered &lt;IDENTIFIER&gt; \"GleambookUsers\" at column 1.</pre>
</div>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookUsers user
WHERE type="advertiser";</pre>
</div>
</div>
<div class="paragraph">
<p>Since "type" is a reserved keyword in the query parser, we will get a
syntax error as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: Syntax error: In line 3 &gt;&gt;WHERE type="advertiser";&lt;&lt; Encountered 'type' "type" at column 7.
==&gt; WHERE type="advertiser";</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="identifier-resolution-errors">Identifier Resolution Errors</h3>
<div class="paragraph">
<p>Referring to an undefined identifier can cause an error if the
identifier cannot be successfully resolved as a valid field access.</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM GleambookUser user;</pre>
</div>
</div>
<div class="paragraph">
<p>If we have a typo as above in "GleambookUsers" that misses the dataset
name&#8217;s ending "s", we will get an identifier resolution error as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: Cannot find dataset GleambookUser in dataverse Default nor an alias with name GleambookUser!</pre>
</div>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT name, message
FROM GleambookUsers u JOIN GleambookMessages m ON m.authorId = u.id;</pre>
</div>
</div>
<div class="paragraph">
<p>If the compiler cannot figure out how to resolve an unqualified field
name, which will occur if there is more than one variable in scope
(e.g., <code>GleambookUsers u</code> and <code>GleambookMessages m</code> as above), we will
get an identifier resolution error as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: Cannot resolve ambiguous alias reference for undefined identifier name</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-errors">Type Errors</h3>
<div class="paragraph">
<p>The query compiler does type checks based on its available type
information. In addition, the query runtime also reports type errors if
a data model instance it processes does not satisfy the type
requirement.</p>
</div>
<div id="example-4" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>abs("123");</pre>
</div>
</div>
<div class="paragraph">
<p>Since function <code>abs</code> can only process numeric input values, we will get
a type error as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: Type mismatch: function abs expects its 1st input parameter to be of type tinyint, smallint, integer, bigint, float or double, but the actual input type is string</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resource-errors">Resource Errors</h3>
<div class="paragraph">
<p>A query can potentially exhaust system resources, such as the number of
open files and disk spaces. For instance, the following two resource
errors could be potentially be seen when running the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error: no space left on device
Error: too many open files</pre>
</div>
</div>
<div class="paragraph">
<p>The "no space left on device" issue usually can be fixed by cleaning up
disk spaces and reserving more disk spaces for the system. The "too many
open files" issue usually can be fixed by a system administrator,
following the instructions
<a href="https://easyengine.io/tutorials/linux/increase-open-files-limit/">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ddl-and-dml-statements">5. DDL and DML statements</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>Statement ::= ( ( SingleStatement )? ( ";" )+ )* &lt;EOF&gt;
SingleStatement ::= DatabaseDeclaration
                  | FunctionDeclaration
                  | CreateStatement
                  | DropStatement
                  | LoadStatement
                  | SetStatement
                  | InsertStatement
                  | DeleteStatement
                  | Query</pre>
</div>
</div>
<div class="paragraph">
<p>In addition to queries, an implementation of the query language needs to
support statements for data definition and manipulation purposes as well
as controlling the context to be used in evaluating query expressions.
This section details the DDL and DML statements supported in the query
language as realized today in Apache AsterixDB.</p>
</div>
<div class="sect2">
<h3 id="lifecycle-management-statements">Lifecycle Management Statements</h3>
<div class="listingblock">
<div class="content">
<pre>CreateStatement ::= "CREATE" ( DatabaseSpecification
                             | TypeSpecification
                             | DatasetSpecification
                             | IndexSpecification
                             | SynonymSpecification
                             | FunctionSpecification )

QualifiedName       ::= Identifier ( "." Identifier )?
DoubleQualifiedName ::= Identifier "." Identifier ( "." Identifier )?</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE statement is used for creating dataverses as well as other
persistent artifacts in a dataverse. It can be used to create new
dataverses, datatypes, datasets, indexes, and user-defined query
functions.</p>
</div>
<div class="sect3">
<h4 id="dataverses">Dataverses</h4>
<div class="listingblock">
<div class="content">
<pre>DatabaseSpecification ::= "DATAVERSE" Identifier IfNotExists</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE DATAVERSE statement is used to create new dataverses. To ease
the authoring of reusable query scripts, an optional IF NOT EXISTS
clause is included to allow creation to be requested either
unconditionally or only if the dataverse does not already exist. If this
clause is absent, an error is returned if a dataverse with the indicated
name already exists.</p>
</div>
<div class="paragraph">
<p>The following example creates a new dataverse named TinySocial if one
does not already exist.</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE DATAVERSE TinySocial IF NOT EXISTS;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="types">Types</h4>
<div class="listingblock">
<div class="content">
<pre>TypeSpecification    ::= "TYPE" FunctionOrTypeName IfNotExists "AS" ObjectTypeDef
FunctionOrTypeName   ::= QualifiedName
IfNotExists          ::= ( &lt;IF&gt; &lt;NOT&gt; &lt;EXISTS&gt; )?
TypeExpr             ::= ObjectTypeDef | TypeReference | ArrayTypeDef | MultisetTypeDef
ObjectTypeDef        ::= ( &lt;CLOSED&gt; | &lt;OPEN&gt; )? "{" ( ObjectField ( "," ObjectField )* )? "}"
ObjectField          ::= Identifier ":" ( TypeExpr ) ( "?" )?
NestedField          ::= Identifier ( "." Identifier )*
IndexField           ::= NestedField ( ":" TypeReference )?
TypeReference        ::= Identifier
ArrayTypeDef         ::= "[" ( TypeExpr ) "]"
MultisetTypeDef      ::= "{{" ( TypeExpr ) "}}"</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE TYPE statement is used to create a new named datatype. This
type can then be used to create stored collections or utilized when
defining one or more other datatypes. Much more information about the
data model is available in the <a href="../datamodel.html">data model
reference guide</a>. A new type can be a object type, a renaming of another
type, an array type, or a multiset type. A object type can be defined as
being either open or closed. Instances of a closed object type are not
permitted to contain fields other than those specified in the create
type statement. Instances of an open object type may carry additional
fields, and open is the default for new types if neither option is
specified.</p>
</div>
<div class="paragraph">
<p>The following example creates a new object type called GleambookUser
type. Since it is defined as (defaulting to) being an open type,
instances will be permitted to contain more than what is specified in
the type definition. The first four fields are essentially traditional
typed name/value pairs (much like SQL fields). The friendIds field is a
multiset of integers. The employment field is an array of instances of
another named object type, EmploymentType.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE TYPE GleambookUserType AS {
  id:         int,
  alias:      string,
  name:       string,
  userSince: datetime,
  friendIds: {{ int }},
  employment: [ EmploymentType ]
};</pre>
</div>
</div>
<div class="paragraph">
<p>The next example creates a new object type, closed this time, called
MyUserTupleType. Instances of this closed type will not be permitted to
have extra fields, although the alias field is marked as optional and
may thus be NULL or MISSING in legal instances of the type. Note that
the type of the id field in the example is UUID. This field type can be
used if you want to have this field be an autogenerated-PK field. (Refer
to the Datasets section later for more details on such fields.)</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE TYPE MyUserTupleType AS CLOSED {
  id:         uuid,
  alias:      string?,
  name:       string
};</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="datasets">Datasets</h4>
<div class="listingblock">
<div class="content">
<pre>DatasetSpecification ::= ( &lt;INTERNAL&gt; )? &lt;DATASET&gt; QualifiedName "(" QualifiedName ")" IfNotExists
                           PrimaryKey ( &lt;ON&gt; Identifier )? ( &lt;HINTS&gt; Properties )?
                           ( "USING" "COMPACTION" "POLICY" CompactionPolicy ( Configuration )? )?
                           ( &lt;WITH&gt; &lt;FILTER&gt; &lt;ON&gt; Identifier )?
                          |
                           &lt;EXTERNAL&gt; &lt;DATASET&gt; QualifiedName "(" QualifiedName ")" IfNotExists &lt;USING&gt; AdapterName
                           Configuration ( &lt;HINTS&gt; Properties )?
                           ( &lt;USING&gt; &lt;COMPACTION&gt; &lt;POLICY&gt; CompactionPolicy ( Configuration )? )?
AdapterName          ::= Identifier
Configuration        ::= "(" ( KeyValuePair ( "," KeyValuePair )* )? ")"
KeyValuePair         ::= "(" StringLiteral "=" StringLiteral ")"
Properties           ::= ( "(" Property ( "," Property )* ")" )?
Property             ::= Identifier "=" ( StringLiteral | IntegerLiteral )
FunctionSignature    ::= FunctionOrTypeName "@" IntegerLiteral
PrimaryKey           ::= &lt;PRIMARY&gt; &lt;KEY&gt; NestedField ( "," NestedField )* ( &lt;AUTOGENERATED&gt; )?
CompactionPolicy     ::= Identifier</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE DATASET statement is used to create a new dataset. Datasets
are named, multisets of object type instances; they are where data lives
persistently and are the usual targets for queries. Datasets are typed,
and the system ensures that their contents conform to their type
definitions. An Internal dataset (the default kind) is a dataset whose
content lives within and is managed by the system. It is required to
have a specified unique primary key field which uniquely identifies the
contained objects. (The primary key is also used in secondary indexes to
identify the indexed primary data objects.)</p>
</div>
<div class="paragraph">
<p>Internal datasets contain several advanced options that can be specified
when appropriate. One such option is that random primary key (UUID)
values can be auto-generated by declaring the field to be UUID and
putting "AUTOGENERATED" after the "PRIMARY KEY" identifier. In this
case, unlike other non-optional fields, a value for the auto-generated
PK field should not be provided at insertion time by the user since each
object&#8217;s primary key field value will be auto-generated by the system.</p>
</div>
<div class="paragraph">
<p>Another advanced option, when creating an Internal dataset, is to
specify the merge policy to control which of the underlying LSM storage
components to be merged. (The system supports Log-Structured Merge tree
based physical storage for Internal datasets.) Currently the system
supports four different component merging policies that can be chosen
per dataset: no-merge, constant, prefix, and correlated-prefix. The
no-merge policy simply never merges disk components. The constant policy
merges disk components when the number of components reaches a constant
number k that can be configured by the user. The prefix policy relies on
both component sizes and the number of components to decide which
components to merge. It works by first trying to identify the smallest
ordered (oldest to newest) sequence of components such that the sequence
does not contain a single component that exceeds some threshold size M
and that either the sum of the component&#8217;s sizes exceeds M or the number
of components in the sequence exceeds another threshold C. If such a
sequence exists, the components in the sequence are merged together to
form a single component. Finally, the correlated-prefix policy is
similar to the prefix policy, but it delegates the decision of merging
the disk components of all the indexes in a dataset to the primary
index. When the correlated-prefix policy decides that the primary index
needs to be merged (using the same decision criteria as for the prefix
policy), then it will issue successive merge requests on behalf of all
other indexes associated with the same dataset. The system&#8217;s default
policy is the prefix policy except when there is a filter on a dataset,
where the preferred policy for filters is the correlated-prefix.</p>
</div>
<div class="paragraph">
<p>Another advanced option shown in the syntax above, related to
performance and mentioned above, is that a <strong>filter</strong> can optionally be
created on a field to further optimize range queries with predicates on
the filter&#8217;s field. Filters allow some range queries to avoid searching
all LSM components when the query conditions match the filter. (Refer to
<a href="../filters.html">Filter-Based LSM Index Acceleration</a> for more
information about filters.)</p>
</div>
<div class="paragraph">
<p>An External dataset, in contrast to an Internal dataset, has data stored
outside of the system&#8217;s control. Files living in HDFS or in the local
filesystem(s) of a cluster&#8217;s nodes are currently supported. External
dataset support allows queries to treat foreign data as though it were
stored in the system, making it possible to query "legacy" file data
(for example, Hive data) without having to physically import it. When
defining an External dataset, an appropriate adapter type must be
selected for the desired external data. (See the
<a href="../externaldata.html">Guide to External Data</a> for more information
on the available adapters.)</p>
</div>
<div class="paragraph">
<p>The following example creates an Internal dataset for storing
FacefookUserType objects. It specifies that their id field is their
primary key.</p>
</div>
<div class="sect4">
<h5 id="example-3">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INTERNAL DATASET GleambookUsers(GleambookUserType) PRIMARY KEY id;</pre>
</div>
</div>
<div class="paragraph">
<p>The next example creates another Internal dataset (the default kind when
no dataset kind is specified) for storing MyUserTupleType objects. It
specifies that the id field should be used as the primary key for the
dataset. It also specifies that the id field is an auto-generated field,
meaning that a randomly generated UUID value should be assigned to each
incoming object by the system. (A user should therefore not attempt to
provide a value for this field.) Note that the id field&#8217;s declared type
must be UUID in this case.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-4">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE DATASET MyUsers(MyUserTupleType) PRIMARY KEY id AUTOGENERATED;</pre>
</div>
</div>
<div class="paragraph">
<p>The next example creates an External dataset for querying LineItemType
objects. The choice of the <code>hdfs</code> adapter means that this dataset&#8217;s data
actually resides in HDFS. The example CREATE statement also provides
parameters used by the hdfs adapter: the URL and path needed to locate
the data in HDFS and a description of the data format.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-5">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE EXTERNAL DATASET LineItem(LineItemType) USING hdfs (
  ("hdfs"="hdfs://HOST:PORT"),
  ("path"="HDFS_PATH"),
  ("input-format"="text-input-format"),
  ("format"="delimited-text"),
  ("delimiter"="|"));</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indices">Indices</h4>
<div class="listingblock">
<div class="content">
<pre>IndexSpecification ::= (&lt;INDEX&gt; Identifier IfNotExists &lt;ON&gt; QualifiedName
                       "(" ( IndexField ) ( "," IndexField )* ")" (&lt;TYPE&gt; IndexType)? (&lt;ENFORCED&gt;)?)
                       |
                       &lt;PRIMARY&gt; &lt;INDEX&gt; Identifier? IfNotExists &lt;ON&gt; QualifiedName (&lt;TYPE&gt; &lt;BTREE&gt;)?
IndexType          ::= &lt;BTREE&gt; | &lt;RTREE&gt; | &lt;KEYWORD&gt; | &lt;NGRAM&gt; "(" IntegerLiteral ")"</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE INDEX statement creates a secondary index on one or more
fields of a specified dataset. Supported index types include <code>BTREE</code> for
totally ordered datatypes, <code>RTREE</code> for spatial data, and <code>KEYWORD</code> and
<code>NGRAM</code> for textual (string) data. An index can be created on a nested
field (or fields) by providing a valid path expression as an index field
identifier.</p>
</div>
<div class="paragraph">
<p>An indexed field is not required to be part of the datatype associated
with a dataset if the dataset&#8217;s datatype is declared as open <strong>and</strong> if
the field&#8217;s type is provided along with its name and if the <code>ENFORCED</code>
keyword is specified at the end of the index definition. <code>ENFORCING</code> an
open field introduces a check that makes sure that the actual type of
the indexed field (if the optional field exists in the object) always
matches this specified (open) field type.</p>
</div>
<div class="paragraph">
<p>The following example creates a btree index called gbAuthorIdx on the
authorId field of the GleambookMessages dataset. This index can be
useful for accelerating exact-match queries, range search queries, and
joins involving the author-id field.</p>
</div>
<div class="sect4">
<h5 id="example-6">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX gbAuthorIdx ON GleambookMessages(authorId) TYPE BTREE;</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates an open btree index called gbSendTimeIdx
on the (non-declared) <code>sendTime</code> field of the GleambookMessages dataset
having datetime type. This index can be useful for accelerating
exact-match queries, range search queries, and joins involving the
<code>sendTime</code> field. The index is enforced so that records that do not have
the <code>sendTime</code> field or have a mismatched type on the field cannot be
inserted into the dataset.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-7">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX gbSendTimeIdx ON GleambookMessages(sendTime: datetime?) TYPE BTREE ENFORCED;</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates an open btree index called gbReadTimeIdx
on the (non-declared) <code>readTime</code> field of the GleambookMessages dataset
having datetime type. This index can be useful for accelerating
exact-match queries, range search queries, and joins involving the
<code>readTime</code> field. The index is not enforced so that records that do not
have the <code>readTime</code> field or have a mismatched type on the field can
still be inserted into the dataset.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-8">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX gbReadTimeIdx ON GleambookMessages(readTime: datetime?);</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates a btree index called crpUserScrNameIdx on
screenName, a nested field residing within a object-valued user field in
the ChirpMessages dataset. This index can be useful for accelerating
exact-match queries, range search queries, and joins involving the
nested screenName field. Such nested fields must be singular, i.e., one
cannot index through (or on) an array-valued field.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-9">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX crpUserScrNameIdx ON ChirpMessages(user.screenName) TYPE BTREE;</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates an rtree index called gbSenderLocIdx on
the sender-location field of the GleambookMessages dataset. This index
can be useful for accelerating queries that use the
<a href="functions.html#spatial-intersect"><code>spatial-intersect</code> function</a> in a
predicate involving the sender-location field.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-10">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX gbSenderLocIndex ON GleambookMessages("sender-location") TYPE RTREE;</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates a 3-gram index called fbUserIdx on the
name field of the GleambookUsers dataset. This index can be used to
accelerate some similarity or substring maching queries on the name
field. For details refer to the document on
<a href="similarity.html#NGram_Index">similarity queries</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-11">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX fbUserIdx ON GleambookUsers(name) TYPE NGRAM(3);</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates a keyword index called fbMessageIdx on the
message field of the GleambookMessages dataset. This keyword index can
be used to optimize queries with token-based similarity predicates on
the message field. For details refer to the document on
<a href="similarity.html#Keyword_Index">similarity queries</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-12">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX fbMessageIdx ON GleambookMessages(message) TYPE KEYWORD;</pre>
</div>
</div>
<div class="paragraph">
<p>The following example creates a special secondary index which holds only
the primary keys. This index is useful for speeding up aggregation
queries which involve only primary keys. The name of the index is
optional. If the name is not specified, the system will generate one.
When the user would like to drop this index, the metadata can be queried
to find the system-generated name.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-13">Example</h5>
<div class="listingblock">
<div class="content">
<pre>CREATE PRIMARY INDEX gb_pk_idx ON GleambookMessages;</pre>
</div>
</div>
<div class="paragraph">
<p>An example query that can be accelerated using the primary-key index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT COUNT(*) FROM GleambookMessages;</pre>
</div>
</div>
<div class="paragraph">
<p>To look up the the above primary-key index, issue the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT VALUE i
FROM Metadata.`Index` i
WHERE i.DataverseName = "TinySocial" AND i.DatasetName = "GleambookMessages";</pre>
</div>
</div>
<div class="paragraph">
<p>The query returns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ { "DataverseName": "TinySocial", "DatasetName": "GleambookMessages", "IndexName": "GleambookMessages", "IndexStructure": "BTREE", "SearchKey": [ [ "messageId" ] ], "IsPrimary": true, "Timestamp": "Wed Nov 07 17:25:11 PST 2018", "PendingOp": 0 }
, { "DataverseName": "TinySocial", "DatasetName": "GleambookMessages", "IndexName": "gb_pk_idx", "IndexStructure": "BTREE", "SearchKey": [  ], "IsPrimary": false, "Timestamp": "Wed Nov 07 17:25:11 PST 2018", "PendingOp": 0 }
 ]</pre>
</div>
</div>
<div class="paragraph">
<p>Remember that <code>CREATE PRIMARY INDEX</code> creates a secondary index. That is
the reason the <code>IsPrimary</code> field is false. The primary-key index can be
identified by the fact that the <code>SearchKey</code> field is empty since it only
contains primary key fields.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="functions">Functions</h4>
<div class="paragraph">
<p>The CREATE FUNCTION statement creates a <strong>named</strong> function that can then
be used and reused in queries. The body of a function can be any query
expression involving the function&#8217;s parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FunctionSpecification ::= "FUNCTION" FunctionOrTypeName IfNotExists ParameterList "{" Expression "}"</pre>
</div>
</div>
<div class="paragraph">
<p>The following is an example of a CREATE FUNCTION statement which is
similar to our earlier DECLARE FUNCTION example. It differs from that
example in that it results in a function that is persistently registered
by name in the specified dataverse (the current dataverse being used, if
not otherwise specified).</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE FUNCTION friendInfo(userId) {
    (SELECT u.id, u.name, len(u.friendIds) AS friendCount
     FROM GleambookUsers u
     WHERE u.id = userId)[0]
 };</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="synonyms">Synonyms</h4>
<div class="listingblock">
<div class="content">
<pre>SynonymSpecification ::= "SYNONYM" QualifiedName "FOR" QualifiedName IfNotExists</pre>
</div>
</div>
<div class="paragraph">
<p>The CREATE SYNONYM statement creates a synonym for a given dataset. This
synonym may be used used instead of the dataset name in SELECT, INSERT,
UPSERT, DELETE, and LOAD statements. The target dataset does not need to
exist when the synonym is created.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE DATASET GleambookUsers(GleambookUserType) PRIMARY KEY id;

CREATE SYNONYM GleambookUsersSynonym FOR GleambookUsers;

SELECT * FROM GleambookUsersSynonym;</pre>
</div>
</div>
<div class="paragraph">
<p>More information on how synonyms are resolved can be found in the
appendix section on Variable Resolution.</p>
</div>
</div>
<div class="sect3">
<h4 id="removal">Removal</h4>
<div class="listingblock">
<div class="content">
<pre>DropStatement       ::= "DROP" ( "DATAVERSE" Identifier IfExists
                               | "TYPE" FunctionOrTypeName IfExists
                               | "DATASET" QualifiedName IfExists
                               | "INDEX" DoubleQualifiedName IfExists
                               | "SYNONYM" QualifiedName IfExists
                               | "FUNCTION" FunctionSignature IfExists )
IfExists            ::= ( "IF" "EXISTS" )?</pre>
</div>
</div>
<div class="paragraph">
<p>The DROP statement is the inverse of the CREATE statement. It can be
used to drop dataverses, datatypes, datasets, indexes, functions, and
synonyms.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate some uses of the DROP statement.</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DROP DATASET GleambookUsers IF EXISTS;

DROP INDEX GleambookMessages.gbSenderLocIndex;

DROP TYPE TinySocial2.GleambookUserType;

DROP FUNCTION friendInfo@1;

DROP SYNONYM GleambookUsersSynonym;

DROP DATAVERSE TinySocial;</pre>
</div>
</div>
<div class="paragraph">
<p>When an artifact is dropped, it will be droppped from the current
dataverse if none is specified (see the DROP DATASET example above) or
from the specified dataverse (see the DROP TYPE example above) if one is
specified by fully qualifying the artifact name in the DROP statement.
When specifying an index to drop, the index name must be qualified by
the dataset that it indexes. When specifying a function to drop, since
the query language allows functions to be overloaded by their number of
arguments, the identifying name of the function to be dropped must
explicitly include that information. (<code>friendInfo@1</code> above denotes the
1-argument function named friendInfo in the current dataverse.)</p>
</div>
</div>
<div class="sect3">
<h4 id="load-statement">Load Statement</h4>
<div class="listingblock">
<div class="content">
<pre>LoadStatement  ::= &lt;LOAD&gt; &lt;DATASET&gt; QualifiedName &lt;USING&gt; AdapterName Configuration ( &lt;PRE-SORTED&gt; )?</pre>
</div>
</div>
<div class="paragraph">
<p>The LOAD statement is used to initially populate a dataset via bulk
loading of data from an external file. An appropriate adapter must be
selected to handle the nature of the desired external data. The LOAD
statement accepts the same adapters and the same parameters as discussed
earlier for External datasets. (See the <a href="externaldata.html">guide to
external data</a> for more information on the available adapters.) If a
dataset has an auto-generated primary key field, the file to be imported
should not include that field in it.</p>
</div>
<div class="paragraph">
<p>The target dataset name may be a synonym introduced by CREATE SYNONYM
statement.</p>
</div>
<div class="paragraph">
<p>The following example shows how to bulk load the GleambookUsers dataset
from an external file containing data that has been prepared in ADM
(Asterix Data Model) format.</p>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre> LOAD DATASET GleambookUsers USING localfs
    (("path"="127.0.0.1:///Users/bignosqlfan/tinysocialnew/gbu.adm"),("format"="adm"));</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modification-statements">Modification statements</h3>
<div class="sect3">
<h4 id="inserts">INSERTs</h4>
<div class="listingblock">
<div class="content">
<pre>InsertStatement ::= &lt;INSERT&gt; &lt;INTO&gt; QualifiedName Query</pre>
</div>
</div>
<div class="paragraph">
<p>The INSERT statement is used to insert new data into a dataset. The data
to be inserted comes from a query expression. This expression can be as
simple as a constant expression, or in general it can be any legal
query. In case the dataset has an auto-generated primary key, when
performing an INSERT operation, the system allows the user to manually
add the auto-generated key field in the INSERT statement, or skip that
field and the system will automatically generate it and add it. However,
it is important to note that if the a record already exists in the
dataset with the auto-generated key provided by the user, then that
operation is going to fail. As a general rule, insertion will fail if
the dataset already has data with the primary key value(s) being
inserted.</p>
</div>
<div class="paragraph">
<p>Inserts are processed transactionally by the system. The transactional
scope of each insert transaction is the insertion of a single object
plus its affiliated secondary index entries (if any). If the query part
of an insert returns a single object, then the INSERT statement will be
a single, atomic transaction. If the query part returns multiple
objects, each object being inserted will be treated as a separate
tranaction.</p>
</div>
<div class="paragraph">
<p>The target dataset name may be a synonym introduced by CREATE SYNONYM
statement.</p>
</div>
<div class="paragraph">
<p>The following example illustrates a query-based insertion.</p>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO UsersCopy (SELECT VALUE user FROM GleambookUsers user)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="upserts">UPSERTs</h4>
<div class="listingblock">
<div class="content">
<pre>UpsertStatement ::= &lt;UPSERT&gt; &lt;INTO&gt; QualifiedName Query</pre>
</div>
</div>
<div class="paragraph">
<p>The UPSERT statement syntactically mirrors the INSERT statement
discussed above. The difference lies in its semantics, which for UPSERT
are "add or replace" instead of the INSERT "add if not present, else
error" semantics. Whereas an INSERT can fail if another object already
exists with the specified key, the analogous UPSERT will replace the
previous object&#8217;s value with that of the new object in such cases. Like
the INSERT statement, the system allows the user to manually provide the
auto-generated key for datasets with an auto-generated key as its
primary key. This operation will insert the record if no record with
that key already exists, but if a record with the key already exists,
then the operation will be converted to a replace/update operation.</p>
</div>
<div class="paragraph">
<p>The target dataset name may be a synonym introduced by CREATE SYNONYM
statement.</p>
</div>
<div class="paragraph">
<p>The following example illustrates a query-based upsert operation.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>UPSERT INTO UsersCopy (SELECT VALUE user FROM GleambookUsers user)</pre>
</div>
</div>
<div class="paragraph">
<p>*Editor&#8217;s note: Upserts currently work in AQL but are not yet enabled
(at the moment) in the current query language.</p>
</div>
</div>
<div class="sect3">
<h4 id="deletes">DELETEs</h4>
<div class="listingblock">
<div class="content">
<pre>DeleteStatement ::= &lt;DELETE&gt; &lt;FROM&gt; QualifiedName ( ( &lt;AS&gt; )? Variable )? ( &lt;WHERE&gt; Expression )?</pre>
</div>
</div>
<div class="paragraph">
<p>The DELETE statement is used to delete data from a target dataset. The
data to be deleted is identified by a boolean expression involving the
variable bound to the target dataset in the DELETE statement.</p>
</div>
<div class="paragraph">
<p>Deletes are processed transactionally by the system. The transactional
scope of each delete transaction is the deletion of a single object plus
its affiliated secondary index entries (if any). If the boolean
expression for a delete identifies a single object, then the DELETE
statement itself will be a single, atomic transaction. If the expression
identifies multiple objects, then each object deleted will be handled as
a separate transaction.</p>
</div>
<div class="paragraph">
<p>The target dataset name may be a synonym introduced by CREATE SYNONYM
statement.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate single-object deletions.</p>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DELETE FROM GleambookUsers user WHERE user.id = 8;</pre>
</div>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DELETE FROM GleambookUsers WHERE id = 5;</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-1.-reserved-keywords">Appendix 1. Reserved keywords</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All reserved keywords are listed in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.667%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ANY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">APPLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ASC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AUTOGENERATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BETWEEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BTREE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLOSED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMPACTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMPACT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CORRELATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATASET</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COLLECTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATAVERSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECLARE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEFINITION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECLARE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEFINITION</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISCONNECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISTINCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DROP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ELEMENT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ELEMENT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXPLAIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ELSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ENFORCED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">END</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EVERY</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXCEPT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXTERNAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FEED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FLATTEN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FUNCTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GROUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HAVING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HINTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INDEX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INGESTION</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INNER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INSERT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTERNAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTERSECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOIN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEYWORD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEFT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LETTING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIKE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIMIT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NODEGROUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NGRAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ON</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OPEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ORDER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTPUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OVER</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POLICY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRE-SORTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRIMARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REFRESH</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RETURN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTREE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RUN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SATISFIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECONDARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SOME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEMPORARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">THEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNKNOWN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNNEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UPDATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">USING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VALUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WHEN</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WHERE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="appendix-2.-performance-tuning">Appendix 2. Performance Tuning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The SET statement can be used to override some cluster-wide
configuration parameters for a specific request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET &lt;IDENTIFIER&gt; &lt;STRING_LITERAL&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>As parameter identifiers are qualified names (containing a '.') they
have to be escaped using backticks (``). Note that changing query
parameters will not affect query correctness but only impact performance
characteristics, such as response time and throughput.</p>
</div>
<div class="sect2">
<h3 id="parallelism-parameter">Parallelism Parameter</h3>
<div class="paragraph">
<p>The system can execute each request using multiple cores on multiple
machines (a.k.a., partitioned parallelism) in a cluster. A user can
manually specify the maximum execution parallelism for a request to
scale it up and down using the following parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>compiler.parallelism</strong>: the maximum number of CPU cores can be used to
process a query. There are three cases of the value <em>p</em> for
compiler.parallelism:</p>
<div class="ulist">
<ul>
<li>
<p><em>p</em> &lt; 0 or <em>p</em> &gt; the total number of cores in a cluster: the system
will use all available cores in the cluster;</p>
</li>
<li>
<p><em>p</em> = 0 (the default): the system will use the storage parallelism
(the number of partitions of stored datasets) as the maximum parallelism
for query processing;</p>
</li>
<li>
<p>all other cases: the system will use the user-specified number as the
maximum number of CPU cores to use for executing the query.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET `compiler.parallelism` "16";

SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u JOIN GleambookMessages m ON m.authorId = u.id;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="memory-parameters">Memory Parameters</h3>
<div class="paragraph">
<p>In the system, each blocking runtime operator such as join, group-by and
order-by works within a fixed memory budget, and can gracefully spill to
disks if the memory budget is smaller than the amount of data they have
to hold. A user can manually configure the memory budget of those
operators within a query. The supported configurable memory parameters
are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>compiler.groupmemory</strong>: the memory budget that each parallel group-by
operator instance can use; 32MB is the default budget.</p>
</li>
<li>
<p><strong>compiler.sortmemory</strong>: the memory budget that each parallel sort
operator instance can use; 32MB is the default budget.</p>
</li>
<li>
<p><strong>compiler.joinmemory</strong>: the memory budget that each parallel hash join
operator instance can use; 32MB is the default budget.</p>
</li>
<li>
<p><strong>compiler.windowmemory</strong>: the memory budget that each parallel window
aggregate operator instance can use; 32MB is the default budget.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For each memory budget value, you can use a 64-bit integer value with a
1024-based binary unit suffix (for example, B, KB, MB, GB). If there is
no user-provided suffix, "B" is the default suffix. See the following
examples.</p>
</div>
<div id="example-1" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET `compiler.groupmemory` "64MB";

SELECT msg.authorId, COUNT(*)
FROM GleambookMessages msg
GROUP BY msg.authorId;</pre>
</div>
</div>
<div id="example-2" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET `compiler.sortmemory` "67108864";

SELECT VALUE user
FROM GleambookUsers AS user
ORDER BY ARRAY_LENGTH(user.friendIds) DESC;</pre>
</div>
</div>
<div id="example-3" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET `compiler.joinmemory` "132000KB";

SELECT u.name AS uname, m.message AS message
FROM GleambookUsers u JOIN GleambookMessages m ON m.authorId = u.id;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parallel-sort-parameter">Parallel Sort Parameter</h3>
<div class="paragraph">
<p>The following parameter enables you to activate or deactivate full
parallel sort for order-by operations.</p>
</div>
<div class="paragraph">
<p>When full parallel sort is inactive (<code>false</code>), each existing data
partition is sorted (in parallel), and then all data partitions are
merged into a single node.</p>
</div>
<div class="paragraph">
<p>When full parallel sort is active (<code>true</code>), the data is first sampled,
and then repartitioned so that each partition contains data that is
greater than the previous partition. The data in each partition is then
sorted (in parallel), but the sorted partitions are not merged into a
single node.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>compiler.sort.parallel</strong>: A boolean specifying whether full parallel
sort is active (<code>true</code>) or inactive (<code>false</code>). The default value is
<code>true</code>.</p>
</li>
</ul>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET `compiler.sort.parallel` "true";

SELECT VALUE user
FROM GleambookUsers AS user
ORDER BY ARRAY_LENGTH(user.friendIds) DESC;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="controlling-index-only-plan-parameter">Controlling Index-Only-Plan Parameter</h3>
<div class="paragraph">
<p>By default, the system tries to build an index-only plan whenever
utilizing a secondary index is possible. For example, if a SELECT or
JOIN query can utilize an enforced B+Tree or R-Tree index on a field,
the optimizer checks whether a secondary-index search alone can generate
the result that the query asks for. It mainly checks two conditions: (1)
predicates used in WHERE only uses the primary key field and/or
secondary key field and (2) the result does not return any other fields.
If these two conditions hold, it builds an index-only plan. Since an
index-only plan only searches a secondary-index to answer a query, it is
faster than a non-index-only plan that needs to search the primary
index. However, this index-only plan can be turned off per query by
setting the following parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>noindexonly</strong>: if this is set to true, the index-only-plan will not be
applied; the default value is false.</p>
</li>
</ul>
</div>
<div id="example" class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET noindexonly 'true';

SELECT m.message AS message
FROM GleambookMessages m where m.message = " love product-b its shortcut-menu is awesome:)";</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-3.-variable-bindings-and-name-resolution">Appendix 3. Variable Bindings and Name Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this Appendix, we&#8217;ll look at how variables are bound and how names
are resolved. Names can appear in every clause of a query. Sometimes a
name consists of just a single identifier, e.g., <code>region</code> or <code>revenue</code>.
More often a name will consist of two identifiers separated by a dot,
e.g., <code>customer.address</code>. Occasionally a name may have more than two
identifiers, e.g., <code>policy.owner.address.zipcode</code>. <em>Resolving</em> a name
means determining exactly what the (possibly multi-part) name refers to.
It is necessary to have well-defined rules for how to resolve a name in
cases of ambiguity. (In the absence of schemas, such cases arise more
commonly, and also differently, than they do in SQL.)</p>
</div>
<div class="paragraph">
<p>The basic job of each clause in a query block is to bind variables. Each
clause sees the variables bound by previous clauses and may bind
additional variables. Names are always resolved with respect to the
variables that are bound ("in scope") at the place where the name use in
question occurs. It is possible that the name resolution process will
fail, which may lead to an empty result or an error message.</p>
</div>
<div class="paragraph">
<p>One important bit of background: When the system is reading a query and
resolving its names, it has a list of all the available dataverses and
datasets. As a result, it knows whether <code>a.b</code> is a valid name for
dataset <code>b</code> in dataverse <code>a</code>. However, the system does not in general
have knowledge of the schemas of the data inside the datasets; remember
that this is a much more open world. As a result, in general the system
cannot know whether any object in a particular dataset will have a field
named <code>c</code>. These assumptions affect how errors are handled. If you try
to access dataset <code>a.b</code> and no dataset by that name exists, you will get
an error and your query will not run. However, if you try to access a
field <code>c</code> in a collection of objects, your query will run and return
<code>missing</code> for each object that doesn&#8217;t have a field named <code>c</code> – this is
because it’s possible that some object (someday) could have such a
field.</p>
</div>
<div class="sect2">
<h3 id="binding-variables">Binding Variables</h3>
<div class="paragraph">
<p>Variables can be bound in the following ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>WITH and LET clauses bind a variable to the result of an expression
in a straightforward way</p>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p><code>WITH cheap_parts AS (SELECT partno FROM parts WHERE price &lt; 100)</code> binds
the variable <code>cheap_parts</code> to the result of the subquery.</p>
</div>
<div class="paragraph">
<p><code>LET pay = salary + bonus</code> binds the variable <code>pay</code> to the result of
evaluating the expression <code>salary + bonus</code>.</p>
</div>
</li>
<li>
<p>FROM, GROUP BY, and SELECT clauses have optional AS subclauses that
contain an expression and a name (called an <em>iteration variable</em> in a
FROM clause, or an alias in GROUP BY or SELECT.)</p>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p><code>FROM customer AS c, order AS o</code></p>
</div>
<div class="paragraph">
<p><code>GROUP BY salary + bonus AS total_pay</code></p>
</div>
<div class="paragraph">
<p><code>SELECT MAX(price) AS highest_price</code></p>
</div>
<div class="paragraph">
<p>An AS subclause always binds the name (as a variable) to the result of
the expression (or, in the case of a FROM clause, to the <em>individual
members</em> of the collection identified by the expression.)</p>
</div>
<div class="paragraph">
<p>It&#8217;s always a good practice to use the keyword AS when defining an alias
or iteration variable. However, as in SQL, the syntax allows the keyword
AS to be omitted. For example, the FROM clause above could have been
written like this:</p>
</div>
<div class="paragraph">
<p><code>FROM customer c, order o</code></p>
</div>
<div class="paragraph">
<p>Omitting the keyword AS does not affect the binding of variables. The
FROM clause in this example binds variables c and o whether the keyword
AS is used or not.</p>
</div>
<div class="paragraph">
<p>In certain cases, a variable is automatically bound even if no alias or
variable-name is specified. Whenever an expression could have been
followed by an AS subclause, if the expression consists of a simple name
or a path expression, that expression binds a variable whose name is the
same as the simple name or the last step in the path expression. Here
are some examples:</p>
</div>
<div class="paragraph">
<p><code>FROM customer, order</code> binds iteration variables named <code>customer</code> and
<code>order</code></p>
</div>
<div class="paragraph">
<p><code>GROUP BY address.zipcode</code> binds a variable named <code>zipcode</code></p>
</div>
<div class="paragraph">
<p><code>SELECT item[0].price</code> binds a variable named <code>price</code></p>
</div>
<div class="paragraph">
<p>Note that a FROM clause iterates over a collection (usually a dataset),
binding a variable to each member of the collection in turn. The name of
the collection remains in scope, but it is not a variable. For example,
consider this FROM clause used in a self-join:</p>
</div>
<div class="paragraph">
<p><code>FROM customer AS c1, customer AS c2</code></p>
</div>
<div class="paragraph">
<p>This FROM clause joins the customer dataset to itself, binding the
iteration variables c1 and c2 to objects in the left-hand-side and
right-hand-side of the join, respectively. After the FROM clause, c1 and
c2 are in scope as variables, and customer remains accessible as a
dataset name but not as a variable.</p>
</div>
</li>
<li>
<p>Special rules for GROUP BY:</p>
</li>
<li>
<p>If a GROUP BY clause specifies an expression that has no explicit
alias, it binds a pseudo-variable that is lexicographically identical to
the expression itself. For example:</p>
<div class="paragraph">
<p><code>GROUP BY salary + bonus</code> binds a pseudo-variable named
<code>salary + bonus</code>.</p>
</div>
<div class="paragraph">
<p>This rule allows subsequent clauses to refer to the grouping expression
(salary + bonus) even though its constituent variables (salary and
bonus) are no longer in scope. For example, the following query is
valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM employee
GROUP BY salary + bonus
HAVING salary + bonus &gt; 1000
SELECT salary + bonus, COUNT(*) AS how_many</pre>
</div>
</div>
<div class="paragraph">
<p>While it might have been more elegant to explicitly require an alias in
cases like this, the pseudo-variable rule is retained for SQL
compatibility. Note that the expression <code>salary + bonus</code> is not
<em>actually</em> evaluated in the HAVING and SELECT clauses (and could not be
since <code>salary</code> and <code>bonus</code> are no longer individually in scope).
Instead, the expression <code>salary + bonus</code> is treated as a reference to
the pseudo-variable defined in the GROUP BY clause.</p>
</div>
</li>
<li>
<p>A GROUP BY clause may be followed by a GROUP AS clause that binds a
variable to the group. The purpose of this variable is to make the
individual objects inside the group visible to subqueries that may need
to iterate over them.</p>
<div class="paragraph">
<p>The GROUP AS variable is bound to a multiset of objects. Each object
represents one of the members of the group. Since the group may have
been formed from a join, each of the member-objects contains a nested
object for each variable bound by the nearest FROM clause (and its LET
subclause, if any). These nested objects, in turn, contain the actual
fields of the group-member. To understand this process, consider the
following query fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM parts AS p, suppliers AS s
WHERE p.suppno = s.suppno
GROUP BY p.color GROUP AS g</pre>
</div>
</div>
<div class="paragraph">
<p>Suppose that the objects in <code>parts</code> have fields <code>partno</code>, <code>color</code>, and
<code>suppno</code>. Suppose that the objects in suppliers have fields <code>suppno</code> and
<code>location</code>.</p>
</div>
<div class="paragraph">
<p>Then, for each group formed by the GROUP BY, the variable g will be
bound to a multiset with the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ { "p": { "partno": "p1", "color": "red", "suppno": "s1" },
    "s": { "suppno": "s1", "location": "Denver" } },
  { "p": { "partno": "p2", "color": "red", "suppno": "s2" },
    "s": { "suppno": "s2", "location": "Atlanta" } },
  ...
]</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="scoping">Scoping</h3>
<div class="paragraph">
<p>In general, the variables that are in scope at a particular position are
those variables that were bound earlier in the current query block, in
outer (enclosing) query blocks, or in a WITH clause at the beginning of
the query. More specific rules follow.</p>
</div>
<div class="paragraph">
<p>The clauses in a query block are conceptually processed in the following
order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FROM (followed by LET subclause, if any)</p>
</li>
<li>
<p>WHERE</p>
</li>
<li>
<p>GROUP BY (followed by LET subclause, if any)</p>
</li>
<li>
<p>HAVING</p>
</li>
<li>
<p>SELECT or SELECT VALUE</p>
</li>
<li>
<p>ORDER BY</p>
</li>
<li>
<p>OFFSET</p>
</li>
<li>
<p>LIMIT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During processing of each clause, the variables that are in scope are
those variables that are bound in the following places:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In earlier clauses of the same query block (as defined by the
ordering given above).</p>
<div class="paragraph">
<p>Example: <code>FROM orders AS o SELECT o.date</code> The variable <code>o</code> in the SELECT
clause is bound, in turn, to each object in the dataset <code>orders</code>.</p>
</div>
</li>
<li>
<p>In outer query blocks in which the current query block is nested. In
case of duplication, the innermost binding wins.</p>
</li>
<li>
<p>In the WITH clause (if any) at the beginning of the query.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, in a query block where a GROUP BY clause is present:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In clauses processed before GROUP BY, scoping rules are the same as
though no GROUP BY were present.</p>
</li>
<li>
<p>In clauses processed after GROUP BY, the variables bound in the
nearest FROM-clause (and its LET subclause, if any) are removed from
scope and replaced by the variables bound in the GROUP BY clause (and
its LET subclause, if any). However, this replacement does not apply
inside the arguments of the five SQL special aggregating functions (MIN,
MAX, AVG, SUM, and COUNT). These functions still need to see the
individual data items over which they are computing an aggregation. For
example, after <code>FROM employee AS e GROUP BY deptno</code>, it would not be
valid to reference <code>e.salary</code>, but <code>AVG(e.salary)</code> would be valid.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Special case: In an expression inside a FROM clause, a variable is in
scope if it was bound in an earlier expression in the same FROM clause.
Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM orders AS o, o.items AS i</pre>
</div>
</div>
<div class="paragraph">
<p>The reason for this special case is to support iteration over nested
collections.</p>
</div>
<div class="paragraph">
<p>Note that, since the SELECT clause comes <em>after</em> the WHERE and GROUP BY
clauses in conceptual processing order, any variables defined in SELECT
are not visible in WHERE or GROUP BY. Therefore the following query will
not return what might be the expected result (since in the WHERE clause,
<code>pay</code> will be interpreted as a field in the <code>emp</code> object rather than as
the computed value <code>salary + bonus</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT name, salary + bonus AS pay
FROM emp
WHERE pay &gt; 1000
ORDER BY pay</pre>
</div>
</div>
<div class="paragraph">
<p>The likely intent of the query above can be accomplished as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM emp AS e
LET pay = e.salary + e.bonus
WHERE pay &gt; 1000
SELECT e.name, pay
ORDER BY pay</pre>
</div>
</div>
<div class="paragraph">
<p>Note that variables defined by <code>JOIN</code> subclauses are not visible to
other subclauses in the same <code>FROM</code> clause. This also applies to the
<code>FROM</code> variable that starts the <code>JOIN</code> subclause.</p>
</div>
</div>
<div class="sect2">
<h3 id="resolving-names">Resolving Names</h3>
<div class="paragraph">
<p>The process of name resolution begins with the leftmost identifier in
the name. The rules for resolving the leftmost identifier are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>In a FROM clause</em>: Names in a FROM clause identify the collections
over which the query block will iterate. These collections may be stored
datasets or may be the results of nested query blocks. A stored dataset
may be in a named dataverse or in the default dataverse. Thus, if the
two-part name <code>a.b</code> is in a FROM clause, a might represent a dataverse
and <code>b</code> might represent a dataset in that dataverse. Another example of
a two-part name in a FROM clause is <code>FROM orders AS o, o.items AS i</code>. In
<code>o.items</code>, <code>o</code> represents an order object bound earlier in the FROM
clause, and items represents the items object inside that order.</p>
<div class="paragraph">
<p>The rules for resolving the leftmost identifier in a FROM clause
(including a JOIN subclause), or in the expression following IN in a
quantified predicate, are as follows:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the identifier matches a variable-name that is in scope, it
resolves to the binding of that variable. (Note that in the case of a
subquery, an in-scope variable might have been bound in an outer query
block; this is called a correlated subquery.)</p>
</li>
<li>
<p>Otherwise, if the identifier is the first part of a two-part name
like <code>a.b</code>, the name is treated as <code>dataverse.dataset</code>. If the
identifier stands alone as a one-part name, it is treated as the name of
a dataset in the default dataverse. If the designated dataset exists
then the identifier is resolved to that dataset, otherwise if a synonym
with given name exists then the identifier is resolved to the target
dataset of that synonym (potentially recursively if this synonym points
to another synonym). An error will result if the designated dataset or a
synonym with this name does not exist.</p>
<div class="paragraph">
<p>Datasets take precedence over synonyms, so if both a dataset and a
synonym have the same name then the resolution is to the dataset.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><em>Elsewhere in a query block</em>: In clauses other than FROM, a name
typically identifies a field of some object. For example, if the
expression <code>a.b</code> is in a SELECT or WHERE clause, it&#8217;s likely that <code>a</code>
represents an object and <code>b</code> represents a field in that object.</p>
<div class="paragraph">
<p>The rules for resolving the leftmost identifier in clauses other than
the ones listed in Rule 1 are:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the identifier matches a variable-name that is in scope, it
resolves to the binding of that variable. (In the case of a correlated
subquery, the in-scope variable might have been bound in an outer query
block.)</p>
</li>
<li>
<p>(The "Single Variable Rule"): Otherwise, if the FROM clause in the
current query block binds exactly one variable, the identifier is
treated as a field access on the object bound to that variable. For
example, in the query <code>FROM customer SELECT address</code>, the identifier
address is treated as a field in the object bound to the variable
customer. At runtime, if the object bound to customer has no <code>address</code>
field, the <code>address</code> expression will return <code>missing</code>. If the FROM
clause in the current query block binds multiple variables, name
resolution fails with an "ambiguous name" error. If there&#8217;s no FROM
clause in the current query block, name resolution fails with an
"undefined identifier" error. Note that the Single Variable Rule
searches for bound variables only in the current query block, not in
outer (containing) blocks. The purpose of this rule is to permit the
compiler to resolve field-references unambiguously without relying on
any schema information. Also note that variables defined by LET clauses
do not participate in the resolution process performed by this rule.</p>
<div class="paragraph">
<p>Exception: In a query that has a GROUP BY clause, the Single Variable
Rule does not apply in any clauses that occur after the GROUP BY
because, in these clauses, the variables bound by the FROM clause are no
longer in scope. In clauses after GROUP BY, only Rule 2.1 applies.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>In an ORDER BY clause following a UNION ALL expression:</p>
<div class="paragraph">
<p>The leftmost identifier is treated as a field-access on the objects that
are generated by the UNION ALL. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>query-block-1
UNION ALL
query-block-2
ORDER BY salary</pre>
</div>
</div>
<div class="paragraph">
<p>In the result of this query, objects that have a foo field will be
ordered by the value of this field; objects that have no foo field will
appear at at the beginning of the query result (in ascending order) or
at the end (in descending order.)</p>
</div>
</li>
<li>
<p><em>In a standalone expression</em>: If a query consists of a standalone
expression then identifiers inside that expression are resolved
according to Rule 1. For example, if the whole query is
<code>ARRAY_COUNT(a.b)</code> then <code>a.b</code> will be treated as dataset <code>b</code> contained
in dataverse <code>a</code>. Note that this rule only applies to identifiers which
are located directly inside a standalone expression. Identifiers inside
SELECT statements in a standalone expression are still resolved
according to Rules 1-3. For example, if the whole query is
<code>ARRAY_SUM( (FROM employee AS e SELECT VALUE salary) )</code> then <code>salary</code> is
resolved as <code>e.salary</code> following the "Single Variable Rule" (Rule 2.2).</p>
</li>
<li>
<p>Once the leftmost identifier has been resolved, the following dots
and identifiers in the name (if any) are treated as a path expression
that navigates to a field nested inside that object. The name resolves
to the field at the end of the path. If this field does not exist, the
value <code>missing</code> is returned.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
<div class="row-fluid">Apache AsterixDB, AsterixDB, Apache, the Apache
        feather logo, and the Apache AsterixDB project logo are either
        registered trademarks or trademarks of The Apache Software
        Foundation in the United States and other countries.
        All other marks mentioned may be trademarks or registered
        trademarks of their respective owners.
      </div>
        </div>
      </div>
    </footer>
  </body>
</html>
