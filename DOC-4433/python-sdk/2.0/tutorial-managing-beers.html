<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Managing beers | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4433/python-sdk/2.5/start-using-sdk.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="python-sdk">
    <meta name="dcterms.identifier" content="2.0">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4433">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="introduction.html"><span class="title">Python SDK</span> <span class="version">2.0</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.5/start-using-sdk.html">Python SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/start-using-sdk.html">Python SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">Python SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.2/start-using-sdk.html">Python SDK 2.2</a></li>
                  <li><a class="navbar-item" href="../2.1/start-using-sdk.html">Python SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/tutorial-managing-beers.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/tutorial-managing-beers.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/tutorial-managing-beers.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/tutorial-managing-beers.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/tutorial-managing-beers.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/tutorial-managing-beers.html">PHP SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="introduction.html">Python SDK 2.0</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API Reference</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="migrating.html">Migrating from the 1.x SDK</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="2">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="tutorial-intro.html">Python tutorial</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="quickstart.html">Quick start</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="tutorial-prep.html">Setting up the project</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="tutorial-welcome.html">Creating a welcome page</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="tutorial-managing-beers.html">Managing beers</a>
    </span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-line">
    <a class="nav-link" href="tutorial-next-steps.html">Wrapping Up</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="asynchronous-frameworks.html">Using asynchronous frameworks</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing server connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="crud.html">Key-Value (CRUD) operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="bulk-operations.html">Bulk operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-queries.html">N1QL queries</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="view-queries.html">MapReduce (view) queries</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="exception-handling.html">Handling Exceptions</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="performance-tuning.html">Performance tuning</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="threads.html">Using threads</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.5/start-using-sdk.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="introduction.html">Python SDK</a></li>
    <li class="crumb"><a href="introduction.html">Python SDK 2.0</a></li>
    <li class="crumb"><a href="getting-started.html">Getting Started</a></li>
    <li class="crumb"><a href="tutorial-intro.html">Python tutorial</a></li>
    <li class="crumb"><a href="tutorial-managing-beers.html">Managing beers</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-python/edit/release/2.0/modules/ROOT/pages/tutorial-managing-beers.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Managing beers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
First we’ll show the construction of the web app with respect to managing beers.
</blockquote>
</div>
<div class="paragraph">
<p>We’ll be able to list, inspect, edit, create, search, and delete beers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="showing-beers"><a class="anchor" href="#showing-beers"></a>Showing Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we’re finally getting into the cooler stuff of this tutorial.
First, we’ll implement several classes for our pages to use.</p>
</div>
<div class="listingblock">
<div class="title">beer.py (custom Beer row class and processing)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">class Beer(object):
    def __init__(self, id, name, doc=None):
        self.id = id
        self.name = name
        self.brewery = None
        self.doc = doc

    def __getattr__(self, name):
        if not self.doc:
            return ""
        return self.doc.get(name, "")

class BeerListRowProcessor(object):
    """
    This is the row processor for listing all beers (with their brewery IDs).
    """
    def handle_rows(self, rows, connection, include_docs):
        ret = []
        by_docids = {}

        for r in rows:
            b = Beer(r['id'], r['key'])
            ret.append(b)
            by_docids[b.id] = b

        keys_to_fetch = [ x.id for x in ret ]
        docs = connection.get_multi(keys_to_fetch, quiet=True)

        for beer_id, doc in docs.items():
            if not doc.success:
                ret.remove(beer)
                continue

            beer = by_docids[beer_id]
            beer.brewery_id = doc.value['brewery_id']

        return ret</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, we declare a simple <code>Beer</code> object.
This app isn’t too fancy and we could’ve just used a simple <code>dict</code>.
However, it allows us to demonstrate the use of the <code>RowProcessor</code> interface.</p>
</div>
<div class="paragraph">
<p>In the beer listing page, we want to display each beer along with a link to the brewery that produces it.
However, we’ve defined the <code>beer/by_name</code> view to return only the name of the beer.
To obtain the brewery, we need to fetch each beer document and examine it.
The document contains the Brewery ID that we need later.</p>
</div>
<div class="paragraph">
<p>The <code>BeerListRowProcessor</code> is an implementation of the <code>RowProcessor</code> interface that operates on the returned view rows: For each raw JSON row, it creates a new <code>Beer</code> object.
The first argument is the document ID, which is used to provide a link to display more information about the beer.
The second argument is the name of the beer itself, which we use in the beer list on the webpage.</p>
</div>
<div class="paragraph">
<p>We also create a local variable called <code>by_docids</code> that allows us to get a <code>Beer</code> object by its document ID.</p>
</div>
<div class="paragraph">
<p>After we’ve created all the beers, we create a list of document IDs to fetch by using list comprehension.
We pass this list to <code>get_multi</code> (passing <code>quiet=True</code>, because there might be some inconsistencies between the view indexes and the actual documents).
While we could have made this simpler by performing an individual <code>get</code> on each <code>beer.id</code>, that would be less efficient in terms of network usage.</p>
</div>
<div class="paragraph">
<p>Now that we have the beer documents, it’s time to set each beer’s <code>brewery_id</code> to its relevant value: We first check to see that each document was successful in being retrieved; then we look up the corresponding <code>Beer</code> object by getting it from the <code>by_docids</code> dictionary using the <code>beer_id</code> as the key; then, we extract the <code>brewery_id</code> field from the document and place it into the <code>Beer</code> object.</p>
</div>
<div class="paragraph">
<p>Finally, we return the list of populated beers.
The <code>View</code> object (returned by the <code>query</code> function) now yields results as we iterate over it.</p>
</div>
<div class="paragraph">
<p>Before we forget, let’s put this all together:</p>
</div>
<div class="listingblock">
<div class="title">beer.py (showing beer listings)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@app.route('/beers')
def beers():
    rp = BeerListRowProcessor()
    rows = db.query("beer", "by_name",
                    limit=ENTRIES_PER_PAGE,
                    row_processor=rp)

    return render_template('beer/index.html', results=rows)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code tells Flask to route requests to <code>/beers</code> to this function.
Inside the function it creates an instance of the <code>BeerListRowProcessor</code> class we just defined; finally it executes a view query using the <code>query</code> method, passing it the name of the design and view ( <code>beer</code> and <code>by_name</code>, respsectively).
We set the <code>limit</code> directive to the aforementioned <code>ENTRIES_PER_PAGE</code> directive, to avoid flooding a single webpage with many results.
The last parameter in the <code class="api">query</code> method call instructs the client use our own <code>BeerListRowProcessor</code> for processing the results.</p>
</div>
<div class="paragraph">
<p>At the end, the function directs the template engine to render the <code>beer/index.html</code> template, setting the template variable <code>rows</code> to the iterable returned by the <code>query</code> function.</p>
</div>
<div class="paragraph">
<p>Here is the <code>beer/index.html</code> template:</p>
</div>
<div class="listingblock">
<div class="title">templates/beer/index.html</div>
<div class="content">
<pre>{% extends "layout.html" %}
{% block body %}

&lt;h3&gt;Browse Beers&lt;/h3&gt;
&lt;form class="navbar-search pull-left"&gt;
    &lt;input id="beer-search" type="text" class="search-query" placeholder="Search for Beers"&gt;
&lt;/form&gt;


&lt;table id="beer-table" class="table table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Name&lt;/th&gt;
            &lt;th&gt;Brewery&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {% for beer in results %}
        &lt;tr&gt;
            &lt;td&gt;&lt;a href="/beers/show/{{beer.id}}"&gt;{{beer.name}}&lt;/a&gt;&lt;/td&gt;
            &lt;td&gt;&lt;a href="/breweries/show/{{beer.brewery_id}}"&gt;To Brewery&lt;/a&gt;&lt;/td&gt;
            &lt;td&gt;
                &lt;a class="btn btn-small btn-warning" href="/beers/edit/{{beer.id}}"&gt;Edit&lt;/a&gt;
                &lt;a class="btn btn-small btn-danger" href="/beers/delete/{{beer.id}}"&gt;Delete&lt;/a&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        {% endfor %}
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;div&gt;
    &lt;a class="btn btn-small btn-success" href="/beers/create"&gt;Add Beer&lt;/a&gt;
&lt;/div&gt;

{% endblock %}</pre>
</div>
</div>
<div class="paragraph">
<p>We’re using <em>Jinja</em> <code>{% for %}</code> blocks to iterate and emit a fragment of HTML for each <code>Beer</code> object returned by the query.</p>
</div>
<div class="paragraph">
<p>Navigate to <code>localhost:5000/beers</code>, to see a listing of beers.
Each beer has <code>To Brewery <code>,</code>Edit <code>, and</code>Delete</code> buttons.</p>
</div>
<div class="paragraph">
<p>On the bottom of the page, you can also see an <code>Add Beer</code> button, which allows you to define new beers.</p>
</div>
<div class="paragraph">
<p>Let’s implement the <code>Delete</code> button next!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deleting-beers"><a class="anchor" href="#deleting-beers"></a>Deleting Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Due to the simplicity of Couchbase and Flask, we can implement a single method to delete both beers and breweries.</p>
</div>
<div class="listingblock">
<div class="title">beer.py (deleting a beer)</div>
<div class="content">
<pre>@app.route('&lt;otype&gt;/delete/&lt;id&gt;')
def delete_object(otype, id):
    try:
        db.delete(id)
        return redirect('/welcome')

    except NotFoundError:
        return "No such {0} '{1}'".format(otype, id), 404</pre>
</div>
</div>
<div class="paragraph">
<p>Here we tell Flask to route any URL that has as its second component the string <code>delete</code> to this method.
The paths in <code>&lt;angle brackets&gt;</code> are routing tokens that Flask passes to the handler as arguments.
This means that URLs such as <code>/beers/delete/foobar</code> and <code>/foo/delete/whatever</code> are all routed here.</p>
</div>
<div class="paragraph">
<p>When we get an ID, we try to delete it by using the <code>delete</code> method in a <code>try</code> block.
If successful, we redirect to the welcome page, but if the key does not exist, we return with an error message and a <code>404</code> status code.</p>
</div>
<div class="paragraph">
<p>You can now access this page by going to <code>localhost:5000/beers/delete/nonexistent</code> and get a 404 error.
Or you can delete a beer by clicking on one of the <code>Delete</code> buttons in the <code>/beers</code> page!</p>
</div>
<div class="paragraph">
<p>If you find that a beer is still displayed after you click the delete button, you can refresh the browser page to verify that the beer has been deleted.</p>
</div>
<div class="paragraph">
<p>Another way to verify that a beer has been deleted is by clicking the delete button again and getting a 404 error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="displaying-beers"><a class="anchor" href="#displaying-beers"></a>Displaying Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we demonstrate how you can display the beers.
In this case, we display a page showing all the fields and values of a given beer.</p>
</div>
<div class="listingblock">
<div class="title">beer.py (showing a single beer)</div>
<div class="content">
<pre class="highlightjs highlight"><code>@app.route('/beers/show/&lt;beer_id&gt;')
def show_beer(beer_id):
    doc = db.get(beer_id, quiet=True)
    if not doc.success:
        return "No such beer {0}".format(beer_id), 404

    return render_template(
        'beer/show.html',
        beer=Beer(beer_id, doc.value['name'], doc.value))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like for the <code>delete</code> action, we first check to see that the beer exists.
We are passed the beer ID as the last part of the URL - this is passed to us as the <code>beer_id</code>.</p>
</div>
<div class="paragraph">
<p>In order to display the information for the given beer ID, we simply call the connection’s <code>get</code> method with the <code>beer_id</code> argument.
We also pass the <code>quiet</code> parameter so that we don’t receive an exception if the beer does not exist; we then check to see that the <code>success</code> property of the returned <code>Result</code> object is true: If it isn’t then the beer does not exist and we return an HTTP <code>404</code> error; otherwise we construct a new <code>Beer</code> object; passing it the ID and the <code>name</code> field within the value dictionary.</p>
</div>
<div class="paragraph">
<p>At the end, the <code>Beer</code> object is passed to the <code>templates/beer/show.html</code> template which we’ll show here:</p>
</div>
<div class="listingblock">
<div class="title">templates/beer/show.html</div>
<div class="content">
<pre>{% extends "layout.html" %}
{% block body %}

{% set display = beer.doc %}
{% set brewery_id = display['brewery_id'] %}

&lt;h3&gt;Show Details for Beer "{{beer.name}}"&lt;/h3&gt;
&lt;table class="table table-striped"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;strong&gt;brewery_id&lt;/strong&gt;&lt;/td&gt;
            &lt;td&gt;&lt;a href="/breweries/show/{{brewery_id}}"&gt;{{brewery_id}}&lt;/a&gt;&lt;/td&gt;
        &lt;/tr&gt;
        {% for k, v in display.items() if not k == "brewery_id" %}
        &lt;tr&gt;
            &lt;td&gt;&lt;strong&gt;{{k}}&lt;/strong&gt;&lt;/td&gt;
            &lt;td&gt;{{v}}&lt;/td&gt;
        &lt;/tr&gt;
        {% endfor %}
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;a class="btn btn-medium btn-warning"
    href="/beers/edit/{{beer.id}}"&gt;Edit&lt;/a&gt;
&lt;a class="btn btn-medium btn-danger"
    href="/beers/delete/{{beer.id}}"&gt;Delete&lt;/a&gt;

{% endblock %}</pre>
</div>
</div>
<div class="paragraph">
<p>Here we make the <code>display</code> variable in a special <code>{% set %}</code> directive.
This makes dealing with the rest of the code simpler.</p>
</div>
<div class="paragraph">
<p>The next thing we do is extract the <code>brewery_id</code>, and create a special entry with a link pointing to the page to display the actual brewery.</p>
</div>
<div class="paragraph">
<p>Then we is iterate over the rest of the fields (omitting the brewery ID), printing out the key and value of each.</p>
</div>
<div class="paragraph">
<p>Finally, we provide links at the bottom to <code>Edit</code> and <code>Delete</code> the beer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="editing-beers"><a class="anchor" href="#editing-beers"></a>Editing Beers</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">beer.py (beer edit page)</div>
<div class="content">
<pre>def normalize_beer_fields(form):
    doc = {}
    for k, v in form.items():
        name_base, fieldname = k.split('_', 1)
        if name_base != 'beer':
            continue

        doc[fieldname] = v

    if not 'name' in doc or not doc['name']:
        return (None, ("Must have name", 400))

    if not 'brewery_id' in doc or not doc['brewery_id']:
        return (None, ("Must have brewery ID", 400))

    if not db.get(doc['brewery_id'], quiet=True).success:
        return (None,
                ("Brewery ID {0} not found".format(doc['brewery_id']), 400))

    return doc, None

@app.route('/beers/edit/&lt;beer&gt;', methods=['GET'])
def edit_beer_display(beer):
    bdoc = db.get(beer, quiet=True)
    if not bdoc.success:
        return "No Such Beer", 404

    return render_template('beer/edit.html',
                           beer=Beer(beer, bdoc.value['name'], bdoc.value),
                           is_create=False)


@app.route('/beers/edit/&lt;beer&gt;', methods=['POST'])
def edit_beer_submit(beer):
    doc, err = normalize_beer_fields(request.form)

    if not doc:
        return err

    db.upsert(beer, doc)
    return redirect('/beers/show/' + beer)</pre>
</div>
</div>
<div class="paragraph">
<p>We define two handlers for editing.
The first handler is the <code>GET</code> method for <code>/beers/edit/&lt;beer&gt;</code>, which displays a nice HTML form that we can use to edit the beer.
It passes the following parameters to the template: the <code>Beer</code> object and a Boolean that indicates this is <em>not</em> a new beer (because the same template is also used for the <code>Create Beer</code> form).</p>
</div>
<div class="paragraph">
<p>The second handler is the <code>POST</code> method, which validates the input.
The post handler calls the <code>normalize_beer_fields</code> function, which converts the form fields into properly formed names for the beer document, checks to see that the beer has a valid <code>name</code>, and checks to see that a <code>brewery_id</code> is specified and that it indeed exists.
If all the checks pass, the function returns a tuple of ( <code>doc</code>, <code>None</code> ).
The <code>POST</code> handler checks whether the second element of the returned tuple is false.
If it is not false, then it’s an error code, and the first element is the error message.
Otherwise, the first element is the document.
It then sets the document in Couchbase by using the <code>set</code> method.</p>
</div>
<div class="paragraph">
<p>The template is rather wordy because we enumerate all the possible fields with a nice description.</p>
</div>
<div class="listingblock">
<div class="title">templates/beer/edit.html</div>
<div class="content">
<pre>{% extends "layout.html" %}
{% block body %}

{% if is_create %}
&lt;h3&gt;Create Beer&lt;/h3&gt;
{% else %}
&lt;h3&gt;Editing {{beer.name}}&lt;/h3&gt;
{% endif %}

&lt;form method="post" action=""&gt;
  &lt;fieldset&gt;
    &lt;legend&gt;General Info&lt;/legend&gt;
    &lt;div class="span12"&gt;
      &lt;div class="span6"&gt;
        &lt;label&gt;Name&lt;/label&gt;
        &lt;input type="text" name="beer_name" placeholder="The name of the beer." value="{{beer.name}}"&gt;

        &lt;label&gt;Description&lt;/label&gt;
        &lt;input type="text" name="beer_description" placeholder="A short description." value="{{beer.description}}"&gt;
      &lt;/div&gt;
      &lt;div class="span6"&gt;
        &lt;label&gt;Style&lt;/label&gt;
        &lt;input type="text" name="beer_style" placeholder="Bitter? Sweet? Hoppy?" value="{{beer.style}}"&gt;

        &lt;label&gt;Category&lt;/label&gt;
        &lt;input type="text" name="beer_category" placeholder="Ale? Stout? Lager?" value="{{beer.category}}"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;fieldset&gt;
    &lt;legend&gt;Details&lt;/legend&gt;
    &lt;div class="span12"&gt;
      &lt;div class="span6"&gt;
        &lt;label&gt;Alcohol (ABV)&lt;/label&gt;
        &lt;input type="text" name="beer_abv" placeholder="The beer's ABV" value="{{beer.abv}}"&gt;

        &lt;label&gt;Biterness (IBU)&lt;/label&gt;
        &lt;input type="text" name="beer_ibu" placeholder="The beer's IBU" value="{{beer.ibu}}"&gt;
      &lt;/div&gt;
      &lt;div class="span6"&gt;
        &lt;label&gt;Beer Color (SRM)&lt;/label&gt;
        &lt;input type="text" name="beer_srm" placeholder="The beer's SRM" value="{{beer.srm}}"&gt;

        &lt;label&gt;Universal Product Code (UPC)&lt;/label&gt;
        &lt;input type="text" name="beer_upc" placeholder="The beer's UPC" value="{{beer.upc}}"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;fieldset&gt;
    &lt;legend&gt;Brewery&lt;/legend&gt;
    &lt;div class="span12"&gt;
      &lt;div class="span6"&gt;
        &lt;label&gt;Brewery&lt;/label&gt;
        &lt;input type="text" name="beer_brewery_id" placeholder="The brewery" value="{{beer.brewery_id}}"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;div class="form-actions"&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Save changes&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;

{% endblock %}</pre>
</div>
</div>
<div class="paragraph">
<p>The template first checks the <code>is_create</code> variable.
If it’s <code>False</code>, then we’re editing an existing beer, and the caption is filled with that name.
Otherwise, it’s titled as <code>Create Beer</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-beers"><a class="anchor" href="#creating-beers"></a>Creating Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Creating beers is largely the same as editing beers:</p>
</div>
<div class="listingblock">
<div class="title">beer.py (create beer page)</div>
<div class="content">
<pre>@app.route('/beers/create')
def create_beer_display():
    return render_template('beer/edit.html', beer=Beer('', ''), is_create=True)


@app.route('/beers/create', methods=['POST'])
def create_beer_submit():
    doc, err = normalize_beer_fields(request.form)

    if not doc:
        return err

    id = '{0}-{1}'.format(doc['brewery_id'],
                          doc['name'].replace(' ', '_').lower())

    try:
        db.insert(id, doc)
        return redirect('/beers/show/' + id)

    except KeyExistsError:
        return "Beer already exists!", 400</pre>
</div>
</div>
<div class="paragraph">
<p>Here we display the same form as the one for editing beers, except we set the <code>is_create</code> parameter to True, and pass an empty <code>Beer</code> object.
This is necessary because the template still tries to populate the form fields with <em>existing</em> values.</p>
</div>
<div class="paragraph">
<p>In the <code>POST</code> handler, we call <code>normalize_beer_field</code> as above when editing beers.</p>
</div>
<div class="paragraph">
<p>Because we’re creating a <em>new</em> beer, we use the <code>add</code> method instead.
This raisew an exception if the beer already exists.
We catch this and display it to the user.</p>
</div>
<div class="paragraph">
<p>If everything went well, the user is redirected to the beer display page for the newly created beer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="searching-beers"><a class="anchor" href="#searching-beers"></a>Searching Beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the beer listing page above, you might have noticed a search box at the top.
We can use it to dynamically filter our table based on user input.
We’ll use Javascript at the client layer to perform the querying and filtering, and views with range queries at the server (Flask) layer to return the results.</p>
</div>
<div class="paragraph">
<p>Before we implement the Python-level search method, we need to put the following in the <code>static/js/beersample.js</code> file (if it’s not there already) to listen on search box changes and update the table with the resulting JSON (which is returned from the search method):</p>
</div>
<div class="listingblock">
<div class="title">static/js/beersample.js (snippet)</div>
<div class="content">
<pre>$(document).ready(function() {

    /**
     * AJAX Beer Search Filter
     */
    $("#beer-search").keyup(function() {
       var content = $("#beer-search").val();
       if(content.length &gt;= 0) {
           $.getJSON("/beers/search", {"value": content}, function(data) {
               $("#beer-table tbody tr").remove();
               for(var i=0;i&lt;data.length;i++) {
                   var html = "&lt;tr&gt;";
                   html += "&lt;td&gt;&lt;a href=\"/beers/show/"+data[i].id+"\"&gt;"+data[i].name+"&lt;/a&gt;&lt;/td&gt;";
                   html += "&lt;td&gt;&lt;a href=\"/breweries/show/"+data[i].brewery+"\"&gt;To Brewery&lt;/a&gt;&lt;/td&gt;";
                   html += "&lt;td&gt;";
                   html += "&lt;a class=\"btn btn-small btn-warning\" href=\"/beers/edit/"+data[i].id+"\"&gt;Edit&lt;/a&gt;\n";
                   html += "&lt;a class=\"btn btn-small btn-danger\" href=\"/beers/delete/"+data[i].id+"\"&gt;Delete&lt;/a&gt;";
                   html += "&lt;/td&gt;";
                   html += "&lt;/tr&gt;";
                   $("#beer-table tbody").append(html);
               }
           });
       }
    });
});</pre>
</div>
</div>
<div class="paragraph">
<p>The code waits for keyup events on the search field, and if they happen, it issues an AJAX query on the search function within the app.
The search handler computes the result (using views) and returns it as JSON.
The JavaScript then clears the table, iterates over the results, and creates new rows.</p>
</div>
<div class="paragraph">
<p>The search handler looks like this:</p>
</div>
<div class="listingblock">
<div class="title">beer.py (ajax search response)</div>
<div class="content">
<pre>def return_search_json(ret):
    response = app.make_response(json.dumps(ret))
    response.headers['Content-Type'] = 'application/json'
    return response

@app.route('/beers/search')
def beer_search():
    value = request.args.get('value')
    q = Query()
    q.mapkey_range = [value, value + Query.STRING_RANGE_END]
    q.limit = ENTRIES_PER_PAGE

    ret = []

    rp = BeerListRowProcessor()
    res = db.query("beer", "by_name",
                   row_processor=rp,
                   query=q,
                   include_docs=True)

    for beer in res:
        ret.append({'id' : beer.id,
                    'name' : beer.name,
                    'brewery' : beer.brewery_id})

    return return_search_json(ret)</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>beer_search</code> function first extracts the user input by examining the query string from the request.</p>
</div>
<div class="paragraph">
<p>It then creates a <code>Query</code> object.
The <code>Query</code> object&#8217;s <code>mapkey_range</code> property is set to a list of two elements; the first is the user input, and the second is the user input with the magic <code>STRING_RANGE_END</code> string appended to it.
This form of range indicates that all keys that start with the user input ( <code>value</code> ) are returned.
If we just provided a single element, the results would also contain matches that are lexically greater than the user input; if we just provided the same value for the second and first elements, only items that match the string exactly are returned.</p>
</div>
<div class="paragraph">
<p>The special <code>STRING_RANGE_END</code> is actually a <code>u"\u0FFF"</code> UTF-8 character, which for the view engine means "end here." You need to get used to it a bit, but it’s actually very neat and efficient.</p>
</div>
<div class="paragraph">
<p>We re-use our <code>BeerListRowProcessor</code> class to filter the results here (because the data required is the same as that of the beer listing ( <code>beer/index.html</code> ) page.</p>
</div>
<div class="paragraph">
<p>However we need to return a JSON array of</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ "id" : "beer_id", "name" : "beer_name", "brewery" : "the_brewery_id" }</pre>
</div>
</div>
<div class="paragraph">
<p>so we need to convert the rows into JSON first.
This is done by the <code>return_search_json</code> function.</p>
</div>
<div class="paragraph">
<p>Now your search box should work nicely.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
