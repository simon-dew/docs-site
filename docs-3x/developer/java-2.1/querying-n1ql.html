<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Working with N1QL — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a><ul class="sub-sections"><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/java-2.1/java-intro.html"><span>Java SDK 2.1</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/java-2.1/overview.html"><span>Overview</span></a></li><li class="section"><a href="../../developer/java-2.1/download-links.html"><span>Download and API Reference</span></a></li><li class="section"><a href="../../developer/java-2.1/migrate.html"><span>Migrating from Java SDK 1.4.x to 2.x</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/java-2.1/getting-started.html"><span>Getting started with the Java SDK</span></a></li><li class="section"><a href="../../developer/java-2.1/managing-connections.html"><span>Managing connections</span></a></li><li class="section"><a href="../../developer/java-2.1/env-config.html"><span>Configuring the environment</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/java-2.1/documents.html"><span>Working with documents</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/java-2.1/querying.html"><span>Querying buckets</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/java-2.1/querying-views.html"><span>Working with views</span></a></li><li class="section"><a href="../../developer/java-2.1/querying-n1ql.html" class="current"><span>Working with N1QL</span></a><ul class="sub-sections"></ul></li></ul></li><li class="section"><a href="../../developer/java-2.1/observables.html"><span>Mastering observables</span></a></li><li class="section"><a href="../../developer/java-2.1/logging.html"><span>Setting up logging</span></a></li><li class="section"><a href="../../developer/java-2.1/release-notes.html"><span>Release notes</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/java-2.0/java-intro.html"><span>Java SDK 2.0</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dotnet-2.1/dotnet-intro.html"><span>.NET SDK 2.1</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dotnet-2.0/dotnet-intro.html"><span>.NET SDK 2.0</span></a></li></ul></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Working with N1QL</h1>

	
	<div class="body conbody"><p class="shortdesc">You can query a bucket using the N1QL query language.</p>

		<div class="p"><div class="note note"><span class="notetitle">Note:</span> N1QL is currently experimental and may change in subsequent versions.</div>
</div>


		<p class="p">To query via N1QL, you need to make sure to have the query engine downloaded, started and
			pointed to your cluster. For more information about using N1QL, see <a class="xref" href="http://query.couchbase.com" target="_blank">http://query.couchbase.com</a>.</p>


		<p class="p">Next, you need to enable N1QL either through a system property or through the environment
			builder. This step will go away once N1QL is fully integrated into the server:</p>

		<p class="p">To enable N1QL by using a system property:</p>


<pre class="pre codeblock language-java"><code>// Through a system property
System.setProperty("com.couchbase.queryEnabled", "true");

Cluster cluster = CouchbaseCluster.create();
Bucket bucket = cluster.openBucket("beer-sample");</code></pre>


<p class="p">To enable N1QL by using  the builder:</p>

<pre class="pre codeblock language-java"><code>// Through the builder
Cluster cluster = CouchbaseCluster.create(DefaultCouchbaseEnvironment
    .builder()
    .queryEnabled(true)
    .build());

Bucket bucket = cluster.openBucket("beer-sample");</code></pre>


		<p class="p">Finally, you are ready to run the various kinds of queries. All queries are composed at a
			minimum of a statement and optionally of N1QL additional parameters. The simplest form of
			query is just a raw string statement, or a domain-specific language (DSL) statement:</p>


<pre class="pre codeblock language-java"><code>// raw string query
QueryResult queryResult =
   bucket.query(Query.simple("SELECT * FROM beer-sample LIMIT 10"));

// using the DSL
QueryResult query = bucket.query(select("*").from("beer-sample").limit(10));</code></pre>


		<p class="p">The DSL provides a type-safe and intuitive way to perform queries. The
				<span class="keyword apiname">select()</span> method is a static import that kicks off a  BNF-aware DSL
			for N1QL. (BNF stands for Backus-Naur Form.) </p>


		<p class="p">The query always returns a <span class="keyword apiname">QueryResult</span>, which aside from the actual
            <span class="keyword apiname">QueryRow</span>s also contains debug or error information if supplied.</p>


		<div class="p"><ul class="ul">
            <li class="li"><strong class="ph b">parseSuccess</strong>: Returns true if the query could correctly be parsed. This
					information is available immediately even if the actual list of results takes more
					time to be computed and streamed to the client.</li>

            <li class="li"><strong class="ph b">finalSuccess</strong>: Returns true if the whole query could be executed successfully, including
                retrieving all the results and streaming them to the client.</li>

			<li class="li"><strong class="ph b">allRows</strong>: Contains all rows returned by the query, can be an empty list.</li>

            <li class="li"><strong class="ph b">rows</strong>: Same as allRows but in an iterator form (the <span class="keyword apiname">QueryResult</span> itself is
                iterable).</li>

            <li class="li"><strong class="ph b">requestId</strong>: The server-generated unique ID for this query (useful to find associated logs
                on the N1QL server).</li>

            <li class="li"><strong class="ph b">clientContextId</strong>: User-provided identifier reflected in the server's response. This can be
                useful to group several queries (eg. in a kind of in-house transaction) and find all associated
                queries.</li>

			<li class="li"><strong class="ph b">info</strong>: Returns a <span class="keyword apiname">JsonObject</span> containing metrics for the query (like number
                of results, processing time, etc...).</li>

			<li class="li"><strong class="ph b">errors</strong>: Returns a list of <span class="keyword apiname">JsonObject</span> describing errors or warnings
					(if any occurred during execution).</li>

		</ul>
</div>


        <section class="section"><h2 class="title sectiontitle">Querying Asynchronously</h2>
            <p class="p">Querying asynchronously is done through the <span class="keyword apiname">AsyncBucket</span> interface, obtained
                by calling <span class="keyword apiname">bucket.async()</span>. The API is pretty similar except everything is
                returned as an <span class="keyword apiname">Observable</span>. Some of the components of the query result (an
                <span class="keyword apiname">AsyncQueryResult</span>) can also be delayed and so returned as Observables. Only
                <span class="keyword apiname">requestId</span>, <span class="keyword apiname">clientContextId</span> and <span class="keyword apiname">parseSuccess</span>
                return immediately.</p>

		    <p class="p">The following Java 8 code prints the found documents or errors as they come:</p>


<pre class="pre codeblock language-java"><code>bucket.async()
.query(select("*").from("beer-sample").limit(10))
.subscribe(result -&gt; {
    result.errors()
        .subscribe(
            e -&gt; System.err.println("N1QL Error/Warning: " + e),
            runtimeError -&gt; runtimeError.printStackTrace()
        );
    result.rows()
        .map(row -&gt; row.value())
        .subscribe(
            rowContent -&gt; System.out.println(rowContent),
            runtimeError -&gt; runtimeError.printStackTrace()
        )
    }
);</code></pre>

        <p class="p">First, we see that we work on asynchronous mode. Second line issues a <span class="keyword apiname">Statement</span>
            using the DSL. Then we subscribe a first time to trigger the query and obtain the result.</p>

        <p class="p">On receiving the result (there will be only one), we subscribe to its components to be notified
            respectively of n1ql errors and n1ql results. Results (as rows) are first mapped into their
            JSON values.</p>

        <p class="p">Notice we also define an <span class="keyword apiname">onError</span> behavior for both n1ql errors stream and results
            stream, that just prints the stack trace.</p>

        <p class="p"><em class="ph i">Note: All this is done asynchronously so it's not suitable for a simple test (where the main
            thread would exit potentially before any result could have been displayed)</em></p>

        </section>


        <section class="section"><h2 class="title sectiontitle">Different Kinds of Queries</h2>
        <p class="p">Queries are represented by the <span class="keyword apiname">Query</span> interface, which also provides factory
            methods to create all variants of queries. Each variant can be constructed from a <span class="keyword apiname">
            Statement</span>, even in <samp class="ph codeph">String</samp> form, but also additionally can define
            a <span class="keyword apiname">QueryParams</span>. This represents additional N1QL parameters, like setting a
            <samp class="ph codeph">clientContextId</samp>.</p>

        <div class="p">Variants of queries are:
                <ul class="ul">
                    <li class="li"><strong class="ph b">simple</strong>: The basic query used so far in this tutorial.</li>

                    <li class="li"><strong class="ph b">parameterized</strong>: A variant to use with statements containing
						placeholders (like <span class="keyword apiname">$1</span> or <span class="keyword apiname">$placeholder</span>). The
						user must provide the values for the placeholders as well, either as a
							<span class="keyword apiname">JsonArray</span> (for positional parameters) or
							<span class="keyword apiname">JsonObject</span> (for named parameters).</li>

                    <li class="li"><strong class="ph b">prepared</strong>: This is very much like the idea of an SQL prepared
						statement. First the <samp class="ph codeph">bucket.prepare(statement)</samp> method must be
						called to obtain a <span class="keyword apiname">QueryPlan</span>. This plan can then be cached and
						replayed using <samp class="ph codeph">Query.prepared(plan)</samp>, skipping the query parsing
						and preparation on the server side. Prepared statements can also use
						placeholders.</li>

                    </ul>

        </div>

        </section>

        <section class="section"><h2 class="title sectiontitle">Reading Your Own Writes (RYOW)</h2>
        <p class="p">Often you will want to insert or update some data into Couchbase and immediately read this data back using a N1QL query. This is referred to as RYOW (Read Your Own Write).</p>

        <p class="p">This can be achieved by using the <samp class="ph codeph">QueryParams</samp>, and more precisely the <samp class="ph codeph">consistency</samp> parameter:</p>


<pre class="pre codeblock language-java"><code>
JsonDocument doc = JsonDocument.create("test", JsonObject.create().put("test", true));
bucket.insert(doc);

Statement select = select("*").from("beer-sample")
    .where(x("test").eq(true));
QueryParams ryow = QueryParams.build().consistency(ScanConsistency.REQUEST_PLUS);

bucket.async()
    .query(Query.simple(select, ryow))
    .subscribe(result -&gt; {
    result.errors()
        .subscribe(
            e -&gt; System.err.println("N1QL Error/Warning: " + e),
            runtimeError -&gt; runtimeError.printStackTrace()
        );
    result.rows()
        .map(row -&gt; row.value())
        .subscribe(
            rowContent -&gt; System.out.println(rowContent),
            runtimeError -&gt; runtimeError.printStackTrace()
        )
    }
);</code></pre>

    </section>


	</div>

<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/java-2.1/querying.html" title="The Java SDK supports a wide range of querying features, including views and the N1QL query language.">Querying buckets</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/java-2.1/querying-views.html" title="This section describes how to query views in a design document.">Working with views</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>