<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Performing a first query — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/dev-env.html"><span>Setting up the development environment</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/connect.html"><span>Connecting to Couchbase Server</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/connect-get-set.html"><span>Performing connect, set and get</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/first-query.html" class="current"><span>Performing a first query</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/telnet.html"><span>Performing basic Telnet operations</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Performing a first query</h1>

	<div class="body conbody">
		<p class="p">As of Couchbase 2.0, you can index and query entries using views. Views are functions you
			define and use to filter, extract and perform calculations on entries that are persisted in
			a given data bucket. The functions you create will provide a ‘map’ function, which can
			filter/extract items based on rules you specify, and may optionally perform a ‘reduce’
			function, which can perform calculations and operations across a selected group of entries.
			There are a few possible ways you can initially store and use views functions as JSON
			documents:</p>

		<ul class="ul">
			<li class="li">
				<p class="p">Create and manage using Couchbase Admin Console, or</p>

			</li>

			<li class="li">
				<p class="p">Create and manage using the REST API, or</p>

			</li>

			<li class="li">
				<p class="p">Create, store, and query using your chosen Couchbase SDK.</p>

			</li>

		</ul>

		<p class="p">Since this content is for the developer audience, we will focus here on using the SDKs to
			perform queries and describe the REST API as an alternative approach.</p>

		<p class="p">Imagine in our previous example that we also want to find all the names of users who are
			under 21. In this scenario we would use a view; in fact we would want to use views in any
			other scenario where we want to filter entries based on certain field values, or provide
			lists and tables of certain entries. For this example we provide the map function for you.
			If you are more familiar with views in Couchbase 2.0, you may notice some missing elements
			in our map function. For the sake of brevity here and for newcomers to views, we omitted
			some of the complexity for now:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (doc) {
    if ( doc.age &amp;&amp; doc.name ) {
    if ( doc.age &lt; 21 ) { emit(doc.name, doc.age) };
  }
}
</samp></code></pre>

		<p class="p">You may not have used JavaScript before, but if you have used other programming languages
			such as C, Java, or PHP, this should look familiar to you. This is a standard function
			definition with one parameter, <samp class="ph codeph">doc</samp> which is a JSON document stored in
			Couchbase Server.</p>

		<p class="p">The key part of this function to understand is the conditional statement <samp class="ph codeph">if
				(doc.age &lt; 21 )....</samp>. This is how you specify the core logic of your map
			function. In this case, we are saying that if <samp class="ph codeph">age</samp> field has a value less
			than 21, we want information from that record extracted and put in the result set. The next
			part of the code, <samp class="ph codeph">emit(doc.name, doc.age)</samp> indicates when Couchbase Server
			finds a matching record, it should include value from the <samp class="ph codeph">name</samp> field and
			should include value from the <samp class="ph codeph">age</samp> field in the result set.</p>

		<p class="p">As a best practice we want make sure that the fields we want to include in our index
			actually exist. Therefore we have our map function within a conditional: <samp class="ph codeph">if
				(doc.age &amp;&amp; doc.name)</samp>. This ensures the fields exist in documents when
			we query the view and we therefore avoid a view failure when Couchbase Server generates the
			index.</p>

		<p class="p">For the sake of convenience, we can store our view in a ‘design document’ and then use a
			Couchbase SDK to store it from the file. Design documents are JSON documents where we store
			our views functions as strings; they are stored in Couchbase Server and are associated with
			a Couchbase Bucket. First we create the design document and include our view function in
			it:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
  "_id": "_design/students",
  "language": "javascript",
  "views": {
    "underage": {
      "map": "function(doc) {if (doc.age &amp;&amp; doc.name)
{if(doc.age &lt; 21){emit(doc.name, doc.age);}}}"
    }
  }
}
</samp></code></pre>

		<p class="p">The first two fields indicate the JSON document is a design document named
				<samp class="ph codeph">students</samp> and it follows the syntax used in JavaScript. The next field
			is a hash that contains any views and in this case we have one view called
				<samp class="ph codeph">underage</samp>. Within the view we provide the map function described above.
			We can store this to the file system as <samp class="ph codeph">students.json</samp> and then write the
			design document to Couchbase Server using an SDK.</p>

		<p class="p">As a best practice we want make sure that the fields we want to include in our index
			actually exist. Therefore we have our map function within a conditional: <samp class="ph codeph">if
				(doc.age &amp;&amp; doc.name)</samp>. This ensures the fields exist in documents when
			we query the view and we therefore avoid a view failure when Couchbase Server generates the
			index.</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">client = Couchbase.connect("http://localhost:8091/pools/default/buckets/newBucket")

client.save_design_doc(File.open('students.json'))
</samp></code></pre>

		<p class="p">We open the <samp class="ph codeph">students.json</samp> file and then write it to Couchbase Server with
			the <samp class="ph codeph">save_design_doc</samp> call. Couchbase Server will store a new design
			document with the key <samp class="ph codeph">students</samp> which is available from our SDK. At this
			point we can query the view and retrieve matching results:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">students = client.design_docs['students']

students.views                    #=&gt; ["underage"]

students.underage
</samp></code></pre>

		<p class="p">The first things we do is retrieve the design document from Couchbase Server. We do this by
			first calling <samp class="ph codeph">design_docs</samp> with the named design document
				<samp class="ph codeph">students</samp>, and then call <samp class="ph codeph">views</samp> to get the views it
			contains. Finally we perform the query by calling the view, in this case we call
				<samp class="ph codeph">underage</samp>. Couchbase Server will execute the map function in our view
			and return this information in the result set:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">.... @id="doc1" @key="Aaron" @value=20 ....
.... @id="doc3" @key="Peter" @value=16 ....
.... @id="doc4" @key="Ralf" @value=12 ....
</samp></code></pre>

		<p class="p">If you go back and look at our map function, we indicate we want to extract
				<samp class="ph codeph">doc.name</samp> and <samp class="ph codeph">doc.age</samp>. Couchbase Server provides the
			key for the document containing a matching field value under 21, which is
				<samp class="ph codeph">docNum</samp>, as well as the name and age of the student. As an alternate
			approach, you can also store a view in Couchbase Server by using the REST API and then
			query it using a REST request. To store the view, you would make a REST request as
			follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">curl -X PUT -u newBucket:password -H 'Content-Type: application/json' \
 'http://server_ip:8092/newBucket/_design/students' \
-d '{"views": {"underage":{"map":"function(doc) {if(doc.age &amp;&amp; doc.name) \
{if(doc.age&lt;21){emit(doc.name, doc.age);}}}"}}}'
</samp></code></pre>

		<p class="p">We perform the REST request as a put and provide the bucket name and password for that
			bucket. We indicate the content will be JSON, and the rest endpoint is the Couchbase bucket
			along with <samp class="ph codeph">/_design/students</samp>. Finally we provide the view as the request
			payload. After Couchbase Server successfully stores the new design document
				<samp class="ph codeph">students</samp> with the <samp class="ph codeph">underage</samp> view, it provides a
			response in JSON:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{"ok":true, "id":"_design/students"}
</samp></code></pre>

		<p class="p">Now we can query the view by performing a REST request as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">curl -X GET -u newBucket:password 'http://server_ip:8092/newBucket/_design/students/_view/underage?'
</samp></code></pre>

		<p class="p">Couchbase Server responds with the following results as JSON:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{"total_rows":3,"rows":[
{"id":"doc1", "key":"Aaron", "age":20},
{"id":"doc3", "key":"Peter", "age":16},
{"id":"doc4", "key":"Ralf", "age":12}
]
}
</samp></code></pre>

		<p class="p">This section is intended as a brief introduction to querying and indexing JSON documents
			with Couchbase SDKs. There is definitely much more to learn about the topic. For more
			information about using views with the SDKs, see <a class="xref" href="find-data.html#concept1470">Finding data with views</a>. For general information about Couchbase Server indexes and queries, see <a class="xref" href="http://docs.couchbase.com/admin/admin/Views/views-intro.html" target="_blank">Views and indexes</a>.</p>

	</div>


<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/first-app.html">Creating your first application</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/connect-get-set.html">Performing connect, set and get</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/telnet.html">Performing basic Telnet operations</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>