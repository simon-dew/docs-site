<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Handling temporary out of memory errors — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/bulk-set.html"><span>Performing a bulk set</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/memory-errors.html" class="current"><span>Handling temporary out of memory errors</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/sync-async-transactions.html"><span>Synchronous and asynchronous transactions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/transactional-logic.html"><span>Providing transactional logic</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/app-performance.html"><span>Improving application performance</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/thread-safety.html"><span>Thread safety for Couchbase SDKs</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/common-errors.html"><span>Handling common errors</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/troubleshooting.html"><span>Troubleshooting</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content"><h1 class="title topictitle1" id="ariaid-title1">Handling temporary out of memory errors</h1>
<div class="body conbody"><p class="p">There may be cases where you are performing operations at such a high volume,
that you need to decrease your requests to a rate your environment can handle.
For instance Couchbase Server may return a temporary out of memory response
based on a heavy request volume, your network can be slow, or your operations
may be returning too many errors. You can handle this scenario by creating a
loop that performs exponential backoff. With this technique, you have your
process increasingly wait to a point if your requests stall.</p>
<p class="p">One of the typically errors that may occur when you bulk load of data is that
Couchbase Server returns an out of memory error due to the volume of requests.
To handle this, you would follow this approach:</p>
<ul class="ul">
<li class="li"><p class="p">Create a loop that continuously tries your operation within a certain number of
 time limit, and possible a certain number of tries,</p>
</li>

<li class="li"><p class="p">In the loop, attempt your operation,</p>
</li>

<li class="li"><p class="p">If you get an out of memory error, have your process/thread wait,</p>
</li>

<li class="li"><p class="p">Try the operation again,</p>
</li>

<li class="li"><p class="p">If you get an error again, increase your wait time, and wait. This part of the
 approach is known as the exponential backoff.</p>
</li>

</ul>
<p class="p">This is a similar approach you could use for any Couchbase SDK, and for any
operation you are performing in bulk, such as getting in bulk. The following
example shows this approach using the Java SDK:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">public OperationFuture&lt;Boolean&gt; contSet(String key, int exp, Object value,
          int tries) {
    OperationFuture&lt;Boolean&gt; result = null;
    OperationStatus status;
    int backoffexp = 0;

    try {
        do {
            if (backoffexp &gt; tries) {
                throw new RuntimeException("Could not perform a set after "
                  + tries + " tries.");
             }

            result = cbc.set(key, exp, value);
            status = result.getStatus(); // blocking call

            if (status.isSuccess()) {
              break;
             }

            if (backoffexp &gt; 0) {
              double backoffMillis = Math.pow(2, backoffexp);
              backoffMillis = Math.min(1000, backoffMillis); // 1 sec max
              Thread.sleep((int) backoffMillis);
              System.err.println("Backing off, tries so far: " + backoffexp);
            }

            backoffexp++;

            if (!status.isSuccess()) {
              System.err.println("Failed with status: " + status.getMessage());
            }

            } while (status.getMessage().equals("Temporary failure"));

    } catch (InterruptedException ex) {
        System.err.println("Interrupted while trying to set.  Exception:"
              + ex.getMessage());
    }

 }
</samp></code></pre>
<p class="p">In the first part of our <samp class="ph codeph">try..catch</samp> loop, we have a <samp class="ph codeph">do..while</samp> loop which
continuously tries to set a key and value. In this loop we specify the amount of
time the application waits, in milliseconds, as <samp class="ph codeph">backoffMillis</samp>, and we increase
it exponentially each time we receive a runtime exception. We will only
exponentially increase the wait time a certain number of times, which we specify
in the parameter, <samp class="ph codeph">tries</samp>.</p>
<p class="p">The other approach you can try if you get temporary out of memory errors from
the server is to explicitly pace the timing of requests you make. You can do
this in any SDK by creating a timer and only perform a Couchbase request after a
specific timed interval. This will provide a slight delay between server
requests and will reduce the risk of an out of memory error. For instance in
Ruby:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">c.set("foo", 100)
n = 1

c.run do
    c.create_periodic_timer(500000) do |tm|
        c.incr("foo") do
            if n == 5
                tm.cancel
      else
        n += 1
      end
    end
  end
end
</samp></code></pre>
<p class="p">In this example we create a sample record ‘foo’ with the initial fixnum value of
100. Then we create a increment count set to one, to indicate the first time we
will create a Couchbase request. In the event loop, we create a timing loop that
runs every.5 seconds until we have repeated the loop 5 times and our increment
is equal to 5. In the timer loop, we increment ‘foo’ per loop.</p>
</div>
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/advanced-topics.html">Advanced topics in development</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/bulk-set.html">Performing a bulk set</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/sync-async-transactions.html">Synchronous and asynchronous transactions</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>