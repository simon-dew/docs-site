<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Understanding custom reduces and rereduce — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/views.html"><span>Understanding views</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/filter-extract.html"><span>Filtering and extracting data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/build-index.html"><span>Building an index</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/efficient-lookups.html"><span>Providing efficient lookups</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/order-results.html"><span>Ordering results</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/handle-results.html"><span>Handling result sets</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/built-in-reduce.html"><span>Using built-in reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/compound-keys.html"><span>Using compound keys and group-by functions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/views-from-apps.html"><span>Using views from an application</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/custom-reduces.html"><span>Creating custom reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/reduce-rereduce.html" class="current"><span>Understanding custom reduces and rereduce</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/view-errors.html"><span>Error handling for views</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Understanding custom reduces and rereduce</h1>

	<div class="body conbody">
		<p class="p">If you are going to write your own custom reduces, you should be aware of how the
				<em class="ph i">rereduce</em> option works in Couchbase Server. Rereduces are a form of recursion
			where Couchbase Server precalculates preliminary results and stores these results in a
			structure known in computer science as a <em class="ph i">b-tree</em>. First it applies the reduce
			function to groups of data in a result set and then stores these calculated values in the
			b-tree. The Server will then apply the reduce function to the calculated values, and will
			repeat the process on these resulting values, if needed. Couchbase Server performs the
			reduce as an initial reduction and then re-reduces repeatedly to provide better
			performance, and faster access to results.</p>

		<p class="p">If you have a large initial result set, Couchbase Server may create a b-tree structure with
			several levels, where the results from the initial reduce are stored at one level, and
			results from the following re-reduces are stored at the second, third, and forth level, and
			so on. The number of precalculated results decreases at each level, as Couchbase Server
			re-applies the reduce function:</p>

				<img class="image" src="images/rereduce1.png">
					
		<p class="p">This example shows the initial result set, and the different levels of results that exist
			when we sum numbers as part of our reduce and rereduces. The first level represents the
			result set generated by a map function where the key is a letter and the value is a number.
			Additional levels represents the results from two rereduces. In this example, we assume the
			server applies a reduce and then applies rereduces to groups of three items. In reality the
			size of the blocks are arbitrary and determined by internal logic in Couchbase Server. When
			Couchbase Server applies the reduce function to groups of three from the original result
			set, it sums each set and stores 4, 6, and 8 as precalculated results. The last items in a
			result set only consist of two items, so those are summed and stored as the value 3, The
			second time Couchbase Server applies the function as a rereduce, we get 18 which is the sum
			of the set of three numbers: 4 + 6 + 8. The second value for our rereduce is the remaining
			number 3, which has no other values to form a group of three and to be summed with.</p>

		<p class="p">Now that you see the logic of rereduces with Couchbase Server, you may wonder if this
			matters to you at all. It does matter if you perform want to perform a calculation based on
			the original result set. Because you have the option of performing a reduce and rereduce,
			when you choose this option you can no longer assume that you final result will be the same
			result you would have gotten if you performed the reduce on the initial data set.</p>

		<p class="p">For instance, this may be a consideration if you create a custom reduce which performs some
			type of counting. Couchbase Server already provides a built-in version of a count function
			which you can use for a reduce, but imagine you have a scenario where you need to do custom
			counting for your scenario. In this case, if you provided a count-type function the
			rereduce would apply the count to the precalculated values, not the original result set.
			You would get a count based on a reduced set, not the true number of values in the initial
			result. In the example below, if you use a count-type function to rereduce, you would get
			3, which represent the number of values stored after the initial reduce:</p>

		
				<img class="image" src="images/rereduceCT.png">
					
		<p class="p">So instead of getting the number of keys, which is 8, you get the number of values in the
			reduction, which is only 3. This is not what you might have expected, had you known about
			rereduce before you built your custom reduce. Instead of using a type of counting function
			for and performing rereduce, you actually need to sum after the initial reduction. The
			following code samples demonstrates the custom reduce function you would use:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (keys, values, rereduce) {
    if(!rereduce) {
        return values.length;
    } else {
        var sum = 0;
        for (i in values) {
            sum += values[i];
        }
        return sum;
    }
}
</samp></code></pre>

		<p class="p">For all custom reduces you will write the reduce function to take <samp class="ph codeph">keys</samp>,
				<samp class="ph codeph">values</samp>, and <samp class="ph codeph">rereduce</samp> as parameters. Couchbase Server
			will execute the custom reduce and provide the function keys and values from a map
			function, and will provide a boolean for <samp class="ph codeph">rereduce</samp>. Whether this Boolean is
			true or false is determined by internal Couchbase Server logic. So we should always provide
			a custom reduce function that can handle the case where <samp class="ph codeph">rereduce</samp> can be
			false or <samp class="ph codeph">rereduce</samp> is true. This way we cover our bases and create a custom
			reduce which produces results we expect.</p>

		<p class="p">For this example if <samp class="ph codeph">rereduce</samp> is false, Couchbase Server will not perform
			the reduce on a reduction, rather it will perform it on the original result set from a map
			function; therefore we can return the length of all values in the result set. In this case
			we will get the value 8. If <samp class="ph codeph">rereduce</samp> is true, we need to handle this by
			performing a sum of the reduction which is the correct number of items, 8. The logic for
			this second case is illustrated below:</p>

				<img class="image" src="images/rereduce2.png">
		<p class="p">Be aware that this is a very contrived example to demonstrate the rereduce and how to handle it
			in your custom reduce. In reality Couchbase Server provides a built-in function
				<samp class="ph codeph">_count</samp> which automatically handles the rereduce so that you get a count
			of all items in a result set, not the count of the reduced set. Nonetheless you should keep
			this behavior in mind if you perform a custom reduce which assumes the calculations are
			performed on the initial result set. If you want to find more information about the
			rereduce, and other forms of custom reduces, see <a class="xref" href="http://docs.couchbase.com/admin/admin/Views/views-writing.html#reduce-functions" target="_blank">Reduce functions</a>.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/find-data.html">Finding data with views</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/custom-reduces.html">Creating custom reduces</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/view-errors.html">Error handling for views</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>