<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Locking items — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/sdk-vs-sql.html"><span>Couchbase SDKs and SQL commands</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/read-write.html"><span>Reading and writing data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/doc-expiration.html"><span>About document expiration</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/async-methods.html"><span>About asynchronous methods</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/store-info.html"><span>Storing information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/retrieve-info.html"><span>Retrieving information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/retrieve-by-cas.html"><span>Retrieving items with CAS values</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/lock-items.html" class="current"><span>Locking items</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/update-info.html"><span>Updating Information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/delete-info.html"><span>Deleting information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/observe.html"><span>Monitoring data using observe</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/destroy-data.html"><span>Permanently destroying data</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Locking items</h1>

	<div class="body conbody">
		<p class="p">Get-and-lock methods enable you to retrieve a value for a given key and lock that key; it
			thereby provides a form of pessimistic concurrency control in Couchbase Server. While a key
			is locked, other clients are not able to update the key, nor are they able to retrieve
			it.</p>

		<p class="p">When you perform a get-and-lock operation you provide an expiration for the lock as a
			parameter. The maximum amount of time a key can be locked is 30 seconds; any parameter you
			provide that is more than 30 seconds will be set to 30 seconds; negative numbers will be
			interpreted as 30 seconds also. When Couchbase Server locks a key, it sets a flag on the
			key indicating it is locked, it updates the CAS value for the key and returns the new CAS
			value. When you perform a <samp class="ph codeph">cas</samp> operation with the new CAS value, it will
			release the lock.</p>

		<p class="p">You would want to use this method any time you want to provide a high level of assurance
			that a value you update is valid, or that a user can modify the value without any conflict
			with other users.</p>

		<p class="p">Going back to the spaceship example, imagine we want spaceships to be able to immediately
			put a repair item on hold when they arrive in the spaceship service station. This way, a
			player with a broken spaceship can immediately be assured that as long as they perform a
				<samp class="ph codeph">getl</samp> and the repair part is in inventory, they will get that part:</p>

		
				<img class="image" src="images/getl.png">
					
		<p class="p">Other spaceships that arrive in open repair spots afterwards cannot take it since the
			entire inventory is locked. In this case, it would make sense to provide separate
			inventories for all the different parts so that only that type of part is locked while a
			ship reserves a part. The spaceship that made the lock can update the inventory and release
			the key by using a <samp class="ph codeph">cas</samp> update.</p>

		<p class="p">The following are two examples of using a get-and-lock operation in the Ruby SDK:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">c.get("foo", :lock =&gt; true)

c.get("foo", "bar", :lock =&gt; 3)
</samp></code></pre>

		<p class="p">In the first example, we use the standard method call of <samp class="ph codeph">get()</samp> and include
			the parameter <samp class="ph codeph">:lock =&gt; true</samp> to indicate we want to lock the when we
			perform the retrieve. This lock will remain on the key until we perform a
				<samp class="ph codeph">cas</samp> operation on it with the correct CAS value, or the lock will expire
			by default in 30 seconds. In the second version of get-and-lock we explicit set the lock to
			a three second expiration by providing the parameter <samp class="ph codeph">:lock =&gt; 3</samp>. If we
			perform a <samp class="ph codeph">cas</samp> operation within the three seconds with the correct CAS
			value it will release the key; alternately the lock will expire and Couchbase Server will
			unlock the key in three seconds.</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">Object myObject = client.getAndLock("someKey", 10);
</samp></code></pre>

		<p class="p">In this previous example we retrieve the value for ‘someKey’ and lock that key for ten
			seconds. In the next example we perform a get-and-lock operation and try to retrieve the
			value while it is still locked:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">public static void main(String args[]) throws Exception {
      List&lt;URI&gt; uris = new LinkedList&lt;URI&gt;();
      uris.add(URI.create("http://localhost:8091/pools"));

      CouchbaseClient client = new CouchbaseClient(uris, "default", "");

      client.set("key", 0, "value").get();

      client.getAndLock("key", 2);


      System.out.println("Set locked key result: " + client.set("key", 0, "lockedvalue").get());
      System.out.println("Get locked key result: " + client.get("key"));

      Thread.sleep(3000);

      System.out.println("Set unlocked key result: " + client.set("key", 0, "newvalue").get());
      System.out.println("Get unlocked key result: " + client.get("key"));
      client.shutdown();
}
</samp></code></pre>

		<p class="p">The first attempt to set the key to ‘lockedvalue’ will output an error since the key is
			still locked. The attempt to output it will output the original value, which is ‘value.’
			After we have the thread sleep 30 seconds we are able to set it to ‘newvalue’ since the
			lock has expired. When we then perform a get, it outputs the updated value, ‘newvalue.’</p>

		<p class="p">The other way to explicitly unlock a value using a Couchbase SDK is to perform a
				<samp class="ph codeph">cas</samp> operation on the key with a valid CAS value. After Couchbase Server
			successfully updates the document, it will also unlock the key.</p>

		<p class="p">The equivalent call in the memcached protocol is <samp class="ph codeph">get</samp> which returns the
			value for the key and will set a timed lock if you provide it as a parameter. For more
			information, see <a class="xref" href="https://github.com/memcached/memcached/blob/master/doc/protocol.txt" target="_blank">memcached protocol</a>.</p>

		<p class="p">The types of errors that can occur during this operation include 1) inability to connect to
			a node, or 2) some error exists while attempting to format a value being retrieved. If you
			have a connection-level error you may need to reattempt connection, and possibly check the
			status of the server. If you have an error with the size of your value or formatting, you
			need to check the value itself, and how it is encoded and see if there are any issues that
			make the document incompatible with Couchbase Server.</p>

		<p class="p">For more information about connections and connection-level settings, see <a class="xref" href="app-performance.html#concept_gmj_qss_np__optimize-instances">Optimizing client instances</a> and 
			<a class="xref" href="common-errors.html#concept7680__client-timeouts">Client-side timeouts</a>.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/access-data.html">Accessing data with Couchbase SDKs</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/retrieve-by-cas.html">Retrieving items with CAS values</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/update-info.html">Updating Information</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>