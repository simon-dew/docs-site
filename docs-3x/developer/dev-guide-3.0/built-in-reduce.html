<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Using built-in reduces — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/views.html"><span>Understanding views</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/filter-extract.html"><span>Filtering and extracting data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/build-index.html"><span>Building an index</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/efficient-lookups.html"><span>Providing efficient lookups</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/order-results.html"><span>Ordering results</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/handle-results.html"><span>Handling result sets</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/built-in-reduce.html" class="current"><span>Using built-in reduces</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/compound-keys.html"><span>Using compound keys and group-by functions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/views-from-apps.html"><span>Using views from an application</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/custom-reduces.html"><span>Creating custom reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/reduce-rereduce.html"><span>Understanding custom reduces and rereduce</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/view-errors.html"><span>Error handling for views</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Using built-in reduces</h1>

	<div class="body conbody">
		<p class="p">We discussed earlier how a Couchbase view includes a map function for finding and
			extracting into an index. <em class="ph i">Reduce</em> functions are optional functions which can perform
			calculations and other operations on items in an index. There are two types of reduce
			functions: those that are provided by Couchbase Server, known as built-in reduces,
			and reduce functions you create as custom JavaScript. The built-in reduce functions
			include:</p>

		<ul class="ul">
			<li class="li"><p class="p"><samp class="ph codeph">_count</samp>—this function counts the number of emitted items. For instance
					if you perform a query on a view and provide a start key and end key resulting in 10
					items in a result set, you will get the value 10 as a result of the reduce.</p>
</li>

			<li class="li"><p class="p"><samp class="ph codeph">_sum</samp>—adds up all values emitted to an index. For instance, for the
					values 3, 4, and 5 in a result set the result of the reduce function will be
				12.</p>
</li>

			<li class="li"><p class="p"><samp class="ph codeph">_stats</samp>—calculates statistics on your emitted values, including sum of
					emitted values, count of emitted items, minimum emitted value, maximum emitted value
					and sum of squares for emitted values.</p>
</li>

		</ul>

		<p class="p">To understand how a built-in reduce works, imagine an application for beers and breweries.
			Each brewery document would appear as follows in JSON:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
"name":"Allguer Brauhaus AG Kempten",
"state":"Bayern",
"code":"",
"country":"Germany",
"phone":"49-(0)831-/-2050-0",
"website":"",
"type":"brewery",
"updated":"2010-07-22 20:00:20",
"description":"",
"address":["Beethovenstrasse 7"],
"geo":{"accuracy":"ROOFTOP","lat":47.7487,"lng":10.5694}
}
</samp></code></pre>

		<p class="p">This specific brewery document contains information for a brewery in Bavaria, but all other
			breweries in our application would follow the same document model. Imagine we want to be
			able to count the number of breweries in each unique city, state or country. In this case
			we need both a map and reduce function; in this case the map function of our view would
			look like this:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (doc, meta) {
  if (doc.country, doc.state, doc.city) {
    emit([doc.country, doc.state, doc.city], 1);
  } else if (doc.country, doc.state) {
    emit([doc.country, doc.state], 1);
  } else if (doc.country) {
    emit([doc.country], 1);
  }
}
</samp></code></pre>

		<p class="p">As a best practice we want make sure that the fields we want to include in our index
			actually exist. Therefore we have our map function build on index based on a conditional,
			and the same conditional ensures the presence of the items we want to index. This ensures
			the fields exist in documents when we query the view and we therefore avoid a view failure
			when Couchbase Server generates the index.</p>

		<p class="p">If a brewery has all categories of information, namely country, state, and city, we will
			create an index with the country, state and city as key with the value equal to one. If the
			brewery only has country and state, we create an index with country and state as key with
			the value equal to one. Finally if we only have the country of origin, we create an index
			with only the country as key and the value set to one. As a result of the map function, we
			would have an index that appears as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
["Germany", "Bayern"]            1
["Belgium", "Namur"]            1
["Germany", "Bayern"]            1
....
</samp></code></pre>

		<p class="p">For our reduce function we use a built-in reduce function, <samp class="ph codeph">_count</samp>. This
			function which will sum the values for all unique keys. In this case, the result set for
			our view query will be as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
["Germany", "Bayern"]            2
["Belgium", "Namur"]            1
</samp></code></pre>

		<p class="p">When you create reduce function and store it in a design document, it will appear in JSON
			as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
  "_id": "_design/beers",
  "language": "javascript",
  "views": {
    "titles": {
      "map": "function(doc, meta){
        if (meta.type == "json" &amp;&amp; doc.date &amp;&amp; doc.title) {
        // Check if doc is JSON
        emit(doc.date, doc.title);
         } else {
        // do something with binary value
         }
    }
  }
  "reduce" : "_count"
}
</samp></code></pre>

		
	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/find-data.html">Finding data with views</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/handle-results.html">Handling result sets</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/compound-keys.html">Using compound keys and group-by functions</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>