<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Monitoring data using observe — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/sdk-vs-sql.html"><span>Couchbase SDKs and SQL commands</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/read-write.html"><span>Reading and writing data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/doc-expiration.html"><span>About document expiration</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/async-methods.html"><span>About asynchronous methods</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/store-info.html"><span>Storing information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/retrieve-info.html"><span>Retrieving information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/retrieve-by-cas.html"><span>Retrieving items with CAS values</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/lock-items.html"><span>Locking items</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/update-info.html"><span>Updating Information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/delete-info.html"><span>Deleting information</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/observe.html" class="current"><span>Monitoring data using observe</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/destroy-data.html"><span>Permanently destroying data</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Monitoring data using observe</h1>

	<div class="body conbody">
		<p class="p">With Couchbase you can use observe functions in the SDKs to determine the status of a
			document in Couchbase Server. This provides a level of assurance in your application that
			data will be available in spite of node failure.</p>

		<p class="p">For instance, you may want to create a ticketing application and you want to place a hold
			on tickets while you perform a credit card authorization to pay for the ticket. If a node
			fails during that time, you may not be able to recover the current state of the ticket, and
			determine whether it was on hold for a user, or not. If the ticket is in RAM only, you may
			not be able to retrieve the ticket at all. By using an observe command, you can determine
			whether the ticket is persisted or whether it has been replicated. You can then determine
			if you retrieve the ticket state you can get the most current version that is on disk.</p>

		<p class="p">This section describes when you would want to use observe-functions and how to implement it
			in your application.</p>

		<p class="p"></p>

		<section class="section"><h2 class="title sectiontitle">Why observe items?</h2>
			
			<p class="p">One of the challenges working with items that can be in-memory or on-disk is that you
				may want to keep track of the state of your document in the system. For instance, in
				your application you may also want to know if a document has been stored to disk or not.
				You may also want to specify how many copies of a document are stored on replicas. Both
				of these enhancements enable you to recover important documents and provide consistent
				information in your application despite server failure.</p>

			<p class="p">With Couchbase Server, you can use Couchbase SDK observe-functions to do the following
				in your application logic:</p>

			<ul class="ul">
				<li class="li">
					<p class="p">Determine whether a document has been persisted,</p>

				</li>

				<li class="li">
					<p class="p">Determine whether a document has been replicated.</p>

				</li>

			</ul>

			<p class="p">One of the new features of Couchbase Server is support for indexing and querying of
				data. We provide this functionality as <dfn class="term">views</dfn>. Views enable you to find
				specific information in Couchbase Server, extract information, sort information, and
				also perform a wide variety of calculations across a group of entries in the database.
				For instance if you want to generate an alphabetical list of users in your system you
				can use views to do so.</p>

			<p class="p">Couchbase Server can index and query information from a document when that document is
				actually persisted to disk. Therefore you may want to use an observe-function to
				determine if the document is persisted and therefore available for use in views. To do
				so, you would make an observe request, and after you know Couchbase Server persists the
				item, you can retrieve the relevant view.</p>

			<p class="p">The other scenario you may want to handle in your application is where you want to make
				sure a document has been replicated. You can automatically configure replication of data
				from one cluster to another cluster and from one data bucket to another bucket.
				Collectively, this functionality is known as <a class="xref" href="http://docs.couchbase.com/admin/admin/Views/views-development.html" target="_blank">cross data center replication (XDCR)</a>.</p>

			<p class="p">The final scenario where you would want to use an observe-function is for documents that
				should be durable in nature. For instance, imagine you have a shopping cart in your
				application and you want to maintain the state of the shopping cart in the application
				while a user continues searching for other items. When a user returns to a shopping cart
				the latest items they have selected should still be there for purchase. You also want
				the state of the shopping cart to not only be current but also to survive a node failure
				if possible.</p>

			<p class="p">In this type of scenario, you can use the observe command so that you know the state of
				the shopping cart data in Couchbase Server. By knowing the state of the shopping cart
				document in the server, you can provide the correct application logic to handle the
				document state. If you know you are unable to recover the shopping cart data, you might
				want to provide an error message to the user and ask them to reselect items for the
				cart; if you are able to recover a persisted or replica document, you can provide
				another message and provide the most current recovered shopping cart items.</p>

			<p class="p">The following illustrates two different scenarios using an observe-function. The first
				illustration is how you might handle a scenario where a node fails and the
				observe-function indicates the cart is not yet on disk or in replica:</p>

					<img class="image" src="images/observe1.png">
			<p class="p">In this case where node fails and the data is not yet persisted or replicated on another
				node, it will disappear from RAM and is not recoverable. When you observe this type of
				scenario, an observe-function will indicate the data is not replicated or persisted and
				therefore it cannot be recreated into RAM and retrieved from RAM. So your application
				logic would need to compensate for that lack of data by showing for instance, an empty
				cart, or a cart error message letting the user know they need to add items once again.
				In the next illustration we show the scenario where a node fails but we successfully
				determine that the cart is persisted or on a replica node:</p>

					<img class="image" src="images/observe2.png">
			<p class="p">In this second scenario we have a backup of the shopping cart on disk or on a replica
				node; we can retrieve the shopping cart data once it is brought back into RAM by
				Couchbase Server. After a node fails an observe-function will indicate when the item
				returns back into RAM and then we can retrieve it to rebuild the user shopping cart.</p>

			<p class="p">When you observe a key, this will survive node rebalance and topology changes. In other
				words if your application observes a key, and the key moves to another node due to
				rebalance or cluster changes, a Couchbase SDK will be able to continue monitoring the
				status of the key in the new location.</p>

			<p class="p">There are important points to understand about data replication and data persistence.
				When Couchbase Server creates replica data, it adds this data in the RAM of another
				Couchbase node. This supports very rapid reads/writes for the data once the data has
				been replicated. When Couchbase Server persists data, the data must wait in a queue
				before it is persisted to disk. Even if there are only a few documents ahead of
				document, it will take longer to be stored on disk from the queue than it would be to
				create a replica on another node. Therefore if rapid access to data is your priority,
				but you want to provide high availability of the data, you may prefer to use
				replication.</p>

			<p class="p"></p>

		</section>

		<section class="section"><h2 class="title sectiontitle">Observing documents</h2>
			
			<p class="p">Couchbase SDK observe-functions indicate whether a document is on disk or on a replica
				node. Documents in Couchbase Server can be in RAM only, can be persisted to disk, or can
				also be on a replica node as a copy. When data is persisted onto disk or is on a replica
				node, when the node that contains that data fails, you can still recover the data.</p>

			<p class="p">Once the node fails, the document can be recovered from disk back into RAM and then
				retrieved by your application. If the document is available on a replica node that is
				still functioning, you can request the document and it will be retrieved from the
				replica node. You use observe-functions to determine whether important application data
				has been persisted or replicated so that you have some assurance you can recreate the
				document or not if a Couchbase node is down.</p>

			<p class="p">There are two approaches for providing ‘observe’/monitoring functionality in Couchbase
				SDKs:</p>

			<ul class="ul">
				<li class="li">
					<p class="p">Provide ability to monitor the state of a document and determine if it is
						persisted or on replica node.</p>

				</li>

				<li class="li">
					<p class="p">Provide ability to explicitly persist or replicate documents to a certain number
						of disks or replica nodes.</p>

				</li>

			</ul>

			<p class="p">The first example we demonstrate in the Ruby SDK takes the first approach where you can
				monitor a given key. The Couchbase Ruby SDK will return a <samp class="ph codeph">Result</samp> object
				with the status of a given key:</p>

			<pre class="pre codeblock"><code><samp class="ph codeph">stats = conn.observe("foo")
</samp></code></pre>

			<p class="p">In this case, we perform the <samp class="ph codeph">observe</samp> with a Couchbase cluster
				containing one replica node. The results we receive will be as follows:</p>

			<pre class="pre codeblock"><code><samp class="ph codeph">&lt;Couchbase::Result:0x0000000182d588 error=0x0 key="foo" status=:persisted cas=4640963567427715072 from_master=true time_to_persist=0 time_to_replicate=0&gt;
</samp></code></pre>

			<p class="p">This <samp class="ph codeph">Results</samp> object provides the status for the key
					<samp class="ph codeph">foo</samp> : the symbol <samp class="ph codeph">:persisted</samp> tells us that it has
				been persisted to disk, and the <samp class="ph codeph">from_master=true</samp> result indicates that
				the document has been replicated. The Couchbase Ruby SDK also supports the second
				approach where we can specify our preferences for replica and persistence when we store
				a document:</p>

			<pre class="pre codeblock"><code><samp class="ph codeph">conn.set("foo", "bar", :observe =&gt; {:persisted =&gt; 2, :timeout =&gt; 5})
</samp></code></pre>

			<p class="p">For store and update operations, we can provide a parameter to specify that a document
				be persisted or replicated a certain number of times. In this example above we indicate
				that the key <samp class="ph codeph">foo</samp> be persisted onto disk on two nodes. The
					<samp class="ph codeph">:timeout</samp> parameter is specific to this operation and indicates the
				operation should time out after waiting five (5) seconds for the two document writes to
				disk.</p>

			<p class="p">One common approach for using an observe-function is to verify that a document is on at
				least one replica node. If you want to be extremely certain about the durability of some
				documents, you may want to verify that the document is replicated to at least three
				nodes and persisted to at least four servers. This represents the maximum number of
				replicas and on-disk copies that Couchbase Server currently supports.</p>

			<p class="p">For asynchronous observe requests, a Couchbase SDK determines that an observe request is
				complete by polling the Couchbase Server. A Couchbase SDK will determine which observe
				requests have completed all the events that are being observed for a key, namely
				replication and persistence.</p>

			<p class="p">The types of errors that can occur during this operation include 1) inability to connect
				to a node, or 2) some error exists while attempting to format a value being used. If you
				have a connection-level error you may need to reattempt connection, and possibly check
				the status of the server. If you have an error with the size of your value or
				formatting, you need to check the value itself, and how it is encoded and see if there
				are any issues that make the document incompatible with Couchbase Server.</p>

			<p class="p">For more information about connections and connection-level settings, see <a class="xref" href="app-performance.html#concept_gmj_qss_np__optimize-instances">Optimizing client instances</a>
				<a class="xref" href="common-errors.html#concept7680__client-timeouts">Client-side timeouts</a>.</p>

		</section>

	</div>

<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/access-data.html">Accessing data with Couchbase SDKs</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/delete-info.html">Deleting information</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/destroy-data.html">Permanently destroying data</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>