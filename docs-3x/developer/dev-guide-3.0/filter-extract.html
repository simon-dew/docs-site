<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Filtering and extracting data — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/views.html"><span>Understanding views</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/filter-extract.html" class="current"><span>Filtering and extracting data</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/build-index.html"><span>Building an index</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/efficient-lookups.html"><span>Providing efficient lookups</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/order-results.html"><span>Ordering results</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/handle-results.html"><span>Handling result sets</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/built-in-reduce.html"><span>Using built-in reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/compound-keys.html"><span>Using compound keys and group-by functions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/views-from-apps.html"><span>Using views from an application</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/custom-reduces.html"><span>Creating custom reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/reduce-rereduce.html"><span>Understanding custom reduces and rereduce</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/view-errors.html"><span>Error handling for views</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Filtering and extracting data</h1>

	<div class="body conbody">
		<p class="p">One of the simplest ways to learn about views is to create a basic map function which
			extracts data from entries. Imagine we have our own blog application and we want to provide
			a list of blog posts by title. First imagine what the JSON documents would look like for
			our blog posts:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
  "title":"Move Today",
  "body":"We just moved into a new big apartment in Mountain View just off of....",
  "date":"2012/07/30 18:12:10"
}

{
  "title":"Bought New Fridge",
  "body":"Our freezer broke down so ordered this new one on Amazon....",
  "date":"2012/09/17 21:13:39"
}

{
  "title":"Paint Ball",
  "body":"Had so much fun today when my company took the whole team out for...",
  "date":"2012/9/25 15:52:20"
}
</samp></code></pre>

		<p class="p">Then we create our map function which will extract our blog post titles:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function(doc) {
    if(doc.title) {
        emit(doc.title, null);

  }
}
</samp></code></pre>

		<p class="p">This function will look at a JSON document and if the document has a <samp class="ph codeph">title</samp>
			attribute, it will include that title in the result set as a key. The <samp class="ph codeph">null</samp>
			indicates no value should be provided in the result set. In reality if you look at all the
			details, a standard view function syntax is a bit more complex in Couchbase 2.1.0.</p>

		<p class="p">Here is how the map function appears when you provide full handling of all JSON document
			information:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (doc, meta) {
  if (meta.type == "json" &amp;&amp; doc.title &amp;&amp; doc.date) {
    // Check if doc is JSON
    emit(doc.title, doc.date);
  } else {
    // do something with binary value
  }
}
</samp></code></pre>

		<p class="p">As a best practice we want make sure that the fields we want to emit in our index actually
			exist before we emit it to the index. Therefore we have our map function within a
			conditional: <samp class="ph codeph">if (doc.title &amp;&amp; doc.date)</samp>. For instance, if we
			wanted to perform a views function that tried to emit <samp class="ph codeph">doc.name.length</samp> we
			would get a “undefined reference” exception if the field does not exist and the view
			function would fail. By checking for the field we avoid these potential types of
			errors.</p>

		<p class="p">If you have ever looked at a view in Couchbase Admin Console, this map function will be more
			familiar. In Couchbase 2.1.0 we separate metadata about an entry such as expiration and the
			entry itself into two parts in a JSON document. So in our function we have the parameter
				<samp class="ph codeph">meta</samp> for all document meta-data and <samp class="ph codeph">doc</samp> as the
			parameter for document values, such as the title and blog text. Our function first looks at
			the metadata to determine if it is a JSON document by doing a <samp class="ph codeph">if..else</samp>. If
			the document is JSON, the map function extracts the blog title and the date/time for the
			blog entry. </p>

		<p class="p">If the document is binary data, you would need to provide some code to handle it, but typically
			if you are going to query an index data, you would do so on JSON documents. </p>

		<p class="p">The <samp class="ph codeph">emit()</samp> function takes two arguments: the first one is
				<samp class="ph codeph">key</samp>, and the second one is <samp class="ph codeph">value</samp>. The
				<samp class="ph codeph">emit()</samp> creates an entry, or row, in our result set. You are able to
			call the <samp class="ph codeph">emit</samp> function multiple times in a map function; this will create
			multiple entries in the result set from a single document. We will discuss that more in
			depth later.</p>

		<p class="p">Once you have your view functions, you store them to Couchbase Server and then query the
			view to get the result set. When you query your view, Couchbase Server takes the code in
			your view and runs it on <em class="ph i">every document persisted on disk</em>. You store your map
			function as a string in a design document as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
  "_id": "_design/blog",
  "language": "javascript",
  "views": {
    "titles": {
      "map": "function(doc, meta){
          if (meta.type == "json" &amp;&amp; doc.date &amp;&amp; doc.title) {
                // Check if doc is JSON
                emit(doc.date, doc.title);
              } else {
                // do something with binary value
              }
    }
  }
}
</samp></code></pre>

		<p class="p">All design documents are prefixed with the id <samp class="ph codeph">_design/</samp> and then your name
			for the design document. We store all view functions in the <samp class="ph codeph">views</samp>
			attribute and name this particular view <samp class="ph codeph">titles</samp>. Using a Couchbase SDK, you
			can read the design document in as a file from the file system and store the design
			document to the server. In this case we name our design document file
				<samp class="ph codeph">blog.json</samp> :</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">client = Couchbase.connect("http://localhost:8091/pools/default/buckets/bucketName")

client.save_design_doc(File.open('blog.json'))
</samp></code></pre>

		<p class="p">This code will create a Couchbase client instance with a connection to the bucket,
				<samp class="ph codeph">bucketName</samp>. We then read the design document into memory and write it
			to Couchbase Server. At this point we can query the view and retrieve our map function
			results:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">posts = client.design_docs['blog']

posts.views                    #=&gt; ["titles"]

posts.titles
</samp></code></pre>

		<p class="p">Couchbase Server will take each document on disk, determine if the document is JSON and
			then put the blog title and date into a list. Each row in that list includes a key and
			value:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
"2012/07/30 18:12:10"            "Move Today"
"2012/09/17 21:13:39"            "Bought New Fridge"
"2012/09/25 15:52:20"            "Paint Ball"
</samp></code></pre>

		<p class="p">You may wonder how effective it is to run query your view if Couchbase Server will run it
			on every persisted document in the database. But Couchbase Server is designed to avoid
			duplicate work. It will run the function on all documents once, when you first query the
			view. For subsequent queries on the view Couchbase Server will recompute the keys and
			values only for documents that have changed.</p>

		<p class="p">When you query this view, Couchbase Server will send the list of all documents as JSON. It will
			contain the key, value and the document id, plus some additional metadata.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/find-data.html">Finding data with views</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/views.html">Understanding views</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/build-index.html">Building an index</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>