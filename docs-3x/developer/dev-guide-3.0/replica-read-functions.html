<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Replica read â€” Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/sasl.html"><span>Providing SASL authentication</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/topology.html"><span>Getting cluster topology</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/observe-functions.html"><span>Providing observe functions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/replica-read-functions.html" class="current"><span>Replica read</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/protocol-extensions.html"><span>Couchbase protocol extensions</span></a></li></ul></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Replica read</h1>

	<div class="body conbody">
		<p class="p">As of Couchbase Server 2.1.0, we have a binary protocol to retrieve replicated data for a
			given key. The command is similar to the existing binary get command, however it returns
			data from a vBucket that is in a replica state as opposed to an active state.</p>

		<p class="p">In case of node failure you can have an application retry the server and wait until
			replicated data is available on another node. Couchbase Server takes 30 seconds to detect a
			node has failed, automatically failover the node, and then elevate replicated data to an
			active state on another node. If you do not have automatic failover enabled, it may take
			even longer for human intervention and manual failover. Although clients can wait and retry
			a read, you may have a scenario where you cannot wait 30 seconds to detect node failure,
			perform failover and activate replicated data. For instance, if you have an SLA that
			requires you to get data within 30 seconds of a request or less, you may need replica read
			functionality. In this case you can use replica read at the binary protocol level or as it
			is available in Couchbase SDKs. For more information about node failure and failover, see
			<a class="xref" href="http://docs.couchbase.com/admin/admin/Tasks/maintenance-server-node.html" target="_blank">Server maintenance</a>.</p>

		<p class="p">If you create your own Couchbase client, you can also create a wrapper on this protocol to
			provide replica reads.</p>

		<p class="p">If you use replica read, it will introduce the possibility that a client gets inconsistent data
			from the cluster; for this reason we generally recommend you have your application logic
			handle shorts periods of unavailability. For example if a user cannot get their user
			profile within 30 seconds, you can handle it with an error message and request that they
			try later. Replica read will get replicated data from the functioning node; but this does
			not ensure that the document is the most current document. For instance, if you update a
			document then immediately perform replica read, the data might not yet be replicated to the
			other node and you will get an older version back. If it is very important that you always
			have the most current version of a document, you may not satisfy this with a replica read.
			One thing you can do to help mitigate this problem is to keep the CAS value for an item
			when you set or update it and compare this with the CAS value returned by replica read. For
			more information, see <a class="xref" href="update-info.html#concept29631__cas">Compare and swap (CAS)</a></p>

		<p class="p">The request is identical to a get request with the exception of the opcode of 0x83:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">Field (offset) (value)
  Magic (0) : 0x80
  Opcode (1) : 0x83
  Key length (2,3) : 0x0005
  Extra length (4) : 0x00
  Data type (5) : 0x00
  VBucket (6,7) : 0x0000
  Total body (8-11) : 0x00000005
  Opaque (12-15): 0x00000000
  CAS (16-23): 0x0000000000000000
  Extras : None
  Key (24-29): The textual string: "Hello"
  Value : None
</samp></code></pre>

		<p class="p">The response is also identical to a get response except for the opcode of 0x83:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">Field (offset) (value)
  Magic (0) : 0x81
  Opcode (1) : 0x83
  Key length (2,3) : 0x0000
  Extra length (4) : 0x04
  Data type (5) : 0x00
  Status (6,7) :0x0000
  Total body (8-11) : 0x00000009
  Opaque (12-15): 0x00000000
  CAS (16-23): 0x0000000000000001
  Key (24-29): The textual string: "Hello"
  Value : The textual string: "World"
</samp></code></pre>

		<p class="p">Possible errors from the server include the following:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">ENGINE_NOT_MY_VBUCKET = 0x0c
ENGINE_EWOULDBLOCK = 0x07
</samp></code></pre>

		<p class="p">You will get the <samp class="ph codeph">ENGINE_NOT_MY_VBUCKET</samp> message if the server cannot find
			the vBucket with this key. You may also get this message if the vBucket with this key is
			not in replica state. This means you will get this error if the server has already
			performed automatic failover and has already elevated the replicated data into an active
			state when it got the request. In this case, the key is available as a get operation and
			not as a replica read.</p>

		<p class="p">Couchbase Server will return <samp class="ph codeph">ENGINE_EWOULDBLOCK</samp> if the vBucket with
			replicated data is still undergoing rebalance. In this case you may want to provide logic
			in your client to retry as a get operation once the rebalance completes.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/client-library.html">Developing a client library</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/observe-functions.html">Providing observe functions</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/protocol-extensions.html">Couchbase protocol extensions</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">Â© 2011â€“2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>