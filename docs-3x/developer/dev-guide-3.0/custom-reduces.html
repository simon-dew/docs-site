<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Creating custom reduces — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/views.html"><span>Understanding views</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/filter-extract.html"><span>Filtering and extracting data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/build-index.html"><span>Building an index</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/efficient-lookups.html"><span>Providing efficient lookups</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/order-results.html"><span>Ordering results</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/handle-results.html"><span>Handling result sets</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/built-in-reduce.html"><span>Using built-in reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/compound-keys.html"><span>Using compound keys and group-by functions</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/views-from-apps.html"><span>Using views from an application</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/custom-reduces.html" class="current"><span>Creating custom reduces</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/reduce-rereduce.html"><span>Understanding custom reduces and rereduce</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/view-errors.html"><span>Error handling for views</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Creating custom reduces</h1>

	<div class="body conbody">
		<p class="p">In the majority of cases most developers will use built-in reduce functions provided by
			Couchbase Server to perform calculations on index items. Even more complex operations can
			be performed using a combination of logic in a map function combined with built-in reduce
			functions. The advantage of using built-in reduces with map functions is that your view
			functions will tend to be less complex, and will tend to be less error-prone. There are
			however some cases where you will need to build a custom reduce function either alone, or
			in conjunction with a built-in reduce. This section demonstrates the use of custom reduce
			functions.</p>

		<p class="p">For more information about the sample application described in this section, as well as the
			custom reduce function used in it, see <a class="xref" href="http://crate.im/posts/couchbase-views-reddit-data/" target="_blank">Creating a Couchbase view from Reddit</a>.</p>

		<p class="p">The goal of our application is to show the frequency of Reddit posts that occur over the
			course of a day. To do this we aggregate information from Reddit, the online source for
			user-nominated and user-voted links. In this sample we already have information from a
			Reddit page as JSON documents stored in Couchbase Server. Here is the output we would like
			to present as graph:</p>

		
				<img class="image" src="images/reddit_snippet.png">
					
		<p class="p">In this graph we have a x-axis to represent the 24 hours in a day. Each bar that appears in
			the graph represents the number of Reddit posts that occurred in a one-hour time block
			during the day, such as the time between 6:00AM to 7:00AM. To start, we extract information
			from the page and create JSON documents to represent each Reddit post. An example document
			would look like this:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
    ....

    "kind": "link",
    ....

    "title": "I don't buy the bottled Thai Sweet Chili Sauce anymore...",
    "thumbnail": "",
    "permalink": "/r/food/comments/yph1p/i_dont_buy_the_bottled_thai_sweet_chili_sauce/",
    "url": "http://www.ibelieveicanfry.com/2012/08/thai-sweet-chili-sauce.html",
    "created": 1345745189,
    "num_reports": null,
    "saved": false,
    "subreddit": "food",
    "ups": 10,
    "created_utc": 134759064,

    ....
}
</samp></code></pre>

		<p class="p">For the sake of brevity we do not show some of the document attributes which we do not use
			in our application. When we extract JSON from Reddit, we add an attribute
				<samp class="ph codeph">kind</samp> with the value of “link” to indicate this is a Reddit link. The
			attributes we want to extract with a map function and output as a compound key are
				<samp class="ph codeph">[subreddit, day-of-week, date]</samp>.</p>

		<p class="p">The logic used to index items in Couchbase Server require that compound keys be sorted first by
			the first element, and then by the second element, and so on. This means that items in an
			index from the same <samp class="ph codeph">subreddit</samp> will be grouped, and within that group,
			items are sorted by <samp class="ph codeph">day-of-week</samp> and so on. For more information about
			compound keys and sorting, see <a class="xref" href="compound-keys.html#concept3545">Using compound keys and group-by functions</a>.</p>

		<p class="p">Creating compound keys sorts the keys so that we can specify what range we want to retrieve
			from the index using query parameters. When we query the view for this data we can use the
			query parameters <samp class="ph codeph">startkey</samp> and <samp class="ph codeph">endkey</samp> to get the items in
			a particular subreddit post, in all the subreddits between days of the week, or in all
			subreddits on a day based on the time of day. The following is the map function we use to
			generate a compound key and provide the post time, date, and score:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (doc, meta) {
  if (meta.type == "json" &amp;&amp; doc.kind &amp;&amp; doc.created_utc) {
    if(doc.kind == "link") {
      var dt = new Date(doc.created_utc * 1000);
      var hrs = dt.getUTCHours();
      var out = {total: 1, freqs: [], score: []};
      //Get day of week, but start week on Saturday, not Sunday, so that
      //we can pull out the weekend easily.
      var ssday = dt.getUTCDay() + 1;
      if (ssday == 7) ssday = 0;
      out.freqs[hrs] = 1;
      out.score[hrs] = doc.score;
      emit([doc.subreddit, ssday, dt], out);
    }
  }
}
</samp></code></pre>

		<p class="p">As a best practice we want make sure that the fields we want to include in our index
			actually exist. Therefore we have our map function within a conditional which determines
			the document is JSON and also checks that the fields <samp class="ph codeph">doc.kind</samp> and
				<samp class="ph codeph">doc.created_utc</samp> actually exist. This ensures the fields exist in
			documents when we query the view and we therefore avoid a view failure when Couchbase
			Server generates the index.</p>

		<p class="p">The first thing we do is determine if the document is JSON and whether it is a Reddit link.
			Then we create instance variables <samp class="ph codeph">dt</samp> to store the date of the post as a
			UTC value multiplied by 1000. We then have a variable <samp class="ph codeph">hrs</samp> to store the
			hour of the post. We will use these two variables for the second and third elements of our
			compound key. The variable <samp class="ph codeph">out</samp> will be a hash value that we emit for each
			compound key. It will contain the total instances of the post that occur, the frequency of
			the post, and the score for the post. The final variable we set up, <samp class="ph codeph">ssday</samp>
			converts the UTC to the day of the week plus one and if it is the last day of the week, we
			set it to 0. So following our logic, Saturday would be set to 0, Sunday will be 1, and
			Thursday would be 5.</p>

		<p class="p">Then we generate the value for our index. We set position <samp class="ph codeph">hrs</samp> of the array to
			1, for instance, if the post time stamp is the 2:00 in the morning, we have the array
				<samp class="ph codeph">[null, null, 1]</samp>. Finally we emit the value in our index with the
			compound key and the <samp class="ph codeph">out</samp> hash as our value.</p>

		<p class="p">A sample index entry based on this map function will appear as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">Key
["food", 5, "2012-09-14T02:44:07.230Z"]

Value
{total:1, freqs: [null, null, 1], score: [null, null, 5]}
</samp></code></pre>

		<p class="p">The map function outputs the hour of the day by storing 1 in <samp class="ph codeph">freqs</samp> at the
			position representing the hour of day. In the <samp class="ph codeph">score</samp> array we output the
			score at the position representing the hour of day. In this case we have a post that
			occurred at 2:00AM so the score of 5 is at position 2 of the array. To aggregate the
			frequency of posts into each 24-hour time periods in a day, we use this custom reduce
			function:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">function (keys, values, rereduce) {
  var out = {};
  out.freqs = [];
  out.score = [];
  for(i = 0; i &lt; 24; i++) {
    out.freqs[i] = 0;
    out.score[i] = 0;
  }
  out.total = 0;
  for(v in values) {
    for(h in values[v].freqs) {
      out.freqs[h] += values[v].freqs[h];
      out.score[h] += values[v].score[h];
    }
    out.total += values[v].total;
  }
  return out;
}
</samp></code></pre>

		<p class="p">The reduce function will aggregate the output of the map and can later be queried to get a
			range of keys within the result set. We create arrays to store our aggregated frequency and
			aggregated scores, and then create array elements for the 24 hours in a day. We then sum
			the frequency and sum the scores in each array element and store it in the array position
			for the hour of the day. When we query the view, the result of the reduce function will
			appear as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{"rows":[{"key":null,
          "value":{"freqs":[20753,19760,15821,15284,14627,13699,11012,8991,
                            7330,6327,6637,7711,10003,12705,15464, 17765,
                            19265,21043,21068,22372,18423,17951,20382,20404],
                   "score":[640304,620266,543505,507882,444247,362853,307157,
                            269177,249111,299142,336299,484781,701107,885255,
                            1006005,1095631,1020605,982352,849484,864482,
                            727186,689255,666884,692730],
                   "total":364797}}]}
</samp></code></pre>

		<p class="p">So for the first hour of the day, which is midnight to 1:00 AM we have 20753 posts on
			Reddit with the aggregate score of 640304. Both the <samp class="ph codeph">freqs</samp> and
				<samp class="ph codeph">score</samp> attributes have arrays with 24 values. The values in
				<samp class="ph codeph">freqs</samp> are the total number of Reddits posts that occured in 1 hour time
			blocks, and the values in <samp class="ph codeph">scores</samp> are the aggregate scores for posts that
			occured in 1 hour time blocks over a day. The final item in the reduce is
				<samp class="ph codeph">total</samp>, which is the total number of Reddit posts that occurred in an
			entire day. We use the array values in <samp class="ph codeph">freqs</samp> from our custom reduce to
			generate our frequency graph. Each frequency can be plotted to the corresponding hour in a
			day and color-coded:</p>

		
				<img class="image" src="images/reddit.png">
					
		<p class="p">To create a graph from the JSON result set, we use open source data visualization code
			available from <a class="xref" href="http://d3js.org" target="_blank">Data-Driven
				Documents</a>. The graph is created using HTML and JQuery.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/find-data.html">Finding data with views</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/views-from-apps.html">Using views from an application</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/reduce-rereduce.html">Understanding custom reduces and rereduce</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>