<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Providing observe functions — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/sasl.html"><span>Providing SASL authentication</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/topology.html"><span>Getting cluster topology</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/observe-functions.html" class="current"><span>Providing observe functions</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/replica-read-functions.html"><span>Replica read</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/protocol-extensions.html"><span>Couchbase protocol extensions</span></a></li></ul></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content"><h1 class="title topictitle1" id="ariaid-title1">Providing observe functions</h1>
<div class="body conbody"><p class="p">As of Couchbase Server 2.0, the underlying binary protocol provides the ability
to observe items. This means an application can determine whether a document has
been persisted to disk, or exists on a replica node. This provides developers
assurance that a document will survive node failure. In addition, since the new
views functionality of Couchbase Server will only index a document and include
it in a view once the document is persisted, an observe function provides
assurance that a document will or will not be in a view.</p>
<p class="p">Before you provide an observe-function, you need to understand how to retrieve cluster topology
			for your SDK. In other words, your SDK needs to be able to determine if a key is on a
			master and/or replica nodes. The observe-function that you provide in your SDK will need to
			be sent from your SDK to an individual node where the key exists; therefore being able to
			retrieve cluster topology is critical to implement an observe. Your SDK must also be able
			to be ‘cluster-aware’. This means that your SDK should be able to get updated cluster
			topology after node failure, rebalance, or node addition. For more information about
			getting cluster topology from an SDK, see <a class="xref" href="topology.html#concept12200">Getting cluster topology</a>.</p>
<p class="p">To provide an observe function in your SDK, you send the following binary
request from an SDK:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">Byte/     0       |       1       |       2       |       3       |
     /              |               |               |               |
    |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
    +---------------+---------------+---------------+---------------+
   0| 0x80          | 0x92          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
   4| 0x00          | 0x00          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
   8| 0x00          | 0x00          | 0x00          | 0x14          |
    +---------------+---------------+---------------+---------------+
  12| 0xde          | 0xad          | 0xbe          | 0xef          |
    +---------------+---------------+---------------+---------------+
  16| 0x00          | 0x00          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
  20| 0x00          | 0x00          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
  24| 0x00          | 0x04          | 0x00          | 0x05          |
    +---------------+---------------+---------------+---------------+
  28| 0x68 ('h')    | 0x65 ('e')    | 0x6c ('l')    | 0x6c ('l')    |
    +---------------+---------------+---------------+---------------+
  32| 0x6f ('o')    | 0x00          | 0x05          | 0x00          |
    +---------------+---------------+---------------+---------------+
  36| 0x05          | 0x77 ('w')    | 0x6f ('o')    | 0x72 ('r')    |
    +---------------+---------------+---------------+---------------+
  40| 0x6c ('l')    | 0x64 ('d')    |
    +---------------+---------------+
observe command
Field        (offset) (value)
Magic        (0)    : 0x80
Opcode       (1)    : 0x92
Key length   (2,3)  : 0x0000
Extra length (4)    : 0x00
Data type    (5)    : 0x00
Vbucket      (6,7)  : 0x0000
Total body   (8-11) : 0x00000014
Opaque       (12-15): 0xdeadbeef
CAS          (16-23): 0x0000000000000000
Key #0
    vbucket  (24-25): 0x0004
    keylen   (26-27): 0x0005
             (28-32): "hello"
Key #1
    vbucket  (33-34): 0x0005
    keylen   (35-36): 0x0005
             (37-41): "world"
</samp></code></pre>
<p class="p">In this type of binary request, all the information that follows the <samp class="ph codeph">CAS</samp> value
is considered payload. All information up to and including the <samp class="ph codeph">CAS</samp> value is
considered header data. The format of this request is similar to any other
Couchbase Server read/write request, but there are differences in the header and
payload. Here we specify the key that we want to observe as payload, beginning
with <samp class="ph codeph">Key #0</samp>. In this example, we provide two keys that we want to observe,
<samp class="ph codeph">hello</samp> and <samp class="ph codeph">world</samp>. The <samp class="ph codeph">Opcode : 0x92</samp> indicates to Couchbase Server that this
is an observe request.</p>
<p class="p">Your SDK should build a binary request packet once for all the keys that will be
observed. After your SDK sends the request to all master and replica nodes
containing the key, a node will send back one response with all keys that exist
on that node.</p>
<p class="p">When you make a binary request, you are providing the functional equivalent of
the following Couchbase Server <samp class="ph codeph">STAT</samp> requests which are used in the telnet
protocol:</p>
<ul class="ul">
<li class="li"><p class="p"><samp class="ph codeph">STAT key_is_dirty</samp> : If Couchbase Server responds with a value of 0, this means
 a key is persisted; if <samp class="ph codeph">key_is_dirty</samp> has the value 1, the key is not yet
 persisted.</p>
</li>

<li class="li"><p class="p"><samp class="ph codeph">STAT key_cas</samp> : Couchbase Server provides the current CAS value for a key as a
 response. This type of information is helpful to use in your SDK to determine if
 a key has been updated before you perform an observe.</p>
</li>

</ul>
<p class="p">You will determine how often your SDK will poll Couchbase Server as part of an
observe request. Keep in mind that you should take into account your expected
server workload. You will also need to determine a standard timeout for the
observe function you provide; as an option you can provide the developer the
ability to set a timeout as a parameter. The following statistics are useful in
determining how often you should poll:</p>
<ul class="ul">
<li class="li"><p class="p"><samp class="ph codeph">Persist Stat</samp> : check this server statistic within your SDK to determine how
 many milliseconds it takes for a key to be persisted.</p>
</li>

<li class="li"><p class="p"><samp class="ph codeph">Repl Stat</samp> : check this server statistic to determine how many milliseconds it
 takes for a key to be placed on a replica node.</p>
</li>

</ul>
<p class="p">When Couchbase Server responds to an observe request, it will be in the
following binary format:</p>
<pre class="pre codeblock"><code><samp class="ph codeph">Byte/     0       |       1       |       2       |       3       |
     /              |               |               |               |
    |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
    +---------------+---------------+---------------+---------------+
   0| 0x81          | 0x92          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
   4| 0x00          | 0x00          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
   8| 0x00          | 0x00          | 0x00          | 0x26          |
    +---------------+---------------+---------------+---------------+
  12| 0xde          | 0xad          | 0xbe          | 0xef          |
    +---------------+---------------+---------------+---------------+
  16| 0x00          | 0x00          | 0x03          | 0xe8          |
    +---------------+---------------+---------------+---------------+
  20| 0x00          | 0x00          | 0x00          | 0x64          |
    +---------------+---------------+---------------+---------------+
  24| 0x00          | 0x04          | 0x00          | 0x05          |
    +---------------+---------------+---------------+---------------+
  28| 0x68 ('h')    | 0x65 ('e')    | 0x6c ('l')    | 0x6c ('l')    |
    +---------------+---------------+---------------+---------------+
  32| 0x6f ('o')    | 0x01          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
  36| 0x00          | 0x00          | 0x00          | 0x00          |
    +---------------+---------------+---------------+---------------+
  40| 0x00          | 0x0a          | 0x00          | 0x05          |
    +---------------+---------------+---------------+---------------+
  44| 0x00          | 0x05          | 0x77 ('w')    | 0x6f ('o')    |
    +---------------+---------------+---------------+---------------+
  48| 0x72 ('r')    | 0x6c ('l')    | 0x64 ('d')    | 0x00          |
    +---------------+---------------+---------------+---------------+
  52| 0xde          | 0xad          | 0xbe          | 0xef          |
    +---------------+---------------+---------------+---------------+
  56| 0xde          | 0xad          | 0xca          | 0xfe          |
    +---------------+---------------+---------------+---------------+
observe response
Field        (offset) (value)
Magic        (0)    : 0x81
Opcode       (1)    : 0x92
Key length   (2,3)  : 0x0000
Extra length (4)    : 0x00
Data type    (5)    : 0x00
Status       (6,7)  : 0x0000
Total body   (8-11) : 0x00000026
Opaque       (12-15): 0xdeadbeef
Persist Stat (16-19): 0x000003e8 (msec time)
Repl Stat    (20-23): 0x00000064 (msec time)
Key #0
    vbucket  (24-25): 0x0004
    keylen   (26-27): 0x0005
             (28-32): "hello"
    keystate (33)   : 0x01 (persisted)
    cas      (34-41): 000000000000000a
Key #1
    vbucket  (42-43): 0x0005
    keylen   (44-45): 0x0005
             (46-50): "world"
    keystate (51)   : 0x00 (not persisted)
    cas      (52-59): deadbeefdeadcafe
</samp></code></pre>
<p class="p">In the Couchbase Server response, <samp class="ph codeph">keystate</samp> will indicate whether a key is
persisted or not. The following are possible values for <samp class="ph codeph">keystate</samp> :</p>
<ul class="ul">
<li class="li"><p class="p"><samp class="ph codeph">0x00</samp> : Found, not persisted. Indicates key is in RAM, but not persisted to
 disk.</p>
</li>

<li class="li"><p class="p"><samp class="ph codeph">0x01</samp> : Found, persisted. Indicates key is found in RAM, and is persisted to
 disk</p>
</li>

<li class="li"><p class="p"><samp class="ph codeph">0x80</samp> : Not found. Indicates the key is persisted, but not found in RAM. In
 this case, a key is not available in any view/index. Couchbase Server will
 return this <samp class="ph codeph">keystate</samp> for any item that is not stored in the server. It
 indicates you will not expect to have the item in a view/index.</p>
</li>

<li class="li"><p class="p"><samp class="ph codeph">0x81</samp> : Logically deleted. Indicates an item is in RAM, but is not yet deleted
 from disk.</p>
</li>

</ul>
<p class="p">It is important that you understand the difference between ‘not found’ and
‘logically deleted.’ The context in which your SDK receives this message is
important. If an SDK performs a write for a key and the key is not found, then
the responses ‘not found’ and ‘logically deleted’ indicate the same state of a
key. After an SDK performs a document write, the first thing the SDK needs to
determine is whether or not the item has been stored on the right node; in this
scenario, the ‘not found’ and ‘logically deleted’ response both mean that the
item is not yet stored on the appropriate node.</p>
<p class="p">If the SDK performs a delete on a key, then the observe responses ‘not found’
and ‘logically deleted’ have two different meanings about a key. If Couchbase
Server returns ‘not found’ for a delete operation, this means that the delete
has been persisted on that node. If you receive a ‘logically deleted’ response
then it means that the item has been removed from Couchbase Server RAM but the
item is not yet deleted from disk.</p>
<p class="p">As a final note, should you choose to provide an observe-function as an asynchronous method, you
			need to provide an ‘observe-set’ as part of your SDK. An observe-set is a table that stores
			all the ongoing observe requests sent from the SDK. When Couchbase Server fulfills an
			observe request by providing all required status updates for a key, your SDK should remove
			an observe request from the observe-set. In the SDK you should naturally also provide a
			function that retrieves any asynchronous observe results that are received from Couchbase
			Server and stored in SDK run time memory.</p>
</div>
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/client-library.html">Developing a client library</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/topology.html">Getting cluster topology</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/replica-read-functions.html">Replica read</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>