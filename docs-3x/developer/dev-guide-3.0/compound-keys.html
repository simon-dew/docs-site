<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Using compound keys and group-by functions — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/views.html"><span>Understanding views</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/filter-extract.html"><span>Filtering and extracting data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/build-index.html"><span>Building an index</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/efficient-lookups.html"><span>Providing efficient lookups</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/order-results.html"><span>Ordering results</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/handle-results.html"><span>Handling result sets</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/built-in-reduce.html"><span>Using built-in reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/compound-keys.html" class="current"><span>Using compound keys and group-by functions</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/views-from-apps.html"><span>Using views from an application</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/custom-reduces.html"><span>Creating custom reduces</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/reduce-rereduce.html"><span>Understanding custom reduces and rereduce</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/view-errors.html"><span>Error handling for views</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Using compound keys and group-by functions</h1>

	<div class="body conbody">
		<p class="p">When Couchbase Server generates an index, it can create <em class="ph i">compound keys</em> ; a compound
			key is an array that contains multiple values. Couchbase Server will sort items in an index
			based on the sequence of keys provided in a compound key. Couchbase Server will sort items
			in an index based on the key in position 0, and then for all items with matching keys for
			position 0, sort based on the key in position 1 and so forth. This enables you to control
			how an index is sorted, and ultimately how you can retrieve information that is grouped the
			way you need it. For example here is an index created by Couchbase Server using compound
			keys:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
["a","b","c"]        1
["a","b","e"]        1
["a","c","m"]        1
["b","a","c"]        1
["b","a","g"]        1
</samp></code></pre>

		<p class="p">Each of the keys above is a compound key consisting of three different array elements. The
			keys at the beginning of the index all have ‘a’ in position 0 of the array; within the
			first group of items starting with ‘a’, the items with ‘b’ in position 1 are placed before
			those with ‘c’ in position 1. By providing multiple keys we have a first key for sorting,
			and within the first keys that match, a secondary key for sorting within that group, and so
			forth.</p>

		<p class="p">To retrieve results from this index, we can use a <em class="ph i">group-by</em> function to extract the
			items which meet our criterion. The criterion we use to select an item for a group-by
			function is called a <em class="ph i">prefix</em>. When you run a group-by query you run a reduce query on
			each range that exists at the <em class="ph i">level</em> you want. Couchbase Server will return results
			grouped by the unique prefix at that level. For instance, if you specify level 1 a unique
			prefix is <samp class="ph codeph">["a"]</samp> ; if you specify level 2, a unique prefix is
				<samp class="ph codeph">["a","b"]</samp>. Here is an example using the Ruby SDK:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">doc.myview(:group_level =&gt; 1)
</samp></code></pre>

		<p class="p">We query <samp class="ph codeph">myview</samp> and provide the parameter <samp class="ph codeph">:group_level</samp>
			set to 1 to indicate the first position in a compound key. The result set returned by
			Couchbase Server will appear as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
["a"]                3
["b"]                2
</samp></code></pre>

		<p class="p">In this case we perform the built-in reduce function of <samp class="ph codeph">_count</samp> which will
			count the unique instances of keys at level 1, which corresponds to position 0 of the
			compound key. Since we have three instances of <samp class="ph codeph">["a"]</samp> we have the first row
			in the result set have 3 as the value, and since there are two instances of a
				<samp class="ph codeph">["b"]</samp> as a prefix, we have 2 for the second result. The next example
			demonstrates the result set we receive if we query a view with a group level of 2. Our
			query would be as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">doc.myview(:group_level =&gt; 2)
</samp></code></pre>

		<p class="p">In this case we query the view with the group-by level set to 2, and the unique prefix will
			consist of items in position 0 and 1 of the array. We receive this result set:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">KeyValue
["a", "b"]            2
["a", "c"]            1
["b", "a"]            2
</samp></code></pre>

		<p class="p">Since there are two instances of the unique prefix <samp class="ph codeph">["a","b"]</samp>, we have the
			value of 2 for the first result. The second result is the next unique item based on the
			unique prefix <samp class="ph codeph">["a","c"]</samp>. In this case the item only occurs one time in our
			index, therefore we have the value of 1. The last item is the unique prefix
				<samp class="ph codeph">["b","a"]</samp> which occurs 2 times in the index, therefore we have a value
			of 2 for that result. To learn more about group-by parameters used in view queries, see the
			individual Language Reference for your SDK at <a class="xref" href="http://www.couchbase.com/develop" target="_blank">Develop with Couchbase</a>.</p>

	</div>

	
<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/find-data.html">Finding data with views</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/built-in-reduce.html">Using built-in reduces</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/views-from-apps.html">Using views from an application</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>