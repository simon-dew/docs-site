<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Using reference documents for lookups — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/admin-intro.html"><span>Administration</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/first-app.html"><span>Creating your first application</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../developer/dev-guide-3.0/modeling-docs.html"><span>Modeling documents</span></a><ul class="sub-sections"><li class="section"><a href="../../developer/dev-guide-3.0/compare-docs-vs-relational.html"><span>Comparing document-oriented and relational data</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/using-json-docs.html"><span>Using JSON documents</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/schemaless.html"><span>Schemaless data modeling</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/doc-design-considerations.html"><span>Document design considerations</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/model-docs-retrieval.html"><span>Modeling documents for retrieval</span></a></li><li class="section"><a href="../../developer/dev-guide-3.0/lookups.html" class="current"><span>Using reference documents for lookups</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../developer/dev-guide-3.0/sample-docs.html"><span>Sample storage documents</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/access-data.html"><span>Accessing data with Couchbase SDKs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/store-data.html"><span>Storing data</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/find-data.html"><span>Finding data with views</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/advanced-topics.html"><span>Advanced topics in development</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/client-library.html"><span>Developing a client library</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Using reference documents for lookups</h1>

	<div class="body conbody">
		<p class="p">There are two approaches for finding information based on specific values. One approach is
			to perform index and querying with views in Couchbase. The other approach is to use
			supporting documents that contain the key for the main document. The latter approach may be
			preferable even with the ability to query and index in Couchbase because the document-based
			lookup can still provide better performance if you use the lookup frequently. In this
			scenario, you could separate documents to represent a main application object, and create
			additional documents to represent alternate values associated with the main the
			document.</p>

		<p class="p">When you store an object, you use these supporting documents which enable you to later
			lookup the object with different keys. For instance, if you store a user as a document, you
			can create additional helper documents so that you can find the user by email, Facebook ID,
			TwitterID, user name, and other identifiers beside the original document key.</p>

		<p class="p">To use this approach, you should store your original document and use a predictable pattern
			as the key for that type of object. In this case we specifically create a unique identifier
			for each user so that we avoid any duplicate keys. Following the example of performing a
			user profile lookup, imagine we store all users in documents structured as follows:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
"uid"
"type"
"name"
"email"
"fbid"
}
</samp></code></pre>

		<p class="p">To keep track of how many users are in our system, we create a counter,
				<samp class="ph codeph">user::count</samp> and increment it each time we add a new user. The key for
			each user document will be in the standard form of <samp class="ph codeph">user::uuid</samp>. The records
			that we will have in our system would be structured as follows:</p>

		<img class="image" src="images/user_lookup1.png">
		<p class="p">In this case we start with an initial user count of <samp class="ph codeph">100</samp>. In the Ruby
			example that follows we increment the counter and then set a new user record with a new
			unique user id:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph"># =&gt; setup default connection
c = Couchbase.new

# =&gt; initialize counter to 100
c.set("user::count", 100)

# =&gt; increment counter
c.incr("user::count")

# =&gt; get unique uuid, new_id = 12f1
new_id = UUID.timestamp_create().to_s

user_name = "John Smith"
user_username = "johnsmith"
user_email = "jsm@do.com"
user_fb = "12393"

# save User to Couchbase
user_doc = c.add("user::#{new_id}", {
    :uid =&gt; new_id,
    :type =&gt; "user",
    :name =&gt; user_name,
    :email =&gt; user_email,
    :fbid =&gt; user_fb
    })
</samp></code></pre>

		<p class="p">Here we create a default connection to the server in a new Couchbase client instance. We then
			create a new record <samp class="ph codeph">user::count</samp> with the initial value of 100. We will
			increment this counter each time we add a new user. We then generated a unique user ID with
			a standard Ruby UUID gem. The next part of our code creates local variables which represent
			our user properties, such as <samp class="ph codeph">John Smith</samp> a the user name. In the past part
			of this code we take the user data and perform an <samp class="ph codeph">add</samp> to store it to
			Couchbase. Now our document set is as follows:</p>

		
				<img class="image" src="images/user_lookup2.png">
					
		<p class="p">Then we store additional supporting documents which will enable us to find the user with
			other keys. For each different type of lookup we create a separate record. For instance to
			enable lookup by email, we create a email record with the fixed prefix
				<samp class="ph codeph">email::</samp> for a key:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph"># using same variables from above for the user's data

# add reference document for username
c.add("username::#{user_username.downcase}", new_id)    # =&gt; save lookup document, with document key = "username::johnsmith" =&gt; 101

# add reference document for email
c.add("email::#{user_email.downcase}", new_id)        # =&gt; save lookup document, with document key = "email::jsmith@domain.com" =&gt; 101

# add reference document for Facebook ID
c.add("fb::#{user_fb}", new_id)                # =&gt; save lookup document, with document key = "fb::12393" =&gt; 101
</samp></code></pre>

		<p class="p">The additional ‘lookup’ documents enable us to store alternate keys for the user and relate
			those keys to the unique key for the user record <samp class="ph codeph">user::101.</samp> The first
			document we set is for a lookup by username, so we do an <samp class="ph codeph">add</samp> using the key
				<samp class="ph codeph">username::</samp>. After we create all of our lookup records, the documents in
			our system that relate to our user appear as follows:</p>

		
				<img class="image" src="images/user_lookup3.png">
					
		<p class="p">Once these supporting documents are stored, we can attempt a lookup using input from a
			form. This can be any type of web form content, such as an entry in a login, an item from a
			customer service call, or from an email support system. First we retrieve the web form
			parameter:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">#retrieve input from a web form
user_username = params["username"]

# retrieve by user_id value using username provided in web form
user_id = c.get("username::#{user_username.downcase}")    # =&gt; get the user_id   # =&gt; 12f1
user_hash = c.get("user::#{user_id}")            # =&gt; get the primary User document (key = user::12f1)

puts user_hash
# =&gt; { "uid" =&gt; 101, "type" =&gt; "user", "name" =&gt; "John Smith", "email" =&gt; "jsmith@domain.com", "fbid" =&gt; "12393" }

#get additional web form parameter, email
user_email = params["email"]

# retrieve by email
user_id = c.get("email::#{user_email.downcase}")    # =&gt; get the user_id  # =&gt; 12f1
user_hash = c.get("user::#{user_id}")            # =&gt; get the primary User document (key = user::12f1)

#get facebook ID
user_fb = auth.uid

# retrieve by Facebook ID
user_id = c.get("fb::#{user_fb}")            # =&gt; get the user_id  # =&gt; 12f1
user_hash = c.get("user::#{user_id}")            # =&gt; get the primary User document (key = user::12f1)
</samp></code></pre>

		<p class="p">The first part of our code stores the <samp class="ph codeph">username</samp> from a web form to variable
			we can later use. We pass the lowercase version of the form input to a <samp class="ph codeph">get</samp>
			to find the unique user id 12f1. With that unique user id, we perform a
				<samp class="ph codeph">get</samp> with the key consisting of <samp class="ph codeph">user::12f1</samp> to get the
			entire user record. So the supporting documents enable you to store a reference to a
			primary document under a different key. By using a standard key pattern, such as prefix of
				<samp class="ph codeph">email::</samp> you can get to the primary user document with an email. By
			using this pattern you can lookup an object based on many different properties. The
			following illustrates the sequence of operations you can perform, and the documents used
			when you do an email-based lookup:</p>

		
				<img class="image" src="images/user_lookup4.png">
					
		<p class="p">The other use case for this pattern is to create categories for objects. For instance, if
			you have a beer, keyed with the id <samp class="ph codeph">beer::#{sku}</samp>, you can create a product
			category and reference products belonging to that category with they key
				<samp class="ph codeph">category::ales::count</samp>. For this category key, you would provide a
			unique count and the category name, such as ales. Then you would add products to the
			content that references the SKU for your beers. For instance, the key-value pair might look
			like this:</p>

		<pre class="pre codeblock"><code><samp class="ph codeph">{
  "product" : "#{sku}"
}
</samp></code></pre>

		<p class="p">When you perform a lookup, you could also do a <samp class="ph codeph">multi-get</samp> on all items that are
			keyed <samp class="ph codeph">category::ales</samp>. This way you can retrieve all primary records for
			ales. For more information about multi-get, see <a class="xref" href="retrieve-info.html#concept16930__retrieve-multiple-keys">Retrieving multiple keys</a>.</p>

	</div>

<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/modeling-docs.html">Modeling documents</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/model-docs-retrieval.html">Modeling documents for retrieval</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../developer/dev-guide-3.0/sample-docs.html">Sample storage documents</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>