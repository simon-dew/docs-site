<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Database Change Protocol — Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/admin-intro.html"><span>Administration</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../admin/Misc/admin-basics.html"><span>Administration basics</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/Concepts/concept-intro.html"><span>Architecture and concepts</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../admin/Concepts/concept-clusterMgr.html"><span>Cluster Manager</span></a></li><li class="section"><a href="../../admin/Concepts/concept-dataStorage.html"><span>Data storage</span></a></li><li class="section"><a href="../../admin/Concepts/concept-ramQuota.html"><span>RAM quotas</span></a></li><li class="section"><a href="../../admin/Concepts/concept-vBucket.html"><span>vBuckets</span></a></li><li class="section"><a href="../../admin/Concepts/concept-cacheLayer.html"><span>Caching layer</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Concepts/concept-diskStorage.html"><span>Disk storage</span></a></li><li class="section"><a href="../../admin/Concepts/global-thread-pool.html"><span>Shared thread pool</span></a></li><li class="section"><a href="../../admin/Concepts/bucket-priority.html"><span>Disk I/O priority</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Concepts/bucket-eviction.html"><span>Tunable memory</span></a></li><li class="section"><a href="../../admin/Concepts/concept-docExpiration.html"><span>Expiration</span></a></li><li class="section"><a href="../../admin/Concepts/concept-serverWarmup.html"><span>Server warmup</span></a></li><li class="section"><a href="../../admin/Concepts/concept-replication.html"><span>Replicas and replication</span></a></li><li class="section"><a href="../../admin/Concepts/concepts-TAP.html"><span>TAP</span></a></li><li class="section"><a href="../../admin/Concepts/dcp.html" class="current"><span>Database Change Protocol</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../admin/Concepts/concept-client-interface.html"><span>Client interface</span></a></li><li class="section"><a href="../../admin/Concepts/concepts-statsMonitor.html"><span>Statistics and monitoring</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../admin/security/security-intro.html"><span>Security in Couchbase </span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Concepts/bp-deployment-considerations.html"><span>Deployment considerations</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/cluster-management.html"><span>Cluster management</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Monitoring/monitor-intro.html"><span>Monitoring</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/XDCR/xdcr-intro.html"><span>Cross Datacenter Replication (XDCR)</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/UI/ui-intro.html"><span>Web console</span></a></li><li class="section"><a href="../../admin/Misc/faq.html"><span>FAQs</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Misc/Trbl-intro.html"><span>Troubleshooting</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
	<h1 class="title topictitle1" id="ariaid-title1">Database Change Protocol</h1>

	

	<div class="body"><p class="shortdesc">Database Change Protocol (DCP) is the protocol used to stream data changes to
		buckets.</p>

		<p class="p">The Database Change Protocol (DCP) is a streaming protocol that significantly reduces
			latency for view updates. With DCP, changes made to documents in memory are immediately
			streamed to be indexed without being written to disk. This provides faster view consistency
			which provides fresher data. DCP reduces latency for cross data center replication (XDCR).
			Data is replicated memory-to-memory from the source cluster to the destination cluster
			before being written to disk on the source cluster.</p>


		<p class="p">To work with DCP, you need to be familiar with the following concepts, which are listed in
			alphabetical order for convenience.</p>


		<dl class="dl">
			
				<dt class="dt dlterm">Application client</dt>

				<dd class="dd">A normal client that transmits read, write, update, delete, and query requests to
					the server cluster, usually for an interactive web application. </dd>

			

			
				<dt class="dt dlterm">DCP client</dt>

				<dd class="dd">A special client that streams data from one or more Couchbase server nodes, for
					purposes of intra-cluster replication (to be a backup in case the master server
					fails), indexing (to answer queries in aggregate about the data in the whole
					cluster), XDCR (to replicate data from one cluster to another cluster, usually
					located in a separate data center), incremental backup, and any 3rd party component
					that wants to index, monitor, or analyze Couchbase data in near real time, or in
					batch mode on a schedule. </dd>

			

			
				<dt class="dt dlterm">Failover log</dt>

				<dd class="dd">A list of previously known vBucket versions for a vBucket. If a client connects to a
					server and was previously connected to a different version of a vBucket than that
					server is currently working with, the failure log is used to find a rollback
					point.</dd>

			

			
				<dt class="dt dlterm">History branch</dt>

				<dd class="dd">Whenever a node becomes the master node for a vBucket in the event of a failover or
					uncontrolled shutdown and restart, if it was not the farthest ahead of all processes
					watching events on that partition and starts taking mutations, it might reuse
					sequence numbers that other processes have already seen on this partition. This can
					be a history branch, and the new master must assign the vBucket a new vBucket version
					so that DCP clients in the distributed system can recognize that they are ahead of
					the new master and roll back changes at the point this happened in the stream. During
					a controlled handover from an old master to a new master, the sequence history cannot
					have branches, so there is no need to assign a new version to the vBucket being
					handed off. Controlled handovers occur in the case of a rebalance for elasticity
					(such as adding or removing a node) or a swap rebalance in the case of an upgrade
					(such as adding a new version of Couchbase Server to a cluster or removing an old
					version of Couchbase Server).</dd>

			

			
				<dt class="dt dlterm">Mutation</dt>

				<dd class="dd">A mutation is an event that deletes a key or changes the value a key points to.
					Mutations occur when transactions such as create, update, delete or expire are
					executed.</dd>

			

			
				<dt class="dt dlterm">Rollback point</dt>

				<dd class="dd">The server uses the failover log to find the first possible history branch between
					the last time a client was receiving mutations for a vBucket and now. The sequence
					number of that history branch is the rollback point that is sent to the client.</dd>

			

			
				<dt class="dt dlterm">Sequence number</dt>

				<dd class="dd">Each mutation that occurs on a vBucket is assigned a number, which strictly
					increases as events are assigned numbers (there is no harm in skipping numbers, but
					they must increase), that can be used to order that event against other mutations
					within the same vBucket. This does not give a cluster-wide ordering of events, but it
					does enable processes watching events on a vBucket to resume where they left off
					after a disconnect. </dd>

			

			
				<dt class="dt dlterm">Server</dt>

				<dd class="dd">A master or replica node that serves as the network storage component of a cluster.
					For a given partition, only one node can be master in the cluster. If that node fails
					or becomes unresponsive, the cluster selects a replica node to become the new
					master.</dd>

			

			
				<dt class="dt dlterm">Snapshot</dt>

				<dd class="dd">To send a client a consistent picture of the data it has, the server takes a
					snapshot of the state of its disk write queue or the state of its storage, depending
					on where it needs to read from to satisfy the client’s current requests. This
					snapshot represents the exact state of the mutations it contains at the time it was
					taken. Using this snapshot, the server can send the items that existed at the point
					in time the snapshot was taken, and only those items, in the state they were in when
					the snapshot was taken. Snapshots do not imply that everything is locked or copied
					into a new structure. In the current Couchbase storage subsystem, snapshots are
					essentially “free." The only cost is when a file is copy compacted to remove garbage
					and wasted space, the old file cannot be freed until all snapshot holders have
					released the old file. It’s also possible to “kick” a snapshot holder if the system
					determines the holder of the snapshot is taking too long. DCP clients that are kicked
					can reconnect and a new snapshot will be obtained, allowing it to restart from where
					it left off. </dd>

			

			
				<dt class="dt dlterm">vBucket</dt>

				<dd class="dd">Couchbase splits the key space into a fixed amount of vBuckets, usually 1024. Keys
					are deterministically assigned to a vBucket, and vBuckets are assigned to nodes to
					balance the load across the cluster. </dd>

			

			
				<dt class="dt dlterm">vBucket stream</dt>

				<dd class="dd">A grouping of messages related to receiving mutations for a specific vBucket. This
					includes mutation, deletion, and expiration messages and snapshot marker messages.
					The transport layer provides a way to separate and multiplex multiple streams of
					information for different vBuckets. All messages between snapshot marker messages are
					considered to be one snapshot. A snapshot contains only the recent update for any
					given key within the snapshot window. It might require several complete snapshots to
					get the current version of the document. </dd>

			

			
				<dt class="dt dlterm">vBucket version</dt>

				<dd class="dd">A universally unique identifier (UUID) and sequence number pair associated with a
					vBucket. A new version is assigned to a vBucket by the new master node any time there
					might have been a history branch. The UUID is a randomly generated number, and the
					sequence number is the sequence number that vBucket last processed at the time the
					version was created. </dd>

			

		</dl>




	</div>


<nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../admin/Concepts/concept-intro.html" title="Couchbase Server concepts include the different components and systems that make up an individual Couchbase Server instance and a Couchbase cluster including information and concepts needed to understand the fast and elastic nature, high availability, and high performance of the Couchbase Server database.">Architecture and concepts</a></div>
<div class="previouslink"><strong>Previous topic:</strong> <a class="link" href="../../admin/Concepts/concepts-TAP.html" title="The TAP protocol is an internal part of the Couchbase Server system that is used to exchange data throughout the system.">TAP</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../admin/Concepts/concept-client-interface.html">Client interface</a></div>
</div>
</nav></div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">© 2011–2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>