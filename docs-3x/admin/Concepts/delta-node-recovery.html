<!DOCTYPE html><html xmlns:related-links="http://dita-ot.sourceforge.net/ns/200709/related-links" class="no-js developer-portal" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Delta node recovery â€” Couchbase Server 3.0/3.1</title><meta name="apple-mobile-web-app-title" content="Couchbase"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png"><link rel="stylesheet" href="../../assets/stylesheets/application.css"><link rel="stylesheet" href="../../assets/stylesheets/docs.css"></head><body data-modules="developer-portal-sidebar-navigation developer-portal-versions-navigation">
	<!-- Google Tag Manager -->
				<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2"
					height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
				<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
					new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
					j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
					'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
					})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
				<!-- End Google Tag Manager -->
				<header class="developer-portal-header" role="banner"><div class="layout-wrapper"><div class="developer-portal-header__hgroup"><h1 class="developer-portal-header__logo"><a href="http://couchbase.com" rel="home">Couchbase</a></h1><p class="developer-portal-header__page-title">Couchbase Server 3.0/3.1</p></div><nav class="developer-portal-header__navigation" id="primary-navigation" role="navigation"><div class="developer-portal-header__navigation__wrapper" id="primary-navigation__wrapper"><ul class="developer-portal-header__navigation__items"><li class="developer-portal-header__navigation__item"><a href="/index.html">Documentation Home</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/nosql-databases/downloads">Downloads</a></li><li class="developer-portal-header__navigation__item"><a href="http://www.couchbase.com/open-source">Open Source Projects</a></li><li class="developer-portal-header__navigation__item"><a href="http://forums.couchbase.com">Forums</a></li></ul><div class="developer-portal-header__search"><script>
					  (function() {
					    var cx = '018016427239405524608:fkg1v30apnm';
					    var gcse = document.createElement('script');
					    gcse.type = 'text/javascript';
					    gcse.async = true;
					    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					        '//www.google.com/cse/cse.js?cx=' + cx;
					    var s = document.getElementsByTagName('script')[0];
					    s.parentNode.insertBefore(gcse, s);
					  })();
					</script><gcse:search></gcse:search></div></div></nav></div></header><main class="developer-portal-global-content" role="main"><aside class="developer-portal-sidebar"><nav class="developer-portal-sidebar__navigation"><div class="developer-portal-sidebar__navigation__wrapper" id="developer-portal-sidebar-navigation"><ul><li class="section section--has-sub-sections"><a href="../../admin/Couchbase-intro.html"><span>Introduction</span></a></li><li class="section"><a href="../../admin/Whats-new-3.0.html"><span>What's new in 3.0</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/install-intro.html"><span>Installation and upgrade</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/admin-intro.html"><span>Administration</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../admin/Misc/admin-basics.html"><span>Administration basics</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Concepts/concept-intro.html"><span>Architecture and concepts</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/security/security-intro.html"><span>Security in Couchbase </span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Concepts/bp-deployment-considerations.html"><span>Deployment considerations</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/Tasks/cluster-management.html"><span>Cluster management</span></a><ul class="sub-sections"><li class="section"><a href="../../admin/Tasks/tasks-manage-serverWarmup.html"><span>Handling server warmup</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/tasks-manage-replication.html"><span>Handling replication</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/tasks-compaction.html"><span>Compacting data files</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/cluster-maintenance.html"><span>Cluster maintenance</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/Tasks/maintenance-server-node.html"><span>Server maintenance</span></a><ul class="sub-sections"><li class="section section--has-sub-sections"><a href="../../admin/Concepts/concept-nodeFailover.html"><span>Failing over nodes</span></a></li><li class="section section--has-sub-sections&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;section--active"><a href="../../admin/Tasks/recovery-failover-nodes.html"><span>Recovering failed over nodes</span></a><ul class="sub-sections"><li class="section"><a href="../../admin/Concepts/delta-node-recovery.html" class="current"><span>Delta node recovery</span></a><ul class="sub-sections"></ul></li><li class="section"><a href="../../admin/Tasks/recovery-full-recovery.html"><span>Full recovery</span></a></li></ul></li><li class="section"><a href="../../admin/Tasks/rebalance-and-failover-nodes.html"><span>Rebalancing after failover</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/tasks-backup-restore.html"><span>Backup and restore</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Tasks/tasks-manage-xdcr.html"><span>Managing XDCR</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../admin/Monitoring/monitor-intro.html"><span>Monitoring</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/XDCR/xdcr-intro.html"><span>Cross Datacenter Replication (XDCR)</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/UI/ui-intro.html"><span>Web console</span></a></li><li class="section"><a href="../../admin/Misc/faq.html"><span>FAQs</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/Misc/Trbl-intro.html"><span>Troubleshooting</span></a></li></ul></li><li class="section section--has-sub-sections"><a href="../../admin/Views/views-intro.html"><span>Views and indexes</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/cli-intro.html"><span>CLI reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rest-intro.html"><span>REST API reference</span></a></li><li class="section section--has-sub-sections"><a href="../../admin/rel-notes/rel-notes3.0.html"><span>Release notes</span></a></li><li class="section"><a href="../../admin/pdfs.html"><span>PDFs</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/intro.html"><span>Overview</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/concepts.html"><span>Developing applications</span></a></li><li class="section section--has-sub-sections"><a href="../../developer/dev-guide-3.0/old-versions.html"><span>Older SDK versions</span></a></li></ul></div></nav></aside><div class="developer-portal-content"><div class="developer-portal-content__wrapper textblock__content">
  <h1 class="title topictitle1" id="ariaid-title1">Delta node recovery</h1>

	
  
  <div class="body"><p class="shortdesc">Delta node recovery permits nodes to be re-added to the cluster and incrementally caught
    up with the data changes.</p>

  	
    <p class="p">Delta node recovery permits a failed over node to be recovered by re-using the data on its
      disk and then resynchronizing the data based on the delta change. 
      The failed over node is checked to identify the point when data
      mutations stopped and resynchronized beginning at that point. The server node catches up on
      data mutations for its vBuckets and starts serving data. 
      Because the original data and data buckets are retained, the cluster starts functioning with minimal downtime. 
      This operation improves recovery time and network resource usage. </p>

    
    <p class="p">Server nodes are removed from clusters under many circumstances. 
      The following are circumstances (among many others) where a server node might be re-added to the cluster 
      after being failed over.</p>

    
    <ul class="ul">
      <li class="li">Node goes down for a short period of time</li>

      <li class="li">Routine maintenance is scheduled</li>

      <li class="li">Network connectivity is briefly disrupted</li>

    </ul>

      
    <p class="p">When a node is failed over, data files are preserved. 
      The data files are used either for Couchbase support, data recovery, or delta node recovery.</p>

    
    <p class="p">In the process of failing over a node, performing maintenance, adding the node back into the
      cluster, and rebalancing, data is recovered via either full recovery mode or delta recovery
      mode. With delta recovery mode, Couchbase detects (with the Database Change Protocol)
      which data files are up-to-date and which are out-of-date and then, during rebalance, the
      existing data files on the failed over server node are retained and the out-of-date files are
      updated.</p>

    
    <p class="p">From the web console, the Delta Recovery and Full Recovery options display after the server node is failed over.
      Both recovery methods add the server node back into the cluster during the rebalance operation, however, 
      full recovery removes the node's data prior to the rebalance and delta recovery schedules the node's existing data to be re-used.
    </p>

    
    
    
    <p class="p">Delta recovery requirements:</p>

    <ul class="ul">
      <li class="li">A healthy server node and a healthy state for the cluster.</li>

      <li class="li">The server node is failed over. 
        Delta recovery is not possible for a rebalance-in operation (add server) 
        or rebalance-out operation (remove server).</li>

      <li class="li">Delta recovery must be possible for all buckets. For example, if delta recovery is
        possible for a subset of buckets but not possible for another subset of buckets, then the
        Couchbase cluster does not permit a rebalance operation.</li>

      <li class="li">Because delta recovery relies on the existing data files on the failed over server node's
        disk, the exact same set of buckets must be transferred to the failed over server node.</li>

      </ul>

    
    <p class="p">Delta recovery characteristics:</p>

    <ul class="ul">
      <li class="li">Data files are "warmed up" into memory. Warmed up into memory means that data is loaded
        into memory. As a minimum, depending on whether metadata is retained in or not, all data
        file keys are loaded from disk prior to the rebalance operation.</li>

      <li class="li">Indexes must be rebuilt on the server node that is being re-added.</li>

      <li class="li">Use in deployments where data size is much greater than RAM size,  
        bucket eviction is set to full eviction (metadata is not retained in memory), and 
        indexes are not defined.</li>

    </ul>


    
    <div class="note tip"><span class="tiptitle">Tip:</span> An environment with a large data footprint might use delta node recovery when
      re-adding a failed over server node. </div>

    

 
 
    <section class="section"><h2 class="title sectiontitle">Delta node recovery failure scenarios</h2>
      
      <p class="p">The following are conditions where delta node recovery either defaults to full recovery or
        is not available:</p>

      <ul class="ul">
        <li class="li">If topology changes occur while a node is pending delta recovery, delta node
          recovery is impacted. For example,  another node is added, a node is removed, or a node is
          swapped. </li>

        <li class="li">If a down node is hard failed over and is marked for removal.</li>

        <li class="li">If rebalance-in-out operations are performed 
          where the number of in and out nodes do not match (swap rebalance works in this case).</li>

        <li class="li">If certain bucket operations are performed while a node is pending delta recovery,
          delta node recovery is impacted. For example, a new bucket is added, a bucket's replica
          configuration is changed, or a bucket is flushed.</li>

      </ul>

      

        <p class="p">The following describes scenarios where delta node recovery either defaults to full
        recovery or is not available. </p>

      
      <p class="p">Node 1 is in delta recovery and Node 2, an active server node, crashes.</p>

      <ol class="ol">
            <li class="li">Node 1 is failed over and delta recovery is specified. Now, Node 1 is pending delta
              recovery.</li>

            <li class="li">Node 2, an active server, goes down. <div class="note note"><span class="notetitle">Note:</span> The rebalance operation is not
                available.</div>
</li>

            <li class="li">Fail over Node 2. </li>

            <li class="li">Cancel the pending delta recovery, specify full recovery, and rebalance.</li>

            <li class="li">Repair Node 2, add the server to the cluster, and rebalance.</li>

          </ol>

       
        <p class="p">Node 1 is in delta recovery and Node 1 crashes during rebalance.</p>
 
      
      <ol class="ol">
            <li class="li">Node 1 is failed over, delta recovery is specified, and the rebalance operation is
              started.</li>

            <li class="li">Node 1 crashes and the rebalance operation fails.</li>

            <li class="li">Repair Node 1, re-start the server node, and rebalance. Node1 is added back to the
              cluster using full recovery.</li>

          </ol>

        
        <p class="p">Node 1 is in delta recovery and a bucket operation is performed. </p>

      <p class="p">The bucket operations that cause rebalance to fail are adding bucket, changing replica
        configuration, or flushing bucket</p>

      <ol class="ol">
            <li class="li">Node 1 is failed over, delta recovery is specified, and then a bucket operation is
              performed.</li>

            <li class="li">Rebalance is performed and fails. <p class="p"><img class="image" src="../images/ui-delta-rebalance-not-available.png" width="360"></p>
</li>

            <li class="li">Cancel the pending delta recovery, specify full recovery, and rebalance.</li>

          </ol>

          <div class="note note"><span class="notetitle">Note:</span> Bucket deletion does not lead to delta recovery failure.</div>

        
        
        <p class="p">Node 1 and Node 2 are in delta node recovery and Node 2 crashes. </p>

          <ol class="ol">
            <li class="li">Both Node 1 and Node 2 are failed over, delta recovery is specified.</li>

            <li class="li">Node 2 crashes.</li>

            <li class="li">Rebalance is performed and fails. <p class="p"><img class="image" src="../images/ui-rebalance-failed.png" width="480"></p>
</li>

          </ol>

      
     
    </section>

    
    
    
  </div>

  
  <nav class="related-links"><h2>Related information</h2>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../../admin/Tasks/recovery-failover-nodes.html" title="The options for recovering failed over nodes are delta node recovery and full recovery.">Recovering failed over nodes</a></div>
<div class="nextlink"><strong>Next topic:</strong> <a class="link" href="../../admin/Tasks/recovery-full-recovery.html" title="With full recovery mode, the data files are removed from the failed over server node and then, during rebalance, the node is populated with new data files (active and replica vBuckets).">Full recovery</a></div>
</div>

<div class="linklist linklist">
<div><a class="link" href="graceful-failover.html" title="Graceful failover provides the time to administrators to safely fail over a node from the cluster after all in-flight operations are completed and without data loss.">Graceful failover</a></div>
<div><a class="link" href="../CLI/CBcli/cbcli-servers.html" title="Managing server nodes in a cluster involve a variety of couchbase-cli tool commands.">Server nodes</a></div>
<div><a class="link" href="../REST/rest-server-nodes.html" title="The Server Nodes REST API manages nodes in a cluster.">Server nodes API</a></div></div>
</nav>
</div><footer class="developer-portal-footer" role="contentinfo"><p class="legal"><span class="license">Â© 2011â€“2015 <b class="company-name">Couchbase</b>. All rights reserved.</span><a href="http://support.couchbase.com/">Customer Login</a><a href="http://www.couchbase.com/terms-of-service">Terms of Service</a><a href="http://www.couchbase.com/privacy-policy">Privacy Policy</a></p></footer></div></main><script src="../../assets/javascripts/vendor/prism.js"></script><script type="text/javascript">var BASEPATH='../../';</script><script src="../../assets/javascripts/init.js"></script><script type="text/javascript" src="https://issues.couchbase.com/s/en_US-pvmaib-418945332/845/131/1.2.9/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=86389172"></script></body></html>