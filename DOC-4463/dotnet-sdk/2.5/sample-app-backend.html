<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>.NET Sample App Backend Tutorial | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4463/dotnet-sdk/2.7/sample-app-backend.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="dotnet-sdk">
    <meta name="dcterms.identifier" content="2.5">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4463">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="start-using-sdk.html"><span class="title">.NET SDK</span> <span class="version">2.5</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.7/sample-app-backend.html">.NET SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/sample-app-backend.html">.NET SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.4/sample-app-backend.html">.NET SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">.NET SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.2/dotnet-intro.html">.NET SDK 2.2</a></li>
                  <li><a class="navbar-item" href="../2.1/dotnet-intro.html">.NET SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/sample-app-backend.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/sample-app-backend.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/sample-app-backend.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/sample-app-backend.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/sample-app-backend.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/sample-app-backend.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Hello World!</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="start-using-sdk.html">Start Using the SDK</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sample-application.html">Sample Application</a>
    </span>
<ul class="nav-list">
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sample-app-backend.html">Sample App Backend</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="webui-cli-access.html">Browser and CLI Access</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Users and Security</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-authentication-overview.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-user-management-overview.html">User Management</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-user-management-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with Data</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="core-operations.html">Core Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="document-operations.html">Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="subdocument-operations.html">Sub-Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="datastructures.html">Data Structures</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-query.html">Querying with N1QL</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="n1ql-queries-with-sdk.html">N1QL from the SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="scan-consistency-examples.html">Using Scan Consistency</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-search-overview.html">Full Text Search</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-searching-with-sdk.html">Searching from the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="view-queries-with-sdk.html">MapReduce Views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="async-programming.html">Asynchronous Programming</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="batching-operations.html">Batching Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="concurrent-mutations-cluster.html">Concurrent Document Mutations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sdk-xattr-overview.html">Extended Attributes</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sdk-xattr-example.html">Sample Code</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="nonjson.html">Non-JSON Documents</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment Environments</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing Connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-clusters.html">Managing Clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Settings, Error Handling &amp; Diagnostics</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="client-settings.html">Client Settings</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-error-conditions.html">Handling Errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="failure-considerations.html">Failure Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="collecting-information-and-logging.html">Collecting Information</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Project Docs</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="relnotes-dotnet-sdk.html#version-2-5-12-12-june-2018">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-licenses.html">Licenses</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="get-involved.html">Get involved</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/home/contribute/index.html">Improve the Docs</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.7/sample-app-backend.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="start-using-sdk.html">.NET SDK</a></li>
    <li class="crumb">Hello World!</li>
    <li class="crumb"><a href="sample-application.html">Sample Application</a></li>
    <li class="crumb"><a href="sample-app-backend.html">Sample App Backend</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-dotnet/edit/release/2.5/modules/ROOT/pages/sample-app-backend.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">.NET Sample App Backend Tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The .NET SDK tutorial bridges the gap between simple and advanced concepts by walking through a complete web application.
</blockquote>
</div>
<div class="paragraph">
<p>The full source code for the tutorial is available <a href="https://github.com/couchbaselabs/try-cb-dotnet/" target="_blank" rel="noopener">on GitHub couchbaselabs/try-cb-dotnet</a>.
The primary focus of the tutorial is to explain the function and theory behind the Couchbase .NET client and how it works together with Couchbase Server, and especially new features in versions 4.0/4.5 like <code>N1QL</code>, <code>FTS</code> and <code>sub-document</code>.
It makes use of the <code>travel-sample</code> data set.
The code that generates the web application is provided with the source code, but is not discussed in this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="specific-net-prerequisites-and-set-up"><a class="anchor" href="#specific-net-prerequisites-and-set-up"></a>Specific .NET prerequisites and set up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the prerequisites mentioned in <a href="sample-application.html" class="page">Sample Application</a>, you&#8217;ll need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visual Studio 2015 (Community is fine)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To get set up for the tutorial proper, follow these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>git clone https://github.com/couchbaselabs/try-cb-dotnet.git</code> or <a href="https://github.com/couchbaselabs/try-cb-dotnet/releases/tag/v2.0.0" target="_blank" rel="noopener">download the source</a></p>
</li>
<li>
<p>if you don&#8217;t want to connect to <code>localhost</code>, change the couchbaseServer entry in <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Web.config" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Web.config</code></a></p>
</li>
<li>
<p>open the project in Visual Studio and build the project, nuget references will be restored automatically</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to code it yourself, the real work is done in the following classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/AirportController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/AirportController.cs</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/FlightPathsController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/FlightPathsController.cs</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/HotelController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/HotelController.cs</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/UserController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/UserController.cs</code></a></p>
</li>
<li>
<p><a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/App_Start/CouchbaseConfig.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/App_Start/CouchbaseConfig.cs</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s currently no "fill-in-the-blanks" branch so you&#8217;ll have to delete method bodies and try to take it from there.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This tutorial focuses on querying through N1QL and FTS rather than mapreduce views.
If you want information about using views, see <a href="../../server/6.0/learn/views/views-intro.html" class="page">Views</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="walking-through-the-api"><a class="anchor" href="#walking-through-the-api"></a>Walking Through the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections lead you through the primary functions of the sample application.
All of the REST API application code is in several files according to function.
The following shows you how to program with the various features and services of Couchbase including: <strong>connecting</strong> to a cluster and bucket, <strong>key/value</strong> iteraction, document <strong>query through N1QL</strong> and <strong>full text searches</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-and-bootstrap-the-sdk"><a class="anchor" href="#configure-and-bootstrap-the-sdk"></a>Configure and Bootstrap the SDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where:</strong> <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/App_Start/CouchbaseConfig.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/App_Start/CouchbaseConfig.cs</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals:</strong> Connecting to the <code>Cluster</code> and getting familiar with <code>ClusterHelper</code>.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics:</strong> <a href="managing-connections.html" class="page">Managing Connections</a></p>
</div>
<div class="paragraph">
<p>The first step in the Couchbase SDK is to configure your connection to the cluster.
This can be done either programattically or through configuration files.
For simplicity, in this sample app we&#8217;re going to do it programmatically.</p>
</div>
<div class="paragraph">
<p>In the sample app, the <code>CouchbaseConfig.Register()</code> method is responsible for reading the hostnames and/or IP addresses for the cluster and initializing the connection.
First it reads the <code>CouchbaseServer</code> setting from the <code>web.config</code> and then creates a <code>ClientConfiguration</code>, setting the Servers with the hostname from the app setting.
The <code>ClientConfiguration</code> is then passed into the <code>ClusterHelper</code> utility which uses the configuration to setup everything required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var couchbaseServer = ConfigurationManager.AppSettings.Get("CouchbaseServer");
ClusterHelper.Initialize(new ClientConfiguration
{
    Servers = new List { new Uri(couchbaseServer) }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ClusterHelper</code> is a utility built into the .NET SDK to help with managing the cluster connection and can be used to get references to a <code>bucket</code> (which is your entry point for the whole storage API).
The <code>cluster</code> connection should be reused as much as possible, typically called a singleton, because it is expensive to create.
The <code>ClusterHelper</code> stores the connection to the cluster for easy reuse within your applications.</p>
</div>
<div class="paragraph">
<p>To get a references to a bucket, with which you can then execute operations such as Get, Insert and Remove, you can use the <code>GetBucket</code> method on <code>ClusterHelper</code>.
This returns an <code>IBucket</code> which exposes the majority of the operations available in Couchbase.</p>
</div>
<div class="paragraph">
<p>An example of getting a reference to a <code>bucket</code> and retrieving a document is below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var bucket = ClusterHelper.GetBucket("default");
var user = bucket.Get&lt;User&gt;("user::" + 123); // retrieves the document 'user::123' and deserializes it into the application User class</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="key-value-users"><a class="anchor" href="#key-value-users"></a>Key/Value: Users</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/UserController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/UserController.cs</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use <code class="code">Bucket</code>'s Key/Value operations and discover the <code>Document</code> API.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="document-operations.html" class="page">CRUD Document Operations Using the .NET SDK with Couchbase Server</a>, <a href="async-programming.html" class="page">Asynchronous Programming Using the .NET SDK with Couchbase Server</a></p>
</div>
<div class="paragraph">
<p>Couchbase Server is a document-oriented database which provides access to your data both through its document ID (for high performance access), as well as through map/reduce views and N1QL (SQL like query language).</p>
</div>
<div class="paragraph">
<p>This is noticeable in the API, where the methods reflect Key/Value operations (<code>get</code>, <code>create</code>, etc...) and work with a <code>Document&lt;T&gt;</code> interface that has an <code>Id</code> and a <code>Content</code>.</p>
</div>
<div class="paragraph">
<p>Typically, in this type of scenario you would implement the Repository pattern to separte functional logic from business logic.
However, to make this sample as easy to get up to speed with controllers are used instead.</p>
</div>
<div class="paragraph">
<p><strong>Creating New Users</strong></p>
</div>
<div class="paragraph">
<p>For the purposes of this sample application users are required to register before they can book flights.
All the user related operations are going to exist in the <code>UserController</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SignUp</code> method is where new users are registered.
The method takes a <code>LoginModel</code> (<code>src/Models/LoginModel.cs</code>) as the only method parameter.
ASP.NET has an automatic model binder where it can map a POST request&#8217;s properties to a custom class, like the <code>LoginModel</code>.
The property types and names have to match for it to assign the value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public async Task&lt;IHttpActionResult&gt; SignUp(LoginModel model)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The model is validated to ensure that the username and password fields are non-empty and then checked to see if the username already exists.
For the purposes of this sample app, the user document keys are in the format <code>user::&lt;username&gt;</code>.
The <code>ExistsAsync</code> method is used to do a non-blocking check to see if the document already exists in the bucket.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var userKey = CreateUserKey(model.Username);
if (await _bucket.ExistsAsync(userKey))
{
    return Content(HttpStatusCode.Conflict, new Error($"Username '{model.Username}' already exists"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next a document with the user details is created and stored in Couchbase Server.
The <code>userKey</code> created earlier is used and alsoa document expiry time is included if one was set on the model.
As you do not want to store plain text passwords, the passwords are MD5-hashed before storing it in the user document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var userDoc = new Document&lt;User&gt;
{
    Id = userKey,
    Content = new User
    {
        Username = model.Username,
        Password = CalcuateMd5Hash(model.Password)
    },
    Expiry = model.Expiry
};

var result = await _bucket.InsertAsync(userDoc);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The non-blocking <code>InsertAsync</code> method is used to ensure that a thread waiting for the response from Couchbase Server is not blocked.
Once the code receives the response, it continues where it left off.</p>
</div>
<div class="paragraph">
<p>The last thing to do is to create a security token for the browser, so that the front end knows that additional requests are for a valid user.
For this a JWT (JSON Web Token) is used, which includes the username in a list of claims and is then encrypted with a secret key.
The secret is stored in the <code>Web.Config</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var data = new
{
    token = BuildToken(model.Username)
};
var context = $"Created user with ID '{userKey}' in bucket '{_bucket.Name}' that expires in {userDoc.Expiry}ms";
return Content(HttpStatusCode.Accepted, new Result(data, context));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response content has two parts, the first is the JWT and the second part is a narration string which is something the frontend app understands and will display in a console.
The narration enables the users of the application to get an idea of what is going on on the server side while browsing the app.
It is similar to a log, but sent to the frontend.</p>
</div>
<div class="paragraph">
<p><strong>Loging in Signed up Users</strong></p>
</div>
<div class="paragraph">
<p>The <code>Login</code> method enables users who have already signed up to sign in and use the application.
The <code>Login</code> method signature looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public async Task&lt;IHttpActionResult&gt; Login(LoginModel model)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>LoginModel</code> includes <code>Username</code> and <code>Password</code> properties that can be used to find the user document and verify the passwords.</p>
</div>
<div class="paragraph">
<p>First the user document must be retrieved and the password checked to ensure that it matches with the model.
The user document key needs to be built using the model&#8217;s username property, the document is then retrieved from Couchbase Server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var userKey = CreateUserKey(model.Username);
var userDocument = await _bucket.GetDocumentAsync&lt;User&gt;(userKey);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the application has a user document, it can check the passwords match.
Remember the password was hashed in the document for added security so the model&#8217;s password will also have to be hashed before they are compared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var user = userDocument.Content;
if (user.Password != CalcuateMd5Hash(model.Password))
{
    return Content(HttpStatusCode.Unauthorized, new Error("Invalid username and/or password"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All that is left to do is create the security token like was done for the <code>SignUp</code> method and return it.
A narration to go in the response content is also created for the frontend app to report on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var data = new
{
    token = BuildToken(user.Username)
};
var context = $"User {model.Username} logged in successfully";
return Content(HttpStatusCode.OK, new Result(data, context));</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Getting a User&#8217;s Stored Flights</strong></p>
</div>
<div class="paragraph">
<p>A way to retrieve the flights that a user has booked is required for the application.
The <code>GetFlightsForUser</code> method does this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public async Task&lt;IHttpActionResult&gt; GetFlightsForUser(string username)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is going to be the first time that the application checks for a valid security token; it has only generated these so far.
The security token is fairly simple and only includes the username of the user, but that is enough for this sample application.
To verify the token the <code>authentication</code> header needs to be fetched and then decrypted.
If this fails for any reason, the application returns either a 401 (Unauthorized) or a 403 (Forbidden) response.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var authHeaderValue = GetAuthHeaderValue(Request.Headers);
if (string.IsNullOrEmpty(authHeaderValue))
{
    return Content(HttpStatusCode.Unauthorized, string.Empty);
}
if (!VerifyToken(authHeaderValue, username))
{
    return Content(HttpStatusCode.Forbidden, string.Empty);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The username is passed in as one of the method parameters, so it can be used to create the user document key and get the document from Couchbase Server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var userKey = CreateUserKey(username);
var userDocument = await _bucket.GetDocumentAsync&lt;User&gt;(userKey);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final thing to do is return the list of flights for the user with some narration for the frontend application to record.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var data = userDocument.Content.Flights;
var context = $"Retrieved flights for user {username}.";
return Content(HttpStatusCode.OK, new Result(data, context));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="n1ql-flight-paths"><a class="anchor" href="#n1ql-flight-paths"></a>N1QL: Flight Paths</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/FlightsController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/FlightsController.cs</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use N1QL to perform <code>SELECT</code> on Couchbase.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="n1ql-queries-with-sdk.html" class="page">N1QL Queries Using the .NET SDK with Couchbase Server</a>.</p>
</div>
<div class="paragraph">
<p>In the SDK, there is a <code>query</code> method that accepts all variants of querying with Couchbase (views, spatial/geo views, N1QL and FTS).
For N1QL, the <code>IQueryRequest</code> is expected.
This allows to wrap a N1QL <code>Statement</code>, use positional parameters and provide query tuning (eg Timeout).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
N1QL is a super-set of SQL, so if you&#8217;re familiar with SQL you&#8217;ll feel at ease.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This controller has one method, <code>GetFlights</code>, which provides flight routes between two airports.
It uses a N1QL query to get them.
The method has three parameters; <code>from</code>, <code>to</code> and <code>leave</code> (string for departure date).
The first thing the application does is validate the parameters, returning a 500 (InternalServerError) if it&#8217;s not.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">if (string.IsNullOrEmpty(from) || string.IsNullOrEmpty(to))
{
    return Content(HttpStatusCode.InternalServerError, new Error("Missing or invalid from and/or to airports"));
}

DateTime leaveDate;
if (!DateTime.TryParse(leave, out leaveDate))
{
    return Content(HttpStatusCode.InternalServerError, new Error("Missing or invalid leave date"));
}

var dayOfWeek = (int) leaveDate.DayOfWeek + 1; // Get weekday number; Sun (0) to Sat (7)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next the <code>from</code> and <code>to</code> parameters are used to get the airport FAA code along with its geo-location latitude and longitude.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var airportQuery = new QueryRequest()
    .Statement("SELECT faa AS fromAirport, geo.lat, geo.lon " +
        "FROM `travel-sample` " +
        "WHERE airportname = $1 " +
        "UNION " +
        "SELECT faa AS toAirport, geo.lat, geo.lon " +
        "FROM `travel-sample` " +
        "WHERE airportname = $2;")
    .AddPositionalParameter(from, to);
var airportQueryResult = await _bucket.QueryAsync&lt;dynamic&gt;(airportQuery);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After doing some checks to ensure there are results from both airport codes, the application then does some Geo-location calculations to find the distance between the two airports and the estimated travel time.
The distance and travel time are then used when calculating ticket prices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var fromCoordinate = new GeoCoordinate((double) fromAirport.lat, (double) fromAirport.lon);
var toCoordinate = new GeoCoordinate((double) toAirport.lat, (double) toAirport.lon);
var distance = fromCoordinate.GetDistanceTo(toCoordinate);
var flightTime = Math.Round(distance/AverageFlightSpeed, 2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, all flights between the the two airports have to be retrieved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var flightQuery = new QueryRequest()
    .Statement("SELECT a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment " +
        "FROM `travel-sample` AS r " +
        "UNNEST r.schedule AS s " +
        "JOIN `travel-sample` AS a ON KEYS r.airlineid " +
        "WHERE r.sourceairport = $1 " +
        "AND r.destinationairport = $2 " +
        "AND s.day = $3 " +
        "ORDER BY a.name ASC;")
    .AddPositionalParameter((string) fromAirport.fromAirport, (string) toAirport.toAirport, dayOfWeek);
queries.Add(flightQuery.GetOriginalStatement());</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Yes, you read that right, N1QL can do joins (on a single bucket or on several).
It works as long as the "foreign key" described by <code>ON KEYS</code> clause can be mapped to a document&#8217;s key in the joined bucket.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A specificity of N1QL that is seen in the second statement is <code>UNNEST</code>.
It extracts a sub-JSON and puts it at the same root level as the bucket (so its possible to do joins on each element in this sub-JSON as if they were entries in a left-hand side bucket).</p>
</div>
<div class="paragraph">
<p>The application now has all flights between the <code>from</code> and <code>to</code> airports but there are not any prices any prices.
These are then calculated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var flights = flightQueryResult.Rows;
foreach (var flight in flights)
{
    flight.FlightTime = flightTime;
    flight.Price = _random.Next(2000);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="linq-airports"><a class="anchor" href="#linq-airports"></a>LINQ: Airports</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/AirportController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/AirportController.cs</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use the LINQ provider to build N1QL queries to retrieve Airport details.</p>
</div>
<div class="paragraph">
<p>LINQ is a standardised way of constructing queries over a data storage engine, such as in-memory collections, SQL and even NoSQL like Couchbase.
It&#8217;s a very simple yet powerful tool that enables developers to write complicated queries programatically.</p>
</div>
<div class="paragraph">
<p>In this Controller the application is trying to find the aiport name, given some additional information about the airport.
It uses the LINQ provider to build the queries.</p>
</div>
<div class="paragraph">
<p>The first query looks for an airport using its FAA code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">airports = _context.Query&lt;Airport&gt;()
    .Where(x =&gt; x.Faa == search.ToUpper())
    .Select(x =&gt; x.Airportname);
"SELECT airportname FROM `travel-sample` WHERE type = 'airport' AND faa = '{search.ToUpper()}'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second query looks for an airport using its ICAO code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">airports = _context.Query&lt;Airport&gt;()
    .Where(x =&gt; x.Icao == search.ToUpper())
    .Select(x =&gt; x.Airportname);
"SELECT airportname FROM `travel-sample` WHERE type = 'airport' AND icao = '{search.ToUpper()}'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The third query looks for an airport using its name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">airports = _context.Query&lt;Airport&gt;()
    .Where(x =&gt; x.Airportname.Contains(search))
    .Select(x =&gt; x.Airportname);
"SELECT airportname FROM `travel-sample` WHERE type = 'airport' AND airportname LIKE '%{search}%'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once one of the above queries has been executed, the result then needs to be returned to the frontend application along with a narration of the query that was executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var data = airports.Select(airportname =&gt; new {airportname});
return Content(HttpStatusCode.OK, new Result(data, query));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing-the-data-n1ql-gsi"><a class="anchor" href="#indexing-the-data-n1ql-gsi"></a>Indexing the Data: N1QL &amp; GSI</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/App_Start/CouchbaseConfig.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/App_Start/CouchbaseConfig.cs</code></a></p>
</div>
<div class="paragraph">
<p>Index management is a bit more advanced (and is already done when loading the sample), so now that you&#8217;ve learned about N1QL, you can have a look.
For N1QL to work, you must first ensure that at least a <code>Primary Index</code> has been created.
For that you can use the DSL from the <code>BucketManager</code> class:</p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use the Index DSL to make sure data is indexed ready for N1QL to query it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">bucketManager.CreateN1qlPrimaryIndex(false); // create primary index, and don't defer building it</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fluent API will guide you with the available options, you just have to declare that you want to <code>CreateN1qlPrimaryIndex()</code>.</p>
</div>
<div class="paragraph">
<p>You can also create secondary indexes on specific fields of the JSON, for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">bucketManager.CreateN1qlIndex("index_name", false, "name", "address", etc);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, give a name to your index, specify if the index is to be deferred for building then an array of property names to index.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="full-text-search-finding-hotels"><a class="anchor" href="#full-text-search-finding-hotels"></a>Full Text Search: Finding Hotels</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Where</strong>: <a href="https://github.com/couchbaselabs/try-cb-dotnet/blob/master/src/try-cb-dotnet/Controllers/HotelController.cs" target="_blank" rel="noopener"><code>src/try-cb-dotnet/Controllers/HotelController.cs</code></a></p>
</div>
<div class="paragraph">
<p><strong>Goals</strong>: Use FTS to search for matching Hotels.
Use subdoc API to fetch the relevant data for each hit.</p>
</div>
<div class="paragraph">
<p><strong>Relevant Documentation Topics</strong>: <a href="full-text-searching-with-sdk.html" class="page">Full Text Search (FTS) Using the .NET SDK with Couchbase Server</a>, <a href="subdocument-operations.html" class="page">Sub-Document Operations</a>.</p>
</div>
<div class="paragraph">
<p>In this service, hotels are searched for using more fuzzy criterias, like the content of the address or the description of an hotel.
This is done using Full Text Search (FTS).
When some results match the specified criteria, only the relevant data for each result to be displayed in the UI is fetched using the subdocument API.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the <code>FindHotel</code> method.
It accepts two parameters, <code>location</code> and <code>description</code>, which are the two possible refining criterias for an hotel search.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public HttpResponseMessage FindHotel(string description = null, string location = null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ConjunctionQuery</code> allows you to combine multiple FTS queries into one, in a logical AND fashion.
This query includes an exact match criteria that restricts it to the <code>hotel</code> data type (as reflected in the <code>type</code> field of the JSON document).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var query = new ConjunctionQuery(
    new TermQuery("hotel").Field("type")
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the user provided a location keyword, a second component is added to the FTS query that will look for that keyword in several address-related fields of the document.
That is done in an OR fashion, using a <code>Disjunction</code> query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">if (!string.IsNullOrEmpty(location) &amp;&amp; location != "*")
{
    query.And(new DisjunctionQuery(
        new PhraseQuery(location).Field("address"),
        new PhraseQuery(location).Field("city"),
        new PhraseQuery(location).Field("state"),
        new PhraseQuery(location).Field("country")
    ));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, if a description keyword was provided by the user, the freeform text is inspected of the <code>description</code> field and <code>name</code> field of the document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">if (!string.IsNullOrEmpty(description) &amp;&amp; description != "*")
{
    query.And(new DisjunctionQuery(
        new PhraseQuery(description).Field("name"),
        new PhraseQuery(description).Field("description")
    ));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>matchPhrase</code> FTS query can contain several words and will search for variations of the words (eg.
including plural forms or words with the same root).</p>
</div>
<div class="paragraph">
<p>The compound FTS query is now ready to be executed.
A <code>SearchQuery</code> object is built out of it, which also determines which FTS index to use ("hotel") and allows you to set various parameters (like a limit of maximum 100 hits to return).
The query is logged (and kept for narration) then executed, returning an <code>ISearchQueryResult</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var search = new SearchQuery();
search.Index = "hotel";
search.Query = query;
search.Limit(100);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The FTS results are then iterated over, and the document corresponding to each result is fetched.
In actuality, only the parts of the document that will be displayed in the UI are required.
This is where the sub-document API comes in.</p>
</div>
<div class="paragraph">
<p>The sub-document API allows you to fetch or mutate only a set of paths inside a JSON document, without having to send the whole document back and forth.
This can save network bandwidth if the document is large and the parts that we&#8217;re interested in are small.
So here the results of the FTS search are iterated over and appropriate subdoc calls are triggered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var result = _bucket.Query(search);
foreach (var row in result)
{
    var fragment = _bucket.LookupIn&lt;Hotel&gt;(row.Id)
    .Get("name")
        .Get("description")
        .Get("address")
        .Get("city")
        .Get("state")
        .Get("country")
        .Execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each FTS result is represented as an <code>ISearchQueryRow</code> which exposes the document&#8217;s <code>Id</code>.
The sub-document API can then be used to fetch data (<code>bucket.LookupIn&lt;T&gt;(documentId)</code>) and specify what parts are wanted: name, description, address, city, state and country.
The application then <code>Execute()</code> the sub-document query.
In the rest of the code, the address-related fields are aggregated together and the data obtained is returned.</p>
</div>
<div class="paragraph">
<p>Now the results are obtained, the application can build up the <code>Hotel</code> objects and return them along with the FTS query narration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">    hotels.Add(new
    {
        name = fragment.Value.Name,
        description = fragment.Value.Description,
        address = fragment.Value.GetFullAddress()
    });
}

return Request.CreateResponse(new Result(hotels, queryJson));</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
