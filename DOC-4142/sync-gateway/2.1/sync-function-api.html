<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Sync Function API | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4142/sync-gateway/2.1/sync-function-api.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="sync-gateway">
    <meta name="dcterms.identifier" content="2.1">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4142">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/5.5/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/5.5/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/5.5/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/5.5/analytics/introduction.html">Analytics <small>(Developer Preview)</small></a></li>
                  <li><a href="../../server/5.5/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.1/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.1/index.html">Lite</a></li>
                  <li><a href="index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/5.5/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.8/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.6/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.4/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.6/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.5/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.4/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.4/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/5.5/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/3.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/5.5/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/5.5/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="index.html"><span class="title">Sync Gateway</span> <span class="version">2.1</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.0/sync-function-api.html">Sync Gateway 2.0</a></li>
                  <li><a class="navbar-item" href="../1.5/sync-function-api.html">Sync Gateway 1.5</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Introduction</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="index.html">What&#8217;s New</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Access Control</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="authentication.html">Authentication</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="authorizing-users.html">Authorizing Users</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="data-routing.html">Data Routing</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sync-function-api.html">Sync Function API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Operations</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="config-properties.html">Configuration File</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="command-line-options.html">CLI</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="shared-bucket-access.html">Shared Bucket Access</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="server-integration.html">Webhooks and Changes Feed</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="resolving-conflicts.html">Resolving Conflicts</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="integrating-external-stores.html">Integrating External Stores</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="running-replications.html">Running Replications</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api-client.html">REST API Client</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sgcollect-info.html">SGCollect Info</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Security</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="deployment-considerations.html">Deployment Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="configuring-ssl.html">Configuring SSL</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="upgrade.html">Upgrade</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="load-balancer.html">NGINX</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="database-offline.html">Taking Databases Offline and Online</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="os-level-tuning.html">OS Level Tuning</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">API References</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="rest-api.html">Public REST API</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="admin-rest-api.html">Admin REST API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Release Notes &amp; Compatibility</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-matrix.html">Compatibility Matrix</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Sync Gateway</a></li>
    <li class="crumb">Access Control</li>
    <li class="crumb"><a href="sync-function-api.html">Sync Function API</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbaselabs/docs-sync-gateway/edit/master/modules/ROOT/pages/sync-function-api.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Sync Function API</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The sync function is the core API you interact with on Sync Gateway.
This article explains its functionality, and how you write and configure it.</p>
</div>
<div class="paragraph">
<p>For simple applications it might be the only server-side code you need to write.
For more complex applications it is still a primary touchpoint for managing data routing and access control.</p>
</div>
<div class="paragraph">
<p>The sync function is a JavaScript function whose source code is stored in the Sync Gateway&#8217;s database configuration file.
The sync function is called every time a new revision/update is made to a document, and the changes to channels and access made by the sync function are <em>tied to that revision</em>.
If the document is later updated, the sync function will be called again on the new revision, and the new channel assignments and user/channel access <em>replace</em> the ones from the first call.</p>
</div>
<div class="paragraph">
<p>It can do the following things:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Validate the document</dt>
<dd>
<p>If the document has invalid contents, the sync function can throw an exception to reject it.
The document won&#8217;t be added to the database, and the client request will get an error response</p>
</dd>
<dt class="hdlist1">Authorize the change</dt>
<dd>
<p>The sync function can call <code>requireUser()</code> or <code>requireRole()</code> to specify what user(s) are allowed to modify the document.
If the user making the change isn&#8217;t in that list, an exception is thrown and the update is rejected with an error.
Similarly, <code>requireAccess()</code> requires that the user making the change have access to any of the listed channels.</p>
</dd>
<dt class="hdlist1">Assign the document to channels</dt>
<dd>
<p>Based on the contents of the document, the sync function can call <strong>channel()</strong> to add the document to one or more channels.
This makes it accessible to users who have access to those channels, and will cause the document to be pulled by users that are subscribed to those channels.</p>
</dd>
<dt class="hdlist1">Grant users access to channels</dt>
<dd>
<p>Calling <code>access(user, channel)</code> grants a user access to a channel.
This allows documents to act as membership lists or access-control lists.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>The sync function is crucial to the security of your application.</strong>
It&#8217;s in charge of data validation, and of authorizing both read and write access to documents.
The API is high-level and lets you do some powerful things very simply, but you do need to remain vigilant and review the function carefully to make sure that it detects threats and prevents all illegal access.
The sync function should be a focus of any security review of your application.</p>
</div>
<div class="paragraph">
<p>You write your sync function in JavaScript.
The basic structure of the sync function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
    // Your code here
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sync function arguments are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>doc</code></dt>
<dd>
<p>An object, the content of the document that is being saved.
This matches the JSON that was saved by the Couchbase Lite and replicated to Sync Gateway.
The <code>_id</code> property contains the document ID, and the <code>_rev</code> property the new revision ID.
If the document is being deleted, there will be a <code>_deleted</code> property with the value true.</p>
</dd>
<dt class="hdlist1"><code>oldDoc</code></dt>
<dd>
<p>If the document has been saved before, the revision that is being replaced is available in this argument.
Otherwise it&#8217;s <code>null</code>.
(In the case of a document with conflicts, the current provisional winning revision is passed in <code>oldDoc</code>.)
Your implementation of the sync function can omit the <code>oldDoc</code> parameter if you do not need it (JavaScript ignores extra parameters passed to a function).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The default Sync Function is documented in the API reference <a href="config-properties.html#databases-foo_db-sync" class="page">databases.$dbname.sync</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="validation-and-authorization"><a class="anchor" href="#validation-and-authorization"></a>Validation and Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sync function API provides several methods that you can use to validate document creation, updates and deletions.
For error conditions, you can simply call the built-in JavaScript <code>throw()</code> function.
You can also enforce user access privileges by calling <code>requireUser()</code>, <code>requireRole()</code>, or <code>requireAccess()</code>.</p>
</div>
<div class="paragraph">
<p>What happens to rejected documents? Firstly, they aren&#8217;t saved to the Sync Gateway&#8217;s database, so no access changes take effect.
Instead an error code (usually 403 Forbidden) is returned to Couchbase Lite&#8217;s replicator.</p>
</div>
<div class="paragraph">
<p>Any other exception (including implicit ones thrown by the JavaScript runtime, like array bounds exceptions) will also prevent the document update, but will cause the gateway to return an HTTP 500 "Internal Error" status.</p>
</div>
<div class="sect2">
<h3 id="throw"><a class="anchor" href="#throw"></a>throw()</h3>
<div class="paragraph">
<p>At the most basic level, the sync function can prevent a document from persisting or syncing to any other users by calling <code>throw()</code> with an error object containing a <code>forbidden</code>: property.
You enforce the validity of document structure by checking the necessary constraints and throwing an exception if they&#8217;re not met.</p>
</div>
<div class="paragraph">
<p>Here is an example sync function that disallows all writes to the database it is in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function(doc) {
   throw({forbidden: "read only!"})
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The document update will be rejected with an HTTP 403 "Forbidden" error code, with the value of the <code>forbidden:</code> property being the HTTP status message.
This is the preferred way to reject an update.</p>
</div>
<div class="paragraph">
<p>In validating a document, you&#8217;ll often need to compare the new revision to the old one, to check for illegal changes in state.
For example, some properties may be immutable after the document is created, or may be changeable only by certain users, or may only be allowed to change in certain ways.
That&#8217;s why the current document contents are given to the sync function, as the <code>oldDoc</code> parameter.</p>
</div>
<div class="paragraph">
<p>We recommend that you not create invalid documents in the first place.
As much as possible, your app logic and validation function should prevent invalid documents from being created locally.
The server-side sync function validation should be seen as a fail-safe and a guard against malicious access.</p>
</div>
</div>
<div class="sect2">
<h3 id="requireuser-username"><a class="anchor" href="#requireuser-username"></a>requireUser(username)</h3>
<div class="paragraph">
<p>The <code>requireUser()</code> function authorizes a document update by rejecting it unless it&#8217;s made by a specific user or users, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// Throw an error if username is not "snej":
requireUser("snej");

// Throw an error if username is not in the list:
requireUser(["snej", "jchris", "tleyden"]);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function signals rejection by throwing an exception, so the rest of the sync function will not be run.
All properties of the <code>doc</code> parameter should be considered <em>untrusted</em>, since this is after all the object that you&#8217;re validating.
This may sound obvious, but it can be easy to make mistakes, like calling <code>requireUser(doc.owners)</code> instead of <code>requireUser(oldDoc.owners)</code>.
When using one document property to validate another, look up that property in <code>oldDoc</code>, not <code>doc</code>!</p>
</div>
</div>
<div class="sect2">
<h3 id="requirerole-rolename"><a class="anchor" href="#requirerole-rolename"></a>requireRole(rolename)</h3>
<div class="paragraph">
<p>The <code>requireRole()</code> function authorizes a document update by rejecting it unless the user making it has a specific role or roles, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// Throw an error unless the user has the "admin" role:
requireRole("admin");

// Throw an error unless the user has one or more of those roles:
requireRole(["admin", "old-timer"]);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The argument may be a single role name, or an array of role names.
In the latter case, the user making the change must have one or more of the given roles.</p>
</div>
<div class="paragraph">
<p>The function signals rejection by throwing an exception, so the rest of the sync function will not be run.</p>
</div>
</div>
<div class="sect2">
<h3 id="requireaccess-channels"><a class="anchor" href="#requireaccess-channels"></a>requireAccess(channels)</h3>
<div class="paragraph">
<p>The <code>requireAccess()</code> function authorizes a document update by rejecting it unless the user making it has access to at least one of the given channels, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// Throw an exception unless the user has access to read the "events" channel:
requireAccess("events");

// Throw an exception unless the user can read one of the channels in the
// previous revision's "channels" property:
if (oldDoc) {
    requireAccess(oldDoc.channels);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function signals rejection by throwing an exception, so the rest of the sync function will not be run.</p>
</div>
<div class="paragraph">
<p>If a user was granted access to the <a href="data-routing.html#special-channels" class="page">star channel</a> (noted <code>*</code>), a call to <code>requireAccess('any channel name')'</code> will fail because the user wasn&#8217;t granted access to that channel (only to the <code>*</code> channel). To allow a user to perform a document update in this case, you can specify multiple channel names (<code>requireAccess('any channel name', '*')'</code>)</p>
</div>
</div>
<div class="sect2">
<h3 id="requireadmin"><a class="anchor" href="#requireadmin"></a>requireAdmin()</h3>
<div class="paragraph">
<p>The <code>requireAdmin()</code> function authorizes a document update by rejecting it unless it is being sent to the Sync Gateway Admin REST API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// Throw an exception unless the request is sent to the Admin REST API
requireAdmin();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="routing"><a class="anchor" href="#routing"></a>Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sync function API provides several functions that you can use to route documents.
The routing functions assign documents to channels, and enable user access to channels (which will route documents in those channels to those users.)</p>
</div>
<div class="paragraph">
<p>Routing changes have no effect until the document is actually saved in the database, so if the sync function first calls <code>channel()</code> or <code>access()</code>, but then rejects the update, the channel and access changes will not occur.</p>
</div>
<div class="sect2">
<h3 id="channel-name"><a class="anchor" href="#channel-name"></a>channel (name)</h3>
<div class="paragraph">
<p>The <code>channel()</code> function routes the document to the named channel(s). It accepts one or more arguments, each of which must be a channel name string, or an array of strings.
The channel function can be called zero or more times from the sync function, for any document.
Here is an example that routes all "published" documents to the "public" channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
   if (doc.published) {
      channel ("public");
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As a convenience, it is legal to call <code>channel</code> with a <code>null</code> or <code>undefined</code> argument; it simply does nothing.
This allows you to do something like <code>channel(doc.channels)</code> without having to first check whether <code>doc.channels</code> exists.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Channels don&#8217;t have to be predefined.
A channel implicitly comes into existence when a document is routed to it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the document was previously routed to a channel, but the current call to the sync function (for an updated revision) doesn&#8217;t route it to that channel, the document is removed from the channel.
This may cause users to lose access to that document.
If that happens, the next time Couchbase Lite pulls changes from the gateway, it will receive an empty revision of the document with nothing but a <code>"_removed": true</code> property.
(Of course the previous revisions of the document remain in your Couchbase Lite database until it&#8217;s compacted.)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="read-access"><a class="anchor" href="#read-access"></a>Read Access</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="access-username-channelname"><a class="anchor" href="#access-username-channelname"></a>access (username, channelname)</h3>
<div class="paragraph">
<p>The <code>access()</code> function grants access to a channel to a specified user.
It can be called multiple times from a sync function.</p>
</div>
<div class="paragraph">
<p>The first argument can be an array of strings, in which case each user in the array is given access.
The second argument can also be an array of strings, in which case the user(s) are given access to each channel in the array.
As a convenience, either argument may be <code>null</code> or <code>undefined</code>, in which case nothing happens.</p>
</div>
<div class="paragraph">
<p>If a user name begins with the prefix <code>role:</code>, the rest of the name is interpreted as a role rather than a user.
The call then grants access to the specified channels for all users with that role.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The effects of all access calls by all active documents are effectively unioned together, so if <em>any</em> document grants a user access to a channel, that user has access to the channel.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Revoking access to a channel can cause a user to lose access to documents, if s/he no longer has access to any channels those documents are in.
However, the replicator does <em>not</em> currently delete such documents that have already been synced to a user&#8217;s device (although future changes to those documents will not be replicated.)
This is a design limitation of Sync Gateway that may be resolved in the future.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following code snippets shows some valid ways to call <code>access()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">access ("jchris", "mtv");
access ("jchris", ["mtv", "mtv2", "vh1"]);
access (["snej", "jchris", "role:admin"], "vh1");
access (["snej", "jchris"], ["mtv", "mtv2", "vh1"]);
access (null, "hbo");  // no-op
access ("snej", null);  // no-op</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a sync function that grants access to a channel for all the users listed in a document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
    if (doc.type == "chat_room") {
        // Give members access to the chat channel this document manages:
        access (doc.members, doc.channel_name);

        // Put this document in the channel it manages:
        channel (doc.channel_name);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="role-username-rolename"><a class="anchor" href="#role-username-rolename"></a>role (username, rolename)</h3>
<div class="paragraph">
<p>The <code>role()</code> function grants a user a role, indirectly giving them access to all channels granted to that role.
It can also affect the user&#8217;s ability to revise documents, if the access function requires role membership to validate certain types of changes.
Its use is similar to <code>access</code>&#8201;&#8212;&#8201;the value of either parameter can be a string, an array of strings, or null.
If the value is null, the call is a no-op.</p>
</div>
<div class="paragraph">
<p>For consistency with the <code>access</code> call, role names must always be prefixed with <code>role:</code>.
An exception is thrown if a role name doesn&#8217;t match this.
Some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">role ("jchris", "role:admin");
role ("jchris", ["role:portlandians", "role:portlandians-owners"]);
role (["snej", "jchris", "traun"], "role:mobile");
role ("ed", null);  // no-op</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Roles, like users, have to be explicitly created by an administrator.
So unlike channels, which come into existence simply by being named, you can&#8217;t create new roles with a <code>role()</code> call.
Nonexistent roles don&#8217;t cause an error, but have no effect on the user&#8217;s access privileges.
You can create a role after the fact; as soon as a role is created, any pre-existing references to it take effect.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expiry"><a class="anchor" href="#expiry"></a>Expiry</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="expiry-value"><a class="anchor" href="#expiry-value"></a>expiry (value)</h3>
<div class="paragraph">
<p>Calling <code>expiry(value)</code> from within the sync function will set the expiry value (TTL) on the document.
When the expiry value is reached, the document will be purged from the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">expiry("2018-07-06T17:00:00+01:00")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the hood, the expiration time is set and managed on the Couchbase Server document (TTL is not supported for databases in walrus mode). The value can be specified in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ISO-8601 format:</strong> for example the 6th of July 2016 at 17:00 in the BST timezone would be <code>2016-07-06T17:00:00+01:00</code>;</p>
</li>
<li>
<p><strong>as a numeric Couchbase Server expiry value:</strong> Couchbase Server expiries are specified as Unix time, and if the desired TTL is below 30 days then it can also represent an interval in seconds from the current time (for example, a value of 5 will remove the document 5 seconds after it is written to Couchbase Server).
The document expiration time is returned in the response of GET <a href="rest-api.html#/document/get__db___doc_" class="page">/{db}/{doc}</a> when <code>show_exp=true</code> is included in the querystring.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As with the existing explicit purge mechanism, this applies only to the local database; it has nothing to do with replication.
This expiration time is not propagated when the document is replicated.
The purge of the document does not cause it to be deleted on any other database.</p>
</div>
<div class="paragraph">
<p>If <a href="shared-bucket-access.html" class="page">shared bucket access</a> is enabled (introduced in Sync Gateway 1.5), the behavior of the expiry feature changes in the following way: when the expiry value is reached, instead of getting purged, the <strong>active</strong> revision of the document is tombstoned.
If there is another non-tombstoned revision for this document (i.e a conflict) it will become the active revision.
The tombstoned revision will be purged when the server&#8217;s metadata purge interval is reached.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="document-conflicts"><a class="anchor" href="#document-conflicts"></a>Document Conflicts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a document is in conflict there will be multiple current revisions.
The default, "winning" one is the one whose channel assignments and access grants take effect.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-deletions"><a class="anchor" href="#handling-deletions"></a>Handling deletions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Validation checks often need to treat deletions specially, because a deletion is just a revision with a <code>"_deleted": true</code> property and usually nothing else.
Many types of validations won&#8217;t work on a deletion because of the missing properties&#8201;&#8212;&#8201;for example, a check for a required property, or a check that a property value doesn&#8217;t change.
You&#8217;ll need to skip such checks if <code>doc._deleted</code> is true.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example"><a class="anchor" href="#example"></a>Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s an example of a complete, useful sync function that properly validates and authorizes both new and updated documents.
The requirements are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only users with the role <code>editor</code> may create or delete documents.</p>
</li>
<li>
<p>Every document has an immutable <code>creator</code> property containing the name of the user who created it.</p>
</li>
<li>
<p>Only users named in the document&#8217;s (required, non-empty) <code>writers</code> property may make changes to a document, including deleting it.</p>
</li>
<li>
<p>Every document must also have a <code>title</code> and a <code>channels</code> property.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, oldDoc) {
        if (doc._deleted) {
                // Only editors with write access can delete documents:
                requireRole("role:editor");
                requireUser(oldDoc.writers);
                // Skip other validation because a deletion has no other properties:
                return;
        }
        // Required properties:
        if (!doc.title || !doc.creator || !doc.channels || !doc.writers) {
                throw({forbidden: "Missing required properties"});
        } else if (doc.writers.length == 0) {
                throw({forbidden: "No writers"});
        }
        if (oldDoc == null) {
                // Only editors can create documents:
                requireRole("role:editor");
                // The 'creator' property must match the user creating the document:
                requireUser(doc.creator)
        } else {
                // Only users in the existing doc's writers list can change a document:
                requireUser(oldDoc.writers);
                // The "creator" property is immutable:
                if (doc.creator != oldDoc.creator) {
                        throw({forbidden: "Can't change creator"});
                }
        }
        // Finally, assign the document to the channels in the list:
        channel(doc.channels);
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="changing-the-sync-function"><a class="anchor" href="#changing-the-sync-function"></a>Changing the sync function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Sync Function computes document routing to channels and user access to channels at document write time.
If the Sync Function is changed, Sync Gateway needs to reprocess all existing documents in the bucket to recalculate the routing and access assignments.</p>
</div>
<div class="paragraph">
<p>The Admin REST API has a re-sync endpoint to process every document in the database again.
To update the Sync Function, it is recommended to follow the steps outlined below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update the configuration file of the Sync Gateway instance.</p>
</li>
<li>
<p>Restart Sync Gateway.</p>
</li>
<li>
<p>Take the database offline using the <a href="admin-rest-api.html#/database/post__db___offline" class="page">/{db}/_offline</a> endpoint.</p>
</li>
<li>
<p>Call the re-sync endpoint on the Admin REST API. The message body of the response contains the number of changes that were made as a result of calling re-sync.</p>
</li>
<li>
<p>Bring the database back online using the <a href="admin-rest-api.html#/database/post__db___online" class="page">/{db}/_online</a> endpoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is an expensive operation because it requires every document in the database to be processed by the new function.
The database can&#8217;t accept any requests until this process is complete (because no user&#8217;s full access privileges are known until all documents have been scanned). Therefore the Sync Function update will result in application downtime between the call to the <code>/{db}/_offline</code> and <code>/{db}/_online</code> endpoints as mentioned above.</p>
</div>
<div class="sect2">
<h3 id="when-should-you-run-a-re-sync"><a class="anchor" href="#when-should-you-run-a-re-sync"></a>When should you run a re-sync?</h3>
<div class="paragraph">
<p>When running a re-sync operation, the context in the Sync Function is the admin user.
For that reason, calling the <code>requireUser</code>, <code>requireAccess</code> and <code>requireRole</code> methods will always succeed.
It is very likely that you are using those functions in production to govern write operations.
But in a re-sync operation, all the documents are already written to the database.
For that reason, it is recommended to use re-sync for changing the assignment to channels only (i.e.
reads). If the modifications to the Sync Function only impact write security (and not routing/access), you won&#8217;t need to run the re-sync operation.</p>
</div>
<div class="paragraph">
<p>Similarly, if you wish to change the channel/access rules, but only want those rules to apply to documents written after the change was made, then you don&#8217;t need to run the re-sync operation.</p>
</div>
<div class="paragraph">
<p>If you need to ensure access to the database during the update, you can create a read-only backup of the Sync Gateway&#8217;s bucket beforehand, then run a secondary Sync Gateway on the backup bucket, in read-only mode.
After the update is complete, switch to the main Gateway and bucket.</p>
</div>
<div class="paragraph">
<p>In a clustered environment with multiple Sync Gateway instances sharing the load, all the instances need to share the same configuration, so they all need to be taken offline either by stopping the process or taking them offline using the <a href="admin-rest-api.html#/database/post__db___offline" class="page">/{db}/_offline</a> endpoint.
After the configuration is updated, <strong>one</strong> instance should be brought up so it can update the database&#8212;&#8203;if more than one is running at this time, they&#8217;ll conflict with each other.
After the first instance finishes opening the database, the others can be started.</p>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">2440 West El Camino Real
Mountain View, CA 94040
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://training.couchbase.com" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://training.couchbase.com/online" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
