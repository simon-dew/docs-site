<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Durability requirements | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/query-mockup/java-sdk/2.7/durability.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="java-sdk">
    <meta name="dcterms.identifier" content="2.2">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/query-mockup">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="../../operator/1.2/overview.html">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="../../talend-connector/index.html">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="java-intro.html"><span class="title">Java SDK</span> <span class="version">2.2</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.7/durability.html">Java SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/durability.html">Java SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/durability.html">Java SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/durability.html">Java SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/durability.html">Java SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.1/java-intro.html">Java SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/durability.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/durability.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/durability.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../nodejs-sdk/2.6/durability.html">Node.js SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/durability.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/durability.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="java-intro.html">Java SDK 2.2</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API reference</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="migrate.html">Migrating from Java SDK 1.4.x to 2.x</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting started with the Java SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase Example</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="tutorial4.html">Java SDK tutorial</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-cluster.html">Managing clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="env-config.html">Configuring the environment</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="documents.html">Working with documents</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-basics.html">Document basics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-creating.html">Creating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-updating.html">Updating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-retrieving.html">Retrieving documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-deleting.html">Deleting documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-atomic.html">Atomic operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-bulk.html">Bulk operations</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability requirements</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="querying.html">Querying buckets</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="managing-views.html">Managing views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-views.html">Working with views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-n1ql.html">Working with N1QL</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="rxjava.html">RxJava and reactive programming</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="observables.html">Mastering Observables</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="reactive-apps.html">Writing resilient reactive applications</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="event-bus-metrics.html">Production considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.7/durability.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="java-intro.html">Java SDK</a></li>
    <li class="crumb"><a href="java-intro.html">Java SDK 2.2</a></li>
    <li class="crumb"><a href="documents.html">Working with documents</a></li>
    <li class="crumb"><a href="durability.html">Durability requirements</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/2.2/modules/ROOT/pages/durability.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Durability requirements</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Specify durability requirements to regulate Couchbase Server&#8217;s behavior.
</blockquote>
</div>
<div class="paragraph">
<p>If you do not specify any durability requirements, the server will respond with a success message if the data has been acknowledged and processed in the managed cache.
Since persistence and replication are asynchronous tasks and happen eventually, there is a time gap where a node failure can lead to data loss.
This time gap is exactly between the points when data has neither been replicated to another node nor persisted to disk.</p>
</div>
<div class="paragraph">
<p>For most use cases, this time gap is totally acceptable since it is usually very small.
For the important mutation operations, we need stronger guarantees.
If you change the server to acknowledge only once the data has been either replicated or persisted makes the whole system slower by default.
Therefore, Couchbase Server has another way to handle such  situations:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The SDK will perform the normal mutation without durability requirements.</p>
</li>
<li>
<p>If the server returns with a successful response, the client will start polling.</p>
</li>
<li>
<p>The client polls all the affected nodes for this mutation until either the desired state is reached, or it can’t be reached for a reason.</p>
</li>
<li>
<p>In the successful case, the operation will also complete towards the application layer, and in the failure case the client will error out the operation, leaving the user to decide what&#8217;s next.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following code will make sure that the document has been persisted on the active node for this document ID and also replicated to one of the configured replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">JsonDocument docPersistedAndReplicated = bucket.upsert(docToStore, PersistTo.MASTER, ReplicateTo.ONE);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the client will poll two nodes until completion: the active node for this document and also the configured replica.
If any of the constraints cannot be fulfilled, an exception will be raised.</p>
</div>
<div class="paragraph">
<p>If you wonder why in the failure case we put the burden on you to figure out what next: the SDK has no idea of your SLAs or what you intend to do to when the operation fails.
Sometimes it might be fine to proceed and log the error, in other cases you may want sophisticated retry mechanisms where the SDK can guide you with functionality, but not the actual execution semantics.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistto-and-replicateto"><a class="anchor" href="#persistto-and-replicateto"></a>PersistTo and ReplicateTo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The way to specify your intent to define durability requirements is by passing in <code>PersistTo</code> or <code>ReplicateTo</code> enums as parameters on mutation operations.</p>
</div>
<div class="paragraph">
<p>The following states can be set, and all of the combinations between the two are supported.
Note that the <code>NONE</code> states are the defaults and, in this case, the durability requirement won’t be used.
The <code>NONE</code> state is useful nonetheless if you define it based on a system property and need a fallback to the default.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PersistTo:</code> NONE, MASTER, ONE, TWO, THREE, FOUR</p>
</li>
<li>
<p><code>ReplicateTo:</code> NONE, ONE, TWO, THREE</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since you can have a maximum of three replicas, the maximum number of replicas you can check is three as well.
For persisting the maximum number is four, because the active node can be checked in addition to the three replicas.</p>
</div>
<div class="paragraph">
<p>All options (other than NONE and MASTER) will return as soon as the requirement is fulfilled.
So for example if you have two replicas configured on the bucket, and you specify <code>ReplicateTo.ONE</code>, as soon as either one of the two reports success for the document ID the condition is assumed to be fulfilled.</p>
</div>
<div class="paragraph">
<p>If you provide both <code>PersistTo</code> and <code>ReplicateTo</code> both conditions are linked together with a logical "and", meaning that both conditions must be satisfied so that the SDK can report success.</p>
</div>
<div class="paragraph">
<p>Keep in mind that if the durability requirement failed, it could very well be that the original mutation operation succeeded.
See the common failure scenarios for more context.
This is due to the effect that the actual mutation and the subsequent polling are individual operations that can also fail individually.
As an example, if you specify <code>ReplicateTo.ONE</code> and you have no replica configured, the original mutation will complete without issues, but the durability requirement will fail.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-support"><a class="anchor" href="#api-support"></a>API support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following mutation operations provide support for durability requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>insert</p>
</li>
<li>
<p>upsert</p>
</li>
<li>
<p>replace</p>
</li>
<li>
<p>remove</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that inserts a document and waits until it is persisted on the active node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.insert(document, PersistTo.MASTER);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example replaces a document and waits until it is replicated to at least one replica:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">bucket.replace(document, ReplicateTo.ONE);</code></pre>
</div>
</div>
<div class="paragraph">
<p>While not obvious in the first place, the same holds true for removal operations.
If you want to make sure that the deletion of the document survives node failures under any conditions, you can use the same semantics.
The following example makes sure that the removal is persisted on at least two nodes in the cluster (like the master and one replica):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bucket.remove("docid", PersistTo.TWO);</pre>
</div>
</div>
<div class="paragraph">
<p>In this last example also specifying <code>ReplicateTo.ONE</code> would be redundant, since persisting on a replica means it first needs to be replicated to it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="strong-exceptions-and-errors-strong"><a class="anchor" href="#strong-exceptions-and-errors-strong"></a><strong>Exceptions and errors</strong></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The asynchronous API will send error notifications to your subscriber in the failure case.
Since the synchronous API just wraps the asynchronous one, those errors will be converted into actual exceptions.</p>
</div>
<div class="paragraph">
<p>Every exception that happens during the durability requirement polling will be wrapped into a <code>com.couchbase.client.java.error.DurabilityException</code>.
The original exception is carried as part of the <code>DurabilityException</code>, so you can always call <code>Throwable#getCause()</code> on it.</p>
</div>
<div class="paragraph">
<p>After you do that, you will come across the following errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DocumentConcurrentlyModifiedException</code>: If the observed document has been concurrently modified by another caller.</p>
</li>
<li>
<p><code>ReplicaNotConfiguredException</code>: There are not enough replicas configured to fulfill the durability requirement in the first place.</p>
</li>
<li>
<p><code>ReplicaNotAvailableException</code>: There are currently not enough replicas in the cluster to fulfill the durability requirement right now.</p>
</li>
<li>
<p><code>DocumentMutationLostException</code>: The mutation has been lost during a hard failover.
Only applies to enhanced durability.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These errors can happen for a subset of the documents, depending on which node has been failed over, and no replica is available at this point.
Other errors will affect all documents, for example if no replica is configured on the bucket at all.</p>
</div>
<div class="paragraph">
<p>Keep in mind that because the polling for durability happens after the original mutation, every failure on that one will propagate immediately and never trigger the polling in the first place.
This means that if you specify durability requirements, you need to handle those errors in addition to the errors on the original mutation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="failure-modes-and-their-impact"><a class="anchor" href="#failure-modes-and-their-impact"></a>Failure modes and their impact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An advanced feature of the SDK are different failure modes, but in the context of durability requirements they become more important.
By default, the SDK uses the<code>BestEffortRetryStrategy</code>, but you can plug in a different one, such as the <code>FailFastRetryStrategy</code>) or write your mode.
If you want to change it, you can do it in the environment like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CouchbaseEnvironment env = DefaultCouchbaseEnvironment
    .builder()
    .retryStrategy(FailFastRetryStrategy.INSTANCE)
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep in mind that since this is a global setting, all operations will be affected by it.
Now, what does it change in the context of durability requirements?</p>
</div>
<div class="paragraph">
<p>If the SDK detects an issue during the polling activity, it will either continue to retry (best effort) or bail out immediately (fail fast).
If a node goes down and does not come back up quickly enough using the best effort strategy, you’ll hit the specified client side timeout.
With the fail fast strategy, you’ll very quickly get a DurabilityException that contains the root cause, such as a <code>RequestCancelledException</code>.</p>
</div>
<div class="paragraph">
<p>If you use the fail fast retry strategy, you are trading more complex retry code on your side for faster feedback cycles in the failure case.
A common reason to enable fail fast strategy is if you use some more sophisticated libraries on top of the SDK, for example <a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener">Hystrix</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="common-failure-scenarios"><a class="anchor" href="#common-failure-scenarios"></a>Common failure scenarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Durability constraints in general span more than one node and the statistical chance for operation failures is higher.
As a result, it is even more important for production stability to consider what can go wrong and in what ways to react.</p>
</div>
<div class="paragraph">
<p>This section focuses on failures that come up because of invalid cluster setup.</p>
</div>
<div class="paragraph">
<p>Lots of durability failures occur because the bucket doesn’t have enough replicas configured, or the number of nodes is not sufficient enough.
For example, there are two replicas configured, but there are only two nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>If you have one replica configured on the bucket but you issue a mutation with <code>ReplicateTo.TWO</code>, you’ll get the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Exception in thread "main" com.couchbase.client.java.error.DurabilityException:
				Durability requirement failed: Not enough replicas configured on the bucket.
    at com.couchbase.client.java.CouchbaseAsyncBucket$18$1.call(CouchbaseAsyncBucket.java:549)
    at com.couchbase.client.java.CouchbaseAsyncBucket$18$1.call(CouchbaseAsyncBucket.java:545)
    at rx.internal.operators.OperatorOnErrorResumeNextViaFunction$1.onError(OperatorOnErrorResumeNextViaFunction.java:99)
    ...
Caused by: com.couchbase.client.core.ReplicaNotConfiguredException: Not enough replicas configured on the bucket.
    at com.couchbase.client.core.message.observe.ObserveViaCAS$6$2.call(ObserveViaCAS.java:144)
    at com.couchbase.client.core.message.observe.ObserveViaCAS$6$2.call(ObserveViaCAS.java:136)
    at rx.internal.operators.OperatorMap$1.onNext(OperatorMap.java:55)</pre>
</div>
</div>
<div class="paragraph">
<p>When you have a replica configured on the bucket, but not enough nodes in the cluster to replicate the data, the behavior varies on the retry strategy.
By default (best effort), you’ll get a timeout because the client tries as long as possible (since the node can be added to the cluster at runtime):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Exception in thread "main" java.lang.RuntimeException: java.util.concurrent.TimeoutException
    at com.couchbase.client.java.util.Blocking.blockForSingle(Blocking.java:75)
    at com.couchbase.client.java.CouchbaseBucket.upsert(CouchbaseBucket.java:375)
    at com.couchbase.client.java.CouchbaseBucket.upsert(CouchbaseBucket.java:370)
    at test.MainTest.main(MainTest.java:30)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:497)
    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)
Caused by: java.util.concurrent.TimeoutException
    ... 9 more</pre>
</div>
</div>
<div class="paragraph">
<p>If you choose fail fast, the error will be a <code>DurabilityException</code> which contains a <code>ReplicaNotAvailableException</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Exception in thread "main" com.couchbase.client.java.error.DurabilityException:
				Durability requirement failed: Replica number 1 not available for bucket default
    at com.couchbase.client.java.CouchbaseAsyncBucket$18$1.call(CouchbaseAsyncBucket.java:549)
    at com.couchbase.client.java.CouchbaseAsyncBucket$18$1.call(CouchbaseAsyncBucket.java:545)
    at rx.internal.operators.OperatorOnErrorResumeNextViaFunction$1.onError(OperatorOnErrorResumeNextViaFunction.java:99)
    at rx.internal.operators.OperatorMap$1.onError(OperatorMap.java:49)
    at rx.internal.operators.OperatorMap$1.onError(OperatorMap.java:49)
    at rx.internal.operators.OperatorTake$1.onError(OperatorTake.java:62)
    ...
Caused by: com.couchbase.client.core.ReplicaNotAvailableException: Replica number 1 not available for bucket default
    at com.couchbase.client.core.node.locate.KeyValueLocator.errorObservables(KeyValueLocator.java:202)
    at com.couchbase.client.core.node.locate.KeyValueLocator.locateForCouchbaseBucket(KeyValueLocator.java:127)
    at com.couchbase.client.core.node.locate.KeyValueLocator.locate(KeyValueLocator.java:79)
    ...</pre>
</div>
</div>
<div class="paragraph">
<p>Note the subtle difference between a <code>ReplicaNotConfiugredException</code> and a <code>ReplicaNotAvailableException</code>.
This difference allows you to troubleshoot your cluster effectively if it is not set up properly or if it is suffering from a temporary failure condition.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-and-handling-node-failures"><a class="anchor" href="#understanding-and-handling-node-failures"></a>Understanding and handling node failures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to wrong cluster setup, the most common issue with durability requirements is when the cluster topology changes at runtime in a way that makes it not possible to fulfill the requirements anymore.</p>
</div>
<div class="paragraph">
<p>In practice, this is commonly referred to as a "node failure"and can happen because the <code>couchbase-server</code> service is restarted, the node is powered down or it is not reachable across the network.
In all these cases, operations will start to fail.
The failure is caused either because the active partitions do not respond, such as when the normal mutation fails or the replicas do not respond.</p>
</div>
<div class="paragraph">
<p>If you use the best effort strategy, you will run into your operation timeouts.
In the fast fail case, you’ll see the <code>DurabilityExceptions</code> with the different underlying causes.</p>
</div>
<div class="paragraph">
<p>The difference between strategies is that only a subset of the operations will fail.
If you have a 5-node cluster, only 1/5th of the mutations will fail, and the durability requirement will only fail if the down node involved is the only one that can help fulfilling.
If you have two replicas configured, one node is down, and you use <code>ReplicateTo.ONE</code>, the other replica can still help make the requirement succeed.</p>
</div>
<div class="paragraph">
<p>Once you manually trigger the node failover or the auto-failover feature kicks in, the replicas are promoted to active, and the regular mutations on those partitions will start to work again.
Here is the catch: since replicas had been promoted to active a few seconds ago, those replicas are now gone.</p>
</div>
<div class="paragraph">
<p>You will either have more than one replica configured when there is a spare one sitting in the cluster answering the durability requirement requests, or you’ll still get <code>ReplicaNotAvailableExceptions</code>.</p>
</div>
<div class="paragraph">
<p>Once you click on the Rebalance button,  the cluster manager makes sure that enough replicas are again in place and the data is shuffled around.
At some point, the<code>ReplicaNotAvailableExceptions</code> are gone, and everything is good again.</p>
</div>
<div class="paragraph">
<p>What you have to do when you hit such an exception depends very much of the application type.
If you need to make sure the data is stored and you don’t mind waiting for the cluster to settle again, you can retry the operation with an exponential backoff.
If you are running an interactive application, most of the time you need to propagate the error up the stack or fail in a controlled way.</p>
</div>
<div class="paragraph">
<p>While you should plan for node failures, they don’t happen every hour.
If you plan accordingly, you can minimize production impact.
Multiple replicas strategies, which use the enterprise edition rack-awareness feature and the transparent, enhanced durability, provide a strong foundation to build always-on services even in the failure case.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-concurrent-document-modifications"><a class="anchor" href="#handling-concurrent-document-modifications"></a>Handling concurrent document modifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One error you might encounter in a concurrent application, even if all nodes are up and running, is the <code>DocumentConcurrentlyModifiedException</code>.
To understand its roots, we need to peel back a layer and see how the polling mechanism works.</p>
</div>
<div class="paragraph">
<p>A successful mutation returns the new CAS value as part of the response.
Because the CAS value changes all the time when the document changes, we can use it to track the replication and persistence on the server side.
So here is roughly what happens inside the SDK.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The mutation is performed.</p>
</li>
<li>
<p>If successful, the document ID is sent to each participating server through the internal <code>observe</code> command.</p>
</li>
<li>
<p>All responses are collected.
They contain a status (persisted, replicated) and the CAS of the document on each server.</p>
</li>
<li>
<p>On the master (active) node, if the CAS value is different from the one of our mutation, a <code>DocumentConcurrentlyModifiedException</code> is raised.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Why?</p>
</div>
<div class="paragraph">
<p>Imagine that the application A mutates document D and gets a CAS returned.
Then it starts polling.
Slightly afterward, application B also mutates document D and the CAS value changes again.
The managed cache on the server performs deduplication, or the document can be replicated between poll cycles.
Therefore, the CAS returned to application A might never be observed since it already changed to the CAS from application B.</p>
</div>
<div class="paragraph">
<p>To detect this scenario, once the CAS on the master changes the SDK will raise a <code>DocumentConcurrentlyModifiedException</code>.
How to react depends on the nature of the application.
If from the semantics the latter operation subsumes the previous one, ignoring the error might be acceptable.
If not, application A needs to fetch the document again, perform its changes or raise an error.
In general, error handling is very similar to a <code>CASMismatchException</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enhanced-durability-requirements-with-4-0"><a class="anchor" href="#enhanced-durability-requirements-with-4-0"></a>Enhanced durability requirements with 4.0+</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The "next generation observe" removes the possibility of a <code>DocumentConcurrentlyModifiedException</code> happening.</p>
</div>
<div class="paragraph">
<p>Couchbase Server 4.0 introduces a new feature that allows the SDK to be more accurate during the observe poll cycle, especially in the concurrent and failover cases.
Instead of using the CAS to verify mutations, it uses sequence numbers and partition UUIDs.</p>
</div>
<div class="paragraph">
<p>To enable them, all you need to do is enable mutation tokens on the environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CouchbaseEnvironment env = DefaultCouchbaseEnvironment
    .builder()
    .mutationTokensEnabled(true)
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tradeoff here is an extra 16 byte overhead on every mutation.
Every mutation returns the partition UUID and the sequence number which are then used for the enhanced durability requirements.</p>
</div>
<div class="paragraph">
<p>As a result, the new <code>MutationToken</code> on the <code>Document</code> will be set and, as a result, the polling logic will automatically fall back to the enhanced requirements.
Only enable enhanced durability on a minimum node version of 4.0, because the SDK will not check if each node supports the new observe option.</p>
</div>
<div class="paragraph">
<p>Every mutation on the server side increases the sequence number.
If application A and B update document D, such as the sequence one and two on the document, if we observe sequence two we can be sure that sequence one has also been replicated or persisted.
That happens because the SDK uses sequence numbers instead of the CAS value.</p>
</div>
<div class="paragraph">
<p>If a hard failover happens, a new partition UUID is created, and the server will return with a different response.
From this response, the SDK can reliably infer if a mutation has been lost: the replica took over, but the last replicated sequence did not include the mutation we have been polling for.
In this case, a <code>DocumentMutationLostException</code> will be raised.
In general, it is recommended that the application re-performs the operation if this exception is encountered to avoid data loss.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performance-considerations"><a class="anchor" href="#performance-considerations"></a>Performance considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Server is widely recognized for its excellent and predictable performance.
One of the reasons for that is its managed cache, which allows it to return a response very quickly without taking replication or persistence latency into account.</p>
</div>
<div class="paragraph">
<p>Again, it’s all tradeoffs.
If you need to make sure data is replicated and/or persisted your network or disk performance will be the dominant factor.
If you need high throughput and durability requirements, make sure (and measure) to have fast disks (SSD) and/or fast network.</p>
</div>
<div class="paragraph">
<p>Because more than one node is in general involved and more round trips are needed, think about realistic timeouts you want to set and measure them in production.
If you hit performance issues in production, make use of the new built-in metrics feature to gather operation latency percentile information and adjust timeouts based on those measurements.
All timeouts you set on the blocking API need to take the original mutation and all subsequent polls into account until the durability requirement is met.</p>
</div>
<div class="paragraph">
<p>One more thing you can tune in the environment is the <code>observeIntervalDelay</code>.
It allows you to tune the delays between subsequent polls.
By default, an exponential delay between 10 microseconds and 100 milliseconds is used.
That way there will be a few very quick polls followed by some with a longer pause, the ceiling at 100ms (so it does not grow exponentially out of bounds).
The following example fixes it at 50 microseconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CouchbaseEnvironment env = DefaultCouchbaseEnvironment
    .builder()
    .observeIntervalDelay(Delay.fixed(50, TimeUnit.MICROSECONDS))
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You want to tune the delay according to your network and disk performance characteristics.
Too frequent polls just overload the network unnecessarily while too high poll delays will increase the latency for the overall operation (and subsequently reduce application throughput).
If you are uncertain, work with Couchbase Support to find the optimal settings for your environment.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
