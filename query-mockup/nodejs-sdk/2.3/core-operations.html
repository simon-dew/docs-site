<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Core Operations | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/query-mockup/nodejs-sdk/2.6/core-operations.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="nodejs-sdk">
    <meta name="dcterms.identifier" content="2.3">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/query-mockup">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.0/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.0/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.0/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.0/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.0/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="#">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="../../couchbase-lite/2.5/index.html">Lite</a></li>
                  <li><a href="../../sync-gateway/2.5/index.html">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.0/sdk/overview.html">SDKs</a></li>
                  <li><a href="../../c-sdk/2.10/start-using-sdk.html">C</a></li>
                  <li><a href="../../dotnet-sdk/2.7/start-using-sdk.html">.NET</a></li>
                  <li><a href="../../go-sdk/1.5/start-using-sdk.html">Go</a></li>
                  <li><a href="../../java-sdk/2.7/start-using-sdk.html">Java</a></li>
                  <li><a href="../../nodejs-sdk/2.6/start-using-sdk.html">Node.js</a></li>
                  <li><a href="../../php-sdk/2.6/start-using-sdk.html">PHP</a></li>
                  <li><a href="../../python-sdk/2.5/start-using-sdk.html">Python</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.0/connectors/intro.html">Connectors</a></li>
                  <li><a href="../../elasticsearch-connector/4.0/index.html">Elasticsearch</a></li>
                  <li><a href="../../server/6.0/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="../../kafka-connector/3.4/index.html">Kafka</a></li>
                  <li><a href="../../spark-connector/2.2/index.html">Spark</a></li>
                  <li><a href="#">Talend</a></li>
                  <li><a href="../../server/6.0/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="start-using-sdk.html"><span class="title">Node.js SDK</span> <span class="version">2.3</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../2.6/core-operations.html">Node.js SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/core-operations.html">Node.js SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/core-operations.html">Node.js SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.2/core-operations.html">Node.js SDK 2.2</a></li>
                  <li><a class="navbar-item" href="../2.1/introduction.html">Node.js SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="../../c-sdk/2.10/core-operations.html">C SDK</a></li>
                  <li><a class="navbar-item" href="../../dotnet-sdk/2.7/core-operations.html">.NET SDK</a></li>
                  <li><a class="navbar-item" href="../../go-sdk/1.5/core-operations.html">Go SDK</a></li>
                  <li><a class="navbar-item" href="../../java-sdk/2.7/core-operations.html">Java SDK</a></li>
                  <li><a class="navbar-item" href="../../php-sdk/2.6/core-operations.html">PHP SDK</a></li>
                  <li><a class="navbar-item" href="../../python-sdk/2.5/core-operations.html">Python SDK</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Hello World!</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="start-using-sdk.html">Start Using the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="sample-application.html">Sample Application</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="sample-app-backend.html">Sample App Backend</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="webui-cli-access.html">Browser and CLI Access</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with Data</span>
    </span>
<ul class="nav-list">
  <li class="nav-item is-current-page is-active" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="core-operations.html">Core Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="document-operations.html">Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="subdocument-operations.html">Sub-Document Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="datastructures.html">Data Structures</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-query.html">Querying with N1QL</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-queries-with-sdk.html">N1QL from the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-search-overview.html">Full Text Search</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-searching-with-sdk.html">Searching from the SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="view-queries-with-sdk.html">MapReduce Views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="async-programming.html">Asynchronous Programming</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="batching-operations.html">Batching Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="durability.html">Durability</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="concurrent-mutations-cluster.html">Concurrent Document Mutations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="nonjson.html">Non-JSON Documents</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Deployment Environments</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing Connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-clusters.html">Managing Clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Settings, Error Handling &amp; Diagnostics</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="client-settings.html">Client Settings</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="handling-error-conditions.html">Handling Errors</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="failure-considerations.html">Failure Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="collecting-information-and-logging.html">Collecting Information</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Project Docs</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="relnotes-nodejs-sdk.html#version-2-3-7-22-august-2017">Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="compatibility-versions-features.html">Compatibility</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="sdk-licenses.html">Licenses</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="get-involved.html">Get involved</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/home/contribute/index.html">Improve the Docs</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../2.6/core-operations.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="start-using-sdk.html">Node.js SDK</a></li>
    <li class="crumb">Working with Data</li>
    <li class="crumb"><a href="core-operations.html">Core Operations</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-nodejs/edit/release/2.3/modules/ROOT/pages/core-operations.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Core Operations</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
At the core of a database is its ability to store and retrieve data.
This section discusses the various ways in which you can access data (Documents) in Couchbase: creating, updating, retrieving, querying, and deleting documents.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="document"><a class="anchor" href="#document"></a>Document</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em class="term">document</em> refers to an entry in the database (other databases may refer to the same concept as a <em>row</em>).
A document has an ID (<em>primary key</em> in other databases), which is unique to the document and by which it can be located.
The document also has a value which contains the actual application data.</p>
</div>
<div class="paragraph">
<p><strong>Document IDs</strong> are assigned by application.
A valid document ID must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conform to UTF-8 encoding</p>
</li>
<li>
<p>Be no longer than 250 bytes</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a difference between bytes and characters: most non-Latin characters occupy more than a single byte.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are free to choose any ID for your document, so long as they conform to the above restrictions.
Unlike some other database, Couchbase does not automatically generate IDs for you, though you may use a separate <a href="#devguide_kvcore_counter_generic">counter</a> to increment a serial number.</p>
</div>
<div class="paragraph">
<p>The <strong>document value</strong> contains the actual application data; for example, a <em>product</em> document may contain information about the price and description.
Documents are usually (<a href="nonjson.html" class="page">but not always</a>) stored as JSON on the server.
Because JSON is a structured format, it can be subsequently searched and queried.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "type": "product",
    "sku": "CBSRV45DP",
    "msrp": [5.49, "USD"],
    "ctime": "092011",
    "mfg": "couchbase",
    "tags": ["server", "database", "couchbase", "nosql", "fast", "json", "awesome"]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crud-overview"><a class="anchor" href="#crud-overview"></a>Primitive Key-Value Operations</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">upsert(docid, document)
insert(docid, document)
replace(docid, document)
get(docid)
remove(docid)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Couchbase documents are stored using one of the operations: <em>upsert</em>, <em>insert</em>, and <em>replace</em>.
These operations will all write a JSON document with a given document ID (key) to the database.
The update methods differ in behavior in respect to the existing state of the document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>insert</em> will only create the document if the given ID is not found within the database.</p>
</li>
<li>
<p><em>replace</em> will only replace the document if the given ID already exists within the database.</p>
</li>
<li>
<p><em>upsert</em> will always replace the document, ignoring whether the ID has already existed or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Documents can be retrieved using the <em>get</em> operation, and finally removed using the <em>remove</em> operations.</p>
</div>
<div class="paragraph">
<p>Since Couchbase’s KV store may be thought of as a distributed hashmap or dictionary, the following code samples are explanatory of Couchbase’ update operations in pseudo-code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">map&lt;string,object&gt; KV_STORE;

void insert(string doc_id, object value) {
    if (!KV_STORE.contains(doc_id)) {
        KV_STORE.put(doc_id, value);
    } else {
        throw DocumentAlreadyExists();
    }
}

void replace(string doc_id, object value) {
    if (KV_STORE.contains(doc_id)) {
        KV_STORE.put(doc_id, value);
    } else {
        throw DocumentNotFound();
    }
}

void upsert(string doc_id, object value) {
    KV_STORE.put(doc_id, value);
}

object get(string doc_id) {
    if (KV_STORE.contains(doc_id)) {
        return KV_STORE.get(doc_id);
    } else {
        throw DocumentNotFound();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <a href="n1ql-query.html" class="page">N1QL queries</a> and <a href="full-text-search-overview.html" class="page">Full Text Search</a> to access documents by means other than their IDs, however these query operations Couchbase eventually translate into primitive key-value operations, and exist as separate services outside the data store.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="storing-and-updating-documents"><a class="anchor" href="#storing-and-updating-documents"></a>Storing and Updating Documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Documents can be stored and updated using either the SDK, Command line, or Web UI.
When using a storage operation, the <em>full content</em> of the document is replaced with a new value.</p>
</div>
<div class="paragraph">
<p>The following example shows a document being stored using the <a href="webui-cli-access.html#cli-access" class="page"><code>cbc</code></a> utility.
The ID of the document is <code>docid</code> and its value is JSON containing a single field (<code>json</code>) with the value of <code>value</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># When storing JSON data using cbc, ensure it is properly quoted for your shell:
$ cbc create docid -V '{"json":"value"}' -M upsert -U couchbase://cluster-node/bucket-name
docid               Stored. CAS=0x8234c3c0f213</pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify additional options when storing a document in Couchbase</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#expiry">Expiry</a> (or <em>TTL</em>) value which will instruct the server to delete the document after a given amount of time.
This option is useful for transient data (such as sessions).
By default documents do not expire.
See <a href="#expiry">Expiry</a> for more information on expiration.</p>
</li>
<li>
<p><a href="concurrent-mutations-cluster.html" class="page">CAS</a> value to protect against concurrent updates to the same document.
See <a href="concurrent-mutations-cluster.html" class="page">CAS</a> for a description on how to use CAS values in your application.</p>
</li>
<li>
<p><a href="durability.html" class="page">Durability Requirements</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you wish to only modify certain parts of a document, you can use <a href="subdocument-operations.html" class="page">sub-document</a> operations which operate on specific subsets of documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">cb.mutate_in('docid', subdoc.array_addunique('tags', 'fast'))</code></pre>
</div>
</div>
<div class="paragraph">
<p>or <a href="../../server/4.6/n1ql/n1ql-language-reference/update.html" class="page">N1QL UPDATE</a> to update documents based on specific query criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">update `default` SET sale_price = msrp * 0.75 WHERE msrp &lt; 19.95;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devguide_kvcore_get_generic"><a class="anchor" href="#devguide_kvcore_get_generic"></a>Retrieving Documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FASTPATH: This section discusses retrieving documents using their IDs, or primary keys.
Documents can also be accessed using secondary lookups via <a href="n1ql-query.html" class="page">N1QL queries</a> and MapReduce.
Primary key lookups are performed using the key-value API, which simplifies use and increases performance (as applications may interact with the KV store directly, rather than a secondary index or query processor).</p>
</div>
<div class="paragraph">
<p>In Couchbase, documents are stored with their IDs.
Retrieving a document via its ID is the simplest and quickest operation in Couchbase.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt;&gt;&gt; result = cb.get('docid')
&gt;&gt;&gt; print result.value
{'json': 'value'}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cbc cat docid
docid                CAS=0x8234c3c0f213, Flags=0x0. Size=16
{"json":"value"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a document is retrieved, it is accessible in the native format by which it was stored; meaning that if you stored the document as a list, it is now available as a list again.
The SDK will automatically deserialize the document from its stored format (usually JSON) to a native language type.
It is possible to store and retrieve non-JSON documents as well, using a <a href="nonjson.html" class="page">transcoder</a>.</p>
</div>
<div class="paragraph">
<p>You can also modify a document&#8217;s expiration time while retrieving it; this is known as <em>get-and-touch</em> and allows you to keep temporary data alive while retrieving it in one atomic and efficient operation.</p>
</div>
<div class="paragraph">
<p>Documents can also be retrieved with N1QL.
While N1QL is generally used for secondary queries, it can also be used to retrieve documents by their primary keys (ID) (though it is recommended to use the key-value API if the ID is known).
Lookups may be done either by comparing the <code>META(from-term).id</code> or by using the <code>USE KEYS</code> [...] keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT * FROM default USE KEYS ["docid"];</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT * FROM default WHERE META(default).id = "docid";</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also retrieve <em>parts</em> of documents using <a href="subdocument-operations.html" class="page">sub-document operations</a>, by specifying one or more sections of the document to be retrieved</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">name, email = cb.retrieve_in('user:kingarthur', 'contact.name', 'contact.email')</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devguide_kvcore_counter_generic"><a class="anchor" href="#devguide_kvcore_counter_generic"></a>Counters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can atomically increment or decrement the numerical value of special counter document</p>
</div>
<div class="paragraph">
<p>A document may be used as a counter if its value is a simple ASCII number, like <code>42</code>.
Couchbase allows you to increment and decrement these values atomically using a special <code class="api">counter</code> operation.
The example below (in Python) shows how to use counters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">&gt;&gt;&gt; cb.counter('counter_id', delta=20, initial=100).value
100L
&gt;&gt;&gt; cb.counter('counter_id', delta=1).value
101L
&gt;&gt;&gt; cb.counter('counter_id', delta=-50).value
51L</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, a counter is created by using the <code class="api">counter</code> Python method with an <code class="param">initial</code> value.
The initial value is the value the counter uses if the counter ID does not yet exist.</p>
</div>
<div class="paragraph">
<p>Once created, the counter can be incremented or decremented atomically by a given <em>amount</em> or <em>delta</em>.
Specifying a positive delta increments the value and specifying a negative one decrements it.
When a counter operation is complete, the application receives the current value of the counter, after the increment.</p>
</div>
<div class="paragraph">
<p>Couchbase counters are 64-bit unsigned integers in Couchbase and do not wrap around if decremented beyond 0.
However, counters will wrap around if incremented past their maximum value (which is the maximum value contained within a 64-bit integer).
Many SDKs will limit the <em>delta</em> argument to the value of a <em>signed</em> 64-bit integer.</p>
</div>
<div class="paragraph">
<p><a href="#expiry">Expiration</a> times can also be specified when using counter operations.</p>
</div>
<div class="paragraph">
<p><a href="concurrent-mutations-cluster.html" class="page">CAS</a> values are not used with counter operations since counter operations are atomic.
The intent of the counter operation is to simply increment the current server-side value of the document.
If you wish to only increment the document if it is at a certain value, then you may use a normal <code class="api">upsert</code> function with CAS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">rv = cb.get('counter_id')
value, cas = rv.value, rv.cas
if should_increment_value(value):
  cb.upsert('counter_id', value + increment_amount, cas=cas)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <a href="subdocument-operations.html#ul_fp2_2yw_mv" class="page">sub-document counter operations</a> to increment numeric values <em>within</em> a document containing other content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devguide_datastructures"><a class="anchor" href="#devguide_datastructures"></a>Datastructures - List, Map, Set, Queue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use collection data structures such as lists, maps, sets and queues in Couchbase.
These data structures may be manipulated with basic operations without retrieving and storing the entire document.</p>
</div>
<div class="paragraph">
<p>See the data structures <a href="../../python-sdk/2.5/datastructures.html" class="page">documentation for each SDK language</a> for details on implementation.
Some Python examples are provided below for easy reference, but more advanced Collections frameworks are accessible in <a href="../../java-sdk/2.7/datastructures.html" class="page">Java</a> and <a href="../../dotnet-sdk/2.7/datastructures.html" class="page">.NET</a> as well.</p>
</div>
<div class="paragraph">
<p>Data structures in Couchbase are similar in concept to data structures in, for example, Python:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Map</strong> is like Python <code>dict</code>, and is a key-value structure, where a value is accessed by using a key string.</p>
</li>
<li>
<p><strong>List</strong> is like a Python <code>list</code> and is a sequential data structure.
Values can be placed in the beginning or end of a list, and can be accessed using numeric indexes.</p>
</li>
<li>
<p><strong>Queue</strong> is a wrapper over a <em>list</em> which offers FIFO (first-in-first-out) semantics, allowing it to be used as a lightweight job queue.</p>
</li>
<li>
<p><strong>Set</strong> is a wrapper over a <em>list</em> which provides the ability to handle unique values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These data structures are stored as JSON documents in Couchbase, and can therefore be accessed using N1QL, Full Text Search, and normal key-value operations.
Data structures can also be manipulated using the traditional sub-document and full-document key-value APIs.</p>
</div>
<div class="paragraph">
<p>To add an item to a map, specify the <em>document ID</em> of the map itself (i.e.
the ID which uniquely identifies the map in the server), the key <em>within</em> the map, and the value to store under the key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">bucket.map_add('map_id', 'name', 'Mark Nunberg', create=True)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Data structures can be accessed using their appropriate methods.
Most data access methods will return an <code class="api">ValueResult</code>-like object with the actual returned value under the <code class="var">value</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">bucket.list_get(0).value  # 'hello'
bucket.map_get('map_id', 'name').value  # 'mark nunberg'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devguide_kvcore_append_prepend_generic"><a class="anchor" href="#devguide_kvcore_append_prepend_generic"></a>Raw Byte Concatenation</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following methods should not be used with JSON documents.</p>
</div>
<div class="paragraph">
<p>The append and prepend operations operate at the byte level and are unsuitable for dealing with JSON documents.
Use these methods only when explicitly dealing with binary or UTF-8 documents.
Using the append and prepend methods may invalidate an existing JSON document.
You can use <a href="subdocument-operations.html" class="page">sub-document operations</a> if you want to have true JSON-aware prepend and append operations which add values to JSON arrays.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">append(docid, fragment)
prepend(docid, fragment)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>append</em> and <em>prepend</em> operations atomically add bytes to the end or beginning of a binary document.
They are an efficient alternative to retrieving a binary document in its entirety, appending the contents locally, and then saving the contents back to the server.</p>
</div>
<div class="paragraph">
<p>Because these methods do raw string manipulation, they are only suitable for non-JSON documents: Prepending or appending anything to a JSON document will invalidate the JSON and make it unparseable by standard JSON parsers.</p>
</div>
<div class="paragraph">
<p>The semantics of the <em>append</em> and <em>prepend</em> operations are similar to those of the <em>upsert</em> family of operations, except that they accept the fragment to append as their value, rather than the entire document.
These functions may be used to add efficiency for custom binary data structures (such as logs), as they avoid transferring the contents of the entire document for each operation.
Consider the following versions (which are equivalent)</p>
</div>
<div class="listingblock">
<div class="title">Append using get() and replace() (slow)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python"># Store the document
cb.upsert('binary_doc', '\x01', format=couchbase.FMT_BYTES)

while True:
    # Retrieve the entire document
    rv = cb.get('binary_doc')
    value = rv.value + '\x02'
    try:
        # Upload the entire document
        cb.replace('binary_doc', value, format=couchbase.FMT_BYTES)
        break
    except couchbase.exceptions.KeyExistsError:
        continue

print repr(cb.get('binary_doc').value)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Append using append() (fast)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python"># Store the document
cb.upsert('binary_doc', '\x01', format=couchbase.FMT_BYTES)

# Append a fragment
cb.append('binary_doc', '\x02', format=couchbase.FMT_BYTES)

print repr(cb.get('binary_doc').value)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that since the <em>append</em> operation is done atomically, there is no need for a CAS check (though one can still be supplied if the document must be at a specific state).</p>
</div>
<div class="paragraph">
<p>Users of the <em>append</em> and <em>prepend</em> operations should ensure that the resulting documents do not become too large.
Couchbase has a hard document size limit of 20MB.</p>
</div>
<div class="paragraph">
<p>Using <em>append</em> and <em>prepend</em> on larger documents may cause performance degradation and memory fragmentation at the server level, as for each append operation the server must allocate memory for the new document size and then append the fragment to the new memory.
The performance impact may be significant when document sizes reach beyond 100KB.</p>
</div>
<div class="paragraph">
<p>Finally, note that while append saves network traffic from the client to server (by only specifying the fragment to append), the entire document is replicated for each mutation.
Five append operations on a single 10MB document will result in 50MB of traffic to each replica.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expiry"><a class="anchor" href="#expiry"></a>Expiration Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most data in a database is there to be persisted and long-lived.
However, the need for transient or temporary data does arise in applications, such as in the case of user sessions, caches, or temporary documents representing a given process ownership.
You can use expiration values on documents to handle transient data.</p>
</div>
<div class="paragraph">
<p>In databases without a built-in expiration feature, dealing with transient data may be cumbersome.
To provide "expiration" semantics, applications are forced to record a time stamp in a record, and then upon each access of the record check the time stamp and, if invalid, delete it.</p>
</div>
<div class="paragraph">
<p>Since some logically ‘expired’ documents might never be accessed by the application, to ensure that temporary records do not persist and occupy storage, a scheduled process is typically also employed to scan the database for expired entries routinely, and to purge those entries that are no longer valid.</p>
</div>
<div class="paragraph">
<p>Workarounds such as those described above are not required for Couchbase, as it allows applications to declare the lifetime of a given document, eliminating the need to embed "validity" information in documents and eliminating the need for a routine "purge" of logically expired data.</p>
</div>
<div class="paragraph">
<p>When an application attempts to access a document which has already expired, the server will indicate to the client that the item is not found.
The server internally handles the process of determining the validity of the document and removing older, expired documents.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-document-expiration"><a class="anchor" href="#setting-document-expiration"></a>Setting Document Expiration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, Couchbase documents do not expire.
However, the expiration value may be set for the <em>upsert</em>, <em>replace</em>, and <em>insert</em> operations when modifying data.</p>
</div>
<div class="paragraph">
<p>Couchbase offers two additional operations for setting the document&#8217;s expiration without modifying its contents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>get-and-touch</em> operation allows an application to retrieve a document while modifying its expiration time.
This method is useful when reading session data from the database: since accessing the data is indicative of it still being "alive", <em>get-and-touch</em> provides a natural way to extend its lifetime.</p>
</li>
<li>
<p>The <em>touch</em> operation allows an application to modify a document’s expiration time without otherwise accessing the document.
This method is useful when an application is handling a user session but does not need to access the database (for example, if a particular  document is already cached locally).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Couchbase SDKs which accept simple integer expiry values (as opposed to a proper date or time object) allow expiration to be specified in two flavors.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As an offset from the current time.</p>
</li>
<li>
<p>As an absolute Unix time stamp</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the absolute value of the expiry is less than 30 days (such as <code>60 * 60 * 24 * 30</code>), it is considered an <em>offset</em>.
If the value is greater, it is considered an <em>absolute time stamp</em>.</p>
</div>
<div class="paragraph">
<p>It might be preferable for applications to normalize the expiration value, such as by always converting it to an absolute time stamp.
The conversion is performed to avoid issues when the intended offset is larger than 30 days, in which case it is taken to mean a Unix time stamp and, as a result,  the document will expire automatically as soon as it is stored.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Remember"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>If you wish to use the expiry feature, then you should supply the expiry value for every mutation operation.</p>
</li>
<li>
<p>When dealing with expiration, it is important to note that most operations will implicitly remove any existing expiration.
Thus, when modifying a document with expiration, it is important to pass the desired expiration time.</p>
</li>
<li>
<p>A document is expired as soon as the current time on the Couchbase Server node responsible for the document exceeds the expiration value.
Bear this in mind in situations where the time on your application servers differs from the time on your Couchbase Server nodes.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that expired documents are not deleted from the server as soon as they expire.
While a request to the server for an expired document will receive a response indicating the document does not exist, expired documents are actually deleted (i.e.
cease to occupy storage and RAM) when an <em>expiry pager</em> is run.
The <em>expiry pager</em> is a routine internal process which scans the database for items which have expired and promptly removes them from storage.</p>
</div>
<div class="paragraph">
<p>When gathering resource usage statistics, note that expired-but-not-purged items (such as the expiry pager has not scanned this item yet) will still be considered with respect to the overall storage size and item count.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://plus.google.com/+CouchbaseServer" class="icon">
              <svg width="50px" height="50px" viewBox="36.72 225.573 542.326 343.67"><path d="m209.02 363.05v68.732h93.212c-15.065 44.252-37.662 68.732-93.212 68.732-56.492 0-100.74-46.135-100.74-102.63s44.252-102.63 100.74-102.63c30.129 0 48.96 10.357 66.849 25.422 14.123-14.123 13.182-16.006 48.96-49.902-31.071-28.246-71.557-45.194-115.81-45.194-95.096-0.94-172.3 76.266-172.3 171.36s77.206 172.3 172.3 172.3c142.17 0 177.01-124.28 165.71-206.2-33.896-1e-3 -165.71-1e-3 -165.71-1e-3zm310.71 3.766v-59.317h-42.369v59.317h-61.2v42.369h61.2v61.2h42.369v-61.2h59.317v-42.369h-59.317z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2018 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
