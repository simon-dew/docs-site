<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Restoring with cbrestore | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-4917/server/6.5/cli/cbtools/guides/cbrestore-guide.html">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="server">
    <meta name="dcterms.identifier" content="6.5">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="icon" href="../../../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../../../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-4917">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../../index.html">Server</a></li>
                  <li><a href="../../../../../server/6.5/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../../../../server/6.5/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../../../../server/6.5/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../../../../server/6.5/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="#">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="#">Lite</a></li>
                  <li><a href="#">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../../../../server/6.5/sdk/overview.html">SDKs</a></li>
                  <li><a href="#">C</a></li>
                  <li><a href="#">.NET</a></li>
                  <li><a href="#">Go</a></li>
                  <li><a href="#">Java</a></li>
                  <li><a href="#">Node.js</a></li>
                  <li><a href="#">PHP</a></li>
                  <li><a href="#">Python</a></li>
                  <li><a href="#">Scala</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../../../../server/6.5/connectors/intro.html">Connectors</a></li>
                  <li><a href="#">Elasticsearch</a></li>
                  <li><a href="../../../../../server/6.5/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="#">Kafka</a></li>
                  <li><a href="#">Spark</a></li>
                  <li><a href="../../../../../server/6.5/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="../../../index.html"><span class="title">server</span> <span class="version">6.5</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../../../../6.0/introduction/intro.html">server 6.0</a></li>
                  <li><a class="navbar-item" href="../../../../5.5/index.html">server 5.5</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../../../index.html">server</a></li>
    <li class="crumb"><a href="cbrestore-guide.html">Restoring with cbrestore</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/couchbase-cli/edit/master/docs/modules/cli/pages/cbtools/guides/cbrestore-guide.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Restoring with cbrestore</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
To restore bucket data that was backed up using the command <code class="cmd">cbbackup</code>, use the command <code class="cmd">cbrestore</code> to restore information into a bucket on a new cluster.
</blockquote>
</div>
<div class="paragraph">
<p>When restoring a backup, you have to select the appropriate restore sequence based on the type of restore you are performing.
The available methods when restoring a cluster depend on the method used to back up the cluster.</p>
</div>
<div class="paragraph">
<p>If <code class="cmd">cbbackup</code> was used to backup the bucket data, you could restore back to a cluster with the same or different configuration.
This is because <code class="cmd">cbbackup</code> stores information about the stored bucket data in a format that enables it to be restored back into a bucket on a new cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the information was backed up using a direct file copy, then you must restore the information back to an identical cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code class="cmd">cbrestore</code> command takes the information that has been backed up via the <code class="cmd">cbbackup</code>&gt; command and streams the stored data into a cluster.
The cluster configuration does not have to match the one used when the data was backed up.
It can be used when transferring information to a new cluster or updated or expanded version of the existing cluster in the event of disaster recovery.</p>
</div>
<div class="paragraph">
<p>Because the data can be flexibly restored, it provides for a number of different scenarios to be executed on the data that has been backed up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restoring data into a cluster of a different size and configuration.</p>
</li>
<li>
<p>Transferring or restoring data into a different bucket on the same or different cluster.</p>
</li>
<li>
<p>Restoring a selected portion of the data into a new or different cluster, or the same cluster but a different bucket.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The basic format of the <code class="cmd">cbrestore</code> command is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cbrestore [options] [source] [destination]</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">[options]</dt>
<dd>
<p>Options specifying how the information should be restored into the cluster.
Common options include:</p>
<div class="ulist">
<ul>
<li>
<p><code>--bucket-source</code></p>
<div class="paragraph">
<p>Specify the name of the bucket data to be read from the backup data that will be restored.</p>
</div>
</li>
<li>
<p><code>--bucket-destination</code></p>
<div class="paragraph">
<p>Specify the name of the bucket the data will be written to.
If this option is not specified, the data will be written to a bucket with the same name as the source bucket.</p>
</div>
</li>
<li>
<p><code>--add</code></p>
<div class="paragraph">
<p>Use <code>--add</code> instead of <code>--set</code> to avoid overwriting the existing items in the destination.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">[source]</dt>
<dd>
<p>The backup directory specified to <code>cbbackup</code> where the backup data was stored.</p>
</dd>
<dt class="hdlist1">[destination]</dt>
<dd>
<p>The REST API URL of a node within the cluster where the information will be restored.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <code class="cmd">cbrestore</code> command restores only a single bucket of data at a time.
If you have created a backup of an entire cluster (such as all buckets), then you must restore each bucket individually back to the cluster.
All destination buckets must already exist since <code class="cmd">cbrestore</code> does not create or configure destination buckets for you.</p>
</div>
<div class="paragraph">
<p>For example, to restore a single bucket of data to a cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cbrestore \
    /backups/backup-2012-05-10 \
    http://Administrator:password@HOST:8091 \
    --bucket-source=XXX
    [####################] 100.0% (231726/231726 msgs)
    bucket: default, msgs transferred...
    :                total |       last |    per sec
    batch :                  232 |        232 |       33.1
    byte  :             10247683 |   10247683 |  1462020.7
    msg   :               231726 |     231726 |    33060.0
    done</pre>
</div>
</div>
<div class="paragraph">
<p>To restore the bucket data to a different bucket on the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cbrestore \
    /backups/backup-2012-05-10 \
    http://Administrator:password@HOST:8091 \
    --bucket-source=XXX \
    --bucket-destination=YYY
    [####################] 100.0% (231726/231726 msgs)
    bucket: default, msgs transferred...
    :                total |       last |    per sec
    batch :                  232 |        232 |       33.1
    byte  :             10247683 |   10247683 |  1462020.7
    msg   :               231726 |     231726 |    33060.0
    done</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>msg</code> count in this case is the number of documents restored back to the bucket in the cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="filtering-keys-during-restore"><a class="anchor" href="#filtering-keys-during-restore"></a>Filtering keys during restore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code class="cmd">cbrestore</code> command includes support for filtering the keys that are restored to the database from the files that were created during backup.
This is in addition to the filtering support available during backup).</p>
</div>
<div class="paragraph">
<p>The specification is in the form of a regular expression supplied as an option to the <code class="cmd">cbrestore</code> command.
For example, to restore information to a bucket only where the keys have an <code>object</code> prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cbrestore /backups/backup-20120501 http://HOST:8091 \
    -u Administrator -p password \
    -b default \
    -k '^object.*'
    2013-02-18 10:39:09,476: w0 skipping msg with key: sales_7597_3783_6
    ...
    2013-02-18 10:39:09,476: w0 skipping msg with key: sales_5575_3699_6
    2013-02-18 10:39:09,476: w0 skipping msg with key: sales_7597_3840_6
    [                    ] 0.0% (0/231726 msgs)
    bucket: default, msgs transferred...
    :                total |       last |    per sec
    batch :                    1 |          1 |        0.1
    byte  :                    0 |          0 |        0.0
    msg   :                    0 |          0 |        0.0
    done</pre>
</div>
</div>
<div class="paragraph">
<p>This copies only the keys matching the specified prefix into the <code class="var">default</code> bucket.
For each key skipped, an information message is provided.
The remaining output shows the records transferred and summary as normal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restoring-using-file-copies"><a class="anchor" href="#restoring-using-file-copies"></a>Restoring using file copies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To restore the information to the same cluster with the same configuration, shut down your entire cluster while you restore the data and then restart the cluster again.
In this case, you are replacing the entire cluster data and configuration with the backed up version of the data files, and then restarting the cluster with the saved version of the cluster files.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure that any restoration of files also sets the proper ownership of those files to the Couchbase user.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When restoring data back in the same cluster, verify the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Backup and restore must use the same version of Couchbase Server.</p>
</li>
<li>
<p>The cluster must contain the same number of nodes.</p>
</li>
<li>
<p>Each node must have the same IP address or hostname it was configured with when the cluster was backed up.</p>
</li>
<li>
<p>All <code>config.dat</code> configuration files as well as all database files must be restored to their original locations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The steps required to complete the restore process are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the Couchbase Server service on all nodes.</p>
</li>
<li>
<p>On each node, restore the database, <code>stats.json</code>, and configuration file <code>config.dat</code> from your backup copies for each node.</p>
</li>
<li>
<p>Restart the service on each node.</p>
</li>
</ol>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2019 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../../../../_/js/site.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
