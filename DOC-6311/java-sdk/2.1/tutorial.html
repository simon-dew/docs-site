<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Java SDK tutorial | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-6311/java-sdk/3.0/hello-world/start-using-sdk.html">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="java-sdk">
    <meta name="dcterms.identifier" content="2.1">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-6311">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../server/6.5/introduction/intro.html">Server</a></li>
                  <li><a href="../../server/6.5/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../server/6.5/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../server/6.5/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../server/6.5/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="#">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="#">Lite</a></li>
                  <li><a href="#">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../server/6.5/sdk/overview.html">SDKs</a></li>
                  <li><a href="#">C</a></li>
                  <li><a href="#">.NET</a></li>
                  <li><a href="#">Go</a></li>
                  <li><a href="../3.0/hello-world/start-using-sdk.html">Java</a></li>
                  <li><a href="#">Node.js</a></li>
                  <li><a href="#">PHP</a></li>
                  <li><a href="#">Python</a></li>
                  <li><a href="#">Scala</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../server/6.5/connectors/intro.html">Connectors</a></li>
                  <li><a href="#">Elasticsearch</a></li>
                  <li><a href="../../server/6.5/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="#">Kafka</a></li>
                  <li><a href="#">Spark</a></li>
                  <li><a href="../../server/6.5/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="java-intro.html"><span class="title">Java SDK</span> <span class="version">2.1</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li><a class="navbar-item" href="../3.0/hello-world/start-using-sdk.html">Java SDK 3.0</a></li>
                  <li><a class="navbar-item" href="../2.7/start-using-sdk.html">Java SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../2.6/start-using-sdk.html">Java SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../2.5/start-using-sdk.html">Java SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../2.4/start-using-sdk.html">Java SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../2.3/start-using-sdk.html">Java SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../2.2/java-intro.html">Java SDK 2.2</a></li>
                  <li class="current"><a class="navbar-item" href="tutorial.html">Java SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="#">c-sdk</a></li>
                  <li><a class="navbar-item" href="#">dotnet-sdk</a></li>
                  <li><a class="navbar-item" href="#">go-sdk</a></li>
                  <li><a class="navbar-item" href="#">nodejs-sdk</a></li>
                  <li><a class="navbar-item" href="#">php-sdk</a></li>
                  <li><a class="navbar-item" href="#">python-sdk</a></li>
                  <li><a class="navbar-item" href="#">scala-sdk</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="java-intro.html">Java SDK 2.1</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="overview.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="download-links.html">Download and API Reference</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="migrate.html">Migrating from Java SDK 1.4.x to 2.x</a>
    </span>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="getting-started.html">Getting started with the Java SDK</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="hello-couchbase.html">Hello Couchbase Example</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="tutorial.html">Java SDK tutorial</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing connections</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="env-config.html">Configuring the environment</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="documents.html">Working with documents</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-basics.html">Document basics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-creating.html">Creating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-updating.html">Updating documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-retrieving.html">Retrieving documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-deleting.html">Deleting documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-atomic.html">Atomic operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="documents-bulk.html">Bulk operations</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="querying.html">Querying buckets</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-views.html">Working with views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="querying-n1ql.html">Working with N1QL</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="observables.html">Mastering observables</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="logging.html">Setting up logging</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="release-notes.html">Release notes</a>
    </span>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-banner">
    <p>A newer version of this documentation is available.</p>
    <a class="btn" href="../3.0/hello-world/start-using-sdk.html">View Latest</a>
  </div>
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="java-intro.html">Java SDK</a></li>
    <li class="crumb"><a href="java-intro.html">Java SDK 2.1</a></li>
    <li class="crumb"><a href="getting-started.html">Getting started with the Java SDK</a></li>
    <li class="crumb"><a href="tutorial.html">Java SDK tutorial</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/2.1/modules/ROOT/pages/tutorial.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">Java SDK tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Java SDK tutorial introduces some advanced concepts by walking through a complete web application.
</blockquote>
</div>
<div class="paragraph">
<p>The full source code for the tutorial is available <a href="https://github.com/couchbaselabs/beersample-java2" target="_blank" rel="noopener">on GitHub</a>.
The primary focus of the tutorial is to explain the function and theory connected to the Couchbase Java client and how it connects to Couchbase server.
The code that generates the web application is provided with the source code but is not discussed in this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preview-the-application"><a class="anchor" href="#preview-the-application"></a>Preview the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The complete working source is in the master branch <a href="https://github.com/couchbaselabs/beersample-java2" target="_blank" rel="noopener">on GitHub</a>.
To build from source and preview the application, clone the repository and run the following shell commands from the repository folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package
cd target
java -jar beersample-java2.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the Spring framework start up and begin logging the application.
After it has finished initializing, you can navigate to <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> and view the application or use a tool like <code>curl</code> or <code>postman</code> to use all REST endpoints described in <a href="https://github.com/couchbaselabs/beersample-java2#rest-api" target="_blank" rel="noopener">the README</a> file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparation"><a class="anchor" href="#preparation"></a>Preparation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get ready to build your first app, you need to install Couchbase Server, create a view, and set up your development environment (IDE).</p>
</div>
<div class="paragraph">
<p><strong>Installing Couchbase Server</strong></p>
</div>
<div class="paragraph">
<p>Download <a href="http://www.couchbase.com/download" target="_blank" rel="noopener">Couchbase Server</a> and install it.
As you follow the download instructions and setup wizard, make sure you install the sample bucket named <code>beer-sample</code> because it contains the beer and brewery data used in this tutorial.</p>
</div>
<div class="paragraph">
<p>If you already have Couchbase Server installed but did not install the <code>beer-sample</code> bucket, open the Couchbase Web Console and select <span class="menuseq"><b class="menu">Settings</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Sample Buckets</b></span>.
Select the <code>beer-sample</code> check box, and then click <strong class="ui">Create</strong>.
A notification box in the upper-right corner disappears when the bucket is ready to use.</p>
</div>
<div class="paragraph">
<p><strong>Creating a view</strong></p>
</div>
<div class="paragraph">
<p>Views enable you to index and query data from your database.
The <code>beer-sample</code> bucket comes with a small set of predefined view functions, but to add further functionality to the application you need to add an additional view.
Adding a view offers a very good chance for you to see how you can manage views inside the Couchbase Web Console.</p>
</div>
<div class="paragraph">
<p>We want our users to be able to view a list of both beers and breweries.
Therefore, we need to define one view function for each type of document that will respond with the relevant information for each query.
As such we will be creating one view function for beers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In Couchbase Web Console, click <strong class="ui">Views</strong>.</p>
</li>
<li>
<p>From the drop-down list of bucket names, choose the <strong class="ui">beer-sample</strong> bucket.</p>
<div class="paragraph">
<p>You should see a design document named <code>_design/beer</code> that has some views already defined (<code>brewery_beers</code> and <code>by_location</code>).
If you do not see the views, make sure that Production Views is selected.
You can toggle between Development Views and Production Views by clicking the buttons at the top of the list.</p>
</div>
</li>
<li>
<p>Click <strong class="ui">Copy to Dev</strong>, and then in the Copy Design Document window click <strong class="ui">Copy</strong>.</p>
<div class="paragraph">
<p>You are now looking at the Development Views version of the <code>_design/dev_beer</code> design document, where you can add new views or make changes to existing views in the design document.</p>
</div>
</li>
<li>
<p>Click <strong class="ui">Add View</strong>.</p>
</li>
<li>
<p>In the Create Development View window, enter the following names for the design document and the view:</p>
<div class="ulist">
<ul>
<li>
<p>Design Document Name: <code>_design/dev_beer</code></p>
</li>
<li>
<p>View Name: <code>by_name</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <b class="button">Edit</b> button for the <code>by_name</code> view.</p>
<div class="paragraph">
<p>You are now in the view editor, where you can see sample documents and edit map and reduce functions.</p>
</div>
</li>
<li>
<p>Under View Code, insert the following JavaScript map function and click <strong class="ui">Save</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function (doc, meta) {
   if(doc.type &amp;&amp; doc.type == "beer") {
	 emit(doc.name, doc.brewery_id);
   }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Every <code>map</code> function takes the full document (<code>doc</code>) and its associated metadata (<code>meta</code>) as the arguments.
Your map function can then inspect this data and <code>emit</code> the item to a result set to be added to an index.
In this case, the name of the beer (<code>doc.name</code>) is emitted when the document has a type field, and the type is <code>beer</code>.
We also want to use the brewery associated with the beer, so for our value we will emit the <code>doc.brewery_id</code>.</p>
</div>
<div class="paragraph">
<p>In general, you should try to keep the index as small as possible.
You should resist the urge to include the full document with <code>emit(meta.id, doc)</code> because that increases the size of your view indexes and potentially impacts application performance.
If you need to access the full document or large parts of it, use the <code>.document()</code> method, which does a <code>get()</code> call with the document ID in the background.</p>
</div>
<div class="paragraph">
<p>At this point, you could also add a reduce function to perform further computation on the index results.
This example does not use <code>reduce</code> functions, but you can play around with <code>reduce</code> functions to see how they work.</p>
</div>
<div class="paragraph">
<p>The final step is to push the design documents to production mode for Couchbase Server.
While the design documents are in development mode, the index is applied only on the local node.
For more information about design document modes, see <a href="http://docs.couchbase.com/admin/admin/Views/views-development.html" target="_blank" rel="noopener">Development views</a> and <a href="http://docs.couchbase.com/admin/admin/Views/views-production.html" target="_blank" rel="noopener">Production views</a>.</p>
</div>
<div class="paragraph">
<p>To have the index on the whole data set, you need to publish the design documents to move them into production mode:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In Couchbase Web Console, click <strong class="ui">Views</strong>.</p>
</li>
<li>
<p>Click the <b class="button">Publish</b> button on the design document.</p>
</li>
<li>
<p>Accept any dialog that warns you about overriding the old view function (since you copied them).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about using views for indexing and querying from Couchbase Server, see the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>General Information about views: <a href="http://docs.couchbase.com/admin/admin/Views/views-intro.html" target="_blank" rel="noopener">Views and indexes</a></p>
</li>
<li>
<p>Examples and patterns you can use for views, including patterns for extracting information based on date or time: <a href="http://docs.couchbase.com/admin/admin/Views/views-querySample.html" target="_blank" rel="noopener">View and query pattern samples</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Setting up your IDE</strong></p>
</div>
<div class="paragraph">
<p>This project makes heavy use of <a href="http://maven.apache.org/" target="_blank" rel="noopener">Maven</a> for dependency management, so you should familiarize yourself with using Maven for your chosen IDE or from the command line.
Here is the <em class="path">pom.xml</em> that you can use for full dependency management (included in the example application):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;com.couchbase&lt;/groupId&gt;
	&lt;artifactId&gt;beersample2&lt;/artifactId&gt;
	&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;1.1.9.RELEASE&lt;/version&gt;
	&lt;/parent&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.couchbase.client&lt;/groupId&gt;
			&lt;artifactId&gt;java-client&lt;/artifactId&gt;
			&lt;version&gt;2.1.6&lt;/version&gt;

		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;finalName&gt;beersample-java2&lt;/finalName&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
				&lt;version&gt;3.1&lt;/version&gt;
				&lt;configuration&gt;
					&lt;source&gt;1.6&lt;/source&gt;
					&lt;target&gt;1.6&lt;/target&gt;
				&lt;/configuration&gt;
			&lt;/plugin&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
				&lt;executions&gt;
					&lt;execution&gt;
						&lt;goals&gt;
							&lt;goal&gt;repackage&lt;/goal&gt;
						&lt;/goals&gt;
					&lt;/execution&gt;
				&lt;/executions&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For reference, here is the directory structure used for this example application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">├── src
│   └── main
│  	 ├── java
│  	 │   └── com
│  	 │  	 └── couchbase
│  	 │  		 └── beersample
│  	 │  			 ├── beers
│  	 │  			 ├── breweries
│  	 │  			 └── config
│  	 └── resources
│  		 └── public
└── target</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Download the framework</strong></p>
</div>
<div class="paragraph">
<p>The framework/stub for the tutorial can be downloaded from <a href="https://github.com/couchbaselabs/beersample-java2/tree/tutorialStub" target="_blank" rel="noopener">github</a>.
It includes the <a href="http://projects.spring.io/spring-boot/#quick-start" target="_blank" rel="noopener">Spring Boot</a> application framework and the surrounding code that takes our Couchbase connections and forms a complete application.
The next section of the tutorial explains the inner workings of the <code class="api">CouchbaseService</code> class, currently blank, that deals with the applications connections with your Couchbase server and implements key data-related methods.</p>
</div>
<div class="paragraph">
<p>The best way to go is to clone the repository and use the <code>tutorialStub</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">git clone https://github.com/couchbaselabs/beersample-java2.git
cd beersample-java2
git checkout tutorialStub</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then import the project as a Maven project in your favorite IDE and start filling in the blanks in <code class="api">CouchbaseService</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase-service"><a class="anchor" href="#couchbase-service"></a>Couchbase service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The primary focus of this tutorial is the <code class="api">CouchbaseService</code> class located in the <em class="path">src/main/java/com/couchbase/beersample</em> directory.
The class is responsible for dealing with all interactions between the application and the Couchbase server.
The constructor and <code class="api">preDestroy()</code> method are the part of the class that deals with connecting to and disconnecting from Couchbase.</p>
</div>
<div class="paragraph">
<p>The application is parameterized through the <em class="path">src/main/resources/application.yml</em> configuration file, which gets injected by Spring Boot into the <code class="api">Database</code> class.
You need to customize this to your cluster setup and use the configuration for connection.</p>
</div>
<div class="paragraph">
<p>Try to implement them and compare with the code extract below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
public class CouchbaseService {

	private final Database config;

	private final Bucket bucket;
	private final Cluster cluster;

	@Autowired
	public CouchbaseService(final Database config) {
		this.config = config;

		//connect to the cluster and open the configured bucket
		this.cluster = CouchbaseCluster.create(config.getNodes());
		this.bucket = cluster.openBucket(config.getBucket(), config.getPassword());
	}

	@PreDestroy
	public void preDestroy() {
		if (this.cluster != null) {
			this.cluster.disconnect();
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to reuse the Couchbase connections so that the underlying resources are not duplicated for each connection.
Here the <code>@Service</code> annotation ensures that the Spring framework creates only one instance of the class.
The important message is that you only create one connection to the Couchbase cluster and one connection to each bucket you are using, then statically reference those connections for each use.</p>
</div>
<div class="paragraph">
<p>The line <code>this.cluster = CouchbaseCluster.create(config.getNodes());</code> creates a new Couchbase connection object and makes the initial connection to the cluster.
In this example, we supply a list of IP addresses obtained from the <code class="api">Database</code> configuration object, populated by Spring Boot with the contents of the <code>application.yml</code> file.
You can supply a string, or several strings concatenated with commas so that it can fall back to another node should a connection to a single node fail.</p>
</div>
<div class="paragraph">
<p>Next, connect to the bucket that is storing the data, in this case, the <strong>beer-sample</strong> bucket provided as part of your Couchbase installation.
As with connecting to the cluster, it is important to create a single connection and reuse it multiple times throughout your code.
The line <code>this.bucket = cluster.openBucket (config.getBucket(), config.getPassword());</code> creates a connection to the bucket defined in the configuration.
The Couchbase Java SDK provides both synchronous and asynchronous APIs that allow you to harness easily the power of asynchronous computation while maintaining the simplicity of synchronous operations.
In this case, we are choosing to connect to both the cluster and the bucket synchronously as most of our application will be required to be synchronous, loading data before a web page can be generated.
However, the asynchronous API is explained later on for use in creating view queries.</p>
</div>
<div class="paragraph">
<p>The disconnect method is included even though it is not explicitly called in this example.
Spring framework will invoke the method annotated with <code>PreDestroy</code> when destroying the context and shutting down the application.</p>
</div>
<div class="paragraph">
<p>Now that we have dealt with connecting to the cluster and the bucket we can move onto completing some useful operations, beginning with querying the database for a single document.
We will be using the following code, which connects to the Couchbase server, searches for a given key identifier, and returns the associated <code>JsonDocument</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
* READ the document from database
*/
public JsonDocument read(String id) {
	return bucket.get(id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When data is stored in Couchbase as JSON, it will be converted by the Java SDK into a <strong>JsonDocument</strong> object.
This allows you to use a very simple JSON library, built into the Couchbase SDK, to access, modify and re-save the data held in the document.
This makes working with data with Couchbase very simple as you have direct access to the data as it is stored in the database, allowing for rapid operations from both the client and the server.</p>
</div>
<div class="paragraph">
<p>Another important aspect is error management.
When the document doesn&#8217;t exist, the SDK simply returns null.
But should another error condition arise, a specific exception will be thrown (like a <code>TimeOutException</code> wrapped in a <code class="api">RuntimeException</code> if the server couldn&#8217;t respond in time).
So it is important to ensure that your application can handle the errors that the SDK will pass up to it.</p>
</div>
<div class="paragraph">
<p>Next see if you can complete the very similar methods <code>create</code>, <code>delete</code> and <code>update</code>.
Their corresponding SDK methods are <code>insert</code> (or <code>upsert</code>), <code>remove</code> and <code>update</code>.</p>
</div>
<div class="paragraph">
<p>Some methods like the insert method can additionally specify a durability requirement as is covered in more detail in the document-updating section of the documentation.
Briefly, it allows you to control the performance-persistence relationship.
By default, the server will acknowledge the operation as soon as the document has reached its cache layer, this provides the best performance as the client can receive a response very quickly.
However, in some situations you want or need greater assurances that an operation has completed, and so you can specify at what point during the persistence process the server will respond that the operation has completed.</p>
</div>
<div class="paragraph">
<p>Also, it may be confusing that we are returning a <code class="api">JsonDocument</code> value.
This is because the operations update the document&#8217;s metadata.
So the returned document reflects this, for example by having the <code>cas</code> field updated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying-views"><a class="anchor" href="#querying-views"></a>Querying views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next section of the <code class="api">CouchbaseService</code> class is going to handle making a view query to the Couchbase cluster to allow us to display a list of all the beers ( and potentially limiting that list).</p>
</div>
<div class="paragraph">
<p>The first thing to consider when designing a view is the data requirement for the operation.
Due to the increase in the amount of data being sent, a view query is slower than a basic get operation.
Therefore, we need to consider what data we need from the view so that we only emit the values necessary.
For our application, we have written a view function for beers that emits the name of the beer and the ID of its associated brewery.</p>
</div>
<div class="paragraph">
<p>The <code>findAllBeers</code> method is the first example of querying a view.
We need to prepare the query, optionally add parameters if a limit or a skip value have been provided then execute the query properly.
The returned object, <code class="api">ViewResult</code>, has a collection of rows, representing each key and value pair emitted by the view function.
One can iterate over it by using the <code class="api">rows()</code> method, which is what is used by the <code class="api">BeerController</code> in the <code class="api">listBeers()</code> method.
Note that the controller transforms the result into a slightly different JSON object that better reflect what we want to expose in our REST API.</p>
</div>
<div class="paragraph">
<p>Try to implement <code class="api">findAllBeers</code> and compare with the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public ViewResult findAllBeers(Integer offset, Integer limit) {
	ViewQuery query = ViewQuery.from("beer", "by_name");
	if (limit != null &amp;&amp; limit &gt; 0) {
		query.limit(limit);
	}
	if (offset != null &amp;&amp; offset &gt; 0) {
		query.skip(offset);
	}
	ViewResult result = bucket.query(query);
	return result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the view query is more complex than a get operation, it is advantageous to leverage the asynchronous API in the SDK.
To achieve this, we can use the <code>async()</code> method on the bucket, this tells the SDK to use the underlying asynchronous operations and not to apply any blocking code to it.
This allows us far greater control over the execution of the operation.
Additionally, we will now be dealing with observables (as made more explicit in the API by having the return types being prefixed with <code>Async</code>).</p>
</div>
<div class="paragraph">
<p>Try to implement the <code class="api">findAllBeersAsync()</code> method and compare with the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
* Retrieves all the beers using a view query, returning the result asynchronously.
*/
public Observable&lt;AsyncViewResult&gt; findAllBeersAsync() {
	ViewQuery allBeers = ViewQuery.from("beer", "by_name");
	return bucket.async().query(allBeers);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, going from sync to async is quite easy, by just calling <code class="api">async()</code>.
Methods that returned an <code>X</code> in the sync variant now return an <code>Observable&lt;X&gt;</code>.
You can then apply Rx transformations to it if necessary, as we&#8217;ll see in the next section.
For now, try also to do the simple implementation of <code class="api">asyncRead()</code>.</p>
</div>
<div class="paragraph">
<p>There are two last view-related methods to implement before jumping into more advanced asynchronous data flows: <code class="api">createQueryBeersForBrewery()</code> and <code class="api">findBeersForBreweryAsync()</code>.
The second one just executes the query produced by the first one in an asynchronous manner.
The idea of the query is to use the <code>brewery_beers</code> view to retrieve all beers brewed in a particular brewery.
This can be done by specifying a very narrow range of keys.</p>
</div>
<div class="paragraph">
<p>In this view, note how the key is a JSON array of the brewery identifier and the beer identifier for beers.
If we provide a <code>startKey</code> with just the brewery identifier BW and an <code>endKey</code> that would limit us to the last [BW, <em>beer Id</em>] pair (included), we would be good.
The trick here is to use the UTF-8 character <code>\uefff</code>.
This is a big enough char that we&#8217;re sure no beer identifier will come after it, alphabetically speaking.
So this results in the correct range we&#8217;re seeking:</p>
</div>
<div class="paragraph">
<p>Try to implement <code class="api">createQueryBeersForBrewery</code> and <code class="api">FindBeersForBreweryAsync</code> and compare with the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static ViewQuery createQueryBeersForBrewery(String breweryId) {
	ViewQuery forBrewery = ViewQuery.from("beer", "brewery_beers");
	forBrewery.startKey(JsonArray.from(breweryId));
	//the trick here is that sorting is UTF8 based, uefff is the largest UTF8 char
	forBrewery.endKey(JsonArray.from(breweryId, "\uefff"));
	return forBrewery;
}

public Observable&lt;AsyncViewResult&gt; findBeersForBreweryAsync(String breweryId) {
	return bucket.async().query(createQueryBeersForBrewery(breweryId));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="more-advanced-asynchronous-flow"><a class="anchor" href="#more-advanced-asynchronous-flow"></a>More advanced asynchronous flow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s have a look at a more advanced data flow coded in <code class="api">BreweriesController</code>'s <code class="api">getBrewery()</code> method.
The idea of this method is to display a brewery&#8217;s details (as obtained from the database), but with the addition of a <code>beers</code> field that contains an array of all the beers produced by this brewery.
Prepare two asynchronous observables to retrieve the relevant data: : one to retrieve the brewery&#8217;s document itself, the other to list this brewery&#8217;s beers and assemble them into a <code>List</code> (using the <code>findBeersForBreweryAsync()</code> query we just did).</p>
</div>
<div class="paragraph">
<p>So far, only <code class="api">Observable</code> have been produced, and there&#8217;s not been any consumption of data by calling <code class="api">subscribe()</code> with an <code class="api">Observer</code>.
This means the flow hasn&#8217;t been started, we are just describing what it will do.
Next step needs to combine each item in these two streams to result in a stream of JSON as we want it presented to the user ( combine a brewery document with a list of beers documents and produce a JSON object similar to the brewery document with an additional <em>beers</em> field).
This is the role of the <code>concatBeerInfoToBrewery()</code> method, that we now need to implement.</p>
</div>
<div class="paragraph">
<p>Notice that the controller uses the <code class="api">singleOrDefault</code> Rx operator to specify a default JSON value to return to the user if the brewery document is not found (or no list of beers could be compiled).
Notice as well that in the case of exceptions being detected, they are trapped and transformed into a JSON object emitted to the user by the <code class="api">onErrorReturn</code> Rx operator.</p>
</div>
<div class="paragraph">
<p>The resulting stream is subscribed to a few lines below by waiting for a single emission, getting the JSON content and returning it as the REST API call&#8217;s result.
Subscription and blocking is done by calling <code>fullBeers.toBlocking().single()</code>.</p>
</div>
<div class="paragraph">
<p>Try to implement <code>concatBeerInfoToBrewery()</code> and compare with the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static Observable&lt;JsonDocument&gt; concatBeerInfoToBrewery(Observable&lt;JsonDocument&gt; brewery,
	Observable&lt;List&lt;JsonDocument&gt;&gt; beers) {
		return Observable.zip(brewery, beers,
		new Func2&lt;JsonDocument, List&lt;JsonDocument&gt;, JsonDocument&gt;() {
			@Override
			public JsonDocument call(JsonDocument breweryDoc, List&lt;JsonDocument&gt; beersDoc) {
				JsonArray beers = JsonArray.create();
				for (JsonDocument beerDoc : beersDoc) {
					JsonObject beer = JsonObject.create()
					.put("id", beerDoc.id())
					.put("beer", beerDoc.content());
					beers.add(beer);
				}
				breweryDoc.content().put("beers", beers);
				return breweryDoc;
			}
		});
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last data flow is the one used for searching beers by partial name.
In <code>searchBeer</code> we&#8217;ll try to start from the stream of all beers, rework the data to stick to the REST API return format and filter to find only beers that match the search token.</p>
</div>
<div class="paragraph">
<p>The REST controller will then subscribe to the resulting flow and send the collected data to the user.
The expected format is a JSON object with the beer&#8217;s <code>id</code>, <code>name</code> and the full beer document content under the <code>detail</code> attribute.
This must be done for every beer (and so the input of the method is a stream of every beer obtained by calling <code class="api">findAllBeersAsync</code>).</p>
</div>
<div class="paragraph">
<p>The first step is to transform each query result row in the stream into the expected JSON object format.
One can use the <code class="api">map</code> Rx operator to do that, but this is done on the row&#8217;s <code class="api">document()</code> method, which returns an <code>Observable</code>.
So we have a nested Observable (the document one in the observable of rows) and need to flatten it.
This can be achieved by wrapping the mapping in a <code class="api">flatMap</code> Rx operator call.</p>
</div>
<div class="paragraph">
<p>Try to code the first part of <code class="api">searchBeer</code> and compare to the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">allBeers
//extract the document from the row and carve a result object using its content and id
.flatMap(new Func1&lt;AsyncViewRow, Observable&lt;JsonObject&gt;&gt;() {
	@Override
	public Observable&lt;JsonObject&gt; call(AsyncViewRow row) {
		return row.document().map(new Func1&lt;JsonDocument, JsonObject&gt;() {
			@Override
			public JsonObject call(JsonDocument jsonDocument) {
				return JsonObject.create()
				.put("id", jsonDocument.id())
				.put("name", jsonDocument.content().getString("name"))
				.put("detail", jsonDocument.content());
			}
		});
	}
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then comes the filtering, only keeping beers which name contains the search token, ignoring case.
This can be achieved using the <code class="api">filter</code> Rx operator.
Try to code this second part of <code class="api">searchBeer</code> and compare to the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//reject beers that don't match the partial name
.filter(new Func1&lt;JsonObject, Boolean&gt;() {
	@Override
	public Boolean call(JsonObject jsonObject) {
		String name = jsonObject.getString("name");
		return name != null &amp;&amp; name.toLowerCase().contains(token.toLowerCase());
	}
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, since what we want to output is a big JSON array of all the matching rows, we need to collect each transformed item that passed the filter into a single <code>JsonArray</code>.
The <code class="api">collect</code> Rx operator does just that.
It needs a "factory function" to create the initial collecting structure (here an empty <code>JsonArray</code>) and a section function that populates the collecting structure, called for each emitted upstream item.</p>
</div>
<div class="paragraph">
<p>Try to apply the <code>collect</code> operator to our case in the third part of <code class="api">searchBeer</code> and compare with the solution below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//collect results into a JSON array (one could also just use toList() since a List would be
// transcoded into a JSON array)
.collect(new Func0&lt;JsonArray&gt;() { //this creates the array (once)
	@Override
	public JsonArray call() {
		return JsonArray.empty();
	}
}, new Action2&lt;JsonArray, JsonObject&gt;() { //this populates the array (each item)
	@Override
	public void call(JsonArray objects, JsonObject jsonObject) {
		objects.add(jsonObject);
	}
});</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2019 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
