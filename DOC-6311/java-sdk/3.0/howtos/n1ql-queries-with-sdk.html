<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>N1QL Queries from the SDK | Couchbase Docs (Staging)</title>
    <link rel="canonical" href="https://simon-dew.github.io/docs-site/DOC-6311/java-sdk/3.0/howtos/n1ql-queries-with-sdk.html">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="schema.dcterms" href="https://purl.org/dc/terms/">
    <meta name="dcterms.subject" content="java-sdk">
    <meta name="dcterms.identifier" content="3.0">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" id="topbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://www.couchbase.com"><img src="../../../_/img/logo.svg" alt="Couchbase"></a>
        <button class="navbar-burger" data-target="topbar-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="topbar-menu" class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item has-dropdown">
            <a class="navbar-link" href="https://simon-dew.github.io/docs-site/DOC-6311">Docs</a>
            <div class="navbar-dropdown explore">
              <div class="title">Couchbase Documentation Overview</div>
              <div class="cols">
                <ul>
                  <li class="heading"><a href="../../../server/6.5/introduction/intro.html">Server</a></li>
                  <li><a href="../../../server/6.5/n1ql/n1ql-language-reference/index.html">N1QL</a></li>
                  <li><a href="../../../server/6.5/fts/full-text-intro.html">Full Text Search</a></li>
                  <li><a href="../../../server/6.5/analytics/introduction.html">Analytics</a></li>
                  <li><a href="../../../server/6.5/eventing/eventing-overview.html">Eventing</a></li>
                  <li><a href="#">Autonomous Operator</a></li>
                </ul>
                <ul>
                  <li class="heading">Mobile</li>
                  <li><a href="#">Lite</a></li>
                  <li><a href="#">Sync Gateway</a></li>
                </ul>
                <ul class="two-cols">
                  <li class="heading"><a href="../../../server/6.5/sdk/overview.html">SDKs</a></li>
                  <li><a href="#">C</a></li>
                  <li><a href="#">.NET</a></li>
                  <li><a href="#">Go</a></li>
                  <li><a href="../hello-world/start-using-sdk.html">Java</a></li>
                  <li><a href="#">Node.js</a></li>
                  <li><a href="#">PHP</a></li>
                  <li><a href="#">Python</a></li>
                  <li><a href="#">Scala</a></li>
                </ul>
                <ul>
                  <li class="heading"><a href="../../../server/6.5/connectors/intro.html">Connectors</a></li>
                  <li><a href="#">Elasticsearch</a></li>
                  <li><a href="../../../server/6.5/connectors/hadoop-1.2/hadoop.html">Hadoop</a></li>
                  <li><a href="#">Kafka</a></li>
                  <li><a href="#">Spark</a></li>
                  <li><a href="../../../server/6.5/connectors/odbc-jdbc-drivers.html">ODBC/JDBC</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="navbar-item has-dropdown">
            <a class="navbar-link component" href="../hello-world/start-using-sdk.html"><span class="title">Java SDK</span> <span class="version">3.0</span></a>
            <div class="navbar-dropdown versions">
              <div class="cols">
                <ul>
                  <li class="current"><a class="navbar-item" href="n1ql-queries-with-sdk.html">Java SDK 3.0</a></li>
                  <li><a class="navbar-item" href="../../2.7/start-using-sdk.html">Java SDK 2.7</a></li>
                  <li><a class="navbar-item" href="../../2.6/start-using-sdk.html">Java SDK 2.6</a></li>
                  <li><a class="navbar-item" href="../../2.5/start-using-sdk.html">Java SDK 2.5</a></li>
                  <li><a class="navbar-item" href="../../2.4/start-using-sdk.html">Java SDK 2.4</a></li>
                  <li><a class="navbar-item" href="../../2.3/start-using-sdk.html">Java SDK 2.3</a></li>
                  <li><a class="navbar-item" href="../../2.2/java-intro.html">Java SDK 2.2</a></li>
                  <li><a class="navbar-item" href="../../2.1/java-intro.html">Java SDK 2.1</a></li>
                </ul>
                <ul class="related">
                  <li><a class="navbar-item" href="#">c-sdk</a></li>
                  <li><a class="navbar-item" href="#">dotnet-sdk</a></li>
                  <li><a class="navbar-item" href="#">go-sdk</a></li>
                  <li><a class="navbar-item" href="#">nodejs-sdk</a></li>
                  <li><a class="navbar-item" href="#">php-sdk</a></li>
                  <li><a class="navbar-item" href="#">python-sdk</a></li>
                  <li><a class="navbar-item" href="#">scala-sdk</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="btn red-btn" href="https://www.couchbase.com/downloads">Downloads</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body container">
<nav class="nav">
<div class="nav-menu">
<ul class="nav-list">
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Getting Started</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../hello-world/start-using-sdk.html">Start Using the Java SDK</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../hello-world/sample-application.html">Sample Application</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-path is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with Data</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="kv-operations.html">Key Value Operations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="subdocument-operations.html">Sub-Document Operations</a>
    </span>
  </li>
  <li class="nav-item is-current-page is-active" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="n1ql-queries-with-sdk.html">Query</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="analytics-using-sdk.html">Analytics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="full-text-searching-with-sdk.html">Full Text Search</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Advanced Data Operations</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="concurrent-async-apis.html">Async &amp; Reactive APIs</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="distributed-acid-transactions-from-the-sdk.html">Distributed ACID Transactions</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="transcoders-nonjson.html">Transcoders &amp; Non-JSON</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="working-with-collections.html">Working with Collections DP</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Managing Couchbase</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="managing-connections.html">Managing Connections</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Errors &amp; Diagnostics</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="collecting-information-and-logging.html">Logging</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Learn</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/concepts.html">Overview</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/buckets-and-clusters.html">Buckets &amp; Clusters</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/collections.html">Collections &amp; Scope</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/compression.html">Compression</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../concept-docs/data-model.html">Data Model</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/documents.html">Documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/nonjson.html">Non-json Docs</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/subdocument-operations.html">Sub-Documents</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/xattr.html">XATTR &amp; Virtual XATTR</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../concept-docs/errors.html">Errors and Diagnostics</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/health-check.html">Health Check</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/response-time-observability.html">Tracing</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/durability-replication-failure-considerations.html">Failure Considerations</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/encryption.html">Field Level Encryption</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../concept-docs/data-services.html">Service Selection</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/analytics-for-sdk-users.html">Analytics</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/understanding-views.html">Map Reduce Views</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/n1ql-query.html">Query</a>
    </span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../concept-docs/full-text-search-overview.html">Search</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">References</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/sdk-api/couchbase-java-client">API Reference</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../ref/client-settings.html">Client Settings</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item is-active" data-depth="0">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <span class="nav-text">Project Docs</span>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../project-docs/sdk-release-notes.html">SDK Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../project-docs/distributed-transactions-java-release-notes.html">Transactions Release Notes</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../project-docs/compatibility.html">Compatibility</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="../project-docs/migrating-sdk-code-to-3.n.html">Migrating to SDK 3 API</a>
    </span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <a class="nav-link" href="../project-docs/sdk-licenses.html">Licenses</a>
    </span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-line">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../project-docs/get-involved.html">Get involved</a>
    </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-line">
    <a class="nav-link" href="https://docs.couchbase.com/home/contribute/index.html">Improve the Docs</a>
    </span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
</div>
</nav>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
<main class="article" data-ceiling="topbar">
  <div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../hello-world/start-using-sdk.html">Java SDK</a></li>
    <li class="crumb">Working with Data</li>
    <li class="crumb"><a href="n1ql-queries-with-sdk.html">Query</a></li>
  </ul>
</nav>
<div class="tools" role="navigation">
  <ul>
    <li class="tool edit"><a href="https://github.com/couchbase/docs-sdk-java/edit/release/3.0/modules/howtos/pages/n1ql-queries-with-sdk.adoc" title="Edit Page" target="_blank" rel="noopener">Edit</a></li>
  </ul>
</div>
  </div>
<article class="doc">
<h1 class="page">N1QL Queries from the SDK</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
You can query for documents in Couchbase using the N1QL query language, a language based on SQL, but designed for structured and flexible JSON documents.
Querying can solve typical programming tasks such as finding a user profile by email address, facebook login, or user ID.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After familiarizing yourself with the basics on how the N1QL query language works and how to query it from the UI you can use it from the Java SDK.</p>
</div>
<div class="paragraph">
<p>Before starting, here&#8217;s all imports used in the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.couchbase.client.core.error.CouchbaseException;
import com.couchbase.client.java.*;
import com.couchbase.client.java.json.*;
import com.couchbase.client.java.query.*;
import org.reactivestreams.Subscription;
import reactor.core.publisher.*;

import java.util.UUID;
import java.util.concurrent.atomic.AtomicInteger;

import static com.couchbase.client.java.query.QueryOptions.queryOptions;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a complete example of doing a query and handling the results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try {
  final QueryResult result = cluster
    .query("select * from `travel-sample` limit 10", queryOptions().metrics(true));

  for (JsonObject row : result.rowsAsObject()) {
    System.out.println("Found row: " + row);
  }

  System.out.println("Reported execution time: "
    + result.metaData().metrics().get().executionTime());
} catch (CouchbaseException ex) {
  ex.printStackTrace();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s break it down. A query is always performed at the <code>Cluster</code> level, using the <code>query</code> method. It takes the statement as a required argument and then allows to provide additional options if needed (in the example above, no options are specified).</p>
</div>
<div class="paragraph">
<p>Once a result returns you can iterate the returned rows and/or accessing the <code>QueryMetaData</code> associated with the query. If something goes wrong during the execution of the query, a derivate of the <code>CouchbaseException</code> will be thrown that also provides additional context on the operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Exception in thread "main" com.couchbase.client.core.error.ParsingFailureException: Parsing of the input failed {"completed":true,"coreId":1,"errors":[{"code":3000,"message":"syntax error - at end of input"}],"idempotent":false,"lastDispatchedFrom":"127.0.0.1:56279","lastDispatchedTo":"127.0.0.1:8093","requestId":3,"requestType":"QueryRequest","service":{"operationId":"eee9b796-bfff-42dc-941d-1a985e019ff8","statement":"select 1=","type":"query"},"timeoutMs":75000,"timings":{"dispatchMicros":14381,"totalMicros":1365348}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Open Buckets and Cluster-Level Queries</div>
<div class="paragraph">
<p>If you are using a cluster older than Couchbase Server 6.5, it is required that there is at least one bucket open before performing a cluster-level query. If you fail to do so, the SDK will return a <code>FeatureNotAvailableException</code> with a descriptive error message asking you to open one.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="paramerterized-queries"><a class="anchor" href="#paramerterized-queries"></a>Paramerterized Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Supplying parameters as individual arguments to the query allows the query engine to optimize the parsing and planning of the query. You can either supply these parameters by name or by position.</p>
</div>
<div class="paragraph">
<p>The first example shows how to provide them by name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select count(*) from `travel-sample` where type = \"airports\" and country = $country",
  queryOptions().parameters(JsonObject.create().put("country", "France"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second example by position:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select count(*) from `travel-sample` where type = \"airports\" and country = ?",
  queryOptions().parameters(JsonArray.from("France"))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>What style you choose is up to you, for readability in more complex queries we generally recommend using the named parameters.</p>
</div>
<div class="paragraph">
<p>Note that you cannot use parameters in all positions. If you put it in an unsupported place the server will respond with a <code>PlanningFailureException</code> or similar.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-query-result"><a class="anchor" href="#the-query-result"></a>The Query Result</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When performing a query, the response you receive is a <code>QueryResult</code>. If no exception gets raised the request succeeded and provides access to both the rows returned and also associated <code>QueryMetaData</code>.</p>
</div>
<div class="paragraph">
<p>Rows can be consumed either through a <code>JsonObject</code> directly, turned into a java collection instance (like a <code>Map</code>) or into your POJO of choice mapping directly to your domain logic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select * from `travel-sample` limit 10"
);
for (JsonObject row : result.rowsAsObject()) {
  System.out.println("Found row: " + row);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>QueryMetaData</code> provides insight into some basic profiling/timing information as well as information like the <code>clientContextId</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. QueryMetaData</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String requestId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the request identifer of this request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String clientContextId()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the context ID either generated by the SDK or supplied by the user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>QueryStatus status()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An enum simply representing the state of the result.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;QueryMetrics&gt; metrics()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns metrics provided by the query for the request if enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;JsonObject&gt; signature()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a signature is present, it will be available to consume in a generic fashion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;QueryWarning&gt; warnings()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-fatal errors are available to consume as warnings on this method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;JsonObject&gt; profile()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If enabled returns additional profiling information of the query.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, here is how you can print the <code>executionTime</code> of a query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query("select 1=1", queryOptions().metrics(true));
System.err.println(
  "Execution time: " + result.metaData().metrics().get().executionTime()
);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-options"><a class="anchor" href="#query-options"></a>Query Options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The query service provides an array of options to customize your query. The following table lists them all:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Available Query Options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientContextId(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a context ID returned by the service for debugging purposes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parameters(JsonArray)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to set positional arguments for a parameterized query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parameters(JsonObject)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to set named arguments for a parameterized query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>priority(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigns a different server-side priority to the query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>raw(String, Object)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Escape hatch to add arguments that are not covered by these options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>readonly(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tells the client and server that this query is readonly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adhoc(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to false will prepare the query and later execute the prepared statement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consistentWith(MutationState)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to be consistent with previously written mutations ("read your own writes").</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxParallelism(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tunes the maximum parallelism on the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metrics(boolean)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the server to send metrics back to the client as part of the response.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pipelineBatch(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the batch size for the query pipeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pipelineCap(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the cap for the query pipeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>profile(QueryProfile)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to enable additional query profiling as part of the response.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanWait(Duration)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to specify a maximum scan wait time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanCap(int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a maximum cap on the query scan size.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scanConsistency(QueryScanConsistency)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a different scan consistency for this query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>serializer(JsonSerializer)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to use a different serializer for the decoding of the rows.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="scan-consistency"><a class="anchor" href="#scan-consistency"></a>Scan Consistency</h3>
<div class="paragraph">
<p>By default, the query engine will return whatever is currently in the index at the time of query (this mode is also called <code>QueryScanConsistency.NOT_BOUNDED</code>). If you need to include everything that has just been written, a different scan consistency must be chosen. If <code>QueryScanConsistency.REQUEST_PLUS</code> is chosen, it will likely take a bit longer to return the results but the query engine will make sure that it is as up-to-date as possible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select ...",
  queryOptions().scanConsistency(QueryScanConsistency.REQUEST_PLUS)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <code>consistentWith(MutationState)</code> for a more narrowed-down scan consistency. Construct the <code>MutationState</code> from individual `MutationToken`s that are returned from KV `MutationResult`s to make sure at least those mutations are visible. Depending on the index update rate this might provide a speedier response.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-context-id"><a class="anchor" href="#client-context-id"></a>Client Context Id</h3>
<div class="paragraph">
<p>The SDK will always send a client context ID with each query, even if none is provided by the user. By default a UUID will be generated that is mirrored back from the query engine and can be used for debugging purposes. A custom string can always be provided if you want to introduce application-specific semantics into it (so that for example in a network dump it shows up with a certain identifier). Whatever is chosen, we recommend making sure it is unique so different queries can be distinguished during debugging or monitoring.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select ...",
  queryOptions().clientContextId("user-44" + UUID.randomUUID().toString())
);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="readonly"><a class="anchor" href="#readonly"></a>Readonly</h3>
<div class="paragraph">
<p>If the query is marked as readonly, both the server and the SDK can improve processing of the operation. On the client side, the SDK can be more liberal with retries because it can be sure that there are no state-mutating side-effects happening. The query engine will ensure that actually no data is mutated when parsing and planning the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">QueryResult result = cluster.query(
  "select ...",
  queryOptions().readonly(true)
);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="custom-json-serializer"><a class="anchor" href="#custom-json-serializer"></a>Custom JSON Serializer</h3>
<div class="paragraph">
<p>Like with all JSON apis, it is possible to customize the JSON serializer. It allows to plug in your own library (like GSON) or custom configured mappings on your own Jackson serializer. This in turn makes it possible to serialize rows into POJOs or other structures that your application defines and the SDK has no idea about.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="transcoders-nonjson.html" class="page">documentation on transcoding and serialization</a> for more information.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive-and-async-apis"><a class="anchor" href="#reactive-and-async-apis"></a>Reactive And Async APIs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the blocking API on <code>Cluster</code>, the SDK provides reactive and async APIs on <code>ReactiveCluster</code> or <code>AsyncCluster</code> respectively. If you are in doubt of which API to use, we recommend looking at the reactive first. It builds on top of reactor, a powerful library that allows you to compose reactive computations and deal with error handling and other related concerns (like retry) in an elegant manner. The async API on the other hand exposes a <code>CompletableFuture</code> and is more meant for lower level integration into other libraries or if you need the last drop of performance.</p>
</div>
<div class="paragraph">
<p>Also, there is another reason you want to use the reactive API: streaming large results with backpressure from the application side. Both the blocking and async APIs have no means of signalling backpressure in a good way, so if you need it the reactive API is your best option.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Advanced Reactive Concepts Ahead</div>
<div class="paragraph">
<p>Please see the guides on reactive programming for more information on the basics, this guide is diving straight into their impact on querying.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A simple reactive query is similar to the blocking one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Mono&lt;ReactiveQueryResult&gt; result = cluster
  .reactive()
  .query("select 1=1");

result
  .flatMapMany(ReactiveQueryResult::rowsAsObject)
  .subscribe(row -&gt; System.out.println("Found row: " + row));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will stream all rows as they become available form the server. If you want to manually control the data flow (which is important if you are streaming a lot of rows which could cause a potential out of memory situation) you can do this by using explicit <code>request()</code> calls.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Mono&lt;ReactiveQueryResult&gt; result = cluster
  .reactive()
  .query("select * from hugeBucket");

result
  .flatMapMany(ReactiveQueryResult::rowsAsObject)
  .subscribe(new BaseSubscriber&lt;JsonObject&gt;() {
    // Number of outstanding requests
    final AtomicInteger oustanding = new AtomicInteger(0);

    @Override
    protected void hookOnSubscribe(Subscription subscription) {
      request(10); // initially request to rows
      oustanding.set(10);
    }

    @Override
    protected void hookOnNext(JsonObject value) {
      process(value);
      if (oustanding.decrementAndGet() == 0) {
        request(10);
      }
    }
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we initially request a batch size of 10 rows (so streaming can begin). Then as each row gets streamed it is written to a <code>process()</code> method which does whatever it needs to do to process. Then a counter is decremented and once all of the 10 outstanding rows are processed another batch is loaded. Please note that if your <code>process()</code> method equivalent is blocking, like always with reactive code, you <strong>must</strong> move it onto another scheduler so that the I/O threads are not stalled. As always we recommend not blocking in the first place in reactive code.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/logo.svg" alt="Couchbase">
          </a>
        </div>
        <div class="contact">
          <p class="address">3250 Olcott Street
Santa Clara, CA 95054
United States</p>
          <a href="https://www.couchbase.com/contact" class="btn white-btn">Contact Us</a>
          <a class="tel" href="tel:1-650-417-7500">1-650-417-7500</a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Company</span></li>
          <li><a href="https://www.couchbase.com/about">About</a></li>
          <li><a href="https://www.couchbase.com/leadership">Leadership</a></li>
          <li><a href="https://www.couchbase.com/news-and-press-releases">News &amp; Press</a></li>
          <li><a href="https://www.couchbase.com/careers">Careers</a></li>
          <li><a href="https://www.couchbase.com/resources/events">Events</a></li>
          <li><a href="https://www.couchbase.com/contact">Contact Us</a></li>
          <li><a href="https://www.couchbase.com/request-pricing">Pricing</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Support</span></li>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://www.couchbase.com/services">Professional Services</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support Login</a></li>
          <li><a href="https://learn.couchbase.com/store" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><span class="heading">Quicklinks</span></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Online Training</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
          <li><a href="https://www.couchbase.com/nosql-resources/why-nosql">Why NoSQL</a></li>
          <li><a href="https://www.couchbase.com/resources/security">Security</a></li>
          <li><a href="https://www.couchbase.com/resources/gdpr">GDPR</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <a href="https://www.facebook.com/Couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="26.363 116.363 560.215 560.215"><path d="m586.58 209.58c0-48.96-44.252-93.212-93.212-93.212h-373.79c-48.96 0-93.212 44.252-93.212 93.212v373.79c0 48.96 44.252 93.212 93.212 93.212h186.42v-211.85h-68.732v-93.212h68.732v-36.72c0-63.083 47.077-119.58 105.45-119.58h75.323v93.212h-75.323c-8.474 0-17.889 10.357-17.889 25.422v37.662h93.212v93.212h-93.212v211.85h99.803c48.96 0 93.212-44.252 93.212-93.212v-373.79z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://twitter.com/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="32.012 176.622 542.326 437.815"><path d="m574.34 227.46c-19.772 8.474-41.428 15.065-64.025 17.889 22.597-14.123 40.486-35.778 48.96-61.2-21.655 13.182-45.194 21.655-70.615 27.305-20.714-21.655-48.96-34.837-80.972-34.837-61.2 0-111.1 49.902-111.1 111.1 0 8.474 0.942 16.948 2.825 25.422-92.271-5.649-174.18-49.902-229.74-117.69-9.415 16.006-15.065 35.778-15.065 55.551 0 38.603 19.772 72.498 49.902 92.271-17.889-0.942-35.778-5.649-50.843-14.123v0.942c0 53.668 38.603 98.862 89.446 109.22-9.415 2.825-18.831 3.766-29.188 3.766-7.532 0-14.123-0.942-20.714-1.883 14.123 44.252 55.551 76.265 103.57 77.206-37.662 30.129-85.68 48.018-138.41 48.018-9.415 0-17.889-0.941-26.363-1.883 48.96 32.012 107.34 49.902 170.42 49.902 204.31 0 316.36-169.48 316.36-316.36v-14.123c21.656-14.125 40.487-33.897 55.551-56.494z"/></svg>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/couchbase" class="icon">
              <svg width="50px" height="50px" viewBox="31.071 119.188 539.537 540.443"><path d="m531.97 119.19h-461.35c-21.655 0-39.545 16.948-39.545 38.603v463.24c0 21.655 17.889 38.603 39.545 38.603h460.41c21.655 0 39.545-16.948 39.545-38.603v-463.24c0.942-21.656-16.947-38.603-38.603-38.603zm-337.07 451.94h-81.914v-243.86h81.914v243.86zm-40.486-276.81c-28.246 0-46.135-18.831-46.135-42.369s17.889-42.369 46.135-42.369 45.194 17.889 45.194 42.369c0.942 23.538-16.948 42.369-45.194 42.369zm335.19 276.81h-81.914v-129.93c0-32.954-12.24-55.551-41.428-55.551-22.597 0-35.778 15.065-41.428 30.129-1.883 5.649-2.825 12.24-2.825 19.772v136.52h-81.914s0.942-221.26 0-243.86h81.914v34.837c11.298-16.948 30.129-40.486 73.44-40.486 53.668 0 94.154 34.837 94.154 110.16l1e-3 138.41zm-168.54-208.08s0.941-0.941 0 0z"/></svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <span>2019 COUCHBASE All rights reserved.</span>
      <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
      <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
      <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
